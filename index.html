<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>進階 AI 聊天機器人 Astra-nos-14.2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 新增：引入 marked.js 函式庫以解析 Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 新增：引入 Chart.js 函式庫以繪製圖表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ▼▼▼ 新增：引入 Cropper.js 函式庫以進行圖片裁切 ▼▼▼ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- ▲▲▲ 結束新增 ▲▲▲ -->
    <style>
        :root {
            --chat-bg: #ffffff;
            --sidebar-bg: #f7f7f8;
            --input-bar-bg: #ffffff;
            --input-field-bg: #f9fafb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --hover-bg: #f3f4f6;
            --active-bg: #e5e7eb;
            --modal-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --ai-bubble-bg: var(--sidebar-bg);
            --user-bubble-bg: #3b82f6;
            
            /* ▼▼▼ 新增：UI 主題顏色變數 ▼▼▼ */
            --button-primary-bg: #3b82f6;
            --button-primary-hover-bg: #2563eb;
            --button-primary-text: #ffffff;
            /* ▲▲▲ 結束：UI 主題顏色變數 ▲▲▲ */
        }
        .dark {
            --chat-bg: #111111;
            --sidebar-bg: #1c1c1c;
            --input-bar-bg: #1c1c1c;
            --input-field-bg: #2d2d2d;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --hover-bg: #374151;
            --active-bg: #4b5563;
            --modal-bg: #1f2937;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --ai-bubble-bg: var(--sidebar-bg);
            --user-bubble-bg: #2563eb;
        }

        /* --- 全局動畫與過渡效果 --- */
        @keyframes subtleFadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes subtleScaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* 為常用互動元素增加平滑過渡 */
        button, .sidebar-item, .settings-nav-item, .theme-btn, .voice-input-btn, .model-option-btn-container, .color-option {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }

        /* 增強按鈕的懸停與點擊反饋 */
        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        button:active:not(:disabled) {
            transform: translateY(0px);
            box-shadow: none;
        }
        /* --- 結束 全局動畫 --- */


        body { background-color: var(--chat-bg); color: var(--text-primary); } /* 移除 height: 100vh; overflow: hidden; */
        .sidebar { background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); transition: transform 0.3s ease-in-out; }
        .scroll-area::-webkit-scrollbar { width: 8px; }
        .scroll-area::-webkit-scrollbar-track { background: transparent; }
        .scroll-area::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .scroll-area::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Modal 動畫 (已有) */
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal > div {
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        .modal.visible > div { transform: scale(1); }
        
        /* ▼▼▼ 新增/修改的程式碼 ▼▼▼ */
        /* --- 登入/App 轉場動畫 --- */
        #auth-container {
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        #auth-container.fade-out {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none; /* 避免在淡出時被點擊 */
        }
        #app-container, #store-container {
            /* 初始狀態 */
            opacity: 0;
            transform: scale(1.05);
            transition: opacity 0.4s ease-in 0.2s, transform 0.4s ease-in 0.2s;
        }
        #app-container.visible, #store-container.visible {
            /* 結束狀態 */
            opacity: 1;
            transform: scale(1);
        }
        
        /* 聊天視窗切換動畫 */
        @keyframes chatFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-view-transition {
            animation: chatFadeIn 0.3s ease-out forwards;
        }
        
        /* 資料夾開合動畫 */
        .folder-item > .folder-content-container {
            overflow-y: hidden;
            transition: max-height 0.35s cubic-bezier(0.2, 1, 0.3, 1);
            max-height: 0;
        }
        .folder-item[open] > .folder-content-container {
            max-height: 100vh; /* 一個足夠大的值以容納內容 */
            transition: max-height 0.5s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .folder-item[open] > summary {
            margin-bottom: 4px; /* 開啟時增加一點間距 */
        }
        
        /* 輸入框容器焦點動畫 */
        @keyframes pulse-glow {
            from { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
            to   { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0); }
        }
        .input-wrapper {
            transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
            position: relative;
        }
        .input-wrapper.pulse-glow {
            animation: pulse-glow 0.5s ease-out;
        }
        
        #auth-container .auth-form-container {
            animation: subtleFadeInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* --- 側邊欄主體 - 幻彩玻璃風格 --- */
        .sidebar {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background-color: rgba(255, 255, 255, 0.75);
            border-right: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 4px 0px 15px rgba(0, 0, 0, 0.05);
            --border-color: rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
        }

        .dark .sidebar {
            background-color: rgba(30, 30, 30, 0.5);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 4px 0px 20px rgba(0, 0, 0, 0.2);
            --border-color: rgba(255, 255, 255, 0.1);
        }
        
        /* --- 側邊欄內部項目 - 融入玻璃風格 & 動畫 --- */
        .sidebar-item:hover {
           background-color: rgba(255, 255, 255, 0.3);
        }
        .dark .sidebar-item:hover {
           background-color: rgba(255, 255, 255, 0.08);
        }

        /* 選中項目時增加更明顯的動畫效果 */
        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.02);
            box-shadow: 0 0 15px -3px rgba(59, 130, 246, 0.3);
        }
        .dark .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.12);
        }

        /* Popover 選單動畫 */
        .popover {
            box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
            background-color: var(--modal-bg);
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95) translateY(-10px);
            transition: opacity 0.15s ease-out, transform 0.15s ease-out, visibility 0.15s;
            transform-origin: top; /* 預設從頂部展開 */
        }
        .popover.visible {
            opacity: 1;
            visibility: visible;
            transform: scale(1) translateY(0);
        }
        /* 針對不同位置的 Popover 調整動畫原點 */
        #model-options-popover { transform-origin: top right; }
        #file-options-popover {
            transform-origin: bottom left;
            /* 調整初始狀態以實現向上動畫 */
            transform: scale(0.95) translateY(10px);
        }
        #file-options-popover.visible {
            transform: scale(1) translateY(0);
        }


        #temp-chat-indicator {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background-color: rgba(255, 229, 100, 0.2);
            border: 1px solid rgba(255, 229, 100, 0.4);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            color: #A16207;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            /* 新增過渡動畫 */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #temp-chat-indicator.hidden {
             opacity: 0;
             transform: scale(0.8);
        }
        .dark #temp-chat-indicator {
            background-color: rgba(255, 229, 100, 0.25);
            border: 1px solid rgba(255, 229, 100, 0.5);
            color: #FBBF24;
        }

        #notification-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .notification {
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            font-weight: 500;
            animation: fadeInRight 0.3s ease, fadeOutRight 0.3s ease 2.7s forwards;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }
        .dark .notification {
            background-color: rgba(20, 20, 20, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        .notification.success { color: #22c55e; }
        .notification.error { color: #ef4444; }
        .notification.warning { color: #f97316; }

        /* 訊息進入動畫 (已有) */
        .message-item { animation: slideInUp 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }


        /* AI 正在運行中的動畫效果 (已有) */
        .loading-dots { display: flex; align-items: center; justify-content: center; height: 1.25rem; }
        .loading-dots span { display: inline-block; width: 8px; height: 8px; margin: 0 2px; background-color: var(--text-secondary); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots span:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }


        .prose code:not(pre *) { background-color: var(--hover-bg); padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 6px; color: var(--text-primary); border: 1px solid var(--border-color); }
        .prose pre { background-color: #111827; color: #f3f4f6; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
        .prose pre code { background-color: transparent; padding: 0; color: inherit; border: none; }
        .prose h1, .prose h2, .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: bold; }
        .prose h1 { font-size: 1.875rem; }
        .prose h2 { font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        .prose h3 { font-size: 1.25rem; }
        .prose p { margin-bottom: 1em; }
        .prose table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
        .prose table th, .prose table td { border: 1px solid var(--border-color); padding: 0.75rem; text-align: left; }
        .prose table thead { background-color: var(--hover-bg); }
        .prose table tr:nth-child(even) { background-color: var(--hover-bg); }
        .prose ul, .prose ol { margin-bottom: 1em; padding-left: 1.5em; }
        .prose ul li, .prose ol li { margin-bottom: 0.5em; }


        .folder-item summary { list-style: none; cursor: pointer; }
        .folder-item summary::-webkit-details-marker { display: none; }
        .folder-item summary .folder-arrow { transition: transform 0.2s; }
        .folder-item[open] summary .folder-arrow { transform: rotate(90deg); }


        .color-swatch, .icon-option { transition: transform 0.2s; border: 2px solid transparent; }
        .color-swatch:hover, .icon-option:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: #3b82f6; }
        .icon-option.selected { background-color: var(--active-bg); border-color: #3b82f6; }
        #web-search-btn.active, #header-temp-chat-toggle-btn.active { color: #3b82f6; }
        
        /* 批次操作欄動畫 */
        #batch-action-bar {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #batch-action-bar.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        /* Astras 提示列動畫 */
        #astras-indicator {
             transition: opacity 0.3s ease, transform 0.3s ease, padding 0.3s ease;
        }
        #astras-indicator.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            padding-top: 0;
            padding-bottom: 0;
        }

        .dragging {
            opacity: 0.5;
            background: var(--active-bg);
        }
        .drag-over {
            border-top: 2px solid #3b82f6;
        }


        /* Mobile Sidebar Styles */
        #sidebar.open {
            transform: translateX(0);
        }
        #sidebar-overlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #sidebar-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .theme-button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            padding: 0.25rem;
            background-color: var(--sidebar-bg);
            border-radius: 0.5rem;
        }
        .theme-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s;
        }
        
        /* ▼▼▼ 修改：主要按鈕樣式 (支援漸變) ▼▼▼ */
        .btn-primary {
            background: var(--button-primary-bg); /* Use background instead of background-color */
            color: var(--button-primary-text);
            transition: filter 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-primary:hover:not(:disabled) {
            filter: brightness(90%);
            /* Unset the old property to avoid conflicts */
            background-color: transparent; 
        }
        .theme-btn.active {
            background: var(--button-primary-bg);
            color: var(--button-primary-text);
        }
        /* ▲▲▲ 結束：主要按鈕樣式 ▲▲▲ */


        /* 後續追問區塊動畫 */
        #follow-up-prompts-list {
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        #follow-up-prompts-list.collapsed {
            max-height: 0;
            margin-bottom: 0;
        }
        #follow-up-toggle-btn.rotate-180 {
            transform: rotate(-180deg);
        }
        .follow-up-prompt-btn {
            background-color: var(--hover-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            cursor: pointer;
            white-space: normal;
            overflow: hidden;
            text-overflow: unset;
            max-width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
            /* 動畫設定 */
            opacity: 0;
            transform: translateY(10px);
            animation: subtleFadeInUp 0.4s ease-out forwards;
            animation-delay: var(--animation-delay, 0s);
        }
        .follow-up-prompt-btn:hover {
            background-color: var(--active-bg);
            color: var(--text-primary);
        }


        /* Toggle 開關動畫 (增強) */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        .toggle-checkbox:focus + .toggle-label {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        .toggle-checkbox:checked + .toggle-label:before {
            transform: translateX(1.5rem);
        }
        .toggle-label {
             transition: background-color 0.2s ease-in-out;
        }
        .toggle-label:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: calc(1.5rem - 4px);
            height: calc(1.5rem - 4px);
            border-radius: 9999px;
            background-color: #fff;
            /* 增加更有彈性的過渡效果 */
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .model-description {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.2;
            margin-top: 0.25rem;
        }
        /* ▼▼▼ 需求 1 修正：增加垂直 padding 以提升點擊靈敏度 ▼▼▼ */
        .model-option-btn-container {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem; /* 從 0.5rem 增加到 0.75rem */
            cursor: pointer;
        }
        /* ▲▲▲ 結束修正 ▲▲▲ */
        .model-option-btn-container:hover {
            background-color: var(--hover-bg);
        }


        #model-options-popover {
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }
        /* AI Bubble Colors */
        .model-message .message-bubble {
            background-color: var(--ai-bubble-bg);
        }
        .user-message .message-content {
            white-space: pre-line;
        }
        .user-message .message-bubble {
            background-color: var(--user-bubble-bg);
        }
        
        /* 檔案預覽動畫 */
        .file-preview-item {
             animation: subtleScaleIn 0.3s ease-out forwards;
        }
        
        /* Color dropdown styles */
        .color-dropdown-container {
            position: relative;
        }
        .color-dropdown-btn {
            width: 100%;
            padding: 0.5rem 1rem;
            background-color: var(--input-field-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .color-preview {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
        }
        .color-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            z-index: 10;
            display: none;
            /* 為下拉選單增加動畫 */
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .color-dropdown-menu.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .color-option {
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .color-option:hover {
            background-color: var(--hover-bg);
        }
        /* Settings navigation styles */
        .settings-nav-item {
            cursor: pointer;
        }
        .settings-nav-item:hover {
            background-color: var(--hover-bg);
        }
        .settings-nav-item.active {
            background-color: var(--active-bg);
            font-weight: bold;
        }
        /* 設定頁面內容切換動畫 */
        .settings-section {
            display: none;
            animation: subtleFadeInUp 0.4s ease-out;
        }
        .settings-section.active {
            display: block;
        }
        /* Voice input button styles */
        .voice-input-btn {
            flex-shrink: 0;
            height: 2.5rem;
            width: 2.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .voice-input-btn:hover {
            background-color: var(--hover-bg);
        }
        .voice-input-btn.active {
            color: #ef4444;
            background-color: var(--hover-bg);
        }
        /* Pinned conversation styles */
        .pinned-icon {
            color: #fbbf24; /* Yellow for pinned */
        }

        /* ▼▼▼ 新增：自訂桌布相關樣式 ▼▼▼ */
        #wallpaper-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            z-index: -1;
            display: none;
            transition: opacity 0.3s ease-in-out;
        }

        body.custom-wallpaper-active #wallpaper-container {
            display: block;
        }

        /* 當桌布啟用時，覆蓋所有背景為透明或半透明 */
        body.custom-wallpaper-active {
            background-color: transparent !important;
        }
        body.custom-wallpaper-active #app-container > .bg-\[var\(--chat-bg\)\] {
            background-color: transparent !important;
        }
        body.custom-wallpaper-active .bg-\[var\(--input-bar-bg\)\] {
            background-color: transparent !important;
            border-color: transparent !important;
        }
        body.custom-wallpaper-active #settings-modal .bg-\[var\(--sidebar-bg\)\] {
            background-color: transparent !important;
            border-color: transparent !important;
        }
        body.custom-wallpaper-active #settings-modal .border-t {
            border-color: transparent !important;
        }
        
        /* 為主要區塊加上基礎玻璃效果 */
        body.custom-wallpaper-active .sidebar,
        body.custom-wallpaper-active header,
        body.custom-wallpaper-active .modal > div {
            background-color: rgba(255, 255, 255, 0.65) !important;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-color: rgba(200, 200, 200, 0.5) !important;
        }

        /* ▼▼▼ 修改的程式碼 ▼▼▼ */
        /* 為模型選單和輸入框設計不同的玻璃效果 */
        body.custom-wallpaper-active #model-options-popover {
            /* 將背景改為透明以達成使用者需求 */
            background-color: transparent !important;
            backdrop-filter: blur(16px) !important;
            -webkit-backdrop-filter: blur(16px) !important;
            border: 1px solid rgba(200, 200, 200, 0.5) !important;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        /* ▲▲▲ 修改的程式碼 ▲▲▲ */
        
        body.custom-wallpaper-active .input-wrapper {
            background-color: rgba(255, 255, 255, 0.35) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        body.custom-wallpaper-active #message-input {
            background-color: transparent !important;
        }

        /* ▼▼▼ 需求 2 & 3 修正：聊天泡泡在桌布模式下的玻璃效果與文字顏色 ▼▼▼ */
        body.custom-wallpaper-active .message-bubble {
            backdrop-filter: blur(16px); /* 增強毛玻璃效果 */
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* 在桌布模式下，AI 泡泡使用變數定義的半透明背景，文字為黑色 */
        body.custom-wallpaper-active .model-message .message-bubble {
            background-color: var(--ai-bubble-bg); /* Use variable for customizable color */
            color: #111827 !important;
        }
        body.custom-wallpaper-active .model-message .message-bubble .prose {
            color: #111827 !important;
        }

        /* 在桌布模式下，使用者泡泡也使用變數定義的半透明背景，文字改為黑色 */
        body.custom-wallpaper-active .user-message .message-bubble {
            background-color: var(--user-bubble-bg); /* Use variable for customizable color */
            color: #111827 !important;
        }
        body.custom-wallpaper-active .user-message .message-bubble .prose {
            color: #111827 !important;
        }
        
        /* 確保在桌布模式下，AI泡泡中的程式碼區塊也是淺色底、深色字 */
        body.custom-wallpaper-active .model-message .message-bubble .prose pre {
            background-color: rgba(0, 0, 0, 0.05); /* 淺色背景 */
        }
        body.custom-wallpaper-active .model-message .message-bubble .prose code,
        body.custom-wallpaper-active .model-message .message-bubble .prose pre code {
             color: #111827 !important; /* 確保所有 code 元素都是黑色文字 */
        }
        /* ▲▲▲ 結束修正 ▲▲▲ */
        
        /* 確保文字顏色在桌布模式下為淺色模式的顏色 */
        body.custom-wallpaper-active {
            --text-primary: #111827;
            --text-secondary: #6b7280;
        }
        body.custom-wallpaper-active #message-input::placeholder {
            color: var(--text-secondary);
        }

        /* 禁用深淺色切換按鈕 */
        body.custom-wallpaper-active .theme-button-group {
            opacity: 0.5;
            pointer-events: none;
        }

        /* ▼▼▼ 修改的程式碼 ▼▼▼ */
        body.custom-wallpaper-active #message-list > div.text-center {
            background-color: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            max-width: max-content;
            margin: 4rem auto 0; /* 修正：確保與一般模式的 mt-16 (4rem) 高度一致 */
        }
        /* ▲▲▲ 修改的程式碼 ▲▲▲ */

        /* ▼▼▼ 新增：針對深色桌布動態調整文字顏色 (此處移除泡泡文字顏色變更，因需求3要求一律黑色) ▼▼▼ */
        body.custom-wallpaper-active.wallpaper-is-dark {
            --text-primary: #f9fafb; /* Light text for UI elements, not bubbles */
            --text-secondary: #9ca3af; /* Light gray text for UI elements */
        }
        /* ▲▲▲ 結束：自訂桌布相關樣式 ▲▲▲ */

        /* ▼▼▼ 新增：強制設定頁面與側邊攔字體為黑色 ▼▼▼ */
        /* 強制側邊攔字體顏色 */
        .sidebar, .sidebar button, .sidebar input, .sidebar h2, .sidebar span {
            color: #111827;
        }
        .sidebar .text-\[var\(--text-secondary\)\] {
            color: #6b7280 !important;
        }
        .dark .sidebar .sidebar-item.active, .sidebar .sidebar-item.active {
            color: #111827;
        }
        .dark .sidebar-item:hover, .sidebar-item:hover {
            color: #111827;
        }
        #logout-btn, .folder-options-btn, .chat-options-btn, .astras-options-btn, #new-folder-btn, #new-astras-btn {
            color: #6b7280;
        }
        #logout-btn:hover, .folder-options-btn:hover, .chat-options-btn:hover, .astras-options-btn:hover, #new-folder-btn:hover, #new-astras-btn:hover {
            color: #111827;
        }
        #temp-chat-indicator { /* 臨時對話標籤顏色保持不變 */
             color: #A16207;
        }
        .dark #temp-chat-indicator {
            color: #FBBF24;
        }
        .pinned-icon { /* 釘選圖示顏色保持不變 */
            color: #fbbf24;
        }

        /* 強制設定頁面內容字體顏色 */
        #settings-modal .settings-section {
            color: #111827;
        }
        #settings-modal .settings-section h3, 
        #settings-modal .settings-section label, 
        #settings-modal .settings-section p,
        #settings-modal .settings-section button,
        #settings-modal .settings-section input,
        #settings-modal .settings-section select,
        #settings-modal .settings-section textarea,
        #settings-modal .settings-section span {
            color: #111827;
        }
        #settings-modal .settings-section .text-\[var\(--text-secondary\)\] {
            color: #6b7280 !important;
        }
        .dark #settings-modal .settings-section input, 
        .dark #settings-modal .settings-section select, 
        .dark #settings-modal .settings-section textarea {
            background-color: #f0f0f0; /* 在深色模式下提供淺色背景以確保可讀性 */
            border-color: #d1d5db;
        }
        /* ▲▲▲ 結束：強制顏色設定 ▲▲▲ */

        /* ▼▼▼ 新增：根據使用者要求修改特定文字顏色 ▼▼▼ */

        /* --- 改為黑色 --- */

        /* 1. 右上角模型選單裡的模型名稱 */
        #model-options-popover .model-option-btn-container h4,
        #model-options-popover .model-option-btn-container .model-description {
            color: #111827 !important;
        }

        /* 2. 設定頁面的最上方{設定}字樣 */
        #settings-modal .p-6.border-b h2 {
            color: #111827;
        }

        /* 3. 設定頁面的側邊引導欄字樣 */
        #settings-modal .settings-nav-item {
            color: #111827;
        }

        /* 4. 設定頁面中關閉功能的字樣 (關閉按鈕) */
        #close-settings-btn {
            color: #111827;
        }

        /* 5. 關閉 Astras 功能的字樣 (X 按鈕) */
        #close-astras-btn {
            color: #111827;
        }

        /* --- 改為白色 --- */

        /* 1. 自訂義桌布的上傳圖片與還原預設的功能鍵字樣 */
        /* 為了讓白色文字可見，同時調整背景色 */
        #upload-wallpaper-btn {
            background-color: #3b82f6; /* 主藍色 */
            color: #ffffff !important;
        }
        #upload-wallpaper-btn:hover {
            background-color: #2563eb;
        }
        #restore-wallpaper-btn {
            background-color: #6b7280; /* 主灰色 */
            color: #ffffff !important;
        }
        #restore-wallpaper-btn:hover {
            background-color: #4b5563;
        }

        /* 2. 資料管理的匯出與匯入功能鍵字樣 */
        /* 為了讓白色文字可見，同時調整背景色 */
        #export-data-btn {
            background-color: #3b82f6; /* 主藍色 */
            color: #ffffff !important;
        }
        #export-data-btn:hover {
            background-color: #2563eb;
        }
        #import-data-btn {
            background-color: #16a34a; /* 主綠色 */
            color: #ffffff !important;
        }
        #import-data-btn:hover {
            background-color: #15803d;
        }
        /* ▲▲▲ 結束：使用者要求修改 ▲▲▲ */

        /* ▼▼▼ 新增：強制彈出視窗字體為黑色 ▼▼▼ */
        .modal > div, .popover {
            color: #111827;
        }

        .modal h2, .modal h3, .modal p, .modal label, .modal span,
        .modal input, .modal select, .modal textarea {
            color: #111827;
        }
        
        .modal button, .popover button {
            color: #111827;
        }
        
        .modal .text-\[var\(--text-secondary\)\] {
            color: #6b7280 !important;
        }
        
        .modal .btn-primary, .modal #confirm-import-btn {
            color: #ffffff !important;
        }
        
        .modal .text-red-500, .modal .text-red-600, .popover .text-red-600 {
            color: #ef4444 !important;
        }

        .dark .modal input, .dark .modal select, .dark .modal textarea {
            background-color: #f0f0f0;
            border-color: #d1d5db;
        }
        /* ▲▲▲ 結束：強制彈出視窗字體為黑色 ▲▲▲ */

        /* ▼▼▼ 需求 4 新增：歷史紀錄模型後綴樣式 ▼▼▼ */
        .model-suffix {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.6rem;
            font-weight: 600;
            line-height: 1.2;
            border-radius: 9999px;
            flex-shrink: 0;
            margin-left: 4px; /* 與標題的間距 */

            /* 透明果凍玻璃質感 */
            background-color: rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }
        .dark .model-suffix {
            background-color: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        /* ▲▲▲ 結束新增 ▲▲▲ */
        
        /* ▼▼▼ 新增：刪除對話確認框的警告動畫 ▼▼▼ */
        @keyframes pulse-red-border {
            0%, 100% {
                border-color: #ef4444; /* red-500 */
                box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4);
            }
            50% {
                border-color: #f87171; /* red-400 */
                box-shadow: 0 0 0 0px rgba(239, 68, 68, 0);
            }
        }
        .dialog-warning-border {
            animation: pulse-red-border 1.5s infinite;
        }
        /* ▲▲▲ 結束新增 ▲▲▲ */

        /* ▼▼▼ 新增：桌布裁切 Modal 相關樣式 ▼▼▼ */
        #wallpaper-crop-container {
            width: 100%;
            max-height: 60vh;
            margin-bottom: 1rem;
        }
        /* 確保 cropper.js 的圖片不會超出容器 */
        #wallpaper-crop-container img {
            max-width: 100%;
        }
        /* ▲▲▲ 結束新增 ▲▲▲ */

        /* ▼▼▼ 新增：根據要求將深色模式下所有文字改為白色 ▼▼▼ */
        .dark body,
        .dark .sidebar *,
        .dark #settings-modal *,
        .dark .modal > div *,
        .dark .popover *,
        .dark #model-options-popover .model-option-btn-container h4,
        .dark #model-options-popover .model-option-btn-container .model-description,
        .dark #header-title,
        .dark #current-astras-name,
        .dark .model-message .message-bubble,
        .dark .model-message .message-bubble .prose,
        .dark .model-message .message-bubble .prose *,
        .dark #close-astras-btn,
        .dark .follow-up-prompt-btn,
        .dark .color-dropdown-btn span,
        .dark #message-input::placeholder {
            color: #ffffff !important;
        }

        /* --- 例外與修正 --- */
        /* 修正：確保在深色模式下，具有淺色背景的輸入框文字為黑色以保持可讀性 */
        .dark #settings-modal .settings-section input, 
        .dark #settings-modal .settings-section select, 
        .dark #settings-modal .settings-section textarea,
        .dark .modal input, 
        .dark .modal select, 
        .dark .modal textarea {
            color: #111827 !important;
        }

        /* 修正：確保主要按鈕在深色模式下文字仍為設定的顏色(通常是白色) */
        .dark .btn-primary, .dark .modal .btn-primary, .dark #confirm-import-btn {
            color: var(--button-primary-text, #ffffff) !important;
        }

        /* 修正：保持特殊顏色元素的原始顏色 */
        .dark .text-red-500, .dark .text-red-600, .dark .popover .text-red-600,
        .dark .notification.error {
            color: #ef4444 !important;
        }
        .dark .notification.success {
            color: #22c55e !important;
        }
        .dark .notification.warning {
            color: #f97316 !important;
        }
        .dark .pinned-icon {
            color: #fbbf24 !important;
        }
        .dark #temp-chat-indicator {
            color: #FBBF24 !important;
        }
        .dark .model-suffix {
            color: #ffffff !important; /* 模型後綴也改為白色 */
            background-color: rgba(255, 255, 255, 0.15) !important; /* 微調背景以突顯 */
            border-color: rgba(255, 255, 255, 0.25) !important;
        }
        /* ▲▲▲ 結束：深色模式白色文字設定 ▲▲▲ */

        /* ▼▼▼ 新增：登入頁面展示區塊樣式 ▼▼▼ */
        .demo-model-selector .selector-btn {
            transition: all 0.3s ease;
        }
        .demo-model-selector .selector-btn.active {
            color: #2563eb;
            background-color: #eff6ff;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .demo-chat-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .demo-chat-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* ▲▲▲ 結束：登入頁面展示區塊樣式 ▲▲▲ */

        /* ▼▼▼ 新增：Astras 商店相關樣式 ▼▼▼ */
        .astras-store-card {
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: subtleFadeInUp 0.5s ease-out forwards;
        }
        .astras-store-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
        }
        .astras-card-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            background-color: var(--hover-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            flex-shrink: 0;
        }
        .astras-card-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .astras-card-name {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }
        .astras-card-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
            flex-grow: 1;
            margin-bottom: 1.5rem;
        }
        .subscribe-btn {
            width: 100%;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .subscribe-btn.subscribed {
            background-color: #10b981; /* green-500 */
            color: white;
        }
        .subscribe-btn.subscribed:hover {
            background-color: #059669; /* green-600 */
        }
        /* 側邊欄 Astras 頭像樣式 */
        .astras-sidebar-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 0.75rem;
            background-color: var(--hover-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        /* Cropper.js 圓形裁切框 */
        #avatar-crop-container .cropper-view-box,
        #avatar-crop-container .cropper-face {
            border-radius: 50%;
        }
        /* ▲▲▲ 結束：Astras 商店相關樣式 ▲▲▲ */
    </style>

<script>
window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
</head>

<body class="font-sans bg-gray-50">
    <!-- ▼▼▼ 新增：桌布容器 ▼▼▼ -->
    <div id="wallpaper-container"></div>
    <!-- ▲▲▲ 新增：桌布容器 ▲▲▲ -->

    <!-- ▼▼▼ 修改：全新的登入頁面 ▼▼▼ -->
    <div id="auth-container">
        <div class="min-h-screen flex flex-col">
            <!-- Header -->
            <header class="p-4 sm:px-6 lg:px-8 bg-white/80 backdrop-blur-sm sticky top-0 z-20 border-b border-gray-200">
                <div class="max-w-7xl mx-auto flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <svg class="h-8 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 15h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                        <span class="text-xl font-bold text-gray-800">ASTRA</span>
                    </div>
                    <!-- ▼▼▼ 新增：語言切換下拉選單 ▼▼▼ -->
                    <div class="flex items-center gap-4">
                        <div id="login-language-switcher" class="relative">
                            <button id="login-lang-btn" class="flex items-center gap-1 text-sm text-gray-600 hover:text-gray-900">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                <span id="login-lang-label">繁體中文</span>
                            </button>
                            <div id="login-lang-menu" class="popover absolute right-0 mt-2 w-36 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-30">
                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-lang="zh-TW">繁體中文</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-lang="en">English</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-lang="fr">Français</a>
                                </div>
                            </div>
                        </div>
                        <a href="#login-section" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors" data-lang-key="login">
                            登入
                        </a>
                    </div>
                    <!-- ▲▲▲ 結束新增 ▲▲▲ -->
                </div>
            </header>

            <main class="flex-grow">
                <!-- Hero Section with Login Form -->
                <section id="login-section" class="relative py-20 lg:py-32 bg-white">
                    <div class="absolute inset-0 overflow-hidden">
                         <div class="absolute top-0 left-0 w-96 h-96 bg-blue-100 rounded-full opacity-50 -translate-x-20 -translate-y-20"></div>
                         <div class="absolute bottom-0 right-0 w-96 h-96 bg-indigo-100 rounded-full opacity-50 translate-x-20 translate-y-20"></div>
                    </div>
                    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid lg:grid-cols-2 gap-16 items-center">
                        <div class="text-center lg:text-left">
                            <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-gray-900 tracking-tight">
                                <span data-lang-key="welcome">歡迎使用</span> <span class="text-blue-600">ASTRA</span>
                            </h1>
                            <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-2xl mx-auto lg:mx-0" data-lang-key="heroSubtitle">
                                從創意激盪到數據決策，一鍵直達。體驗前所未有的 AI 協作，釋放您的全部潛力。
                            </p>
                        </div>
                        
                        <!-- Login Form -->
                        <div class="w-full max-w-md mx-auto auth-form-container">
                             <div class="p-8 bg-white/70 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200">
                                <h2 class="text-2xl font-bold text-center text-gray-800 mb-2" data-lang-key="loginOrRegister">登入或註冊</h2>
                                <p class="text-center text-gray-500 mb-8 text-sm" data-lang-key="startJourney">開始您的智慧旅程</p>
                                <form id="auth-form">
                                    <div class="mb-4">
                                        <label for="username-input" class="block text-sm font-medium text-gray-700 mb-1" data-lang-key="username">使用者名稱</label>
                                        <input type="text" id="username-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" placeholder="請輸入您的名稱" required data-lang-key-placeholder="usernamePlaceholder">
                                    </div>
                                    <div class="mb-6">
                                        <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1" data-lang-key="password">密碼</label>
                                        <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" placeholder="用於登入驗證" required data-lang-key-placeholder="passwordPlaceholder">
                                    </div>
                                    <div class="space-y-3">
                                        <button type="submit" id="register-btn" class="w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors" data-lang-key="loginRegisterButton">
                                            登入 / 註冊
                                        </button>
                                        <button type="button" id="import-btn-auth" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled data-lang-key="importRecords">
                                            匯入紀錄
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- AI Model Showcase Section -->
                <section class="py-20 lg:py-24 bg-gray-50">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="text-center">
                            <h2 class="text-3xl lg:text-4xl font-bold text-gray-900" data-lang-key="exploreModels">探索我們的 AI 模型</h2>
                            <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto" data-lang-key="exploreModelsDesc">
                                我們提供一系列為不同任務量身打造的頂尖模型，無論是創意寫作、程式設計還是商業分析，總有一款適合您。
                            </p>
                        </div>

                        <div class="mt-16 max-w-5xl mx-auto">
                            <!-- Model Selector -->
                            <div class="demo-model-selector grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 lg:gap-4">
                                <!-- Selector Buttons will be inserted by JS -->
                            </div>

                            <!-- Chat Window -->
                            <div class="mt-8 bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
                                <div class="p-4 border-b border-gray-200">
                                    <h3 id="demo-chat-title" class="text-lg font-semibold text-gray-800 text-center" data-lang-key="demoChatTitle">Astra-ultra 對話範例</h3>
                                </div>
                                <div id="demo-chat-window" class="p-6 h-96 overflow-y-auto space-y-6 bg-gray-100">
                                    <!-- Chat Content will be inserted by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>

            <!-- Footer -->
            <!-- ▼▼▼ 修改：頁尾版權文字 ▼▼▼ -->
            <footer class="bg-white border-t border-gray-200">
                <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
                    <p data-lang-key="copyright">ASTRA版權所有</p>
                </div>
            </footer>
            <!-- ▲▲▲ 結束修改 ▲▲▲ -->
        </div>
    </div>
    <!-- ▲▲▲ 結束：全新的登入頁面 ▲▲▲ -->
    
    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen"> <!-- 新增 h-screen -->
        <div class="relative flex h-screen w-full bg-[var(--chat-bg)]">
            <!-- Sidebar Overlay (for mobile) -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0"></div>


            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar w-64 lg:w-72 flex-shrink-0 flex flex-col fixed h-full z-40 transform -translate-x-full">
                <!-- Sidebar Top Section -->
                <div class="p-2">
                    <div class="flex gap-2 mb-2">
                        <button id="new-chat-btn" class="sidebar-item w-full text-left p-3 rounded-lg flex items-center gap-3 font-semibold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span data-lang-key="newChat">新對話</span>
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button id="selection-mode-btn" class="w-1/2 p-1.5 text-xs border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] hover:bg-[var(--hover-bg)]" data-lang-key="batchSelect">
                            批次選取
                        </button>
                        <button id="open-search-btn" class="w-1/2 p-1.5 text-xs border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] hover:bg-[var(--hover-bg)]" data-lang-key="search">
                            搜尋
                        </button>
                    </div>
                </div>
                <!-- Sidebar Scrollable Area -->
                <div class="flex-1 overflow-y-auto px-2 scroll-area">
                    <div class="border-b border-[var(--border-color)] mb-2 pb-2">
                        <div class="flex justify-between items-center px-3 py-1">
                            <h2 class="text-sm font-semibold text-[var(--text-secondary)]" data-lang-key="astras">Astras</h2>
                            <!-- ▼▼▼ 修改：新增商店按鈕 ▼▼▼ -->
                            <div class="flex items-center gap-1">
                                <button id="open-store-btn" title="Astras 商店" class="p-1 rounded-md hover:bg-[var(--active-bg)] text-[var(--text-secondary)]" data-lang-key-title="astrasStore">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                                </button>
                                <button id="new-astras-btn" title="新增 Astras" class="p-1 rounded-md hover:bg-[var(--active-bg)] text-[var(--text-secondary)]" data-lang-key-title="addAstras">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path><line x1="12" y1="10" x2="12" y2="16"></line><line x1="9" y1="13" x2="15" y2="13"></line></svg>
                                </button>
                            </div>
                            <!-- ▲▲▲ 結束修改 ▲▲▲ -->
                        </div>
                        <div id="astras-list" class="flex-1 pr-1 mt-1 space-y-1"></div>
                    </div>
                    <div class="border-b border-[var(--border-color)] mb-2 pb-2">
                        <div class="flex justify-between items-center px-3 py-1">
                            <h2 class="text-sm font-semibold text-[var(--text-secondary)]" data-lang-key="folders">資料夾</h2>
                            <button id="new-folder-btn" title="新增資料夾" class="p-1 rounded-md hover:bg-[var(--active-bg)] text-[var(--text-secondary)]" data-lang-key-title="addFolder">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path><line x1="12" y1="10" x2="12" y2="16"></line><line x1="9" y1="13" x2="15" y2="13"></line></svg>
                            </button>
                        </div>
                        <div id="folder-list" class="flex-1 pr-1 mt-1"></div>
                    </div>
                    <div id="history-list" class="pr-1"></div>
                </div>
                <!-- Sidebar Bottom Section -->
                <div class="p-2 border-t border-[var(--border-color)]">
                    <div id="batch-action-bar" class="hidden">
                        <div class="flex justify-between items-center text-xs mb-1 px-1">
                            <span id="selection-count" class="font-medium text-[var(--text-secondary)]"></span>
                            <button id="cancel-selection-btn" class="text-blue-600 hover:underline font-semibold" data-lang-key="done">完成</button>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button id="batch-delete-btn" class="p-1.5 text-xs rounded-md bg-red-500 text-white disabled:bg-red-300" disabled data-lang-key="delete">刪除</button>
                            <button id="batch-archive-btn" class="p-1.5 text-xs rounded-md bg-yellow-500 text-white disabled:bg-yellow-300" disabled data-lang-key="archive">封存</button>
                            <button id="batch-move-btn" class="p-1.5 text-xs rounded-md bg-blue-500 text-white disabled:bg-blue-300" disabled data-lang-key="move">移動</button>
                        </div>
                    </div>
                    <div id="user-controls">
                        <!-- ▼▼▼ 需求 1 修改：將 user-profile 改為開啟數據面板的按鈕 ▼▼▼ -->
                        <button id="user-profile-btn" class="sidebar-item w-full text-left p-3 rounded-lg flex items-center gap-3">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                             <span id="username-display" class="font-semibold truncate">User</span>
                        </button>
                        <!-- ▲▲▲ 結束修改 ▲▲▲ -->
                        <button id="settings-btn" class="sidebar-item w-full text-left p-3 rounded-lg flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                            <span data-lang-key="settings">設定</span>
                        </button>
                    </div>
                </div>
            </aside>
            <!-- Main Chat Area -->
            <main class="flex-1 flex flex-col relative h-full">
                <!-- ▼▼▼ 程式碼修正 ▼▼▼ -->
                <header class="relative z-10 p-2 md:p-4 flex justify-between items-center border-b border-[var(--border-color)]">
                <!-- ▲▲▲ 程式碼修正 ▲▲▲ -->
                    <div class="flex items-center gap-2">
                        <!-- Menu Button -->
                        <button id="menu-toggle-btn" class="p-2 rounded-md hover:bg-[var(--hover-bg)]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </button>
                        <h1 id="header-title" class="text-xl font-semibold truncate" data-lang-key="newChat">新對話</h1>
                        <!-- ▼▼▼ 新增：API 金鑰未設定警示 ▼▼▼ -->
                        <div id="api-key-warning-badge" class="hidden cursor-pointer" title="目前選用的模型需要 API 金鑰，請點此設定" data-lang-key-title="apiKeyWarning">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <!-- ▲▲▲ 結束：API 金鑰未設定警示 ▲▲▲ -->
                        <span id="temp-chat-indicator" class="hidden text-xs font-bold bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full" data-lang-key="tempChat">臨時對話</span>
                    </div>
                    <div class="flex items-center gap-1 md:gap-2">
                        <button id="header-temp-chat-toggle-btn" title="臨時對話 (不儲存紀錄)" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-[var(--text-secondary)]" data-lang-key-title="tempChatDesc">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a8 8 0 0 0-8 8c0 2.4.8 4.6 2.2 6.3l-1.4 2.8c-.1.2 0 .5.2.6s.4.1.6 0l2.8-1.4A8 8 0 1 0 12 2z"/><path d="M12 6v6"/><path d="M12 16h.01"/></svg>
                        </button>
                        <div id="model-switcher-container" class="relative"></div>
                    </div>
                </header>
                <div class="p-2 md:p-4 bg-[var(--input-bar-bg)] border-b border-[var(--border-color)] hidden" id="astras-indicator">
                    <div class="max-w-4xl mx-auto text-sm text-[var(--text-secondary)] flex items-center justify-between gap-2">
                        <div class="flex items-center gap-2">
                            <span data-lang-key="currentAstras">目前使用 Astras:</span>
                            <span id="current-astras-name" class="font-medium text-[var(--text-primary)]"></span>
                        </div>
                        <!-- 需求四: 新增關閉 Astras 的按鈕 -->
                        <button id="close-astras-btn" class="p-1 rounded-md hover:bg-[var(--hover-bg)] text-[var(--text-secondary)]" title="關閉 Astras" data-lang-key-title="closeAstras">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
                <div id="chat-container" class="flex-1 p-4 md:p-6 overflow-y-auto scroll-area">
                    <div id="message-list" class="space-y-8 max-w-4xl mx-auto"></div>
                </div>
                <!-- 新增：後續追問功能區塊 -->
                <div id="follow-up-container" class="p-2 md:p-4 bg-[var(--input-bar-bg)] border-t border-[var(--border-color)] hidden">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-semibold text-[var(--text-secondary)]" data-lang-key="followUp">後續追問</h4>
                            <button id="follow-up-toggle-btn" class="p-1 rounded-md hover:bg-[var(--hover-bg)] text-[var(--text-secondary)] transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                            </button>
                        </div>
                        <div id="follow-up-prompts-list" class="flex flex-wrap gap-2 transition-all duration-300 overflow-hidden">
                            <!-- 提示會被動態插入此處 -->
                        </div>
                    </div>
                </div>
                <div class="p-2 md:p-4 bg-[var(--input-bar-bg)] border-t border-[var(--border-color)]">
                    <div class="max-w-4xl mx-auto">
                        <!-- File Preview Container -->
                        <div id="file-preview-container" class="w-full flex flex-wrap gap-2 mb-2 px-2 empty:hidden"></div>
                        <div class="input-wrapper w-full flex items-end gap-2 p-2 rounded-2xl bg-[var(--input-field-bg)] border border-[var(--border-color)] shadow-sm">
                            <!-- File Input Button and Popover -->
                            <div id="file-input-container" class="relative">
                                <button id="add-file-btn" title="附加檔案" class="flex-shrink:0 h-10 w-10 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 transition-colors" data-lang-key-title="attachFile">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </button>
                                <!-- ▼▼▼ 程式碼修正 ▼▼▼ -->
                                <div id="file-options-popover" class="popover absolute bottom-full left-0 mb-2 w-56 rounded-lg border border-[var(--border-color)] z-20">
                                    <button id="camera-btn" class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--hover-bg)] flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                                        <span data-lang-key="camera">相機</span>
                                    </button>
                                    <button id="upload-image-btn" class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--hover-bg)] flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                        <span data-lang-key="imageVideo">圖片 / 影片</span>
                                    </button>
                                    <button id="upload-file-btn" class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--hover-bg)] flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                                        <span data-lang-key="file">檔案</span>
                                    </button>
                                </div>
                                <!-- ▲▲▲ 結束修正 ▲▲▲ -->
                            </div>
                            <form id="chat-form" class="flex-1 flex items-center">
                                <input type="text" id="message-input" placeholder="請先在設定中輸入 API 金鑰..." class="flex-1 p-2 bg-transparent border-0 focus:ring-0 disabled:bg-transparent" autocomplete="off" disabled data-lang-key-placeholder="enterApiKeyPlaceholder">
                            </form>
                            <button id="voice-input-btn-message" title="語音輸入" class="voice-input-btn" data-lang-key-title="voiceInput">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line></svg>
                            </button>
                            <button id="web-search-btn" title="聯網搜尋" class="flex-shrink:0 h-10 w-10 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 transition-colors" data-lang-key-title="webSearch">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                            </button>
                            <button id="submit-btn" class="flex-shrink:0 h-10 w-10 rounded-full flex items-center justify-center disabled:bg-gray-300 dark:disabled:bg-gray-500 disabled:cursor-not-allowed transition-colors btn-primary">
                                <span id="submit-btn-icon">
                                    <!-- Icon will be dynamically updated here -->
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- ▼▼▼ 需求 2 修正：替換 SVG 路徑以確保置中 ▼▼▼ -->
                <button id="scroll-to-bottom-btn" class="absolute bottom-24 right-4 md:right-8 z-10 h-10 w-10 rounded-full bg-[var(--modal-bg)] shadow-lg hidden items-center justify-center border border-[var(--border-color)] hover:bg-[var(--hover-bg)] transition-opacity">
                    <svg class="h-6 w-6 text-[var(--text-secondary)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m-7-7 7 7 7-7" />
                    </svg>
                </button>
                <!-- ▲▲▲ 結束修正 ▲▲▲ -->
            </main>
        </div>
    </div>
    <!-- ▼▼▼ 新增：商店頁面 ▼▼▼ -->
    <div id="store-container" class="hidden h-screen w-full flex flex-col bg-[var(--chat-bg)]">
        <!-- Store Header -->
        <header class="relative z-10 p-2 md:p-4 flex items-center border-b border-[var(--border-color)]">
            <button id="back-to-chat-btn" class="p-2 rounded-md hover:bg-[var(--hover-bg)] mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 class="text-xl font-semibold" data-lang-key="astrasStore">Astras 商店</h1>
        </header>
        <!-- Store Main Content -->
        <main class="flex-1 overflow-y-auto scroll-area p-4 md:p-6 lg:p-8">
            <div id="store-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <!-- Astra cards will be inserted here by JS -->
            </div>
        </main>
    </div>
    <!-- ▲▲▲ 結束新增 ▲▲▲ -->
    <!-- Modals -->
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-2xl font-bold" data-lang-key="settings">設定</h2>
                <!-- ▼▼▼ 新增：登出按鈕 ▼▼▼ -->
                <button id="logout-btn" title="登出" class="p-2 rounded-md hover:bg-[var(--active-bg)] text-[var(--text-secondary)]" data-lang-key-title="logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
                <!-- ▲▲▲ 結束新增 ▲▲▲ -->
            </div>
            <div class="flex flex-1 overflow-hidden">
                <!-- Settings Navigation -->
                <nav class="w-1/4 border-r border-[var(--border-color)] overflow-y-auto scroll-area">
                    <ul id="settings-nav" class="space-y-2 p-4">
                        <li class="settings-nav-item p-3 rounded-md active" data-section="personalization" data-lang-key="personalization">個人化</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="memory" data-lang-key="memoryManagement">記憶管理</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="model-management" data-lang-key="modelManagement">模型管理</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="data-management" data-lang-key="dataManagement">資料管理</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="accessibility" data-lang-key="accessibility">輔助功能</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="about" data-lang-key="about">關於</li>
                    </ul>
                </nav>
                <!-- Settings Content -->
                <div class="flex-1 p-6 overflow-y-auto scroll-area space-y-6">
                    <!-- 個人化 -->
                    <div id="personalization-section" class="settings-section active">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="appearance">外觀</h3>
                        <div class="theme-button-group">
                            <button id="theme-light-btn" class="theme-btn text-center" data-lang-key="lightMode">淺色</button>
                            <button id="theme-dark-btn" class="theme-btn text-center" data-lang-key="darkMode">深色</button>
                        </div>
                        <!-- ▼▼▼ 新增：語言設定區塊 ▼▼▼ -->
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="languageSettings">語言設定</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="ui-language-select" class="block text-sm font-medium mb-1" data-lang-key="uiLanguage">介面語言</label>
                                <select id="ui-language-select" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]">
                                    <option value="zh-TW">繁體中文</option>
                                    <option value="en">English</option>
                                    <option value="fr">Français</option>
                                </select>
                            </div>
                            <div>
                                <label for="ai-language-select" class="block text-sm font-medium mb-1" data-lang-key="aiReplyLanguage">AI 預設回覆語言</label>
                                <p class="text-xs text-[var(--text-secondary)] mb-2" data-lang-key="aiReplyLanguageDesc">
                                    AI 將以此語言回覆，除非您在對話中另有指定。
                                </p>
                                <select id="ai-language-select" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]">
                                    <option value="zh-TW">繁體中文</option>
                                    <option value="en">English</option>
                                    <option value="fr">Français</option>
                                </select>
                            </div>
                        </div>
                        <!-- ▲▲▲ 結束新增 ▲▲▲ -->
                        <!-- ▼▼▼ 修改：主按鈕顏色設定區塊 (新增漸變選項) ▼▼▼ -->
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="primaryButtonColor">主按鈕顏色</h3>
                        <div id="ui-color-options" class="space-y-3 text-sm">
                            <div class="flex items-center">
                                <input type="radio" id="color-theme-default" name="color-theme" value="default" class="w-4 h-4 mr-2">
                                <label for="color-theme-default" data-lang-key="colorDefault">預設 (藍色)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="color-theme-adaptive" name="color-theme" value="adaptive" class="w-4 h-4 mr-2">
                                <label for="color-theme-adaptive" data-lang-key="colorAdaptive">自適應 (從桌布提取)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="color-theme-custom" name="color-theme" value="custom" class="w-4 h-4 mr-2">
                                <label for="color-theme-custom" data-lang-key="colorCustom">自訂</label>
                            </div>
                            
                            <div id="button-style-container" class="hidden pl-6 pt-2">
                                <label class="block text-sm font-medium" data-lang-key="buttonStyle">按鈕樣式</label>
                                <div class="flex items-center gap-4 mt-1">
                                    <div>
                                        <input type="radio" id="color-style-single" name="color-style" value="single" class="w-4 h-4 mr-2">
                                        <label for="color-style-single" data-lang-key="styleSingle">單色</label>
                                    </div>
                                    <div>
                                        <input type="radio" id="color-style-gradient" name="color-style" value="gradient" class="w-4 h-4 mr-2">
                                        <label for="color-style-gradient" data-lang-key="styleGradient">漸變</label>
                                    </div>
                                </div>
                            </div>
                    
                            <div id="custom-color-picker-container" class="hidden pl-6 pt-2">
                                <div id="custom-color-swatches" class="grid grid-cols-8 gap-2">
                                    <!-- Color swatches will be inserted by JS -->
                                </div>
                            </div>
                            
                            <div id="gradient-picker-container" class="hidden pl-6 pt-2">
                                <p class="text-sm text-[var(--text-secondary)] mb-2" data-lang-key="gradientDesc">
                                    從桌布提取的顏色組合。
                                </p>
                                <div id="gradient-swatches" class="grid grid-cols-4 gap-2">
                                    <!-- Gradient swatches will be inserted by JS -->
                                </div>
                            </div>
                        </div>
                        <!-- ▲▲▲ 結束：主按鈕顏色設定區塊 ▲▲▲ -->
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="aiBubbleColor">AI 回覆泡泡底色</h3>
                        <div id="ai-bubble-color-dropdown" class="color-dropdown-container"></div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="userBubbleColor">使用者訊息泡泡底色</h3>
                        <div id="user-bubble-color-dropdown" class="color-dropdown-container"></div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="customWallpaper">自訂義桌布</h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-2" data-lang-key="customWallpaperDesc">
                            上傳圖片後將覆蓋整個介面，並禁用深淺色模式。
                        </p>
                        <div class="flex gap-2">
                            <button id="upload-wallpaper-btn" class="flex-1 text-center p-2 rounded-md bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800 font-medium" data-lang-key="uploadImage">上傳圖片</button>
                            <button id="restore-wallpaper-btn" class="flex-1 text-center p-2 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 font-medium" data-lang-key="restoreDefault">還原預設</button>
                        </div>
                    </div>
                    <!-- 記憶管理 -->
                    <div id="memory-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="memorySwitch">記憶功能開關</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label class="flex-1 text-sm font-medium" data-lang-key="personalMemory">個人習慣記憶 (類型1)</label>
                                <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" id="memory-toggle-1" class="toggle-checkbox absolute block w-full, h-full rounded-full opacity-0 appearance-none cursor-pointer"/>
                                    <label for="memory-toggle-1" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="auto-memory-toggle-switch" class="flex-1 text-sm font-medium" data-lang-key="enableAutoMemory">啟用自動添加記憶</label>
                                <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="auto-memory-toggle-switch" id="auto-memory-toggle-switch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="auto-memory-toggle-switch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="personalMemoryManage">個人習慣記憶管理</h3>
                        <div id="personal-memory-list" class="space-y-2"></div>
                        <button id="add-personal-memory-btn" class="mt-4 px-4 py-2 rounded-md btn-primary" data-lang-key="addMemory">新增記憶</button>
                    </div>
                    <!-- 模型管理 -->
                    <div id="model-management-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="apiKeyManagement">API 金鑰管理</h3>
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-red-500 mb-2" data-lang-key="geminiFollowUpNotice">如需啟用後續追問功能必需填入 gemini api 才可啟用。</p>
                                <label for="gemini-api-key-input" class="block text-sm font-medium mb-1" data-lang-key="geminiApiKey">Gemini API 金鑰</label>
                                <input type="password" id="gemini-api-key-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="輸入您的 Google API 金鑰" data-lang-key-placeholder="geminiApiPlaceholder">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1" data-lang-key="openRouterApiKey">OpenRouter API 模型金鑰</label>
                                <p class="text-xs text-[var(--text-secondary)] mb-2" data-lang-key="openRouterApiDesc">新增模型金鑰後，該模型才能被選用。</p>
                                <div class="flex items-center gap-2">
                                    <select id="openrouter-model-select" class="flex-1 p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]">
                                        <option value="" data-lang-key="selectModel">選擇一個模型</option>
                                    </select>
                                    <input type="password" id="openrouter-api-key-input" class="flex-1 p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="輸入 API 金鑰" data-lang-key-placeholder="enterApiKey">
                                    <button id="save-openrouter-key-btn" class="flex-shrink:0 px-4 py-2 rounded-md disabled:bg-gray-400 btn-primary" disabled data-lang-key="save">儲存</button>
                                </div>
                                <div id="openrouter-models-list" class="mt-4 space-y-2">
                                </div>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="modelListManagement">模型清單管理</h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-3" data-lang-key="modelListManagementDesc">點擊箭頭以排序、點擊眼睛以隱藏/顯示、點擊圓圈以設定預設模型。</p>
                        <div id="model-management-list" class="space-y-2">
                        </div>
                    </div>
                    <!-- 資料管理 -->
                    <div id="data-management-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="dataSync">資料同步</h3>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="export-data-btn" class="flex-1 text-center p-2 rounded-md bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800 font-medium" data-lang-key="exportData">匯出資料</button>
                            <button id="import-data-btn" class="flex-1 text-center p-2 rounded-md bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800 font-medium" data-lang-key="importData">匯入資料</button>
                        </div>
                        <button id="open-archived-modal-btn" class="w-full text-left p-2 rounded-md hover:bg-[var(--hover-bg)] font-medium mt-4" data-lang-key="manageArchived">
                            管理已封存的對話
                        </button>
                        <!-- ▼▼▼ 需求 1 新增：清除資料功能 ▼▼▼ -->
                        <div class="mt-6 pt-4 border-t border-red-500/30">
                            <h3 class="text-lg font-semibold mb-3 text-red-600" data-lang-key="dangerZone">危險區域</h3>
                            <p class="text-sm text-[var(--text-secondary)] mb-3" data-lang-key="dangerZoneDesc">
                                以下操作將會永久刪除您在此瀏覽器上的所有資料，且無法復原。請謹慎操作。
                            </p>
                            <button id="delete-all-data-btn" class="w-full text-center p-2 rounded-md bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 hover:bg-red-200 dark:hover:bg-red-800 font-medium" data-lang-key="deleteAllData">
                                清除所有紀錄與資料
                            </button>
                        </div>
                        <!-- ▲▲▲ 結束新增 ▲▲▲ -->
                    </div>
                    <!-- 輔助功能 -->
                    <div id="accessibility-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="accessibility">輔助功能</h3>
                        <div class="flex items-center justify-between">
                            <label for="follow-up-toggle-switch" class="flex-1 text-sm font-medium" data-lang-key="enableFollowUp">啟用後續追問提示</label>
                            <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="follow-up-toggle-switch" id="follow-up-toggle-switch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="follow-up-toggle-switch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <label for="auto-naming-toggle-switch" class="flex-1 text-sm font-medium" data-lang-key="enableAutoNaming">啟用對話自動命名</label>
                            <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="auto-naming-toggle-switch" id="auto-naming-toggle-switch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="auto-naming-toggle-switch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <label for="auto-web-search-toggle-switch" class="flex-1 text-sm font-medium" data-lang-key="enableSmartWebSearch">啟用智慧連網搜尋</label>
                            <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="auto-web-search-toggle-switch" id="auto-web-search-toggle-switch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="auto-web-search-toggle-switch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                    <!-- 關於 -->
                    <div id="about-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="helpCenter"></h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="helpCenterDesc"></p>
                        
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="termsOfUse"></h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="termsOfUseDesc"></p>
                        
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="privacyPolicy"></h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="privacyPolicyDesc"></p>
                        
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="version"></h3>
                        <p class="text-sm text-[var(--text-secondary)]" data-lang-key="versionNumber"></p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-[var(--sidebar-bg)] border-t border-[var(--border-color)] flex justify-end gap-3">
                <button id="close-settings-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="close">關閉</button>
                <button id="save-settings-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="save">儲存</button>
            </div>
        </div>
    </div>


    <div id="export-data-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="exportData">匯出資料</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="selectDataToExport">選擇您想要匯出的資料。</p>
            <div class="space-y-3 mb-4">
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-history-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                    <span data-lang-key="exportHistory">歷史對話紀錄 (含封存與資料夾)</span>
                </label>
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-astras-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                    <span data-lang-key="astras">Astras</span>
                </label>
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-settings-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                    <span data-lang-key="appSettings">應用程式設定</span>
                </label>
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-api-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span data-lang-key="exportApiKeys">API 金鑰 (Gemini 和 OpenRouter)</span>
                </label>
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-memory-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span data-lang-key="exportPersonalMemory">個人習慣記憶 (類型1)</span>
                </label>
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancel-export-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">取消</button>
                <button id="confirm-export-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="confirmAndExport">確認並匯出</button>
            </div>
        </div>
    </div>
    <div id="import-data-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="importData">匯入資料</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="importDataDesc">選擇一個之前匯出的 `.json` 檔案。目前的所有資料將會被覆蓋。</p>
            <div class="mb-4">
                <label for="import-file-input" class="block text-sm font-medium mb-1" data-lang-key="selectFile">選擇檔案</label>
                <input type="file" id="import-file-input" class="w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".json" required>
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancel-import-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">取消</button>
                <button id="confirm-import-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" data-lang-key="confirmAndImport">確認並匯入</button>
            </div>
        </div>
    </div>
    <div id="archived-chats-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-2xl font-bold" data-lang-key="archivedChats">已封存的對話</h2>
                <button id="close-archived-modal-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div id="archived-chats-container" class="p-6 overflow-y-auto space-y-2 scroll-area"></div>
        </div>
    </div>
    <!-- ▼▼▼ 新增：封存對話檢視 Modal ▼▼▼ -->
    <div id="view-archived-chat-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[51]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-3xl flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center flex-shrink-0">
                <h2 id="view-archived-title" class="text-2xl font-bold truncate" data-lang-key="viewArchivedChat">檢視封存的對話</h2>
                <button id="close-view-archived-modal-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div id="view-archived-content" class="p-6 overflow-y-auto space-y-4 scroll-area flex-1">
                <!-- Archived messages will be dynamically inserted here -->
            </div>
            <div class="p-4 bg-[var(--sidebar-bg)] border-t border-[var(--border-color)] flex justify-end gap-3 flex-shrink-0">
                <button id="close-view-archived-modal-btn-footer" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="close">關閉</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 結束新增 ▲▲▲ -->
    <div id="rename-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="rename">重新命名</h2>
            <input type="text" id="rename-input" class="w-full p-2 border border-[var(--border-color)] rounded-md mb-4 bg-[var(--input-field-bg)]" placeholder="輸入新名稱" data-lang-key-placeholder="enterNewName">
            <div class="flex justify-end gap-3">
                <button id="cancel-rename-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">取消</button>
                <button id="save-rename-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="save">儲存</button>
            </div>
        </div>
    </div>


    <div id="folder-settings-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="customizeFolder">自訂資料夾</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="text-sm font-medium mb-2" data-lang-key="selectColor">選擇顏色</h3>
                    <div id="color-swatches-container" class="grid grid-cols-8 gap-2"></div>
                </div>
                <div>
                    <h3 class="text-sm font-medium mb-2" data-lang-key="selectIcon">選擇圖示</h3>
                    <div id="icon-options-container" class="grid grid-cols-8 gap-2"></div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-folder-settings-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">取消</button>
                <button id="save-folder-settings-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="save">儲存</button>
            </div>
        </div>
    </div>
    <div id="search-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-xl font-bold" data-lang-key="searchConversations">搜尋對話</h2>
                <button id="close-search-modal-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 flex items-center gap-2 border-b border-[var(--border-color)]">
                <input type="search" id="modal-search-input" placeholder="搜尋..." class="flex-1 p-2 text-sm border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] focus:ring-2 focus:ring-blue-500 focus:outline-none" data-lang-key-placeholder="searchPlaceholder">
                <select id="modal-search-scope-select" class="text-sm border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] focus:ring-2 focus:ring-blue-500 focus:outline-none p-2">
                    <option value="keyword-title" data-lang-key="searchScopeTitle">關鍵字 (標題)</option>
                    <option value="keyword-content" data-lang-key="searchScopeContent">關鍵字 (內文)</option>
                    <option value="natural" data-lang-key="searchScopeNatural">自然語言</option>
                </select>
                <button id="perform-search-btn" class="p-2 rounded-md text-white btn-primary" data-lang-key="search">搜尋</button>
                <button id="voice-input-btn-search" title="語音輸入" class="voice-input-btn" data-lang-key-title="voiceInput">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line></svg>
                </button>
            </div>
            <div id="search-results-container" class="p-4 overflow-y-auto space-y-2 scroll-area flex-1">
                <p class="text-center text-[var(--text-secondary)]" data-lang-key="searchPrompt">請輸入關鍵字進行搜尋。</p>
            </div>
        </div>
    </div>
    <div id="notification-container"></div>
    <div id="custom-dialog-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="custom-dialog-title" class="text-xl font-bold mb-4"></h2>
            <p id="custom-dialog-message" class="text-[var(--text-secondary)] mb-6"></p>
            <div id="custom-dialog-input-container" class="mb-4 hidden">
                <input id="custom-dialog-input" type="text" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]">
            </div>
            <div id="custom-dialog-buttons" class="flex justify-end gap-3"></div>
        </div>
    </div>
    <div id="astras-create-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="createAstras">創建 Astras</h2>
            <div class="space-y-4">
                <div>
                    <label for="astras-name-input" class="block text-sm font-medium mb-1" data-lang-key="name">名稱</label>
                    <input type="text" id="astras-name-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="輸入 Astras 名稱" data-lang-key-placeholder="astrasNamePlaceholder">
                </div>
                <div>
                    <label for="astras-desc-input" class="block text-sm font-medium mb-1" data-lang-key="description">說明</label>
                    <input type="text" id="astras-desc-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="輸入 Astras 說明" data-lang-key-placeholder="astrasDescPlaceholder">
                </div>
                <div>
                    <label for="astras-instructions-input" class="block text-sm font-medium mb-1" data-lang-key="instructions">指令</label>
                    <textarea id="astras-instructions-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] h-32" placeholder="輸入 Astras 指令" data-lang-key-placeholder="astrasInstructionsPlaceholder"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-astras-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">取消</button>
                <button id="save-astras-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="save">儲存</button>
            </div>
        </div>
    </div>
    <!-- 新增: 批次移動 modal -->
    <div id="batch-move-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="batchMove">批次移動</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="batchMoveDesc">選擇要移動到的資料夾，或移出資料夾。</p>
            <div class="space-y-2 mb-4" id="batch-move-folder-list">
                <!-- 資料夾選項將動態插入 -->
            </div>
            <div class="flex justify-end gap-3">
                <button id="batch-move-cancel-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">取消</button>
                <button id="batch-move-confirm-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="confirm">確認</button>
            </div>
        </div>
    </div>
    <!-- ▼▼▼ 需求 1 新增：數據儀表板 Modal ▼▼▼ -->
    <div id="data-dashboard-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-4xl flex flex-col" style="height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-2xl font-bold" data-lang-key="dashboard">個人數據面板</h2>
                <button id="close-dashboard-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div class="flex-1 p-6 overflow-y-auto scroll-area space-y-6">
                <!-- 總覽數據 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]" data-lang-key="totalConversations">總對話數</h3>
                        <p id="total-conv-stat" class="text-3xl font-bold"></p>
                    </div>
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]" data-lang-key="totalFolders">資料夾數量</h3>
                        <p id="total-folder-stat" class="text-3xl font-bold"></p>
                    </div>
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]" data-lang-key="mostUsedModel">最常使用的模型</h3>
                        <p id="most-used-model-stat" class="text-2xl font-bold truncate"></p>
                    </div>
                </div>

                <!-- 模型使用比例 -->
                <div>
                    <h3 class="text-lg font-semibold mb-3" data-lang-key="modelUsageRatio">模型使用比例</h3>
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg" style="height: 300px;">
                        <canvas id="model-usage-pie-chart"></canvas>
                    </div>
                </div>

                <!-- 訊息數量時間分佈 -->
                <div>
                    <h3 class="text-lg font-semibold mb-3" data-lang-key="messageTimeDistribution">訊息數量時間分佈</h3>
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg">
                        <!-- ▼▼▼ 需求 1 修改：新增日期選擇器 ▼▼▼ -->
                        <div class="flex flex-wrap gap-2 mb-4 items-center">
                            <label for="time-analysis-year-select" class="text-sm" data-lang-key="year">年份:</label>
                            <select id="time-analysis-year-select" class="p-1 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] text-sm"></select>
                            <label for="time-analysis-month-select" class="text-sm" data-lang-key="month">月份:</label>
                            <select id="time-analysis-month-select" class="p-1 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] text-sm" disabled></select>
                            <label for="time-analysis-day-select" class="text-sm" data-lang-key="day">日期:</label>
                            <select id="time-analysis-day-select" class="p-1 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] text-sm" disabled></select>
                        </div>
                        <!-- ▲▲▲ 結束修改 ▲▲▲ -->
                        <div id="time-chart-container" style="height: 300px;">
                             <canvas id="time-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 結束新增 ▲▲▲ -->
    <!-- ▼▼▼ 新增：桌布裁切 Modal ▼▼▼ -->
    <div id="wallpaper-crop-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[51]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-4xl p-6">
            <h2 class="text-2xl font-bold mb-4" data-lang-key="cropWallpaper">裁切桌布</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="cropWallpaperDesc">
                拖動選框以調整您想要的桌布區域，建議使用符合螢幕比例的裁切。
            </p>
            <div id="wallpaper-crop-container">
                <img id="wallpaper-crop-image" src="" alt="Wallpaper for cropping">
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancel-crop-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">取消</button>
                <button id="confirm-crop-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="confirmAndApply">確認並套用</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 結束新增 ▲▲▲ -->
    <!-- ▼▼▼ 新增：Astras 頭像裁切 Modal ▼▼▼ -->
    <div id="astras-avatar-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[51]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-4" data-lang-key="setAstrasAvatar">設定 Astras 頭像</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="cropAvatarDesc">
                移動和縮放圖片以裁切您喜歡的圓形頭像。
            </p>
            <div id="avatar-crop-container" class="w-full max-h-[50vh] mb-4 bg-gray-200 dark:bg-gray-700 rounded-md">
                <img id="avatar-crop-image" src="" alt="Avatar for cropping">
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancel-avatar-crop-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">取消</button>
                <button id="confirm-avatar-crop-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="confirmAndApply">確認並套用</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 結束新增 ▲▲▲ -->
    <!-- Hidden File Inputs -->
    <input type="file" id="image-video-input" class="hidden" accept="image/*,video/*" multiple>
    <input type="file" id="file-upload-input" class="hidden" multiple>
    <!-- ▼▼▼ 新增：隱藏的桌布與頭像上傳輸入框 ▼▼▼ -->
    <input type="file" id="wallpaper-upload-input" class="hidden" accept="image/*">
    <input type="file" id="astras-avatar-input" class="hidden" accept="image/*">
    <!-- ▲▲▲ 結束新增 ▲▲▲ -->
    <script src="./i18n.js"></script>
    <script src="./demo-conversations.js"></script>
    <script src="./main.js"></script>
    <script>
        // ▼▼▼ 新增：登入頁面 Demo 區塊的互動邏輯 ▼▼▼
        document.addEventListener('DOMContentLoaded', () => {
            const demoModels = [
                { id: 'ultra', name: 'Astra-ultra', title: 'Astra-ultra 對話範例', desc: '最新旗艦' },
                { id: 'pro', name: 'Astra-Pro', title: 'Astra-Pro 對話範例', desc: '高速精準' },
                { id: 'plus', name: 'Astra-Plus', title: 'Astra-Plus 對話範例', desc: '輕巧迅捷' },
                { id: 'mini', name: 'Astra-Mini', title: 'Astra-Mini 對話範例', desc: '混和推理' },
                { id: 'mill', name: 'Astra-Mill', title: 'Astra-Mill 對話範例', desc: '強大開源' },
                { id: 'nano', name: 'Astra-Nano', title: 'Astra-Nano 對話範例', desc: '超大規模' },
                { id: 'pico', name: 'Astra-Pico', title: 'Astra-Pico 對話範例', desc: '靈活輕量' },
            ];
            const selectorContainer = document.querySelector('.demo-model-selector');
            const chatWindow = document.getElementById('demo-chat-window');
            const chatTitle = document.getElementById('demo-chat-title');

            if (selectorContainer && chatWindow && chatTitle) {
                // Populate selector buttons and chat content divs
                demoModels.forEach((model, index) => {
                    const button = document.createElement('button');
                    button.className = `selector-btn text-center p-3 rounded-lg border-2 border-gray-200 bg-white ${index === 0 ? 'active' : ''}`;
                    button.dataset.modelId = model.id;
                    button.innerHTML = `
                        <div class="font-semibold text-sm text-gray-800">${model.name}</div>
                        <div class="text-xs text-gray-500">${model.desc}</div>
                    `;
                    selectorContainer.appendChild(button);

                    const contentDiv = document.createElement('div');
                    contentDiv.id = `demo-chat-${model.id}`;
                    contentDiv.className = `demo-chat-content space-y-6 ${index === 0 ? 'active' : ''}`;
                    contentDiv.innerHTML = demoConversations[model.id];
                    chatWindow.appendChild(contentDiv);
                });

                // Add event listener to selector buttons
                selectorContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.selector-btn');
                    if (!button) return;
                    
                    const modelId = button.dataset.modelId;
                    
                    // Update active button
                    selectorContainer.querySelector('.active').classList.remove('active');
                    button.classList.add('active');
                    
                    // Update active chat content
                    chatWindow.querySelector('.active').classList.remove('active');
                    document.getElementById(`demo-chat-${modelId}`).classList.add('active');

                    // Update chat title
                    const modelInfo = demoModels.find(m => m.id === modelId);
                    chatTitle.textContent = modelInfo.title;
                });
            }
        });

        // 原有的應用程式邏輯
        const ALL_ELEMENTS = {
            authContainer: document.getElementById('auth-container'),
            appContainer: document.getElementById('app-container'),
            authForm: document.getElementById('auth-form'),
            usernameInput: document.getElementById('username-input'),
            passwordInput: document.getElementById('password-input'),
            importBtnAuth: document.getElementById('import-btn-auth'),
            logoutBtn: document.getElementById('logout-btn'),
            usernameDisplay: document.getElementById('username-display'),
            newChatBtn: document.getElementById('new-chat-btn'),
            headerTempChatToggleBtn: document.getElementById('header-temp-chat-toggle-btn'),
            openSearchBtn: document.getElementById('open-search-btn'),
            historyList: document.getElementById('history-list'),
            folderList: document.getElementById('folder-list'),
            newFolderBtn: document.getElementById('new-folder-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            headerTitle: document.getElementById('header-title'),
            tempChatIndicator: document.getElementById('temp-chat-indicator'),
            modelSwitcherContainer: document.getElementById('model-switcher-container'),
            chatContainer: document.getElementById('chat-container'),
            messageList: document.getElementById('message-list'),
            messageInput: document.getElementById('message-input'),
            chatForm: document.getElementById('chat-form'),
            submitButton: document.getElementById('submit-btn'),
            submitButtonIcon: document.getElementById('submit-btn-icon'),
            scrollToBottomBtn: document.getElementById('scroll-to-bottom-btn'),
            settingsModal: document.getElementById('settings-modal'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            geminiApiKeyInput: document.getElementById('gemini-api-key-input'),
            // 新增 OpenRouter 相關元素
            openrouterModelSelect: document.getElementById('openrouter-model-select'),
            openrouterApiKeyInput: document.getElementById('openrouter-api-key-input'),
            saveOpenrouterKeyBtn: document.getElementById('save-openrouter-key-btn'),
            openrouterModelsList: document.getElementById('openrouter-models-list'),
            modelManagementList: document.getElementById('model-management-list'),
            openArchivedModalBtn: document.getElementById('open-archived-modal-btn'),
            themeLightBtn: document.getElementById('theme-light-btn'),
            themeDarkBtn: document.getElementById('theme-dark-btn'),
            archivedChatsModal: document.getElementById('archived-chats-modal'),
            closeArchivedModalBtn: document.getElementById('close-archived-modal-btn'),
            archivedChatsContainer: document.getElementById('archived-chats-container'),
            // ▼▼▼ 新增：封存對話檢視相關元素 ▼▼▼
            viewArchivedChatModal: document.getElementById('view-archived-chat-modal'),
            viewArchivedTitle: document.getElementById('view-archived-title'),
            viewArchivedContent: document.getElementById('view-archived-content'),
            closeViewArchivedModalBtn: document.getElementById('close-view-archived-modal-btn'),
            closeViewArchivedModalBtnFooter: document.getElementById('close-view-archived-modal-btn-footer'),
            // ▲▲▲ 結束新增 ▲▲▲
            renameModal: document.getElementById('rename-modal'),
            renameInput: document.getElementById('rename-input'),
            saveRenameBtn: document.getElementById('save-rename-btn'),
            cancelRenameBtn: document.getElementById('cancel-rename-btn'),
            folderSettingsModal: document.getElementById('folder-settings-modal'),
            colorSwatchesContainer: document.getElementById('color-swatches-container'),
            iconOptionsContainer: document.getElementById('icon-options-container'),
            saveFolderSettingsBtn: document.getElementById('save-folder-settings-btn'),
            cancelFolderSettingsBtn: document.getElementById('cancel-folder-settings-btn'),
            notificationContainer: document.getElementById('notification-container'),
            customDialogModal: document.getElementById('custom-dialog-modal'),
            customDialogTitle: document.getElementById('custom-dialog-title'),
            customDialogMessage: document.getElementById('custom-dialog-message'),
            customDialogInputContainer: document.getElementById('custom-dialog-input-container'),
            customDialogInput: document.getElementById('custom-dialog-input'),
            customDialogButtons: document.getElementById('custom-dialog-buttons'),
            webSearchBtn: document.getElementById('web-search-btn'),
            selectionModeBtn: document.getElementById('selection-mode-btn'),
            batchActionBar: document.getElementById('batch-action-bar'),
            selectionCount: document.getElementById('selection-count'),
            cancelSelectionBtn: document.getElementById('cancel-selection-btn'),
            batchDeleteBtn: document.getElementById('batch-delete-btn'),
            batchArchiveBtn: document.getElementById('batch-archive-btn'),
            batchMoveBtn: document.getElementById('batch-move-btn'),
            batchMoveModal: document.getElementById('batch-move-modal'),
            batchMoveFolderList: document.getElementById('batch-move-folder-list'),
            batchMoveCancelBtn: document.getElementById('batch-move-cancel-btn'),
            batchMoveConfirmBtn: document.getElementById('batch-move-confirm-btn'),
            userControls: document.getElementById('user-controls'),
            searchModal: document.getElementById('search-modal'),
            closeSearchModalBtn: document.getElementById('close-search-modal-btn'),
            modalSearchInput: document.getElementById('modal-search-input'),
            modalSearchScopeSelect: document.getElementById('modal-search-scope-select'),
            searchResultsContainer: document.getElementById('search-results-container'),
            performSearchBtn: document.getElementById('perform-search-btn'),
            fileInputContainer: document.getElementById('file-input-container'),
            addFileBtn: document.getElementById('add-file-btn'),
            fileOptionsPopover: document.getElementById('file-options-popover'),
            cameraBtn: document.getElementById('camera-btn'),
            uploadImageBtn: document.getElementById('upload-image-btn'),
            uploadFileBtn: document.getElementById('upload-file-btn'),
            imageVideoInput: document.getElementById('image-video-input'),
            fileUploadInput: document.getElementById('file-upload-input'),
            filePreviewContainer: document.getElementById('file-preview-container'),
            exportDataBtn: document.getElementById('export-data-btn'),
            importDataBtn: document.getElementById('import-data-btn'),
            exportDataModal: document.getElementById('export-data-modal'),
            importDataModal: document.getElementById('import-data-modal'),
            cancelExportBtn: document.getElementById('cancel-export-btn'),
            confirmExportBtn: document.getElementById('confirm-export-btn'),
            exportHistoryCheck: document.getElementById('export-history-check'),
            exportAstrasCheck: document.getElementById('export-astras-check'),
            exportSettingsCheck: document.getElementById('export-settings-check'),
            exportMemoryCheck: document.getElementById('export-memory-check'),
            cancelImportBtn: document.getElementById('cancel-import-btn'),
            confirmImportBtn: document.getElementById('confirm-import-btn'),
            importFileInput: document.getElementById('import-file-input'),
            // Mobile specific
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            // 新增: 後續追問相關元素
            followUpContainer: document.getElementById('follow-up-container'),
            followUpToggleBtn: document.getElementById('follow-up-toggle-btn'),
            followUpPromptsList: document.getElementById('follow-up-prompts-list'),
            followUpToggleSwitch: document.getElementById('follow-up-toggle-switch'),
            autoNamingToggleSwitch: document.getElementById('auto-naming-toggle-switch'),
            // 新增：智慧連網搜尋開關
            autoWebSearchToggleSwitch: document.getElementById('auto-web-search-toggle-switch'),
            // 新增: Astras 相關元素
            astrasList: document.getElementById('astras-list'),
            newAstrasBtn: document.getElementById('new-astras-btn'),
            astrasCreateModal: document.getElementById('astras-create-modal'),
            astrasNameInput: document.getElementById('astras-name-input'),
            astrasDescInput: document.getElementById('astras-desc-input'),
            astrasInstructionsInput: document.getElementById('astras-instructions-input'),
            saveAstrasBtn: document.getElementById('save-astras-btn'),
            cancelAstrasBtn: document.getElementById('cancel-astras-btn'),
            astrasIndicator: document.getElementById('astras-indicator'),
            currentAstrasName: document.getElementById('current-astras-name'),
            // 新增: 顏色下拉選單容器
            aiBubbleColorDropdown: document.getElementById('ai-bubble-color-dropdown'),
            userBubbleColorDropdown: document.getElementById('user-bubble-color-dropdown'),
            settingsNav: document.getElementById('settings-nav'),
            // 新增: 語音輸入按鈕
            voiceInputBtnMessage: document.getElementById('voice-input-btn-message'),
            voiceInputBtnSearch: document.getElementById('voice-input-btn-search'),
            // 新增: 記憶管理元素
            memoryToggle1: document.getElementById('memory-toggle-1'),
            personalMemoryList: document.getElementById('personal-memory-list'),
            addPersonalMemoryBtn: document.getElementById('add-personal-memory-btn'),
            autoMemoryToggleSwitch: document.getElementById('auto-memory-toggle-switch'),
            // 需求四: 新增關閉 Astras 的按鈕
            closeAstrasBtn: document.getElementById('close-astras-btn'),
            // ▼▼▼ 新增：自訂桌布 & UI 顏色相關元素 ▼▼▼
            wallpaperContainer: document.getElementById('wallpaper-container'),
            uploadWallpaperBtn: document.getElementById('upload-wallpaper-btn'),
            restoreWallpaperBtn: document.getElementById('restore-wallpaper-btn'),
            wallpaperUploadInput: document.getElementById('wallpaper-upload-input'),
            uiColorOptions: document.getElementById('ui-color-options'),
            customColorPickerContainer: document.getElementById('custom-color-picker-container'),
            customColorSwatches: document.getElementById('custom-color-swatches'),
            buttonStyleContainer: document.getElementById('button-style-container'),
            gradientPickerContainer: document.getElementById('gradient-picker-container'),
            gradientSwatches: document.getElementById('gradient-swatches'),
            // ▲▲▲ 新增：自訂桌布 & UI 顏色相關元素 ▲▲▲
            apiKeyWarningBadge: document.getElementById('api-key-warning-badge'),
            // ▼▼▼ 需求 1 新增：數據儀表板元素 ▼▼▼
            userProfileBtn: document.getElementById('user-profile-btn'),
            dataDashboardModal: document.getElementById('data-dashboard-modal'),
            closeDashboardBtn: document.getElementById('close-dashboard-btn'),
            totalConvStat: document.getElementById('total-conv-stat'),
            totalFolderStat: document.getElementById('total-folder-stat'),
            mostUsedModelStat: document.getElementById('most-used-model-stat'),
            timeAnalysisYearSelect: document.getElementById('time-analysis-year-select'),
            timeAnalysisMonthSelect: document.getElementById('time-analysis-month-select'),
            timeAnalysisDaySelect: document.getElementById('time-analysis-day-select'), // 新增日選擇器
            // ▲▲▲ 結束新增 ▲▲▲
            // ▼▼▼ 新增：桌布裁切 Modal 元素 ▼▼▼
            wallpaperCropModal: document.getElementById('wallpaper-crop-modal'),
            wallpaperCropImage: document.getElementById('wallpaper-crop-image'),
            cancelCropBtn: document.getElementById('cancel-crop-btn'),
            confirmCropBtn: document.getElementById('confirm-crop-btn'),
            // ▲▲▲ 結束新增 ▲▲▲
            // ▼▼▼ 新增：清除資料按鈕 ▼▼▼
            deleteAllDataBtn: document.getElementById('delete-all-data-btn'),
            // ▲▲▲ 結束新增 ▲▲▲
            // ▼▼▼ 新增：語言切換相關元素 ▼▼▼
            loginLanguageSwitcher: document.getElementById('login-language-switcher'),
            loginLangBtn: document.getElementById('login-lang-btn'),
            loginLangMenu: document.getElementById('login-lang-menu'),
            loginLangLabel: document.getElementById('login-lang-label'),
            uiLanguageSelect: document.getElementById('ui-language-select'),
            aiLanguageSelect: document.getElementById('ai-language-select'),
            // ▲▲▲ 結束新增 ▲▲▲
            // ▼▼▼ 新增：商店與頭像相關元素 ▼▼▼
            storeContainer: document.getElementById('store-container'),
            openStoreBtn: document.getElementById('open-store-btn'),
            backToChatBtn: document.getElementById('back-to-chat-btn'),
            storeGrid: document.getElementById('store-grid'),
            astrasAvatarModal: document.getElementById('astras-avatar-modal'),
            avatarCropContainer: document.getElementById('avatar-crop-container'),
            avatarCropImage: document.getElementById('avatar-crop-image'),
            confirmAvatarCropBtn: document.getElementById('confirm-avatar-crop-btn'),
            cancelAvatarCropBtn: document.getElementById('cancel-avatar-crop-btn'),
            astrasAvatarInput: document.getElementById('astras-avatar-input'),
            // ▲▲▲ 結束新增 ▲▲▲
        };
        // 修正: 模型ID更新為最新的公開版本
        const MODELS = [
            { id: 'sonoma-sky-alpha', name: 'astra-ultra', provider: 'openrouter', descriptionKey: 'model_ultra_desc', limitsKey: 'model_ultra_limits' },
            { id: 'gemini-2.5-flash', name: 'astra-pro', provider: 'gemini', descriptionKey: 'model_pro_desc', limitsKey: 'model_pro_limits' },
            { id: 'gemini-2.5-flash-lite', name: 'astra-plus', provider: 'gemini', descriptionKey: 'model_plus_desc', limitsKey: 'model_plus_limits' },
            { id: 'tngtech/deepseek-r1t2-chimera:free', name: 'astra-mini', provider: 'openrouter', descriptionKey: 'model_mini_desc', limitsKey: 'model_mini_limits' },
            { id: 'meta-llama/llama-3.3-70b-instruct:free', name: 'astra-mill', provider: 'openrouter', descriptionKey: 'model_mill_desc', limitsKey: 'model_mill_limits' },
            { id: 'Qwen/Qwen3-235B-A22B:free', name: 'astra-nano', provider: 'openrouter', descriptionKey: 'model_nano_desc', limitsKey: 'model_nano_limits' },
            { id: 'z-ai/glm-4.5-air:free', name: 'astra-pico', provider: 'openrouter', descriptionKey: 'model_pico_desc', limitsKey: 'model_pico_limits' },
        ];
        // 修正: 使用 gemini-2.5-flash-lite 作為生成標題和後續追問的低成本模型
        const CHEAP_MODEL_ID = 'gemini-2.5-flash-lite';
        const FOLDER_COLORS = {
            gray: '#808080', red: '#f87171', yellow: '#facc15', green: '#4ade80',
            blue: '#60a5fa', indigo: '#818cf8', purple: '#a78bfa', pink: '#f472b6',
        };
        const AI_BUBBLE_COLORS = {
            default: {light: '#f7f7f8', dark: '#1c1c1c'},
            gray: {light: '#f3f4f6', dark: '#374151'},
            blue: {light: '#e0f7fa', dark: '#006064'},
            green: {light: '#e8f5e9', dark: '#1b5e20'},
            yellow: {light: '#fffde7', dark: '#f57f17'},
            orange: {light: '#fff3e0', dark: '#ef6c00'},
            red: {light: '#ffebee', dark: '#b71c1c'},
            purple: {light: '#f3e5f5', dark: '#6a1b9a'},
            pink: {light: '#fce4ec', dark: '#ad1457'},
            teal: {light: '#e0f2f1', dark: '#004d40'},
        };
        const USER_BUBBLE_COLORS = {
            default: {light: '#3b82f6', dark: '#2563eb'},
            gray: {light: '#6b7280', dark: '#4b5563'},
            blue: {light: '#3b82f6', dark: '#2563eb'},
            green: {light: '#22c55e', dark: '#15803d'},
            yellow: {light: '#eab308', dark: '#a16207'},
            orange: {light: '#f97316', dark: '#c2410c'},
            red: {light: '#ef4444', dark: '#b91c1c'},
            purple: {light: '#8b5cf6', dark: '#6d28d9'},
            pink: {light: '#ec4899', dark: '#be185d'},
            teal: {light: '#14b8a6', dark: '#0f766e'},
        };
        // ▼▼▼ 新增：UI 顏色主題調色盤 ▼▼▼
        const UI_THEME_COLORS = {
            Red: '#ef4444', Orange: '#f97316', Amber: '#f59e0b',
            Yellow: '#eab308', Lime: '#84cc16', Green: '#22c55e',
            Emerald: '#10b981', Teal: '#14b8a6', Cyan: '#06b6d4',
            Sky: '#0ea5e9', Blue: '#3b82f6', Indigo: '#6366f1',
            Violet: '#8b5cf6', Purple: '#a855f7', Fuchsia: '#d946ef',
            Pink: '#ec4899', Rose: '#f43f5e', Slate: '#64748b'
        };
        // ▲▲▲ 結束：UI 顏色主題調色盤 ▲▲▲
        // ▼▼▼ 新增：官方 Astras 資料 ▼▼▼
        const OFFICIAL_ASTRAS = [
            {
                id: 'official-writer-01',
                name: '創意寫手',
                description: '一個強大的寫作夥伴，可以幫助您產生部落格文章、行銷文案、詩歌和劇本等。',
                instructions: '你是一位專業的創意寫手，精通各種文學風格和寫作技巧。你的任務是根據用戶的要求，創作出高品質、引人入勝的文字內容。',
                avatarUrl: null
            },
            {
                id: 'official-translator-02',
                name: '多語言翻譯家',
                description: '提供精確、流暢且符合在地文化的跨語言翻譯服務，支援多種主要語言。',
                instructions: '你是一位專業的翻譯家，能夠在多種語言之間進行準確且自然的翻譯。請注重語氣、文化背景和專業術語的準確性。',
                avatarUrl: null
            },
            {
                id: 'official-coder-03',
                name: '程式碼助手',
                description: '您的程式設計夥伴，能協助您編寫、除錯、重構程式碼，並解釋複雜的演算法。',
                instructions: '你是一位資深的軟體工程師，擅長多種程式語言。你的目標是提供乾淨、高效且附有清晰註解的程式碼，並能解釋其運作原理。',
                avatarUrl: null
            },
            {
                id: 'official-tutor-04',
                name: '學術導師',
                description: '一個知識淵博的導師，能以簡單易懂的方式解釋複雜的學術概念。',
                instructions: '你是一位耐心且知識淵博的老師，能夠將複雜的主題分解成簡單易懂的部分。請使用比喻和範例來幫助用戶學習。',
                avatarUrl: null
            },
        ];
        // ▲▲▲ 結束新增 ▲▲▲
        let conversations = [];
        let folders = [];
        let astras = [];
        let personalMemories = []; // 第一類記憶: 陣列 of {id, content, enabled}
        let activeConversationId = null;
        let lastNonTempConversationId = null;
        let config = {
            apiKeys: { gemini: '', openrouter: {} },
            defaultModel: MODELS[0].id,
            theme: 'light',
            modelSettings: [],
            enableFollowUp: true,
            enableAutoWebSearch: false, // 新增: 自動連網搜尋開關
            aiBubbleColor: 'default',
            userBubbleColor: 'default',
            autoNaming: true,
            lastUsedModel: null,
            memoryEnabled1: true,
            enableAutoMemory: true, 
            customWallpaper: null, 
            wallpaperBrightness: 'light', 
            // ▼▼▼ 修改：UI 主題顏色設定 (新增漸變相關) ▼▼▼
            uiTheme: {
                mode: 'default', // 'default', 'adaptive', 'custom'
                style: 'single', // 'single' or 'gradient'
                customColor: '#3b82f6',
                adaptiveColor: '#3b82f6',
                adaptivePalette: [], // stores palette from wallpaper
                adaptiveGradient: '' // stores selected gradient value
            },
            // ▲▲▲ 結束：UI 主題顏色設定 ▲▲▲
            // ▼▼▼ 新增：語言設定 ▼▼▼
            uiLanguage: 'zh-TW',
            aiDefaultLanguage: 'zh-TW',
            // ▲▲▲ 結束新增 ▲▲▲
        };
        let itemToRename = { id: null, type: null };
        let folderToCustomize = null;
        let currentUser = null;
        let abortController = null;
        let isSelectionMode = false;
        let selectedConversationIds = new Set();
        let isTemporaryChat = false;
        let currentTempConversation = null;
        let uploadedFiles = [];
        let draggedModelElement = null;
        let sidebarOpen = false;
        let sendConfirmed = false;
        let isFollowUpExpanded = true; // 新增: 後續追問提示的收合狀態
        let editingAstrasId = null;
        let currentSpeechRecognition = null;
        let currentVoiceTarget = null;
        // ▼▼▼ 需求 1 新增：圖表實例變數 ▼▼▼
        let modelPieChart = null;
        let timeDistChart = null;
        // ▲▲▲ 結束新增 ▲▲▲
        // ▼▼▼ 新增：桌布與頭像裁切實例變數 ▼▼▼
        let cropperInstance = null;
        let editingAstraForAvatarId = null;
        // ▲▲▲ 結束新增 ▲▲▲
        // IndexedDB 配置
        const DB_NAME = 'ChatAppDB';
        const STORE_NAME = 'keyValue';
        let db;
        async function openDB() {
            if (db) return db;
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    const idb = e.target.result;
                    idb.createObjectStore(STORE_NAME, { keyPath: 'key' });
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }
        async function getItem(key) {
            const idb = await openDB();
            return new Promise((resolve, reject) => {
                const tx = idb.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
                req.onerror = reject;
            });
        }
        async function setItem(key, value) {
            const idb = await openDB();
            return new Promise((resolve, reject) => {
                const tx = idb.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put({ key, value });
                tx.oncomplete = resolve;
                tx.onerror = reject;
            });
        }
        async function removeItem(key) {
            const idb = await openDB();
            return new Promise((resolve, reject) => {
                const tx = idb.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.delete(key);
                tx.oncomplete = resolve;
                tx.onerror = reject;
            });
        }
        // --- Crypto Helper Functions ---
        const hashString = async (str) => {
            const data = new TextEncoder().encode(str);
            const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        };

        // ▼▼▼ 新增：顏色轉換輔助函式 ▼▼▼
        const hexToRgba = (hex, alpha = 1) => {
            if (!hex) return `rgba(255, 255, 255, ${alpha})`; // 為無效的 hex 提供備用
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return `rgba(255, 255, 255, ${alpha})`;
            const r = parseInt(result[1], 16);
            const g = parseInt(result[2], 16);
            const b = parseInt(result[3], 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };
        // ▲▲▲ 結束：顏色轉換輔助函式 ▲▲▲
        
        // ▼▼▼ 需求 2 新增：完整時間戳格式化函式 ▼▼▼
        const formatFullTimestamp = (isoString) => {
            if (!isoString) return '';
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        };
        // ▲▲▲ 結束新增 ▲▲▲

        const getConfigKey = () => `chatConfig_v_v8.6_${currentUser.username}`;
        const getAppDataKey = () => `chatAppData_v8.6_${currentUser.username}`;
        const getUserKey = (username) => `chatUser_${username}`;
        const showNotification = (message, type = 'success') => {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            ALL_ELEMENTS.notificationContainer.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 3000);
        };
        const toggleModal = (modalElement, show) => {
            if (!modalElement) return;
            if (show) {
                modalElement.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modalElement.classList.add('visible');
                });
            } else {
                modalElement.classList.remove('visible');
                const onTransitionEnd = () => {
                    modalElement.classList.add('hidden');
                    modalElement.removeEventListener('transitionend', onTransitionEnd);
                };
                modalElement.addEventListener('transitionend', onTransitionEnd);
            }
        };


        const showCustomDialog = (options) => {
            return new Promise((resolve) => {
                const { title, message, input = null, buttons, dialogClass = '' } = options;
                const dialogBox = ALL_ELEMENTS.customDialogModal.querySelector('.bg-\\[var\\(--modal-bg\\)\\]');
                
                if (dialogClass) {
                    dialogBox.classList.add(dialogClass);
                }

                ALL_ELEMENTS.customDialogTitle.textContent = title;
                ALL_ELEMENTS.customDialogMessage.textContent = message;
                if (input) {
                    ALL_ELEMENTS.customDialogInput.type = input.type || 'text';
                    ALL_ELEMENTS.customDialogInput.value = '';
                    ALL_ELEMENTS.customDialogInput.placeholder = input.placeholder || '';
                    ALL_ELEMENTS.customDialogInputContainer.classList.remove('hidden');
                } else {
                    ALL_ELEMENTS.customDialogInputContainer.classList.add('hidden');
                }
                ALL_ELEMENTS.customDialogButtons.innerHTML = '';
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = btnInfo.text;
                    button.className = btnInfo.class;
                    button.onclick = () => {
                        toggleModal(ALL_ELEMENTS.customDialogModal, false);
                        if (dialogClass) {
                            dialogBox.classList.remove(dialogClass);
                        }
                        const inputValue = input ? ALL_ELEMENTS.customDialogInput.value : null;
                        resolve(btnInfo.value(inputValue));
                    };
                    ALL_ELEMENTS.customDialogButtons.appendChild(button);
                });
                toggleModal(ALL_ELEMENTS.customDialogModal, true);
                if (input) { ALL_ELEMENTS.customDialogInput.focus(); }
            });
        };
        const showCustomConfirm = (message, title = '請確認') => showCustomDialog({ title, message, buttons: [{ text: '取消', class: 'bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]', value: () => false }, { text: '確定', class: 'px-4 py-2 rounded-md btn-primary', value: () => true }] });
        const showCustomPrompt = (message, title = '請輸入', inputType = 'text') => showCustomDialog({ title, message, input: { type: inputType, placeholder: '請在此輸入...' }, buttons: [{ text: '取消', class: 'bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]', value: () => null }, { text: '確定', class: 'px-4 py-2 rounded-md btn-primary', value: (val) => val }] });


        // 新增：使用 marked.js 進行 Markdown 渲染
        const renderMarkdown = (text) => {
            return marked.parse(text);
        };
        const saveConfig = async () => { if (currentUser) await setItem(getConfigKey(), JSON.stringify(config)); };
        const loadConfig = async () => {
            if (!currentUser) return;
            const saved = await getItem(getConfigKey());
            if (saved) {
                const savedConfig = JSON.parse(saved);
                const savedOpenrouterKeys = savedConfig.apiKeys?.openrouter || {};
                // 合併設定，確保新版本的預設值能被加入
                const defaultConfig = {
                    ...config, // Keep new default values
                    ...savedConfig, // Overwrite with saved values
                    apiKeys: { ...config.apiKeys, ...savedConfig.apiKeys, openrouter: savedOpenrouterKeys },
                    uiTheme: { ...config.uiTheme, ...(savedConfig.uiTheme || {}) } // Merge uiTheme object
                };
                 // 確保舊版本設定檔升級時，新屬性不會是 undefined
                defaultConfig.uiTheme.style = defaultConfig.uiTheme.style || 'single';
                defaultConfig.uiTheme.adaptivePalette = defaultConfig.uiTheme.adaptivePalette || [];
                defaultConfig.uiTheme.adaptiveGradient = defaultConfig.uiTheme.adaptiveGradient || '';
                
                config = defaultConfig;
            }
            // Initialize or merge model settings
            const savedModelSettings = config.modelSettings || [];
            const allModelIds = new Set(MODELS.map(m => m.id));
            const savedSettingIds = new Set(savedModelSettings.map(s => s.id));
            // Add new models from MODELS constant not present in saved settings
            MODELS.forEach((model, index) => {
                if (!savedSettingIds.has(model.id)) {
                    savedModelSettings.push({ id: model.id, hidden: false, order: savedModelSettings.length });
                }
            });
            // Remove models from settings that no longer exist in MODELS constant
            config.modelSettings = savedModelSettings.filter(s => allModelIds.has(s.id));


            // Ensure order is contiguous
            config.modelSettings.sort((a, b) => a.order - b.order);
            config.modelSettings.forEach((s, index) => s.order = index);
            // If the removed model was the default or last used, switch to a new one
            if (!allModelIds.has(config.defaultModel)) {
                config.defaultModel = MODELS[0].id;
            }
            if (!allModelIds.has(config.lastUsedModel)) {
                config.lastUsedModel = MODELS[0].id;
            }
        };
        const saveAppData = async () => { if (currentUser && !isTemporaryChat) await setItem(getAppDataKey(), JSON.stringify({ conversations, folders, astras, personalMemories })); };
        const loadAppData = async () => {
            if (!currentUser) return;
            const saved = await getItem(getAppDataKey());
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    folders = (data.folders || []).map(f => ({...getDefaultFolder(), ...f}));
                    conversations = (data.conversations || []).map(c => ({
                        archived: false, summary: '', folderId: null, isWebSearchEnabled: false, astrasId: null, pinned: false, ...c,
                        genConfig: c.genConfig || getDefaultGenConfig(),
                        messages: (c.messages || []).map(m => ({
                            ...m,
                            createdAt: m.createdAt || c.createdAt, // 修正：為舊版訊息補上時間戳
                            parts: m.parts || [{ text: m.content }] // Compatibility for old format
                        }))
                    }));
                    // ▼▼▼ 修改：確保舊資料能相容 avatarUrl ▼▼▼
                    astras = (data.astras || []).map(a => ({ avatarUrl: null, officialId: null, ...a }));
                    personalMemories = data.personalMemories || [];
                } catch (e) {
                    console.error("Failed to parse app data:", e);
                    showNotification("讀取對話紀錄失敗，資料可能已損毀。", "error");
                    conversations = [];
                    folders = [];
                    astras = [];
                    personalMemories = [];
                    await removeItem(getAppDataKey()); // Clear corrupted data
                }
            } else {
                conversations = [];
                folders = [];
                astras = [];
                personalMemories = [];
            }
        };
        const getDefaultGenConfig = () => ({ temperature: 0.7, topP: 0.95, maxTokens: null });
        const getDefaultFolder = () => ({ color: 'gray', icon: '📁' , isOpen: false});
        const createBaseConversation = (title) => {
            const defaultModelInfo = MODELS.find(m => m.id === config.lastUsedModel) || MODELS.find(m => m.id === config.defaultModel) || MODELS[0];
            return {
                id: crypto.randomUUID(),
                title: title,
                summary: '',
                messages: [],
                model: defaultModelInfo.id,
                provider: defaultModelInfo.provider,
                archived: false,
                createdAt: new Date().toISOString(),
                genConfig: getDefaultGenConfig(),
                isRenamed: false,
                folderId: null,
                astrasId: null,
                isWebSearchEnabled: false,
                pinned: false
            };
        };
        const startNewChat = (isTemporary = false) => {
            const activeConv = getActiveConversation();
            if (activeConv && activeConv.messages.length === 0 && !isTemporaryChat && !isTemporary) {
                showNotification('請先傳送訊息再開始新對話。', 'warning');
                return;
            }


            if (!isTemporary) {
                isTemporaryChat = false;
            } else {
                if (!isTemporaryChat) { // Store last non-temp chat only when entering temp mode
                    lastNonTempConversationId = activeConversationId;
                }
                isTemporaryChat = true;
            }
            uploadedFiles = [];


            if (isTemporary) {
                currentTempConversation = createBaseConversation('臨時對話');
                activeConversationId = currentTempConversation.id;
            } else {
                currentTempConversation = null;
                if (conversations.length > 0 && conversations[0].messages.length === 0 && !conversations[0].isRenamed) {
                    loadChat(conversations[0].id);
                    return;
                }
                const newConv = createBaseConversation('新對話');
                conversations.unshift(newConv);
                activeConversationId = newConv.id;
                saveAppData();
            }


            renderAll();
            toggleSidebar(false);
            sendConfirmed = false;
            updateInputState();
            updateApiKeyWarningBadge();
            // 重新載入對話時，清除追問提示
            renderFollowUpPrompts([]);
        };
        const toggleTemporaryChat = () => {
            if (isTemporaryChat) {
                // Turn off temp chat
                isTemporaryChat = false;
                currentTempConversation = null;
                if (lastNonTempConversationId && conversations.some(c => c.id === lastNonTempConversationId)) {
                    loadChat(lastNonTempConversationId);
                } else {
                    const firstAvailable = conversations.find(c => !c.archived) || null;
                    if (firstAvailable) {
                        loadChat(firstAvailable.id);
                    } else {
                        startNewChat(false);
                    }
                }
                lastNonTempConversationId = null;
            } else {
                // Turn on temp chat
                startNewChat(true);
            }
        };
        const loadChat = (id) => {
            if (id !== activeConversationId || isTemporaryChat) {
                isTemporaryChat = false;
                currentTempConversation = null;
                activeConversationId = id;
                uploadedFiles = [];
                renderAll();
            }
            toggleSidebar(false);
            sendConfirmed = false;
            updateInputState();
            updateApiKeyWarningBadge();
            // 重新載入對話時，清除追問提示
            renderFollowUpPrompts([]);
        };
        const deleteChat = async (id, event) => {
            event?.stopPropagation();
            if (!(await showCustomConfirm('您確定要永久刪除此對話嗎？此操作無法復原。'))) return;


            const convIndex = conversations.findIndex(c => c.id === id);
            if (convIndex > -1) {
                const conv = conversations[convIndex];
                if (conv.folderId) {
                    const folder = folders.find(f => f.id === conv.folderId);
                    if (folder) {
                        folder.conversationIds = folder.conversationIds.filter(cid => cid !== id);
                    }
                }
                conversations.splice(convIndex, 1);
            }
            await saveAppData();
            if (activeConversationId === id) {
                isTemporaryChat = false;
                currentTempConversation = null;
                const nextConv = conversations.find(c => !c.archived && !c.folderId);
                activeConversationId = nextConv ? nextConv.id : null;
                if (!activeConversationId) {
                    const firstInFolder = conversations.find(c => c.folderId);
                    if (firstInFolder) activeConversationId = firstInFolder.id;
                }
                if (!activeConversationId) startNewChat();
                else loadChat(activeConversationId);
            } else {
                renderAll();
            }
        };
        const archiveChat = async (id, event) => {
            event?.stopPropagation();
            const conv = conversations.find(c => c.id === id);
            if(conv) conv.archived = true;
            await saveAppData();
            if (activeConversationId === id) {
                isTemporaryChat = false;
                currentTempConversation = null;
                const nextConv = conversations.find(c => !c.archived);
                activeConversationId = nextConv ? nextConv.id : null;
                if (!activeConversationId) startNewChat();
                else loadChat(activeConversationId);
            } else {
                renderAll();
            }
        };
        const unarchiveChat = async (id, event) => {
            event?.stopPropagation();
            const conv = conversations.find(c => c.id === id);
            if(conv) conv.archived = false;
            await saveAppData();
            renderAll();
        };
        const showArchivedChatPreview = (id, event) => {
            event?.stopPropagation();
            const conv = conversations.find(c => c.id === id);
            if (!conv) return;

            ALL_ELEMENTS.viewArchivedTitle.textContent = conv.title;
            const contentContainer = ALL_ELEMENTS.viewArchivedContent;
            contentContainer.innerHTML = ''; // Clear previous content

            if (conv.messages.length === 0) {
                contentContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)]">此對話沒有訊息。</p>';
            } else {
                conv.messages.forEach(msg => {
                    const isUser = msg.role === 'user';
                    const messageDiv = document.createElement('div');
                    // Match the structure from addMessageToUI for styling
                    messageDiv.className = `flex items-start gap-2 md:gap-4 ${isUser ? 'justify-end user-message' : 'model-message'}`;
                    const icon = isUser 
                        ? `<div class="bg-blue-600 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold">${currentUser ? currentUser.username.charAt(0).toUpperCase() : 'Y'}</div>` 
                        : `<div class="bg-gray-800 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 15h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>`;

                    let contentHTML = '';
                    msg.parts.forEach(part => {
                        if (part.text) {
                             contentHTML += `<div>${isUser ? part.text.replace(/\n/g, '<br>') : renderMarkdown(part.text)}</div>`;
                        } else if (part.inlineData) {
                            const src = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                             if (part.inlineData.mimeType.startsWith('image/')) {
                                contentHTML += `<img src="${src}" class="mt-2 max-w-xs max-h-48 rounded-lg object-cover border border-[var(--border-color)]">`;
                            }
                        }
                    });

                    const messageBubble = `
                        <div class="p-3 md:p-4 rounded-lg shadow-sm max-w-full md:max-w-xl message-bubble">
                            <div class="prose prose-sm max-w-none message-content ${isUser ? 'text-white' : 'text-[var(--text-primary)]'}">${contentHTML}</div>
                        </div>`;
                    
                    messageDiv.innerHTML = isUser ? `${messageBubble}${icon}` : `${icon}${messageBubble}`;

                    contentContainer.appendChild(messageDiv);
                });
            }

            toggleModal(ALL_ELEMENTS.viewArchivedChatModal, true);
        };
        const togglePinChat = async (id, event) => {
            event?.stopPropagation();
            const conv = conversations.find(c => c.id === id);
            if (conv) {
                conv.pinned = !conv.pinned;
                await saveAppData();
                renderAll();
            }
        };


        const showRenameModal = (id, type, event) => {
            event?.stopPropagation();
            itemToRename = { id, type };
            let currentTitle = '';
            if (type === 'conversation') {
                const conv = conversations.find(c => c.id === id);
                if (conv) currentTitle = conv.title;
            } else if (type === 'folder') {
                const folder = folders.find(f => f.id === id);
                if (folder) currentTitle = folder.name;
            }
            ALL_ELEMENTS.renameModal.querySelector('h2').textContent = `重新命名${type === 'folder' ? '資料夾' : '對話'}`;
            ALL_ELEMENTS.renameInput.value = currentTitle;
            toggleModal(ALL_ELEMENTS.renameModal, true);
            ALL_ELEMENTS.renameInput.focus();
        };
        const handleRename = async () => {
            const newTitle = ALL_ELEMENTS.renameInput.value.trim();
            if (!newTitle || !itemToRename.id) return;


            if (itemToRename.type === 'conversation') {
                const conv = conversations.find(c => c.id === itemToRename.id);
                if (conv) { conv.title = newTitle; conv.isRenamed = true; }
            } else if (itemToRename.type === 'folder') {
                const folder = folders.find(f => f.id === itemToRename.id);
                if (folder) { folder.name = newTitle; }
            }


            await saveAppData();
            renderAll();
            toggleModal(ALL_ELEMENTS.renameModal, false);
            itemToRename = { id: null, type: null };
        };
        const getActiveConversation = () => {
            return isTemporaryChat ? currentTempConversation : conversations.find(c => c.id === activeConversationId);
        };
        const renderAll = () => {
            renderHistorySidebar();
            renderFolders();
            renderAstras();
            renderChat();
            renderArchivedChats();
            renderBatchActionBar();
            renderFilePreviews();
            updateFollowUpUI(); // 新增: 渲染後續追問介面
            ALL_ELEMENTS.headerTempChatToggleBtn.classList.toggle('active', isTemporaryChat);
            ALL_ELEMENTS.tempChatIndicator.classList.toggle('hidden', !isTemporaryChat);
            applyLanguage(config.uiLanguage); // 新增：每次渲染時都應用語言
        };


        const renderHistorySidebar = () => {
            ALL_ELEMENTS.historyList.innerHTML = '';
            const visibleConversations = conversations
                .filter(c => !c.archived && !c.folderId)
                .sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });
            visibleConversations.forEach(conv => {
                ALL_ELEMENTS.historyList.appendChild(createConversationElement(conv));
            });
        };
        // ▼▼▼ 修改：更新 renderAstras 以顯示頭像 ▼▼▼
        const renderAstras = () => {
            ALL_ELEMENTS.astrasList.innerHTML = '';
            astras.forEach(ast => {
                const item = document.createElement('div');
                item.className = `sidebar-item w-full text-left p-2.5 rounded-lg flex items-center justify-between cursor-pointer ${ast.id === getActiveAstrasId() && !isTemporaryChat && !isSelectionMode ? 'active' : ''}`;
                item.dataset.id = ast.id;
                
                const avatarUrl = ast.avatarUrl;
                const initials = ast.name.charAt(0);
                const avatarElement = `
                    <div class="astras-sidebar-avatar">
                        ${avatarUrl ? `<img src="${avatarUrl}" class="w-full h-full object-cover rounded-full">` : initials}
                    </div>`;

                item.innerHTML = `
                    <div class="flex items-center truncate flex-1">
                        ${avatarElement}
                        <span class="truncate pr-2 text-sm">${ast.name}</span>
                    </div>
                    <button class="astras-options-btn flex-shrink-0 w-6 h-6 rounded-md hover:bg-[var(--hover-bg)] flex items-center justify-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                    </button>
                `;
                item.addEventListener('click', () => {
                    if (isSelectionMode) return;
                    setAstrasForConversation(ast.id);
                });
                const optionsBtn = item.querySelector('.astras-options-btn');
                optionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    createAstrasMenu(ast.id, optionsBtn);
                });
                ALL_ELEMENTS.astrasList.appendChild(item);
            });
        };
        // ▲▲▲ 結束修改 ▲▲▲
        const renderFolders = () => {
            ALL_ELEMENTS.folderList.innerHTML = '';
            folders.forEach(folder => {
                const folderConvs = folder.conversationIds
                    .map(id => conversations.find(c => c.id === id))
                    .filter(c => c && !c.archived)
                    .sort((a,b) => {
                        if (a.pinned && !b.pinned) return -1;
                        if (!a.pinned && b.pinned) return 1;
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    });


                const folderElement = document.createElement('details');
                folderElement.className = 'folder-item text-sm';
                if (folder.isOpen) folderElement.open = true;
                folderElement.addEventListener('toggle', () => {
                    folder.isOpen = folderElement.open;
                    saveAppData();
                });
                folderElement.innerHTML = `
                    <summary class="sidebar-item p-3 rounded-lg flex items-center justify-between">
                        <div class="flex items-center gap-2 truncate">
                            <svg class="folder-arrow flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            <span class="folder-icon mr-1">${folder.icon}</span>
                            <span class="font-medium truncate" style="color: ${FOLDER_COLORS[folder.color] || FOLDER_COLORS.gray};">${folder.name}</span>
                        </div>
                        <button data-id="${folder.id}" class="folder-options-btn flex-shrink-0 w-6 h-6 rounded-md hover:bg-[var(--active-bg)] flex items-center justify-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button>
                    </summary>
                    <div class="folder-content-container pl-4 mt-1 space-y-1"></div>
                `;
                const contentContainer = folderElement.querySelector('.folder-content-container');
                folderConvs.forEach(conv => {
                    contentContainer.appendChild(createConversationElement(conv));
                });


                // 為 folder-options-btn 綁定事件，阻止冒泡
                const folderOptionsBtn = folderElement.querySelector('.folder-options-btn');
                if (folderOptionsBtn) {
                    folderOptionsBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        createFolderMenu(folder.id, folderOptionsBtn);
                    });
                }


                ALL_ELEMENTS.folderList.appendChild(folderElement);
            });
        };
        // ▼▼▼ 需求 4 修正：修改函式以加入模型後綴 ▼▼▼
        const createConversationElement = (conv) => {
            const item = document.createElement('div');
            item.className = `sidebar-item w-full text-left p-3 rounded-lg flex items-center justify-between cursor-pointer ${conv.id === activeConversationId && !isTemporaryChat && !isSelectionMode ? 'active' : ''}`;
            item.dataset.id = conv.id;

            const modelInfo = MODELS.find(m => m.id === conv.model);
            const modelNameSuffix = modelInfo ? `<span class="model-suffix">${modelInfo.name}</span>` : '';

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'flex-1 flex items-center justify-between truncate';
            contentWrapper.innerHTML = `
                <div class="flex-1 flex items-center gap-2 truncate">
                    <span class="truncate">${conv.title}${conv.pinned ? ' <span class="pinned-icon">📌</span>' : ''}</span>
                    ${modelNameSuffix}
                </div>
                <button class="chat-options-btn flex-shrink-0 w-6 h-6 rounded-md hover:bg-[var(--hover-bg)] flex items-center justify-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button>
            `;


            if (isSelectionMode) {
                item.classList.add('pr-2');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'conv-select-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3 flex-shrink-0';
                checkbox.checked = selectedConversationIds.has(conv.id);
                checkbox.dataset.id = conv.id;
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedConversationIds.add(conv.id);
                    } else {
                        selectedConversationIds.delete(conv.id);
                    }
                    renderBatchActionBar();
                });
                checkbox.addEventListener('click', e => e.stopPropagation());
                item.appendChild(checkbox);
                contentWrapper.querySelector('.chat-options-btn').classList.add('hidden');
            }


            item.appendChild(contentWrapper);
            item.addEventListener('click', () => {
                if (isSelectionMode) {
                    const checkbox = item.querySelector('.conv-select-checkbox');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                } else {
                    loadChat(conv.id);
                }
            });


            // 為 chat-options-btn 綁定事件，阻止冒泡
            const chatOptionsBtn = contentWrapper.querySelector('.chat-options-btn');
            if (chatOptionsBtn) {
                chatOptionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    createHistoryMenu(conv.id, chatOptionsBtn);
                });
            }
            return item;
        };
        // ▲▲▲ 結束修正 ▲▲▲
        const renderArchivedChats = () => {
            ALL_ELEMENTS.archivedChatsContainer.innerHTML = '';
            const archived = conversations.filter(c => c.archived).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (archived.length === 0) {
                ALL_ELEMENTS.archivedChatsContainer.innerHTML = `<p class="text-sm text-[var(--text-secondary)] text-center p-4">${i18n[config.uiLanguage].noArchivedChats || '沒有已封存的對話。'}</p>`;
                return;
            }
            archived.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'p-3 bg-[var(--sidebar-bg)] rounded-md border border-[var(--border-color)]';
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="truncate pr-2 font-medium">${conv.title}</span>
                        <div class="flex gap-2 flex-shrink-0">
                            <button data-id="${conv.id}" class="view-archived-btn text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200">${i18n[config.uiLanguage].view || '檢視'}</button>
                            <button data-id="${conv.id}" class="unarchive-btn text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200">${i18n[config.uiLanguage].restore || '還原'}</button>
                            <button data-id="${conv.id}" class="delete-archived-btn text-xs bg-red-100 text-red-800 px-2 py-1 roundedhover:bg-red-200">${i18n[config.uiLanguage].delete || '刪除'}</button>
                        </div>
                    </div>
                    ${conv.summary ? `<p class="text-xs text-[var(--text-secondary)] mt-2">${conv.summary}</p>` : ''}
                `;
                ALL_ELEMENTS.archivedChatsContainer.appendChild(item);
            });
            ALL_ELEMENTS.archivedChatsContainer.querySelectorAll('.view-archived-btn').forEach(btn => btn.addEventListener('click', (e) => showArchivedChatPreview(e.target.dataset.id, e)));
            ALL_ELEMENTS.archivedChatsContainer.querySelectorAll('.unarchive-btn').forEach(btn => btn.addEventListener('click', (e) => unarchiveChat(e.target.dataset.id, e)));
            ALL_ELEMENTS.archivedChatsContainer.querySelectorAll('.delete-archived-btn').forEach(btn => btn.addEventListener('click', (e) => deleteChat(e.target.dataset.id, e)));
        };
        const renderChat = () => {
            const conv = getActiveConversation();
            
            const messageList = ALL_ELEMENTS.messageList;
            // 為確保動畫重播，先移除 class
            messageList.classList.remove('chat-view-transition');

            if (!conv) {
                messageList.innerHTML = '';
                ALL_ELEMENTS.headerTitle.textContent = i18n[config.uiLanguage].newChat;
                ALL_ELEMENTS.modelSwitcherContainer.innerHTML = '';
                ALL_ELEMENTS.astrasIndicator.classList.add('hidden');
                return;
            }
            ALL_ELEMENTS.headerTitle.textContent = conv.archived ? `(${i18n[config.uiLanguage].archived || '已封存'}) ${conv.title}` : conv.title;
            renderModelSwitcher();
            updateWebSearchUI();
            updateAstrasIndicator();
            
            messageList.innerHTML = ''; // 清空內容
            if (conv.messages.length === 0) {
                const greeting = `${currentUser.username}, ${i18n[config.uiLanguage].howCanIHelp || '有什麼可以為您服務的嗎？'}`;
                messageList.innerHTML = `<div class="text-center text-[var(--text-secondary)] mt-16"><p class="text-lg">${greeting}</p></div>`;
            } else {
                // ▼▼▼ 程式碼修正 ▼▼▼
                conv.messages.forEach((msg, index) => addMessageToUI(msg, index, false, false));
                // ▲▲▲ 程式碼修正 ▲▲▲
            }
            
            // 強制瀏覽器重繪，為動畫做準備
            void messageList.offsetWidth; 

            // 添加 class 以觸發淡入動畫
            messageList.classList.add('chat-view-transition');
            
            updateInputState();
        };
        const updateAstrasIndicator = () => {
            const conv = getActiveConversation();
            const astrasId = conv ? conv.astrasId : null;
            const ast = astras.find(a => a.id === astrasId);
            const astIndicator = ALL_ELEMENTS.astrasIndicator;
            const currentAstrasName = ALL_ELEMENTS.currentAstrasName;
            
            if (ast) {
                currentAstrasName.textContent = ast.name;
                astIndicator.classList.remove('hidden');
            } else {
                astIndicator.classList.add('hidden');
            }
        };
        const getActiveAstrasId = () => {
            const conv = getActiveConversation();
            return conv ? conv.astrasId : null;
        };
        const setAstrasForConversation = (astrasId) => {
            const conv = getActiveConversation();
            if (conv) {
                conv.astrasId = astrasId;
                if (!isTemporaryChat) saveAppData();
                renderAll();
                updateInputState();
            }
        };
        const deactivateAstras = () => {
            const conv = getActiveConversation();
            if (conv) {
                conv.astrasId = null;
                if (!isTemporaryChat) saveAppData();
                renderAll();
                updateInputState();
                showNotification(i18n[config.uiLanguage].astrasDeactivated || '已關閉 Astras。', 'success');
            }
        };
        const createAstras = async () => {
            editingAstrasId = null;
            ALL_ELEMENTS.astrasCreateModal.querySelector('h2').textContent = i18n[config.uiLanguage].createAstras;
            ALL_ELEMENTS.astrasNameInput.value = '';
            ALL_ELEMENTS.astrasDescInput.value = '';
            ALL_ELEMENTS.astrasInstructionsInput.value = '';
            toggleModal(ALL_ELEMENTS.astrasCreateModal, true);
        };
        const handleSaveAstras = async () => {
            const name = ALL_ELEMENTS.astrasNameInput.value.trim();
            const description = ALL_ELEMENTS.astrasDescInput.value.trim();
            const instructions = ALL_ELEMENTS.astrasInstructionsInput.value.trim();
            if (!name || !instructions) {
                showNotification(i18n[config.uiLanguage].nameAndInstructionsRequired || '名稱和指令為必填。', 'error');
                return;
            }
            if (editingAstrasId) {
                const ast = astras.find(a => a.id === editingAstrasId);
                if (ast) {
                    ast.name = name;
                    ast.description = description;
                    ast.instructions = instructions;
                    showNotification(i18n[config.uiLanguage].astrasUpdated || 'Astras 已更新');
                }
                editingAstrasId = null;
            } else {
                const newAstras = {
                    id: crypto.randomUUID(),
                    name,
                    description,
                    instructions,
                    avatarUrl: null, // 新增屬性
                    officialId: null, // 新增屬性
                };
                astras.unshift(newAstras);
                showNotification(i18n[config.uiLanguage].astrasCreated ||'Astras 已創建');
            }
            await saveAppData();
            renderAstras();
            toggleModal(ALL_ELEMENTS.astrasCreateModal, false);
            ALL_ELEMENTS.astrasNameInput.value = '';
            ALL_ELEMENTS.astrasDescInput.value = '';
            ALL_ELEMENTS.astrasInstructionsInput.value = '';
            ALL_ELEMENTS.astrasCreateModal.querySelector('h2').textContent = i18n[config.uiLanguage].createAstras;
        };
        const deleteAstras = async (id) => {
            if (!(await showCustomConfirm(i18n[config.uiLanguage].confirmDeleteAstras || '確定刪除此 Astras？'))) return;
            astras = astras.filter(a => a.id !== id);
            conversations.forEach(c => {
                if (c.astrasId === id) c.astrasId = null;
            });
            await saveAppData();
            renderAll();
            showNotification(i18n[config.uiLanguage].astrasDeleted || 'Astras 已刪除');
        };
        // ▼▼▼ 修改：更新 createAstrasMenu 以新增編輯頭像選項 ▼▼▼
        const createAstrasMenu = (astrasId, targetButton) => {
            const existingPopover = document.getElementById('history-popover');
            if (existingPopover) {
                existingPopover.remove();
                if (existingPopover.dataset.targetId === targetButton.id) return;
            }

            const rect = targetButton.getBoundingClientRect();
            const popover = document.createElement('div');
            popover.id = 'history-popover';
            popover.className = 'popover absolute w-48 rounded-lg border border-[var(--border-color)] z-50';
            popover.dataset.targetId = targetButton.id;
            
            const spaceBelow = window.innerHeight - rect.bottom;
            if (spaceBelow < 150) {
                popover.style.bottom = `${window.innerHeight - rect.top}px`;
                popover.style.transformOrigin = 'bottom';
            } else {
                popover.style.top = `${rect.bottom}px`;
                popover.style.transformOrigin = 'top';
            }
            
            popover.style.left = `${rect.left}px`;
            
            popover.innerHTML = `
                <button data-id="${astrasId}" class="edit-astras-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].edit || '編輯'}</button>
                <button data-id="${astrasId}" class="edit-avatar-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].editAvatar || '編輯頭像'}</button>
                <button data-id="${astrasId}" class="delete-astras-btn w-full text-left px-4 py-2 text-red-600 hover:bg-red-500/10 text-sm">${i18n[config.uiLanguage].delete || '刪除'}</button>
            `;
            document.body.appendChild(popover);
            
            requestAnimationFrame(() => popover.classList.add('visible'));

            popover.querySelector('.edit-astras-btn').addEventListener('click', () => {
                const ast = astras.find(a => a.id === astrasId);
                if (ast) {
                    editingAstrasId = astrasId;
                    ALL_ELEMENTS.astrasNameInput.value = ast.name;
                    ALL_ELEMENTS.astrasDescInput.value = ast.description;
                    ALL_ELEMENTS.astrasInstructionsInput.value = ast.instructions;
                    ALL_ELEMENTS.astrasCreateModal.querySelector('h2').textContent = i18n[config.uiLanguage].editAstras || '編輯 Astras';
                    toggleModal(ALL_ELEMENTS.astrasCreateModal, true);
                }
                popover.remove();
            });
            popover.querySelector('.edit-avatar-btn').addEventListener('click', () => {
                openAvatarEditor(astrasId);
                popover.remove();
            });
            popover.querySelector('.delete-astras-btn').addEventListener('click', () => { deleteAstras(astrasId); popover.remove(); });
        };
        // ▲▲▲ 結束修改 ▲▲▲
        const updateWebSearchUI = () => {
            const conv = getActiveConversation();
            const { webSearchBtn } = ALL_ELEMENTS;
            if (!conv || conv.provider !== 'gemini') {
                webSearchBtn.classList.add('hidden');
                return;
            }
            webSearchBtn.classList.remove('hidden');
            webSearchBtn.classList.toggle('active', !!conv.isWebSearchEnabled);
        };
        const updateFileInputUI = () => {
            const conv = getActiveConversation();
            const modelInfo = MODELS.find(m => m.id === conv?.model);
            const { fileInputContainer } = ALL_ELEMENTS;
            if (modelInfo?.provider === 'gemini') {
                fileInputContainer.classList.remove('hidden');
            } else {
                fileInputContainer.classList.add('hidden');
                if (uploadedFiles.length > 0) {
                    uploadedFiles = [];
                    renderFilePreviews();
                }
            }
        };


        const renderModelSwitcher = () => {
            const conv = getActiveConversation();
            ALL_ELEMENTS.modelSwitcherContainer.innerHTML = '';
            if (!conv) return;
            const visibleModels = config.modelSettings
                .filter(s => !s.hidden)
                .sort((a, b) => a.order - b.order)
                .map(s => MODELS.find(m => m.id === s.id))
                .filter(Boolean);
            const currentModel = MODELS.find(m => m.id === conv.model) || MODELS[0];
            const isArchived = conv.archived;
            let optionsHTML = '';
            const translations = i18n[config.uiLanguage] || i18n['zh-TW']; // 取得目前的語言包

            visibleModels.forEach(m => {
                // 從語言包中讀取描述和限制，如果找不到則顯示空字串
                const description = translations[m.descriptionKey] || '';
                const limits = translations[m.limitsKey] || '';

                optionsHTML += `
                    <div data-model="${m.id}" class="model-option-btn-container ${isArchived ? 'cursor-not-allowed opacity-50' : ''}">
                        <h4 class="font-semibold">${m.name}</h4>
                        <p class="model-description">${description}<span class="whitespace-nowrap"> (${limits})</span></p>
                    </div>
                `;
            });
            {/* <!-- ▼▼▼ 修正 #1：提升 z-index ▼▼▼ --> */}
            ALL_ELEMENTS.modelSwitcherContainer.innerHTML = `
                <button id="current-model-btn" class="flex items-center gap-2 text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] px-2 py-1 md:px-3 rounded-md ${isArchived ? 'cursor-not-allowed' : ''}" ${isArchived ? 'disabled' : ''}>
                    <span class="font-semibold text-sm md:text-base text-[var(--text-primary)]">${currentModel.name}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div id="model-options-popover" class="popover absolute right-0 mt-6 w-72 md:w-80 rounded-lg border border-[var(--border-color)] z-50">
                    ${optionsHTML}
                </div>
            `;
            {/* <!-- ▲▲▲ 結束修正 ▲▲▲ --> */}

            if (!isArchived) {
                document.getElementById('current-model-btn').addEventListener('click', () => {
                    const popover = document.getElementById('model-options-popover');
                    if (popover.classList.contains('visible')) {
                        popover.classList.remove('visible');
                    } else {
                        closeAllPopovers();
                        popover.classList.add('visible');
                    }
                });
                document.querySelectorAll('.model-option-btn-container').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const newModelId = e.currentTarget.dataset.model;
                        const newModelInfo = MODELS.find(m => m.id === newModelId);
                        if (newModelInfo) {
                            conv.model = newModelInfo.id;
                            conv.provider = newModelInfo.provider;
                            config.lastUsedModel = newModelId;
                            saveAppData();
                            saveConfig();
                            renderModelSwitcher();
                            updateInputState();
                            updateWebSearchUI();
                            updateFileInputUI(); // Update file input on model change
                        }
                        document.getElementById('model-options-popover').classList.remove('visible');
                    });
                });
            }
            updateFileInputUI(); // Initial check
            updateApiKeyWarningBadge();
        };
        
        // ▼▼▼ 程式碼修改 ▼▼▼
        const addMessageToUI = (msg, index, shouldSave = true, shouldScroll = true) => {
            const conv = getActiveConversation();
            if (shouldSave) {
                 if (isTemporaryChat) {
                    conv.messages.push(msg);
                } else {
                    conv.messages.push(msg);
                    if (conv.messages.length === 1 && msg.role === 'user' && !conv.isRenamed && config.autoNaming) {
                        const textPart = msg.parts.find(p => p.text);
                        if (textPart) {
                            conv.title = textPart.text.substring(0, 30) || i18n[config.uiLanguage].newChat || '新對話';
                            ALL_ELEMENTS.headerTitle.textContent = conv.title;
                            renderHistorySidebar();
                            generateTitleAndSummary(conv);
                        }
                    }
                    saveAppData();
                }
            }
            const messageDiv = document.createElement('div');
            messageDiv.dataset.messageIndex = index;
            const isUser = msg.role === 'user';
            messageDiv.className = `message-item flex items-start gap-2 md:gap-4 ${isUser ? 'justify-end user-message' : 'model-message'}`;
            const icon = isUser ? `<div class="bg-blue-600 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold">${currentUser ? currentUser.username.charAt(0).toUpperCase() : 'Y'}</div>` : `<div class="bg-gray-800 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 15h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>`;


            let contentHTML = '';
            let actionButtons = '';
            let contentPaddingClass = '';

            const isLoadingMessage = !isUser && msg.parts.length === 1 && msg.parts[0].text === '...';
            
            if (isLoadingMessage) {
                contentHTML = `<div class="loading-dots"><span class="bg-gray-500 dark:bg-gray-400"></span><span class="bg-gray-500 dark:bg-gray-400"></span><span class="bg-gray-500 dark:bg-gray-400"></span></div>`;
            } else {
                let textPartsContent = [];
                let mediaPartsContent = [];
                msg.parts.forEach(part => {
                    if (part.text) {
                        textPartsContent.push(part.text);
                    } else if (part.inlineData) {
                        mediaPartsContent.push(part.inlineData);
                    }
                });
                if (textPartsContent.length > 0) {
                    const combinedText = textPartsContent.join('\n');
                    contentHTML += `<div>${isUser ? combinedText.replace(/\n/g, '<br>') : renderMarkdown(combinedText)}</div>`;
                }
                if (mediaPartsContent.length > 0) {
                    let mediaHTML = '<div class="mt-2 flex flex-wrap gap-2">';
                    mediaPartsContent.forEach(media => {
                        const src = `data:${media.mimeType};base64,${media.data}`;
                        if (media.mimeType.startsWith('image/')) {
                            mediaHTML += `<img src="${src}" class="max-w-xs max-h-48 rounded-lg object-cover border border-[var(--border-color)]">`;
                        } else {
                            mediaHTML += `<div class="p-2 bg-[var(--hover-bg)] rounded-lg text-sm flex items-center gap-2 border border-[var(--border-color)]">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                <span>${media.name || '檔案'}</span>
                            </div>`;
                        }
                    });
                    mediaHTML += '</div>';
                    contentHTML += mediaHTML;
                }
                
                if (!isUser) {
                    const timeString = formatFullTimestamp(msg.createdAt);
                    actionButtons = `
                        <div class="absolute bottom-2 left-2 right-2 flex justify-between items-center">
                            <button class="copy-content-btn p-1 rounded-md hover:bg-gray-500/20 text-[var(--text-secondary)] opacity-50 hover:opacity-100 transition-opacity" title="${i18n[config.uiLanguage].copyContent || '複製內容'}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                            <span class="text-xs text-gray-400">${timeString}</span>
                        </div>
                    `;
                    contentPaddingClass = 'pb-8'; 
                } else {
                    const currentConv = getActiveConversation();
                    if (currentConv && index + 1 < currentConv.messages.length && currentConv.messages[index + 1].role === 'model') {
                         actionButtons = `
                            <div class="absolute bottom-2 left-2 flex items-center">
                                <button class="delete-message-btn p-1 rounded-md hover:bg-gray-500/20 text-gray-400 hover:text-red-400 opacity-50 hover:opacity-100 transition-all" title="${i18n[config.uiLanguage].deletePair || '刪除此對話與 AI 回覆'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        `;
                        contentPaddingClass = 'pb-8';
                    }
                }
            }

            const messageBubble = `
                <div class="p-3 md:p-4 rounded-lg shadow-sm max-w-full md:max-w-xl message-bubble relative ${isUser ? 'text-white' : ''}" >
                    <div class="prose prose-sm max-w-none ${isUser ? 'text-white' : 'text-[var(--text-primary)]'} ${contentPaddingClass} message-content">${contentHTML}</div>
                    ${actionButtons}
                </div>`;

            messageDiv.innerHTML = isUser ? `${messageBubble}${icon}` : `${icon}${messageBubble}`;
            if (ALL_ELEMENTS.messageList.querySelector('.text-center')) ALL_ELEMENTS.messageList.innerHTML = '';

            ALL_ELEMENTS.messageList.appendChild(messageDiv);
            if (shouldScroll) {
                ALL_ELEMENTS.chatContainer.scrollTo({ top: ALL_ELEMENTS.chatContainer.scrollHeight, behavior: 'smooth' });
            }

            return messageDiv;
        };
        // ▲▲▲ 程式碼修改 ▲▲▲

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            if (abortController) return;
            const userMessage = ALL_ELEMENTS.messageInput.value.trim();
            if (!userMessage && uploadedFiles.length === 0) return;

            renderFollowUpPrompts([]);

            const conv = getActiveConversation();
            if (conv.archived) return;


            abortController = new AbortController();
            updateSubmitButtonState(true);

            if (!sendConfirmed) {
                sendConfirmed = true;
                updateInputState();
                return;
            }


            const userParts = [];
            if (userMessage) {
                userParts.push({ text: userMessage });
            }
            uploadedFiles.forEach(file => {
                userParts.push({
                    inlineData: {
                        mimeType: file.type,
                        data: file.base64.split(',')[1]
                    }
                });
            });

            const userMessageObject = { role: 'user', parts: userParts, createdAt: new Date().toISOString() };
            addMessageToUI(userMessageObject, conv.messages.length, true);


            if (config.enableAutoWebSearch && conv.provider === 'gemini' && !conv.isWebSearchEnabled) {
                try {
                    const needsSearch = await shouldPerformWebSearch(userMessage);
                    if (needsSearch) {
                        conv.isWebSearchEnabled = true;
                        showNotification(i18n[config.uiLanguage].autoWebSearchNotice || '偵測到問題需要連網搜尋，已自動開啟。', 'warning');
                    }
                    updateWebSearchUI();
                } catch(err) {
                    console.error("Auto web search check failed:", err);
                }
            }


            ALL_ELEMENTS.messageInput.value = '';
            uploadedFiles = [];
            renderFilePreviews();
            
            const loadingMessageDiv = addMessageToUI({ role: 'model', parts: [{ text: '...' }], createdAt: new Date().toISOString() }, conv.messages.length, false);
            const contentDiv = loadingMessageDiv.querySelector('.message-content');
            let fullResponse = '';
            
            const finalAiMessage = { role: 'model', parts: [{ text: '' }], createdAt: new Date().toISOString() };

            try {
                const completeResponse = await streamApiCall(
                    userParts,
                    (chunk) => {
                        fullResponse += chunk;
                        contentDiv.innerHTML = renderMarkdown(fullResponse);
                        const isUserScrolledToBottom = ALL_ELEMENTS.chatContainer.scrollHeight - ALL_ELEMENTS.chatContainer.scrollTop <= ALL_ELEMENTS.chatContainer.clientHeight + 1;
                        if (isUserScrolledToBottom) {
                            ALL_ELEMENTS.chatContainer.scrollTo({ top: ALL_ELEMENTS.chatContainer.scrollHeight, behavior: 'smooth' });
                        }
                    },
                    abortController.signal
                );
                fullResponse = completeResponse;
                finalAiMessage.parts = [{ text: fullResponse }];
                conv.messages.push(finalAiMessage);
                if (!isTemporaryChat) await saveAppData();


                if(config.enableFollowUp) {
                    await generateFollowUpPrompts(fullResponse);
                }
                if (config.memoryEnabled1 && config.enableAutoMemory) { // 檢查兩個開關
                    await extractPersonalMemory(userMessage, fullResponse);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    contentDiv.innerHTML = renderMarkdown(fullResponse);
                    finalAiMessage.parts = [{ text: fullResponse }];
                    conv.messages.push(finalAiMessage);
                } else {
                    contentDiv.textContent = `${i18n[config.uiLanguage].errorPrefix || '抱歉，發生錯誤：'}${error.message}`;
                    finalAiMessage.parts = [{ text: `${i18n[config.uiLanguage].errorPrefix || '抱歉，發生錯誤：'}${error.message}` }];
                    conv.messages.push(finalAiMessage);
                }
                if (!isTemporaryChat) await saveAppData();
            } finally {
                abortController = null;
                updateSubmitButtonState(false);
                sendConfirmed = false;
                updateInputState();
                
                // ▼▼▼ 優化：AI 回覆完成後，不再重新渲染整個聊天室，而是僅更新最後一則訊息的 UI ▼▼▼
                const lastMessageDiv = ALL_ELEMENTS.messageList.lastElementChild;
                if (lastMessageDiv && lastMessageDiv.classList.contains('model-message')) {
                    const bubble = lastMessageDiv.querySelector('.message-bubble');
                    const content = lastMessageDiv.querySelector('.message-content');
                    const aiMessageObject = conv.messages[conv.messages.length - 1];

                    if (bubble && content && aiMessageObject && !bubble.querySelector('.absolute')) { 
                        content.classList.add('pb-8');
                        
                        const timeString = formatFullTimestamp(aiMessageObject.createdAt);
                        const actionButtonsHTML = `
                            <div class="absolute bottom-2 left-2 right-2 flex justify-between items-center">
                                <button class="copy-content-btn p-1 rounded-md hover:bg-gray-500/20 text-[var(--text-secondary)] opacity-50 hover:opacity-100 transition-opacity" title="${i18n[config.uiLanguage].copyContent || '複製內容'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                                <span class="text-xs text-gray-400">${timeString}</span>
                            </div>
                        `;
                        bubble.insertAdjacentHTML('beforeend', actionButtonsHTML);
                    }
                }

                const userMessageDiv = lastMessageDiv ? lastMessageDiv.previousElementSibling : null;
                if (userMessageDiv && userMessageDiv.classList.contains('user-message')) {
                    const bubble = userMessageDiv.querySelector('.message-bubble');
                    const content = userMessageDiv.querySelector('.message-content');
                    if (bubble && content && !bubble.querySelector('.delete-message-btn')) {
                        content.classList.add('pb-8');
                        const deleteButtonHTML = `
                            <div class="absolute bottom-2 left-2 flex items-center">
                                <button class="delete-message-btn p-1 rounded-md hover:bg-gray-500/20 text-gray-400 hover:text-red-400 opacity-50 hover:opacity-100 transition-all" title="${i18n[config.uiLanguage].deletePair || '刪除此對話與 AI 回覆'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        `;
                        bubble.insertAdjacentHTML('beforeend', deleteButtonHTML);
                    }
                }
                // ▲▲▲ 結束優化 ▲▲▲
            }
        };
        function cleanGeminiHistory(history) {
            const cleaned = []; let lastRole = null;
            history.forEach(msg => {
                // 修正重點：
                // 創建一個只包含 API 所需的 role 和 parts 欄位的新物件，
                // 藉此移除如 createdAt 等自訂的額外屬性。
                const sanitizedMsg = { role: msg.role, parts: msg.parts };

                if (sanitizedMsg.role === 'model' && !sanitizedMsg.parts.some(p => (p.text && p.text.trim() !== '') || p.inlineData)) return;
                
                if (sanitizedMsg.role === lastRole && lastRole === 'user') {
                    cleaned[cleaned.length - 1].parts.push(...sanitizedMsg.parts);
                } else {
                    cleaned.push(sanitizedMsg);
                    lastRole = sanitizedMsg.role;
                }
            });
            if (cleaned.length > 0 && cleaned[0].role !== 'user') cleaned.shift();
            return cleaned;
        }
        async function streamApiCall(parts, onChunk, signal) {
            const conv = getActiveConversation();
            const modelInfo = MODELS.find(m => m.id === conv.model);
            
