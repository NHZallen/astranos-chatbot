<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÈÄ≤Èöé AI ËÅäÂ§©Ê©üÂô®‰∫∫ Astra-nos-15.3.10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
    body {
    touch-action: manipulation;
}
    #file-options-popover button {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
    @keyframes indicator-enter {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}


@keyframes indicator-exit {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}
.input-indicator-item {
}


.input-indicator-item.enter {
    animation: indicator-enter 0.3s ease-out forwards;
}


.input-indicator-item.exit {
    animation: indicator-exit 0.3s ease-out forwards;
}
#store-category-list {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
    -webkit-overflow-scrolling: touch; /* ÁÇ∫‰∫ÜÂú®Ë°åÂãïË£ùÁΩÆ‰∏äÊúâÊõ¥Â•ΩÁöÑÊªæÂãïÈ´îÈ©ó */
}
#store-category-list::-webkit-scrollbar {
    display: none;
}
.store-category-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    background-color: transparent;
    cursor: pointer;
    white-space: nowrap; /* Á¢∫‰øùÊåâÈàïÊñáÂ≠ó‰∏çÊèõË°å */
    transition: all 0.2s ease-in-out;
}
.store-category-btn:hover {
    color: var(--text-primary);
    background-color: var(--hover-bg);
    border-color: var(--text-primary);
}
.store-category-btn.active {
    color: var(--button-primary-text);
    background-color: var(--button-primary-bg);
    border-color: transparent;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
    :root {
        --chat-bg: #ffffff;
        --sidebar-bg: #f7f7f8;
        --input-bar-bg: #ffffff;
        --input-field-bg: #f9fafb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --border-color: #e5e7eb;
        --hover-bg: #f3f4f6;
        --active-bg: #e5e7eb;
        --modal-bg: #ffffff;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --ai-bubble-bg: var(--sidebar-bg);
        --user-bubble-bg: #3b82f6;
        --button-primary-bg: #3b82f6;
        --button-primary-hover-bg: #2563eb;
        --button-primary-text: #ffffff;
    }
    .dark {
        --chat-bg: #111111;
        --sidebar-bg: #1c1c1c;
        --input-bar-bg: #1c1c1c;
        --input-field-bg: #2d2d2d;
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --border-color: #374151;
        --hover-bg: #374151;
        --active-bg: #4b5563;
        --modal-bg: #1f2937;
        --shadow-color: rgba(0, 0, 0, 0.4);
        --ai-bubble-bg: var(--sidebar-bg);
        --user-bubble-bg: #2563eb;
    }
    @keyframes subtleFadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes subtleScaleIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    button, .sidebar-item, .settings-nav-item, .theme-btn, .voice-input-btn, .model-option-btn-container, .color-option {
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
    }
button:not(.btn-primary):hover:not(:disabled) {
    transform: translateY(-1px);
    filter: brightness(95%);
}
button:not(.btn-primary):active:not(:disabled) {
    transform: translateY(0px);
    box-shadow: none;
    filter: brightness(90%);
}
    body { background-color: var(--chat-bg); color: var(--text-primary); }
    .scroll-area {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-y: contain;
    }
    body.modal-open {
        overflow: hidden;
    }
    .sidebar {
        background-color: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    .scroll-area::-webkit-scrollbar { width: 8px; }
    .scroll-area::-webkit-scrollbar-track { background: transparent; }
    .scroll-area::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    .scroll-area::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    .modal {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
    }
    .modal.visible { opacity: 1; visibility: visible; }
    .modal > div {
        transform: scale(0.95);
        transition: transform 0.2s ease-in-out;
    }
    .modal.visible > div { transform: scale(1); }
    #auth-container {
        transition: opacity 0.4s ease-out, transform 0.4s ease-out;
    }
    #auth-container.fade-out {
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
    }
    #app-container, #store-container {
        opacity: 0;
        transform: scale(1.05);
        transition: opacity 0.4s ease-in 0.2s, transform 0.4s ease-in 0.2s;
    }
    #app-container.visible, #store-container.visible {
        opacity: 1;
        transform: scale(1);
    }
    @keyframes chatFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .chat-view-transition {
        animation: chatFadeIn 0.3s ease-out forwards;
    }
    .folder-item > .folder-content-container {
        overflow-y: hidden;
        transition: max-height 0.35s cubic-bezier(0.4, 0.0, 0.2, 1);
        max-height: 0;
    }
    .folder-item[data-open="true"] > .folder-content-container {
        max-height: 100vh;
        transition: max-height 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    @keyframes pulse-glow {
        from {
            box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.4);
            border-color: rgba(59, 130, 246, 0.8);
        }
        to   {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0);
            border-color: var(--border-color);
        }
    }
    .input-wrapper {
    transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out, padding-top 0.3s ease-in-out; /* Êñ∞Â¢û padding-top ÁöÑÈÅéÊ∏°ÊïàÊûú */
    position: relative;
    flex-direction: column;
    padding-top: 0; /* ‚ú® Êñ∞Â¢ûÔºöÈ†êË®≠Ê≤íÊúâ‰∏äÊñπÂÖßÈÇäË∑ù */
}
    #message-input {
    line-height: 1.5rem; /* Ë®≠ÂÆöË°åÈ´òÔºåÈÄôÂ∞çÊñºË®àÁÆóÈ´òÂ∫¶ÂæàÈáçË¶Å */
    max-height: calc(1.5rem * 8 + 1rem); /* 8Ë°åÁöÑÈ´òÂ∫¶ (8 * Ë°åÈ´ò) + ‰∏ä‰∏ã padding (p-2 = 0.5rem * 2) */
    transition: height 0.2s ease-out; /* ËÆìÈ´òÂ∫¶ËÆäÂåñÊúâÂπ≥ÊªëÁöÑÂãïÁï´ÊïàÊûú */
    overflow-y: auto; /* Áï∂ÂÖßÂÆπË∂ÖÂá∫ÊúÄÂ§ßÈ´òÂ∫¶ÊôÇÔºåÈ°ØÁ§∫ÊªæÂãïÊ¢ù */
    -webkit-overflow-scrolling: touch; /* ---> Êñ∞Â¢ûÔºöÂú® iOS Á≠âË£ùÁΩÆ‰∏äÂïüÁî®ÊÖ£ÊÄßÊªæÂãï <--- */
    scrollbar-width: thin; /* ---> Êñ∞Â¢ûÔºöËÆìÊªæÂãïÊ¢ùËÆäÁ¥∞‰∏Ä‰∫õ (ÈÅ©Áî®Êñº Firefox) <--- */
    scrollbar-color: var(--border-color) transparent; /* ---> Êñ∞Â¢ûÔºöË®≠ÂÆöÊªæÂãïÊ¢ùÈ°èËâ≤ <--- */
}
#message-input::-webkit-scrollbar {
    width: 6px;
}
#message-input::-webkit-scrollbar-thumb {
    background-color: var(--border-color);
    border-radius: 3px;
}
#message-input::-webkit-scrollbar-track {
    background: transparent;
}


#message-input.expanded {
    max-height: 50vh; /* Â±ïÈñãÂæåÁöÑÊúÄÂ§ßÈ´òÂ∫¶ÔºåË®≠ÂÆöÁÇ∫Ë¶ñÁ™óÈ´òÂ∫¶ÁöÑ‰∏ÄÂçä */
}


#expand-input-btn.rotated {
    transform: rotate(180deg); /* ËÆìÁÆ≠È†≠ÊóãËΩâ180Â∫¶ÔºåË°®Á§∫ÂèØÊî∂Âêà */
}
    #input-bar-container .input-wrapper.has-indicators > .flex.items-end {
    margin-top: 0.9rem; /* 8px ÁöÑÈñìË∑ùÔºåÊÇ®ÂèØ‰ª•‰æùÂñúÂ•ΩË™øÊï¥ÈÄôÂÄãÊï∏ÂÄº */
}
    .input-wrapper.has-indicators {
    padding-top: 2.25rem; /* 36pxÔºåÁÇ∫ÊåáÁ§∫Âô®ÁïôÂá∫Á©∫ÈñìÔºåÂèØÂæÆË™ø */
}


#input-indicator-container {
    position: absolute;
    top: 0.5rem; /* Ë∑ùÈõ¢È†ÇÈÉ® 8px */
    left: 0.5rem; /* Ë∑ùÈõ¢Â∑¶ÂÅ¥ 8px */
    right: 0.5rem; /* Ë∑ùÈõ¢Âè≥ÂÅ¥ 8px */
    
    display: flex;
    overflow-x: auto;
    white-space: nowrap;
    -ms-overflow-style: none; /* IE and Edge */
    scrollbar-width: none;   /* Firefox */
    -webkit-overflow-scrolling: touch;
}


#input-indicator-container::-webkit-scrollbar {
    display: none; /* Èö±ËóèÊªæÂãïÊ¢ù */
}


#input-indicator-container .input-indicator-item {
    flex-shrink: 0; /* Èò≤Ê≠¢È†ÖÁõÆË¢´Â£ìÁ∏Æ */
}
    .input-wrapper.pulse-glow {
        animation: pulse-glow 0.7s ease-out;
    }
    #auth-container .auth-form-container {
        animation: subtleFadeInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    .sidebar {
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        background-color: rgba(255, 255, 255, 0.55);
        border-right: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 4px 0px 15px rgba(0, 0, 0, 0.05);
        --border-color: rgba(0, 0, 0, 0.1);
    }
    .dark .sidebar {
        background-color: rgba(30, 30, 30, 0.5);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 4px 0px 20px rgba(0, 0, 0, 0.2);
        --border-color: rgba(255, 255, 255, 0.1);
    }
    .popover {
        box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
        background-color: var(--modal-bg);
        opacity: 0;
        visibility: hidden;
        transform: scale(0.95) translateY(-10px);
        transition: opacity 0.15s ease-out, transform 0.15s ease-out, visibility 0.15s;
        transform-origin: top;
    }
    .popover.visible {
        opacity: 1;
        visibility: visible;
        transform: scale(1) translateY(0);
    }
    #model-options-popover { transform-origin: top right; }
#file-options-popover {
    background-color: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 0.5rem;
    transform-origin: bottom left;
    transform: scale(0.95) translateY(10px);
}
.dark #file-options-popover {
    background-color: rgba(30, 30, 30, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.15);
}
#file-options-popover.visible {
    transform: scale(1) translateY(0);
}
#file-options-popover button {
    color: #111827;
}
.dark #file-options-popover button {
    color: #f9fafb;
}
#file-options-popover button svg {
    color: inherit;
    opacity: 0.7;
}
#file-options-popover button:hover {
    background-color: rgba(255, 255, 255, 0.15);
}
.dark #file-options-popover button:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
    .folder-summary .folder-arrow {
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    .folder-item[data-open="true"] .folder-summary .folder-arrow {
        transform: rotate(90deg);
    }
    #batch-action-bar {
        transition: opacity 0.3s ease, transform 0.3s ease;
        transform: translateY(0);
        opacity: 1;
    }
    #batch-action-bar.hidden {
        opacity: 0;
        transform: translateY(20px);
        pointer-events: none;
    }
    #sidebar-overlay {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), visibility 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    #sidebar-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .settings-section {
        display: none;
        animation: subtleFadeInUp 0.4s ease-out;
    }
    .settings-section.active {
        display: block;
    }
    :root {
        --chat-bg: #ffffff;
        --sidebar-bg: #f7f7f8;
        --input-bar-bg: #ffffff;
        --input-field-bg: #f9fafb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --border-color: #e5e7eb;
        --hover-bg: #f3f4f6;
        --active-bg: #e5e7eb;
        --modal-bg: #ffffff;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --ai-bubble-bg: var(--sidebar-bg);
        --user-bubble-bg: #3b82f6;
        --button-primary-bg: #3b82f6;
        --button-primary-hover-bg: #2563eb;
        --button-primary-text: #ffffff;
    }
    .dark {
        --chat-bg: #111111;
        --sidebar-bg: #1c1c1c;
        --input-bar-bg: #1c1c1c;
        --input-field-bg: #2d2d2d;
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --border-color: #374151;
        --hover-bg: #374151;
        --active-bg: #4b5563;
        --modal-bg: #1f2937;
        --shadow-color: rgba(0, 0, 0, 0.4);
        --ai-bubble-bg: var(--sidebar-bg);
        --user-bubble-bg: #2563eb;
    }
    body { background-color: var(--chat-bg); color: var(--text-primary); }
    .scroll-area {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-y: contain;
    }
    body.modal-open {
        overflow: hidden;
    }
    .scroll-area::-webkit-scrollbar { width: 8px; }
    .scroll-area::-webkit-scrollbar-track { background: transparent; }
    .scroll-area::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    .scroll-area::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    #notification-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .notification {
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        font-weight: 500;
        animation: fadeInRight 0.3s ease, fadeOutRight 0.3s ease 2.7s forwards;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
    }
    .dark .notification {
        background-color: rgba(20, 20, 20, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    .notification.success { color: #22c55e; }
    .notification.error { color: #ef4444; }
    .notification.warning { color: #f97316; }
    .message-item { animation: slideInUp 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
    @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .loading-dots { display: flex; align-items: center; justify-content: center; height: 1.25rem; }
    .loading-dots span { display: inline-block; width: 8px; height: 8px; margin: 0 2px; background-color: var(--text-secondary); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    .prose code:not(pre *) { background-color: var(--hover-bg); padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 6px; color: var(--text-primary); border: 1px solid var(--border-color); }
    .prose pre {
    background-color: #111827;
    color: #f3f4f6;
    padding: 1em;
    border-radius: 0.5em;
    overflow-x: auto;
    white-space: pre-wrap; /* ---> Êñ∞Â¢ûÔºöÂÖÅË®±Á®ãÂºèÁ¢ºÂú®‰øùÁïôÊ†ºÂºèÁöÑÊÉÖÊ≥Å‰∏ãËá™ÂãïÊèõË°å <--- */
    word-break: break-all;  /* ---> Êñ∞Â¢ûÔºöÂº∑Âà∂ÈÅéÈï∑ÁöÑÂñÆË©û(Â¶ÇURL)‰πüËÉΩË¢´Êñ∑Èñã <--- */
}
    .prose pre code { background-color: transparent; padding: 0; color: inherit; border: none; }
    .prose h1, .prose h2, .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: bold; }
    .prose h1 { font-size: 1.875rem; }
    .prose h2 { font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
    .prose h3 { font-size: 1.25rem; }
    .prose p { margin-bottom: 1em; }
    .prose table {
  /* ‚ú® Êñ∞Â¢û: ËÆìË°®Ê†ºÂÉè‰∏ÄÂÄãÂçÄÂ°ä‰∏ÄÊ®£ÂèØ‰ª•Ë¢´ÊªæÂãïÂÆπÂô®ËôïÁêÜ */
  display: block;
  /* ‚ú® Êñ∞Â¢û: ËÆìË°®Ê†ºÁöÑÂØ¨Â∫¶Áî±ÂÖ∂ÂÖßÂÆπÊíêÈñãÔºåÈÄôÊòØÂØ¶ÁèæÊªæÂãïÁöÑÈóúÈçµ */
  width: max-content;
  /* ‚ú® Êñ∞Â¢û: Á¢∫‰øùË°®Ê†ºÁöÑÊúÄÂ§ßÂØ¨Â∫¶‰∏çÊúÉË¢´ÊÑèÂ§ñÈôêÂà∂ÔºåÂÖÅË®±ÂÆÉËá™Áî±Âª∂‰º∏ */
  max-width: 100%;
  /* ‚ú® Êñ∞Â¢û: ËÆìË°®Ê†ºÊú¨Ë∫´ÂèØ‰ª•Ê∞¥Âπ≥ÊªæÂãï */
  overflow-x: auto;
  
  border-collapse: collapse;
  margin-bottom: 1em;

  /* üëá ‰ª•‰∏ãÁÇ∫ÂèØÈÅ∏ÁöÑÂÑ™ÂåñÔºåËÆìÊªæÂãïÊ¢ùÊõ¥Â•ΩÁúã üëá */
  -webkit-overflow-scrolling: touch; /* Âú® iOS ‰∏äÊèê‰æõÊõ¥ÊµÅÊö¢ÁöÑÊÖ£ÊÄßÊªæÂãï */
  scrollbar-width: thin; /* ËÆìÊªæÂãïÊ¢ùËÆäÁ¥∞ (ÈÅ©Áî®Êñº Firefox) */
  scrollbar-color: var(--border-color) transparent; /* Ë®≠ÂÆöÊªæÂãïÊ¢ùÈ°èËâ≤ */
}

/* üëá Êñ∞Â¢û: ÈáùÂ∞ç Webkit Ê†∏ÂøÉÁÄèË¶ΩÂô® (Chrome, Safari) ÁöÑÊªæÂãïÊ¢ùÊ®£Âºè üëá */
.prose table::-webkit-scrollbar {
    height: 8px; /* ÊªæÂãïÊ¢ùÈ´òÂ∫¶ */
}
.prose table::-webkit-scrollbar-thumb {
    background-color: var(--border-color); /* ÊªæÂãïÊ¢ùÊªëÂ°äÈ°èËâ≤ */
    border-radius: 4px; /* ÂúìËßí */
}
.prose table::-webkit-scrollbar-track {
    background: transparent; /* ËªåÈÅìËÉåÊôØ */
}
    .prose table th, .prose table td { border: 1px solid var(--border-color); padding: 0.75rem; text-align: left; }
    .prose table thead { background-color: var(--hover-bg); }
    .prose table tr:nth-child(even) { background-color: var(--hover-bg); }
    .prose ul, .prose ol { margin-bottom: 1em; padding-left: 1.5em; }
    .prose ul li, .prose ol li { margin-bottom: 0.5em; }
    .folder-summary {
        cursor: pointer;
    }
    .color-swatch, .icon-option { transition: transform 0.2s; border: 2px solid transparent; }
    .color-swatch:hover, .icon-option:hover { transform: scale(1.1); }
    .color-swatch.selected { border-color: #3b82f6; }
    .icon-option.selected { background-color: var(--active-bg); border-color: #3b82f6; }
    #sidebar.open {
        transform: translateX(0);
    }
    @media (min-width: 1024px) {
        #sidebar-overlay.visible {
            left: 288px;
        }
    }
    .theme-button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        padding: 0.25rem;
        background-color: var(--sidebar-bg);
        border-radius: 0.5rem;
    }
    .theme-btn {
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-align: center;
        transition: background-color 0.2s;
    }
.btn-primary {
    background: var(--button-primary-bg-override, linear-gradient(to bottom,
        color-mix(in srgb, var(--button-primary-bg) 95%, white) 0%,
        color-mix(in srgb, var(--button-primary-bg) 90%, black) 100%
    ));
    color: var(--button-primary-text);
    border: 1px solid color-mix(in srgb, var(--button-primary-bg) 50%, black);
    border-bottom-color: color-mix(in srgb, var(--button-primary-bg) 40%, black);
    box-shadow:
        inset 0 1px 1px rgba(255, 255, 255, 0.45),
        0 4px 8px rgba(0, 0, 0, 0.2);
    text-shadow: 0 -1px 1px rgba(0, 0, 0, 0.2);
    position: relative;
    transition: all 0.15s ease-out;
}
.btn-primary::before {
    content: '';
    position: absolute;
    top: 1px;
    left: 2px;
    right: 2px;
    height: 50%;
    background: linear-gradient(to bottom,
        rgba(255, 255, 255, 0.5),
        rgba(255, 255, 255, 0)
    );
    border-radius: inherit;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}
.btn-primary:hover:not(:disabled) {
    filter: brightness(1.05);
    transform: translateY(-2px);
    box-shadow:
        inset 0 1px 1px rgba(255, 255, 255, 0.5),
        0 6px 12px rgba(0, 0, 0, 0.25);
}
.btn-primary:active:not(:disabled) {
    transform: translateY(1px);
    filter: brightness(0.9);
    box-shadow:
        inset 0 2px 4px rgba(0, 0, 0, 0.3);
    transition-duration: 0.05s;
}
    .theme-btn.active {
        background: var(--button-primary-bg);
        color: var(--button-primary-text);
    }
    #follow-up-prompts-list {
      max-height: 200px;
      overflow-y: auto;
      transition: max-height 0.3s ease-out, margin-top 0.3s ease-out;
    }
    #follow-up-prompts-list:not(.collapsed) {
        margin-top: 0.5rem;
    }
    #follow-up-prompts-list.collapsed {
        max-height: 0;
        margin-top: 0;
        margin-bottom: 0;
        overflow: hidden;
    }
    .follow-up-prompt-btn {
    background-color: var(--hover-bg);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    cursor: pointer;
    white-space: normal;
    overflow: hidden;
    text-overflow: unset;
    max-width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    word-break: break-word;
    opacity: 0;
    transform: translateY(10px);
    animation: subtleFadeInUp 0.4s ease-out forwards;
    animation-delay: var(--animation-delay, 0s);
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
    .follow-up-prompt-btn:hover {
        background-color: var(--active-bg);
        color: var(--text-primary);
    }
    .toggle-checkbox:checked {
        right: 0;
        border-color: #3b82f6;
    }
    .toggle-checkbox:checked + .toggle-label {
        background-color: #3b82f6;
    }
    .toggle-checkbox:focus + .toggle-label {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
    }
    .toggle-checkbox:checked + .toggle-label:before {
        transform: translateX(1.5rem);
    }
    .toggle-label {
         transition: background-color 0.2s ease-in-out;
    }
    .toggle-label:before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: calc(1.5rem - 4px);
        height: calc(1.5rem - 4px);
        border-radius: 9999px;
        background-color: #fff;
        transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .model-description {
        font-size: 0.75rem;
        color: var(--text-secondary);
        line-height: 1.2;
        margin-top: 0.25rem;
    }
    .model-option-btn-container {
        display: block;
        width: 100%;
        text-align: left;
        padding: 0.75rem 1rem;
        cursor: pointer;
    }
    .model-option-btn-container:hover {
        background-color: var(--hover-bg);
    }
    #model-options-popover {
        max-height: calc(100vh - 150px);
        overflow-y: auto;
    }
    .message-bubble {
  position: relative;
  background-color: transparent;
  z-index: 0;
  max-width: 100vw;
  overflow-x: auto;
}
    .message-bubble::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        border-radius: 0.5rem;
        z-index: -1;
    }
    .model-message .message-bubble::before {
        background-color: var(--ai-bubble-bg);
    }
    .user-message .message-content {
        white-space: pre-line;
    }
    .user-message .message-bubble::before {
        background-color: var(--user-bubble-bg);
    }
    .file-preview-item {
         animation: subtleScaleIn 0.3s ease-out forwards;
    }
    .color-dropdown-container {
        position: relative;
    }
    .color-dropdown-btn {
        width: 100%;
        padding: 0.5rem 1rem;
        background-color: var(--input-field-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    .color-preview {
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 0.25rem;
        border: 1px solid var(--border-color);
    }
    .color-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background-color: var(--modal-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        z-index: 10;
        display: none;
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .color-dropdown-menu.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }
    .color-option {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    .color-option:hover {
        background-color: var(--hover-bg);
    }
    .settings-nav-item {
        cursor: pointer;
    }
    .settings-nav-item:hover {
        background-color: var(--hover-bg);
    }
    .settings-nav-item.active {
        background-color: var(--active-bg);
        font-weight: bold;
    }
    .voice-input-btn {
        flex-shrink: 0;
        height: 2.5rem;
        width: 2.5rem;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
    }
    .voice-input-btn:hover {
        background-color: var(--hover-bg);
    }
    .voice-input-btn.active {
        color: #ef4444;
        background-color: var(--hover-bg);
    }
    .pinned-icon {
        color: #fbbf24;
    }
    #wallpaper-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-size: cover;
    background-position: center;
    z-index: -1;
    display: none;
    transition: opacity 0.3s ease-in-out;
    pointer-events: none;
    -webkit-touch-callout: none;
    user-select: none;
    }
    body.custom-wallpaper-active #add-file-btn {
    color: var(--text-primary) !important;
}
body.custom-wallpaper-active .voice-input-btn {
    color: var(--text-primary) !important;
}
body.custom-wallpaper-active .voice-input-btn.active {
    color: #ef4444 !important; 
}
    body.custom-wallpaper-active #wallpaper-container {
        display: block;
    }
    body.custom-wallpaper-active {
        background-color: transparent !important;
    }
    body.custom-wallpaper-active #app-container > .bg-\[var\(--chat-bg\)\] {
        background-color: transparent !important;
    }
    body.custom-wallpaper-active .bg-\[var\(--input-bar-bg\)\] {
        background-color: transparent !important;
        border-color: transparent !important;
    }
    body.custom-wallpaper-active #settings-modal .bg-\[var\(--sidebar-bg\)\] {
        background-color: transparent !important;
        border-color: transparent !important;
    }
    body.custom-wallpaper-active #settings-modal .border-t {
        border-color: transparent !important;
    }
    body.custom-wallpaper-active #search-modal > div,
    body.custom-wallpaper-active #astras-create-modal > div,
    body.custom-wallpaper-active #data-dashboard-modal > div,
    body.custom-wallpaper-active #settings-modal > div,
    body.custom-wallpaper-active #custom-dialog-modal > div {
        background-color: var(--modal-bg) !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        border-color: var(--border-color) !important;
    }
    body.custom-wallpaper-active #update-info-modal > div,
    body.custom-wallpaper-active #latest-update-modal > div {
        background-color: rgba(255, 255, 255, 0.65) !important;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-color: rgba(200, 200, 200, 0.5) !important;
    }
    body.custom-wallpaper-active #model-options-popover {
        background-color: rgba(255, 255, 255, 0.35) !important;
        backdrop-filter: blur(16px) !important;
        -webkit-backdrop-filter: blur(16px) !important;
        border: 1px solid rgba(200, 200, 200, 0.5) !important;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    body.custom-wallpaper-active .input-wrapper {
        background-color: rgba(255, 255, 255, 0.2) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    body.custom-wallpaper-active #message-input {
        background-color: transparent !important;
    }
    body.custom-wallpaper-active .message-bubble {
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    body.custom-wallpaper-active .message-bubble::before {
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
    }
    body.custom-wallpaper-active .model-message .message-bubble::before {
        background-color: var(--ai-bubble-bg);
    }
    body.custom-wallpaper-active .model-message .message-bubble {
        color: #111827 !important;
    }
    body.custom-wallpaper-active .model-message .message-bubble .prose {
        color: #111827 !important;
    }
    body.custom-wallpaper-active .user-message .message-bubble::before {
        background-color: var(--user-bubble-bg);
    }
    body.custom-wallpaper-active .user-message .message-bubble {
        color: #111827 !important;
    }
    body.custom-wallpaper-active .user-message .message-bubble .prose {
        color: #111827 !important;
    }
    body.custom-wallpaper-active .model-message .message-bubble .prose pre {
        background-color: rgba(0, 0, 0, 0.05);
    }
    body.custom-wallpaper-active .model-message .message-bubble .prose code,
    body.custom-wallpaper-active .model-message .message-bubble .prose pre code {
         color: #111827 !important;
    }
    body.custom-wallpaper-active {
        --text-primary: #111827;
        --text-secondary: #6b7280;
    }
    body.custom-wallpaper-active #message-input::placeholder {
    color: var(--text-primary) !important;
}
    body.custom-wallpaper-active .theme-button-group {
        opacity: 0.5;
        pointer-events: none;
    }
    body.custom-wallpaper-active #message-list > div.text-center {
        background-color: rgba(255, 255, 255, 0.35);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        max-width: max-content;
        margin: 4rem auto 0;
    }
    body.custom-wallpaper-active.wallpaper-is-dark {
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
    }
    body.custom-wallpaper-active #update-info-modal .p-4.bg-\[var\(--sidebar-bg\)\],
    body.custom-wallpaper-active #latest-update-modal .p-4.bg-\[var\(--sidebar-bg\)\] {
        background-color: transparent !important;
        border-top-color: rgba(200, 200, 200, 0.5) !important;
    }
    .sidebar, .sidebar button, .sidebar input, .sidebar h2, .sidebar span {
        color: #111827;
    }
    .sidebar .text-\[var\(--text-secondary\)\] {
        color: #6b7280 !important;
    }
    .dark .sidebar .sidebar-item.active, .sidebar .sidebar-item.active {
        color: #111827;
    }
    .dark .sidebar-item:hover, .sidebar-item:hover {
        color: #111827;
    }
    #logout-btn, .folder-options-btn, .chat-options-btn, .astras-options-btn, #new-folder-btn, #new-astras-btn {
        color: #6b7280;
    }
    #logout-btn:hover, .folder-options-btn:hover, .chat-options-btn:hover, .astras-options-btn:hover, #new-folder-btn:hover, #new-astras-btn:hover {
        color: #111827;
    }
    .pinned-icon {
        color: #fbbf24;
    }
    #settings-modal .settings-section {
        color: #111827;
    }
    #settings-modal .settings-section h3,
    #settings-modal .settings-section label,
    #settings-modal .settings-section p,
    #settings-modal .settings-section button,
    #settings-modal .settings-section input,
    #settings-modal .settings-section select,
    #settings-modal .settings-section textarea,
    #settings-modal .settings-section span {
        color: #111827;
    }
    #settings-modal .settings-section .text-\[var\(--text-secondary\)\] {
        color: #6b7280 !important;
    }
    .dark #settings-modal .settings-section input,
    .dark #settings-modal .settings-section select,
    .dark #settings-modal .settings-section textarea {
        background-color: #f0f0f0;
        border-color: #d1d5db;
    }
    #model-options-popover .model-option-btn-container h4,
    #model-options-popover .model-option-btn-container .model-description {
        color: #111827 !important;
    }
    #settings-modal .p-6.border-b h2 {
        color: #111827;
    }
    #settings-modal .settings-nav-item {
        color: #111827;
    }
    #close-settings-btn {
        color: #111827;
    }
    #close-astras-btn {
        color: #111827;
    }
    #upload-wallpaper-btn {
        background-color: #3b82f6;
        color: #ffffff !important;
    }
    #upload-wallpaper-btn:hover {
        background-color: #2563eb;
    }
    #restore-wallpaper-btn {
        background-color: #6b7280;
        color: #ffffff !important;
    }
    #restore-wallpaper-btn:hover {
        background-color: #4b5563;
    }
    #export-data-btn {
        background-color: #3b82f6;
        color: #ffffff !important;
    }
    #export-data-btn:hover {
        background-color: #2563eb;
    }
    #import-data-btn {
        background-color: #16a34a;
        color: #ffffff !important;
    }
    #import-data-btn:hover {
        background-color: #15803d;
    }
    .modal > div, .popover {
        color: #111827;
    }
    .modal h2, .modal h3, .modal p, .modal label, .modal span,
    .modal input, .modal select, .modal textarea {
        color: #111827;
    }
    .modal button, .popover button {
        color: #111827;
    }
    .modal .text-\[var\(--text-secondary\)\] {
        color: #6b7280 !important;
    }
    .modal .btn-primary, .modal #confirm-import-btn {
        color: #ffffff !important;
    }
    .modal .text-red-500, .modal .text-red-600, .popover .text-red-600 {
        color: #ef4444 !important;
    }
    .dark .modal input, .dark .modal select, .dark .modal textarea {
        background-color: #f0f0f0;
        border-color: #d1d5db;
    }
    .model-suffix {
        display: inline-block;
        padding: 2px 8px;
        font-size: 0.6rem;
        font-weight: 600;
        line-height: 1.2;
        border-radius: 9999px;
        flex-shrink: 0;
        margin-left: 4px;
        background-color: rgba(0, 0, 0, 0.05);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
    }
    .dark .model-suffix {
        background-color: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.15);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    .sidebar-item:hover .model-suffix {
        display: none;
    }
    @keyframes pulse-red-border {
        0%, 100% {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4);
        }
        50% {
            border-color: #f87171;
            box-shadow: 0 0 0 0px rgba(239, 68, 68, 0);
        }
    }
    .dialog-warning-border {
        animation: pulse-red-border 1.5s infinite;
    }
    #wallpaper-crop-container {
        width: 100%;
        max-height: 60vh;
        margin-bottom: 1rem;
    }
    #wallpaper-crop-container img {
        max-width: 100%;
    }
    .dark body,
    .dark .sidebar *,
    .dark #settings-modal *,
    .dark .modal > div *,
    .dark .popover *,
    .dark #model-options-popover .model-option-btn-container h4,
    .dark #model-options-popover .model-option-btn-container .model-description,
    .dark #header-title,
    .dark #current-astras-name,
    .dark .model-message .message-bubble,
    .dark .model-message .message-bubble .prose,
    .dark .model-message .message-bubble .prose *,
    .dark .follow-up-prompt-btn,
    .dark .color-dropdown-btn span,
    .dark #message-input::placeholder {
        color: #ffffff !important;
    }
    .dark #settings-modal .settings-section input,
    .dark #settings-modal .settings-section select,
    .dark #settings-modal .settings-section textarea,
    .dark .modal input,
    .dark .modal select,
    .dark .modal textarea {
        color: #111827 !important;
    }
    .dark .btn-primary, .dark .modal .btn-primary, .dark #confirm-import-btn {
        color: var(--button-primary-text, #ffffff) !important;
    }
    .dark .text-red-500, .dark .text-red-600, .dark .popover .text-red-600,
    .dark .notification.error {
        color: #ef4444 !important;
    }
    .dark .notification.success {
        color: #22c55e !important;
    }
    .dark .notification.warning {
        color: #f97316 !important;
    }
    .dark .pinned-icon {
        color: #fbbf24 !important;
    }
    .dark .model-suffix {
        color: #ffffff !important;
        background-color: rgba(255, 255, 255, 0.15) !important;
        border-color: rgba(255, 255, 255, 0.25) !important;
    }
    .demo-model-selector .selector-btn {
        transition: all 0.3s ease;
    }
    .demo-model-selector .selector-btn.active {
        color: #2563eb;
        background-color: #eff6ff;
        border-color: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .demo-chat-content {
        display: none;
        animation: fadeIn 0.5s ease-in-out;
    }
    .demo-chat-content.active {
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .astras-store-card {
        background-color: var(--sidebar-bg);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        animation: subtleFadeInUp 0.5s ease-out forwards;
    }
    .astras-store-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
    }
    .astras-card-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 1rem;
        background-color: var(--hover-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        color: var(--text-secondary);
        border: 2px solid var(--border-color);
        flex-shrink: 0;
    }
    .astras-card-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    .astras-card-name {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--text-primary);
    }
    .astras-card-desc {
        font-size: 0.875rem;
        color: var(--text-secondary);
        flex-grow: 1;
        margin-bottom: 1.5rem;
    }
    .subscribe-btn {
        width: 100%;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
    }
    .subscribe-btn.subscribed {
        background-color: #10b981;
        color: white;
    }
    .subscribe-btn.subscribed:hover {
        background-color: #059669;
    }
    .astras-sidebar-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 0.75rem;
        background-color: var(--hover-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
        color: var(--text-secondary);
        flex-shrink: 0;
    }
    #avatar-crop-container .cropper-view-box,
    #avatar-crop-container .cropper-face {
        border-radius: 50%;
    }
    body.custom-wallpaper-active .astras-store-card {
    background-color: rgba(255, 255, 255, 0.65) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
    border: 1px solid rgba(255, 255, 255, 0.4) !important;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1) !important;
}
    body.custom-wallpaper-active #store-container {
    background-color: transparent !important;
}
    body.custom-wallpaper-active #store-container header h1,
body.custom-wallpaper-active #store-container header #back-to-chat-btn,
body.custom-wallpaper-active .astras-card-name,
body.custom-wallpaper-active .astras-card-desc,
body.custom-wallpaper-active .astras-card-avatar {
    color: #000000 !important;
}
body.custom-wallpaper-active #store-container .border-b {
    border-color: rgba(255, 255, 255, 0.2) !important;
}
body.custom-wallpaper-active .store-category-btn {
    background-color: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.4);
    color: #111827;
}
body.custom-wallpaper-active .store-category-btn:hover {
    background-color: rgba(255, 255, 255, 0.5);
    border-color: rgba(255, 255, 255, 0.8);
}
body.custom-wallpaper-active .store-category-btn.active {
    border-color: transparent !important;
    color: var(--button-primary-text) !important;
    background: var(--button-primary-bg) !important;
}
    #mobile-context-menu-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 99;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    #mobile-context-menu {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--modal-bg);
        border-top-left-radius: 1.5rem;
        border-top-right-radius: 1.5rem;
        z-index: 100;
        padding: 1rem;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        touch-action: none;
    }
    #mobile-context-menu.visible {
        transform: translateY(0);
    }
    #mobile-context-menu-overlay.visible {
        opacity: 1;
    }
    #mobile-context-menu .menu-header {
        padding: 0.5rem 1rem;
        text-align: center;
        font-weight: 600;
        color: var(--text-primary);
        background-color: var(--sidebar-bg);
        border-radius: 0.75rem;
        margin-bottom: 1rem;
    }
    #mobile-context-menu .menu-options {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    #mobile-context-menu .menu-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        gap: 1rem;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        font-size: 1rem;
        color: var(--text-primary);
    }
    #mobile-context-menu .menu-item:last-child {
        border-bottom: none;
    }
    #mobile-context-menu .menu-item:hover {
        background-color: var(--hover-bg);
    }
    #mobile-context-menu .menu-item.delete {
        color: #ef4444;
    }
    #mobile-context-menu .menu-item svg {
        width: 24px;
        height: 24px;
        color: var(--text-secondary);
    }
     #mobile-context-menu .menu-item.delete svg {
        color: #ef4444;
    }
    .dark #mobile-context-menu .menu-header,
    .dark #mobile-context-menu .menu-item {
        color: var(--text-primary);
    }
    .dark #mobile-context-menu .menu-item svg {
        color: var(--text-secondary);
    }
    .dark #mobile-context-menu .menu-item.delete {
        color: #ef4444 !important;
    }
    .dark #mobile-context-menu .menu-item.delete svg {
        color: #ef4444 !important;
    }
    body.custom-wallpaper-active #mobile-context-menu {
        color: #111827 !important;
        background-color: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-color: rgba(200, 200, 200, 0.5) !important;
    }
    body.custom-wallpaper-active #mobile-context-menu .menu-header,
    body.custom-wallpaper-active #mobile-context-menu .menu-item {
         color: #111827 !important;
    }
    body.custom-wallpaper-active #mobile-context-menu .menu-item svg {
        color: #6b7280 !important;
    }
    body.custom-wallpaper-active #mobile-context-menu .menu-item.delete,
    body.custom-wallpaper-active #mobile-context-menu .menu-item.delete svg {
        color: #ef4444 !important;
    }
    @media (max-width: 768px) {
      input[type="text"],
      input[type="search"],
      input[type="password"],
      textarea,
      select {
        font-size: 16px !important;
      }
      .sidebar-item .chat-options-btn,
      .sidebar-item .astras-options-btn,
      .folder-summary .folder-options-btn {
          display: none;
      }
    }
    @media (max-width: 768px) {
      #settings-modal .flex.flex-1.overflow-hidden {
        flex-direction: column;
      }
      #settings-modal nav.w-1\/4 {
        display: none;
      }
      #settings-modal .flex-1.p-6.overflow-y-auto {
        width: 100%;
        border-right: none;
      }
      #settings-modal .settings-section {
        display: block !important;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
      }
      #settings-modal .settings-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }
    }
    @media (max-width: 640px) {
        #search-modal .p-4.flex.items-center {
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        #modal-search-input {
            flex-basis: 100%;
            order: 1;
        }
        #modal-search-scope-select {
            flex-grow: 1;
            order: 2;
        }
        #perform-search-btn {
            order: 3;
        }
        #voice-input-btn-search {
            order: 4;
        }
    }
    .sidebar-item, .folder-summary {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    .model-message .prose {
        overflow-x: auto;
        -ms-overflow-style: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
    }
    .model-message .prose::-webkit-scrollbar {
        height: 8px;
    }
    .model-message .prose::-webkit-scrollbar-track {
        background: transparent;
    }
    .model-message .prose::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
    }
    .model-message .prose::-webkit-scrollbar-thumb:hover {
        background-color: var(--text-secondary);
    }
    @keyframes jelly-bounce {
        0%, 100% { transform: scale(1) translateX(-50%); }
        25% { transform: scale(0.9, 1.1) translateX(-50%); }
        50% { transform: scale(1.1, 0.9) translateX(-50%); }
        75% { transform: scale(0.95, 1.05) translateX(-50%); }
    }
    #scroll-to-bottom-btn {
        position: absolute;
        left: 50%;
        z-index: 20;
        width: 40px;
        height: 40px;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transform: translateX(-50%) scale(0.8);
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease, bottom 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
    }
    #scroll-to-bottom-btn.visible {
        opacity: 1;
        transform: translateX(-50%) scale(1);
        pointer-events: auto;
    }
    #scroll-to-bottom-btn.jelly-animate {
        animation: jelly-bounce 0.5s ease-out;
    }
    #scroll-to-bottom-btn {
        background-color: rgba(255, 255, 255, 0.9);
        color: #111827;
        box-shadow: 0 4px 8px var(--shadow-color);
        border: 1px solid var(--border-color);
    }
    .dark #scroll-to-bottom-btn {
        background-color: rgba(30, 30, 30, 0.9);
        color: #f9fafb;
        border: 1px solid var(--border-color);
    }
    body.custom-wallpaper-active #scroll-to-bottom-btn {
        background-color: var(--button-primary-bg);
        color: #ffffff;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow:
            0 4px 12px rgba(0, 0, 0, 0.2),
            inset 0 1px 2px rgba(255, 255, 255, 0.4);
        background-image: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0) 60%);
        transition: opacity 0.3s ease, transform 0.3s ease, bottom 0.3s ease, background-position 0.4s ease;
        background-size: 200% 200%;
        background-position: 50% 100%;
    }
    body.custom-wallpaper-active #scroll-to-bottom-btn:hover {
        background-position: 50% 50%;
        transform: translateX(-50%) scale(1.05);
    }
    .search-view-btn {
        display: inline-flex;
    }
    @media (max-width: 768px) {
        .search-view-btn {
            display: none;
        }
    }
    #sidebar,
    #header-title,
    #search-view-modal h2,
    #search-view-modal button,
    #mobile-context-menu,
    #history-popover,
    #message-list .text-center,
    #message-input,
    #model-switcher-container,
    #search-view-content,
    #store-container,
    #search-modal,
    #settings-modal,
    #trash-section,
    #trash-view-modal
    {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    @media (max-width: 768px) {
        .trash-item-view-btn {
            display: none;
        }
    }
    body.custom-wallpaper-active #follow-up-container {
        background-color: transparent !important;
        border-color: transparent !important;
        padding-top: 0 !important;
        padding-bottom: 0.5rem !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    body.custom-wallpaper-active #follow-up-content-wrapper {
        background-color: rgba(255, 255, 255, 0.2) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        padding: 0.75rem;
        border-radius: 1rem;
    }
    body.custom-wallpaper-active .follow-up-prompt-btn {
        background-color: rgba(255, 255, 255, 0.3) !important;
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        color: var(--text-primary) !important;
        transition: all 0.2s ease-in-out;
    }
    body.custom-wallpaper-active .follow-up-prompt-btn:hover {
        background-color: rgba(255, 255, 255, 0.5) !important;
        transform: translateY(-2px);
        border-color: rgba(255, 255, 255, 0.6);
    }
        #follow-up-container #follow-up-header h4 {
    color: #111827 !important;
}
.spotlight-effect {
    position: relative;
}
.spotlight-effect::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    border-radius: 1rem;
    background-image: radial-gradient(
        circle 150px at var(--spotlight-x) var(--spotlight-y),
        rgba(255, 255, 255, 0.15) 0%,
        rgba(255, 255, 255, 0) 100%
    );
    opacity: 0;
    transition: opacity 0.3s ease-out;
    pointer-events: none;
}
.spotlight-effect:hover::before {
    opacity: 1;
}
.dark .spotlight-effect::before {
    background-image: radial-gradient(
        circle 150px at var(--spotlight-x) var(--spotlight-y),
        rgba(255, 255, 255, 0.2) 0%,
        rgba(255, 255, 255, 0) 100%
    );
}
    opacity: 0;
    transition: opacity 0.3s ease-out;
    pointer-events: none;
}
.spotlight-effect:hover::before {
    opacity: 1;
}
.dark .spotlight-effect::before {
    background-image: radial-gradient(
        circle 200px at var(--spotlight-x) var(--spotlight-y),
        rgba(255, 255, 255, 0.12) 0%,
        rgba(255, 255, 255, 0) 100%
    );
}
.input-wrapper {
    flex-direction: column;
    gap: 0.25rem;
}
.input-indicator-item {
    color: var(--button-primary-bg);
    background-color: var(--hover-bg);
    border: 1px solid var(--border-color);
    align-self: flex-start;
    -webkit-user-select: none; /* ÈÅ©Áî®Êñº Chrome, Safari, Opera */
    -moz-user-select: none;    /* ÈÅ©Áî®Êñº Firefox */
    -ms-user-select: none;     /* ÈÅ©Áî®Êñº Internet Explorer/Edge */
    user-select: none;         /* Ê®ôÊ∫ñË™ûÊ≥ï */
}
.dark .input-indicator-item {
    background-color: var(--hover-bg);
    border: 1px solid var(--border-color);
}
body.custom-wallpaper-active .input-indicator-item {
    background-color: rgba(255, 255, 255, 0.2) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    color: var(--button-primary-bg) !important;
}
#input-bar-container .input-wrapper > .flex.items-end {
    width: 100%;
}
}
</style>
<script>
window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
</head>
<body class="font-sans bg-gray-50">
    <div id="wallpaper-container"></div>
    <div id="auth-container">
        <div class="min-h-screen flex flex-col">
            <header class="p-4 sm:px-6 lg:px-8 bg-white/80 backdrop-blur-sm sticky top-0 z-20 border-b border-gray-200">
                <div class="max-w-7xl mx-auto flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <svg class="h-8 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 15h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                        <span class="text-xl font-bold text-gray-800">ASTRA</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="login-language-switcher" class="relative">
                            <button id="login-lang-btn" class="flex items-center gap-1 text-sm text-gray-600 hover:text-gray-900">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                <span id="login-lang-label">ÁπÅÈ´î‰∏≠Êñá</span>
                            </button>
                            <div id="login-lang-menu" class="popover absolute right-0 mt-2 w-36 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-30">
                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-lang="zh-TW">ÁπÅÈ´î‰∏≠Êñá</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-lang="en">English</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-lang="fr">Fran√ßais</a>
                                </div>
                            </div>
                        </div>
                        <a href="#login-section" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors" data-lang-key="login">
                            ÁôªÂÖ•
                        </a>
                    </div>
                </div>
            </header>
            <main class="flex-grow">
                <section id="login-section" class="relative py-20 lg:py-32 bg-white">
                    <div class="absolute inset-0 overflow-hidden">
                         <div class="absolute top-0 left-0 w-96 h-96 bg-blue-100 rounded-full opacity-50 -translate-x-20 -translate-y-20"></div>
                         <div class="absolute bottom-0 right-0 w-96 h-96 bg-indigo-100 rounded-full opacity-50 translate-x-20 translate-y-20"></div>
                    </div>
                    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid lg:grid-cols-2 gap-16 items-center">
                        <div class="text-center lg:text-left">
                            <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-gray-900 tracking-tight">
                                <span data-lang-key="welcome">Ê≠°Ëøé‰ΩøÁî®</span> <span class="text-blue-600">ASTRA</span>
                            </h1>
                            <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-2xl mx-auto lg:mx-0" data-lang-key="heroSubtitle">
                                ÂæûÂâµÊÑèÊøÄÁõ™Âà∞Êï∏ÊìöÊ±∫Á≠ñÔºå‰∏ÄÈçµÁõ¥ÈÅî„ÄÇÈ´îÈ©óÂâçÊâÄÊú™ÊúâÁöÑ AI Âçî‰ΩúÔºåÈáãÊîæÊÇ®ÁöÑÂÖ®ÈÉ®ÊΩõÂäõ„ÄÇ
                            </p>
                        </div>
                        <div class="w-full max-w-md mx-auto auth-form-container">
                             <div class="p-8 bg-white/70 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200">
                                <h2 class="text-2xl font-bold text-center text-gray-800 mb-2" data-lang-key="loginOrRegister">ÁôªÂÖ•ÊàñË®ªÂÜä</h2>
                                <p class="text-center text-gray-500 mb-8 text-sm" data-lang-key="startJourney">ÈñãÂßãÊÇ®ÁöÑÊô∫ÊÖßÊóÖÁ®ã</p>
                                <form id="auth-form">
                                    <div class="mb-4">
                                        <label for="username-input" class="block text-sm font-medium text-gray-700 mb-1" data-lang-key="username">‰ΩøÁî®ËÄÖÂêçÁ®±</label>
                                        <input type="text" id="username-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂêçÁ®±" required data-lang-key-placeholder="usernamePlaceholder">
                                    </div>
                                    <div class="mb-6">
                                        <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1" data-lang-key="password">ÂØÜÁ¢º</label>
                                        <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" placeholder="Áî®ÊñºÁôªÂÖ•È©óË≠â" required data-lang-key-placeholder="passwordPlaceholder">
                                    </div>
                                    <div class="space-y-3">
                                        <button type="submit" id="register-btn" class="w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors" data-lang-key="loginRegisterButton">
                                            ÁôªÂÖ• / Ë®ªÂÜä
                                        </button>
                                        <button type="button" id="import-btn-auth" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled data-lang-key="importRecords">
                                            ÂåØÂÖ•Á¥ÄÈåÑ
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="py-20 lg:py-24 bg-gray-50">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="text-center">
                            <h2 class="text-3xl lg:text-4xl font-bold text-gray-900" data-lang-key="exploreModels">Êé¢Á¥¢ÊàëÂÄëÁöÑ AI Ê®°Âûã</h2>
                            <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto" data-lang-key="exploreModelsDesc">
                                ÊàëÂÄëÊèê‰æõ‰∏ÄÁ≥ªÂàóÁÇ∫‰∏çÂêå‰ªªÂãôÈáèË∫´ÊâìÈÄ†ÁöÑÈ†ÇÂ∞ñÊ®°ÂûãÔºåÁÑ°Ë´ñÊòØÂâµÊÑèÂØ´‰Ωú„ÄÅÁ®ãÂºèË®≠Ë®àÈÇÑÊòØÂïÜÊ•≠ÂàÜÊûêÔºåÁ∏ΩÊúâ‰∏ÄÊ¨æÈÅ©ÂêàÊÇ®„ÄÇ
                            </p>
                        </div>
                        <div class="mt-16 max-w-5xl mx-auto">
                            <div class="demo-model-selector grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 lg:gap-4">
                            </div>
                            <div class="mt-8 bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
                                <div class="p-4 border-b border-gray-200">
                                    <h3 id="demo-chat-title" class="text-lg font-semibold text-gray-800 text-center" data-lang-key="demoChatTitle">Astra-ultra Â∞çË©±ÁØÑ‰æã</h3>
                                </div>
                                <div id="demo-chat-window" class="p-6 h-96 overflow-y-auto space-y-6 bg-gray-100">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="bg-white border-t border-gray-200">
                <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
                    <p data-lang-key="copyright">ASTRAÁâàÊ¨äÊâÄÊúâ</p>
                </div>
            </footer>
        </div>
    </div>
    <div id="app-container" class="hidden h-screen">
        <div class="relative flex h-screen w-full bg-[var(--chat-bg)]">
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0"></div>
            <div id="sidebar-open-handle" class="fixed top-0 left-0 h-full z-20" style="width: 20px; touch-action: pan-y;"></div>
            <aside id="sidebar" class="sidebar w-64 lg:w-72 flex-shrink-0 flex flex-col fixed h-full z-40 transform -translate-x-full">
                <div class="p-2">
                    <div class="flex gap-2 mb-2">
                        <button id="new-chat-btn" class="sidebar-item w-full text-left p-3 rounded-lg flex items-center gap-3 font-semibold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span data-lang-key="newChat">Êñ∞Â∞çË©±</span>
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button id="selection-mode-btn" class="w-1/2 p-1.5 text-xs border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] hover:bg-[var(--hover-bg)]" data-lang-key="batchSelect">
                            ÊâπÊ¨°ÈÅ∏Âèñ
                        </button>
                        <button id="open-search-btn" class="w-1/2 p-1.5 text-xs border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] hover:bg-[var(--hover-bg)]" data-lang-key="search">
                            ÊêúÂ∞ã
                        </button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-2 scroll-area">
                    <div class="border-b border-[var(--border-color)] mb-2 pb-2">
                        <div class="flex justify-between items-center px-3 py-1">
                            <h2 class="text-sm font-semibold text-[var(--text-secondary)]" data-lang-key="astras">Astras</h2>
                            <div class="flex items-center gap-1">
                                <button id="open-store-btn" title="Astras ÂïÜÂ∫ó" class="p-1 rounded-md hover:bg-[var(--active-bg)] text-[var(--text-secondary)]" data-lang-key-title="astrasStore">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                                </button>
                                <button id="new-astras-btn" title="Êñ∞Â¢û Astras" class="p-1 rounded-md hover:bg-[var(--active-bg)] text-[var(--text-secondary)]" data-lang-key-title="addAstras">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path><line x1="12" y1="10" x2="12" y2="16"></line><line x1="9" y1="13" x2="15" y2="13"></line></svg>
                                </button>
                            </div>
                        </div>
                        <div id="astras-list" class="flex-1 pr-1 mt-1 space-y-1"></div>
                    </div>
                    <div class="border-b border-[var(--border-color)] mb-2 pb-2">
                        <div class="flex justify-between items-center px-3 py-1">
                            <h2 class="text-sm font-semibold text-[var(--text-secondary)]" data-lang-key="folders">Ë≥áÊñôÂ§æ</h2>
                            <button id="new-folder-btn" title="Êñ∞Â¢ûË≥áÊñôÂ§æ" class="p-1 rounded-md hover:bg-[var(--active-bg)] text-[var(--text-secondary)]" data-lang-key-title="addFolder">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path><line x1="12" y1="10" x2="12" y2="16"></line><line x1="9" y1="13" x2="15" y2="13"></line></svg>
                            </button>
                        </div>
                        <div id="folder-list" class="flex-1 pr-1 mt-1"></div>
                    </div>
                    <div id="history-list" class="pr-1"></div>
                </div>
                <div class="p-2 border-t border-[var(--border-color)]">
                    <div id="batch-action-bar" class="hidden">
                        <div class="flex justify-between items-center text-xs mb-1 px-1">
                            <span id="selection-count" class="font-medium text-[var(--text-secondary)]"></span>
                            <button id="cancel-selection-btn" class="text-blue-600 hover:underline font-semibold" data-lang-key="done">ÂÆåÊàê</button>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button id="batch-delete-btn" class="p-1.5 text-xs rounded-md bg-red-500 text-white disabled:bg-red-300" disabled data-lang-key="delete">Âà™Èô§</button>
                            <button id="batch-archive-btn" class="p-1.5 text-xs rounded-md bg-yellow-500 text-white disabled:bg-yellow-300" disabled data-lang-key="archive">Â∞ÅÂ≠ò</button>
                            <button id="batch-move-btn" class="p-1.5 text-xs rounded-md bg-blue-500 text-white disabled:bg-blue-300" disabled data-lang-key="move">ÁßªÂãï</button>
                        </div>
                    </div>
                    <div id="user-controls">
                        <button id="user-profile-btn" class="sidebar-item w-full text-left p-3 rounded-lg flex items-center gap-3">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                             <span id="username-display" class="font-semibold truncate">User</span>
                        </button>
                        <button id="settings-btn" class="sidebar-item w-full text-left p-3 rounded-lg flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                            <span data-lang-key="settings">Ë®≠ÂÆö</span>
                        </button>
                    </div>
                </div>
            </aside>
            <main class="flex-1 flex flex-col relative h-full">
                <header class="relative z-10 p-2 md:p-4 flex justify-between items-center border-b border-[var(--border-color)]">
                    <div class="flex items-center gap-2 min-w-0">
                        <button id="menu-toggle-btn" class="p-2 rounded-md hover:bg-[var(--hover-bg)]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </button>
                        <h1 id="header-title" class="text-xl font-semibold truncate">Êñ∞Â∞çË©±</h1>
                        <div id="api-key-warning-badge" class="hidden cursor-pointer" title="ÁõÆÂâçÈÅ∏Áî®ÁöÑÊ®°ÂûãÈúÄË¶Å API ÈáëÈë∞ÔºåË´ãÈªûÊ≠§Ë®≠ÂÆö" data-lang-key-title="apiKeyWarning">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 md:gap-2">
                        <div id="model-switcher-container" class="relative"></div>
                    </div>
                </header>
                <div id="chat-container" class="flex-1 p-4 md:p-6 overflow-y-auto scroll-area">
                    <div id="message-list" class="space-y-8 max-w-4xl mx-auto"></div>
                </div>
                <button id="scroll-to-bottom-btn" title="ÊªæÂãïÂà∞Â∫ïÈÉ®">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div id="follow-up-container" class="p-2 md:p-4 bg-[var(--input-bar-bg)] border-t border-[var(--border-color)] hidden">
                    <div id="follow-up-content-wrapper" class="max-w-4xl mx-auto spotlight-effect">
                        <div id="follow-up-header" class="flex items-center justify-between cursor-pointer">
                            <h4 class="text-sm font-semibold text-[var(--text-secondary)]" data-lang-key="followUp">ÂæåÁ∫åËøΩÂïè</h4>
                        </div>
                        <div id="follow-up-prompts-list" class="flex flex-wrap gap-2 transition-all duration-300 overflow-hidden">
                        </div>
                    </div>
                </div>
                <div id="input-bar-container" class="p-2 md:p-4 bg-[var(--input-bar-bg)] border-t border-[var(--border-color)]">
                    <div class="max-w-4xl mx-auto">
                        <div id="file-preview-container" class="w-full flex flex-wrap gap-2 mb-2 px-2 empty:hidden"></div>
                        <div class="input-wrapper w-full flex items-end gap-2 p-2 rounded-2xl bg-[var(--input-field-bg)] border border-[var(--border-color)] shadow-sm spotlight-effect">
                            <div id="input-indicator-container" class="flex gap-1 empty:hidden">
                            </div>
                            <div class="w-full flex items-end gap-2">
                                <div id="file-input-container" class="relative">
                                    <button id="add-file-btn" title="ÈôÑÂä†Ê™îÊ°à" class="flex-shrink:0 h-10 w-10 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 transition-colors" data-lang-key-title="attachFile">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    </button>
                                    <div id="file-options-popover" class="popover absolute bottom-full left-0 mb-2 w-56 z-20">
    <button id="camera-btn" class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--hover-bg)] flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
        <span data-lang-key="camera">Áõ∏Ê©ü</span>
    </button>
    <button id="upload-image-btn" class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--hover-bg)] flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        <span data-lang-key="imageVideo">ÂúñÁâá / ÂΩ±Áâá</span>
    </button>
    <button id="upload-file-btn" class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--hover-bg)] flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
        <span data-lang-key="file">Ê™îÊ°à</span>
    </button>
    <button id="web-search-popover-btn" class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--hover-bg)] flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        <span data-lang-key="webSearch">ËÅØÁ∂≤ÊêúÂ∞ã</span>
    </button>
    <div class="border-t border-[var(--border-color)] my-1"></div>
    <button id="learning-mode-btn" class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--hover-bg)] flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 18a6 6 0 0 0 6-6c0-1.657-2.686-3-6-3s-6 1.343-6 3a6 6 0 0 0 6 6z"/><path d="M12 2v10"/></svg>
        <span data-lang-key="learningMode">Â≠∏ÁøíËàáÁ†îÁ©∂Ê®°Âºè</span>
    </button>
</div>
                                </div>
                                <form id="chat-form" class="flex-1 flex items-end relative">
    <textarea id="message-input" placeholder="Ë´ãÂÖàÂú®Ë®≠ÂÆö‰∏≠Ëº∏ÂÖ• API ÈáëÈë∞..." class="w-full p-2 bg-transparent border-0 focus:ring-0 disabled:bg-transparent resize-none overflow-y-hidden" rows="1" autocomplete="off" disabled data-lang-key-placeholder="enterApiKeyPlaceholder"></textarea>
    <button type="button" id="expand-input-btn" class="absolute top-1 right-1 w-6 h-6 rounded-full hover:bg-gray-500/20 flex items-center justify-center hidden transition-transform text-[var(--text-secondary)]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7" />
        </svg>
    </button>
</form>
                                <button id="voice-input-btn-message" title="Ë™ûÈü≥Ëº∏ÂÖ•" class="voice-input-btn" data-lang-key-title="voiceInput">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line></svg>
                                </button>
                                <button id="submit-btn" class="flex-shrink:0 h-10 w-10 rounded-full flex items-center justify-center disabled:bg-gray-300 dark:disabled:bg-gray-500 disabled:cursor-not-allowed transition-colors btn-primary">
                                    <span id="submit-btn-icon">
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="store-container" class="hidden h-screen w-full flex flex-col bg-[var(--chat-bg)]">
        <header class="relative z-10 p-2 md:p-4 flex items-center border-b border-[var(--border-color)]">
            <button id="back-to-chat-btn" class="p-2 rounded-md hover:bg-[var(--hover-bg)] mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <div class="flex-1 flex justify-between items-center">
    <h1 class="text-xl font-semibold" data-lang-key="astrasStore">Astras ÂïÜÂ∫ó</h1>
    <button id="propose-astras-btn" class="px-3 py-1.5 rounded-md btn-primary text-sm" data-lang-key="proposeAstras">
        ÊèêÊ°à Astras
    </button>
</div>
        </header>
        <div id="store-category-filter" class="flex-shrink-0 px-4 md:px-6 lg:px-8 pt-4 border-b border-[var(--border-color)]">
        <div id="store-category-list" class="flex items-center gap-2 pb-3 overflow-x-auto">
        </div>
    </div>
        <main id="store-main-content" class="flex-1 overflow-y-auto scroll-area p-4 md:p-6 lg:p-8">
            <div id="store-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            </div>
        </main>
    </div>
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-2xl font-bold" data-lang-key="settings">Ë®≠ÂÆö</h2>
                <button id="logout-btn" title="ÁôªÂá∫" class="p-2 rounded-md hover:bg-[var(--active-bg)] text-[var(--text-secondary)]" data-lang-key-title="logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <nav class="w-1/4 border-r border-[var(--border-color)] overflow-y-auto scroll-area">
                    <ul id="settings-nav" class="space-y-2 p-4">
                        <li class="settings-nav-item p-3 rounded-md active" data-section="personalization" data-lang-key="personalization">ÂÄã‰∫∫Âåñ</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="memory" data-lang-key="memoryManagement">Ë®òÊÜ∂ÁÆ°ÁêÜ</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="model-management" data-lang-key="modelManagement">Ê®°ÂûãÁÆ°ÁêÜ</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="data-management" data-lang-key="dataManagement">Ë≥áÊñôÁÆ°ÁêÜ</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="accessibility" data-lang-key="accessibility">ËºîÂä©ÂäüËÉΩ</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="trash" data-lang-key="trash">ÂûÉÂúæÊ°∂</li>
                        <li class="settings-nav-item p-3 rounded-md" data-section="about" data-lang-key="about">ÈóúÊñº</li>
                    </ul>
                </nav>
                <div class="flex-1 p-6 overflow-y-auto scroll-area space-y-6">
                    <div id="personalization-section" class="settings-section active">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="appearance">Â§ñËßÄ</h3>
                        <div class="theme-button-group">
                            <button id="theme-light-btn" class="theme-btn text-center" data-lang-key="lightMode">Ê∑∫Ëâ≤</button>
                            <button id="theme-dark-btn" class="theme-btn text-center" data-lang-key="darkMode">Ê∑±Ëâ≤</button>
                        </div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="languageSettings">Ë™ûË®ÄË®≠ÂÆö</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="ui-language-select" class="block text-sm font-medium mb-1" data-lang-key="uiLanguage">‰ªãÈù¢Ë™ûË®Ä</label>
                                <select id="ui-language-select" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]">
                                    <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                                    <option value="en">English</option>
                                    <option value="fr">Fran√ßais</option>
                                </select>
                            </div>
                            <div>
                                <label for="ai-language-select" class="block text-sm font-medium mb-1" data-lang-key="aiReplyLanguage">AI È†êË®≠ÂõûË¶ÜË™ûË®Ä</label>
                                <p class="text-xs text-[var(--text-secondary)] mb-2" data-lang-key="aiReplyLanguageDesc">
                                    AI Â∞á‰ª•Ê≠§Ë™ûË®ÄÂõûË¶ÜÔºåÈô§ÈùûÊÇ®Âú®Â∞çË©±‰∏≠Âè¶ÊúâÊåáÂÆö„ÄÇ
                                </p>
                                <select id="ai-language-select" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]">
                                    <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                                    <option value="en">English</option>
                                    <option value="fr">Fran√ßais</option>
                                </select>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="primaryButtonColor">‰∏ªÊåâÈàïÈ°èËâ≤</h3>
                        <div id="ui-color-options" class="space-y-3 text-sm">
                            <div class="flex items-center">
                                <input type="radio" id="color-theme-default" name="color-theme" value="default" class="w-4 h-4 mr-2">
                                <label for="color-theme-default" data-lang-key="colorDefault">È†êË®≠ (ËóçËâ≤)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="color-theme-adaptive" name="color-theme" value="adaptive" class="w-4 h-4 mr-2">
                                <label for="color-theme-adaptive" data-lang-key="colorAdaptive">Ëá™ÈÅ©Êáâ (ÂæûÊ°åÂ∏ÉÊèêÂèñ)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="color-theme-custom" name="color-theme" value="custom" class="w-4 h-4 mr-2">
                                <label for="color-theme-custom" data-lang-key="colorCustom">Ëá™Ë®Ç</label>
                            </div>
                            <div id="button-style-container" class="hidden pl-6 pt-2">
                                <label class="block text-sm font-medium" data-lang-key="buttonStyle">ÊåâÈàïÊ®£Âºè</label>
                                <div class="flex items-center gap-4 mt-1">
                                    <div>
                                        <input type="radio" id="color-style-single" name="color-style" value="single" class="w-4 h-4 mr-2">
                                        <label for="color-style-single" data-lang-key="styleSingle">ÂñÆËâ≤</label>
                                    </div>
                                    <div>
                                        <input type="radio" id="color-style-gradient" name="color-style" value="gradient" class="w-4 h-4 mr-2">
                                        <label for="color-style-gradient" data-lang-key="styleGradient">Êº∏ËÆä</label>
                                    </div>
                                </div>
                            </div>
                            <div id="custom-color-picker-container" class="hidden pl-6 pt-2">
                                <div id="custom-color-swatches" class="grid grid-cols-8 gap-2">
                                </div>
                            </div>
                            <div id="gradient-picker-container" class="hidden pl-6 pt-2">
                                <p class="text-sm text-[var(--text-secondary)] mb-2" data-lang-key="gradientDesc">
                                    ÂæûÊ°åÂ∏ÉÊèêÂèñÁöÑÈ°èËâ≤ÁµÑÂêà„ÄÇ
                                </p>
                                <div id="gradient-swatches" class="grid grid-cols-4 gap-2">
                                </div>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="aiBubbleColor">AI ÂõûË¶ÜÊ≥°Ê≥°Â∫ïËâ≤</h3>
                        <div id="ai-bubble-color-dropdown" class="color-dropdown-container"></div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="userBubbleColor">‰ΩøÁî®ËÄÖË®äÊÅØÊ≥°Ê≥°Â∫ïËâ≤</h3>
                        <div id="user-bubble-color-dropdown" class="color-dropdown-container"></div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="customWallpaper">Ëá™Ë®ÇÁæ©Ê°åÂ∏É</h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-2" data-lang-key="customWallpaperDesc">
                            ‰∏äÂÇ≥ÂúñÁâáÂæåÂ∞áË¶ÜËìãÊï¥ÂÄã‰ªãÈù¢Ôºå‰∏¶Á¶ÅÁî®Ê∑±Ê∑∫Ëâ≤Ê®°Âºè„ÄÇ
                        </p>
                        <div class="flex gap-2">
                            <button id="upload-wallpaper-btn" class="flex-1 text-center p-2 rounded-md bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800 font-medium" data-lang-key="uploadImage">‰∏äÂÇ≥ÂúñÁâá</button>
                            <button id="restore-wallpaper-btn" class="flex-1 text-center p-2 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 font-medium" data-lang-key="restoreDefault">ÈÇÑÂéüÈ†êË®≠</button>
                        </div>
                    </div>
                    <div id="memory-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="memorySwitch">Ë®òÊÜ∂ÂäüËÉΩÈñãÈóú</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label class="flex-1 text-sm font-medium" data-lang-key="personalMemory">ÂÄã‰∫∫ÁøíÊÖ£Ë®òÊÜ∂ (È°ûÂûã1)</label>
                                <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" id="memory-toggle-1" class="toggle-checkbox absolute block w-full, h-full rounded-full opacity-0 appearance-none cursor-pointer"/>
                                    <label for="memory-toggle-1" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <!-- START: Added Cross-Dialogue Memory Toggle -->
                            <div class="flex items-center justify-between">
                                <label class="flex-1 text-sm font-medium" data-lang-key="crossDialogueMemory">Ë∑®Â∞çË©±Ë®òÊÜ∂ (È°ûÂûã2)</label>
                                <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" id="memory-toggle-2" class="toggle-checkbox absolute block w-full, h-full rounded-full opacity-0 appearance-none cursor-pointer"/>
                                    <label for="memory-toggle-2" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <!-- END: Added Cross-Dialogue Memory Toggle -->
                            <div class="flex items-center justify-between">
                                <label for="auto-memory-toggle-switch" class="flex-1 text-sm font-medium" data-lang-key="enableAutoMemory">ÂïüÁî®Ëá™ÂãïÊ∑ªÂä†Ë®òÊÜ∂</label>
                                <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="auto-memory-toggle-switch" id="auto-memory-toggle-switch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="auto-memory-toggle-switch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="personalMemoryManage">ÂÄã‰∫∫ÁøíÊÖ£Ë®òÊÜ∂ÁÆ°ÁêÜ</h3>
                        <div id="personal-memory-list" class="space-y-2"></div>
                        <button id="add-personal-memory-btn" class="mt-4 px-4 py-2 rounded-md btn-primary" data-lang-key="addMemory">Êñ∞Â¢ûË®òÊÜ∂</button>
                    </div>
                    <div id="model-management-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="apiKeyManagement">API ÈáëÈë∞ÁÆ°ÁêÜ</h3>
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-red-500 mb-2" data-lang-key="geminiFollowUpNotice">Â¶ÇÈúÄÂïüÁî®ÂæåÁ∫åËøΩÂïèÂäüËÉΩÂøÖÈúÄÂ°´ÂÖ• gemini api ÊâçÂèØÂïüÁî®„ÄÇ</p>
                                <label for="gemini-api-key-input" class="block text-sm font-medium mb-1" data-lang-key="geminiApiKey">Gemini API ÈáëÈë∞</label>
                                <input type="password" id="gemini-api-key-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="Ëº∏ÂÖ•ÊÇ®ÁöÑ Google API ÈáëÈë∞" data-lang-key-placeholder="geminiApiPlaceholder">
                            </div>
                            <div>
                                <label for="openrouter-api-key-input-all" class="block text-sm font-medium mb-1" data-lang-key="openRouterApiKey">OpenRouter API ÈáëÈë∞</label>
                                <p class="text-xs text-[var(--text-secondary)] mb-2" data-lang-key="openRouterApiDescAll">Ëº∏ÂÖ•ÊÇ®ÁöÑÂñÆ‰∏Ä OpenRouter ÈáëÈë∞‰ª•ÂïüÁî®ÊâÄÊúâÁõ∏ÈóúÊ®°Âûã„ÄÇ</p>
                                <input type="password" id="openrouter-api-key-input-all" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="sk-or-..." data-lang-key-placeholder="openRouterApiPlaceholder">
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold mb-3 mt-6" data-lang-key="modelListManagement">Ê®°ÂûãÊ∏ÖÂñÆÁÆ°ÁêÜ</h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-3" data-lang-key="modelListManagementDesc">ÈªûÊìäÁÆ≠È†≠‰ª•ÊéíÂ∫è„ÄÅÈªûÊìäÁúºÁùõ‰ª•Èö±Ëóè/È°ØÁ§∫„ÄÅÈªûÊìäÂúìÂúà‰ª•Ë®≠ÂÆöÈ†êË®≠Ê®°Âûã„ÄÇ</p>
                        <div id="model-management-list" class="space-y-2">
                        </div>
                    </div>
                    <div id="data-management-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="dataSync">Ë≥áÊñôÂêåÊ≠•</h3>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="export-data-btn" class="flex-1 text-center p-2 rounded-md bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800 font-medium" data-lang-key="exportData">ÂåØÂá∫Ë≥áÊñô</button>
                            <button id="import-data-btn" class="flex-1 text-center p-2 rounded-md bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800 font-medium" data-lang-key="importData">ÂåØÂÖ•Ë≥áÊñô</button>
                        </div>
                        <button id="open-archived-modal-btn" class="w-full text-left p-2 rounded-md hover:bg-[var(--hover-bg)] font-medium mt-4" data-lang-key="manageArchived">
                            ÁÆ°ÁêÜÂ∑≤Â∞ÅÂ≠òÁöÑÂ∞çË©±
                        </button>
                        <div class="mt-6 pt-4 border-t border-red-500/30">
                            <h3 class="text-lg font-semibold mb-3 text-red-600" data-lang-key="dangerZone">Âç±Èö™ÂçÄÂüü</h3>
                            <p class="text-sm text-[var(--text-secondary)] mb-3" data-lang-key="dangerZoneDesc">
                                ‰ª•‰∏ãÊìç‰ΩúÂ∞áÊúÉÊ∞∏‰πÖÂà™Èô§ÊÇ®Âú®Ê≠§ÁÄèË¶ΩÂô®‰∏äÁöÑÊâÄÊúâË≥áÊñôÔºå‰∏îÁÑ°Ê≥ïÂæ©Âéü„ÄÇË´ãË¨πÊÖéÊìç‰Ωú„ÄÇ
                            </p>
                            <button id="delete-all-data-btn" class="w-full text-center p-2 rounded-md bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 hover:bg-red-200 dark:hover:bg-red-800 font-medium" data-lang-key="deleteAllData">
                                Ê∏ÖÈô§ÊâÄÊúâÁ¥ÄÈåÑËàáË≥áÊñô
                            </button>
                        </div>
                    </div>
                    <div id="accessibility-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="accessibility">ËºîÂä©ÂäüËÉΩ</h3>
                        <div class="flex items-center justify-between">
                            <label for="follow-up-toggle-switch" class="flex-1 text-sm font-medium" data-lang-key="enableFollowUp">ÂïüÁî®ÂæåÁ∫åËøΩÂïèÊèêÁ§∫</label>
                            <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="follow-up-toggle-switch" id="follow-up-toggle-switch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="follow-up-toggle-switch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <label for="auto-naming-toggle-switch" class="flex-1 text-sm font-medium" data-lang-key="enableAutoNaming">ÂïüÁî®Â∞çË©±Ëá™ÂãïÂëΩÂêç</label>
                            <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="auto-naming-toggle-switch" id="auto-naming-toggle-switch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="auto-naming-toggle-switch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <label for="auto-web-search-toggle-switch" class="flex-1 text-sm font-medium" data-lang-key="enableSmartWebSearch">ÂïüÁî®Êô∫ÊÖßÈÄ£Á∂≤ÊêúÂ∞ã</label>
                            <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="auto-web-search-toggle-switch" id="auto-web-search-toggle-switch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="auto-web-search-toggle-switch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                    <div id="trash-section" class="settings-section">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold" data-lang-key="trash">ÂûÉÂúæÊ°∂</h3>
                            <div class="flex gap-2">
                                <button id="trash-batch-select-btn" class="text-sm px-3 py-1.5 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] hover:bg-[var(--hover-bg)]" data-lang-key="batchSelect">
                                    ÊâπÊ¨°ÈÅ∏Âèñ
                                </button>
                                <button id="empty-trash-btn" class="text-sm px-3 py-1.5 rounded-md bg-red-100 text-red-800 hover:bg-red-200" data-lang-key="emptyTrash">
                                    Ê∏ÖÁ©∫ÂûÉÂúæÊ°∂
                                </button>
                            </div>
                        </div>
                        <div id="trash-batch-action-bar" class="hidden mb-4 p-2 rounded-md bg-[var(--sidebar-bg)] border border-[var(--border-color)]">
                            <div class="flex justify-between items-center text-xs mb-1 px-1">
                                <span id="trash-selection-count" class="font-medium text-[var(--text-secondary)]"></span>
                                <button id="trash-cancel-selection-btn" class="text-blue-600 hover:underline font-semibold" data-lang-key="done">ÂÆåÊàê</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="trash-batch-restore-btn" class="p-2 text-sm rounded-md bg-green-500 text-white disabled:bg-green-300" disabled data-lang-key="restore">Âæ©Âéü</button>
                                <button id="trash-batch-delete-btn" class="p-2 text-sm rounded-md bg-red-500 text-white disabled:bg-red-300" disabled data-lang-key="permanentlyDelete">Ê∞∏‰πÖÂà™Èô§</button>
                            </div>
                        </div>
                        <div id="trash-list-container" class="space-y-2">
                        </div>
                    </div>
                    <div id="about-section" class="settings-section">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="feedback">ÊÑèË¶ãÂèçÈ•ã</h3>
<p class="text-sm text-[var(--text-secondary)] mb-2" data-lang-key="feedbackDesc">
    Êúâ‰ªª‰ΩïÂïèÈ°åÊàñÂª∫Ë≠∞ÂóéÔºüË´ãÂëäË®¥ÊàëÂÄëÔºÅÊÇ®ÁöÑÂèçÈ•ãÂ∞áÁõ¥Êé•ÁôºÈÄÅÂà∞ÈñãÁôºËÄÖÁöÑ‰ø°ÁÆ±„ÄÇ
</p>
<div class="space-y-3">
    <textarea id="feedback-textarea" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] h-28" placeholder="Ë´ãÂú®Ê≠§Ëº∏ÂÖ•ÊÇ®ÁöÑÂØ∂Ë≤¥ÊÑèË¶ã..." data-lang-key-placeholder="feedbackPlaceholder"></textarea>
    <button id="send-feedback-btn" class="w-full text-center p-2 rounded-md btn-primary" data-lang-key="sendFeedback">
        ÁôºÈÄÅÊÑèË¶ã
    </button>
</div>
<div class="border-t border-[var(--border-color)] my-6"></div>
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="helpCenter">ÂçîÂä©‰∏≠ÂøÉ</h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="helpCenterDesc">ÂÖßÂÆπÂæÖË£úÂÖÖ...</p>
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="termsOfUse">‰ΩøÁî®Ê¢ùÊ¨æ</h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="termsOfUseDesc">ÂÖßÂÆπÂæÖË£úÂÖÖ...</p>
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="privacyPolicy">Èö±ÁßÅÊ¨äÊîøÁ≠ñ</h3>
                        <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="privacyPolicyDesc">ÂÖßÂÆπÂæÖË£úÂÖÖ...</p>
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="versionInfo">ÁâàÊú¨Ë≥áË®ä</h3>
                        <div class="space-y-3 p-3 rounded-lg bg-[var(--input-field-bg)] border border-[var(--border-color)]">
                            <button id="update-info-btn" class="w-full text-left py-2 rounded-md hover:bg-[var(--hover-bg)] font-medium flex justify-between items-center">
                                <span data-lang-key="viewUpdateHistory">Êü•ÁúãÁâàÊú¨Êõ¥Êñ∞Ë≥áË®ä</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                            <div class="border-t border-[var(--border-color)]"></div>
                            <div class="flex items-center justify-between pt-2">
                                <label for="enable-update-notifications-toggle" class="flex-1 text-sm font-medium" data-lang-key="enableUpdateNotifications">ÂïüÁî®Êõ¥Êñ∞ÈÄöÁü•ÂΩàÁ™ó</label>
                                <div class="relative inline-block w-12 h-6 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="enable-update-notifications-toggle" id="enable-update-notifications-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="enable-update-notifications-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-[var(--text-secondary)] mt-4" data-lang-key="versionNumber">ÁõÆÂâçÁâàÊú¨Ôºö<span id="version-number-display">15.0.0</span></p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-[var(--sidebar-bg)] border-t border-[var(--border-color)] flex justify-end gap-3">
                <button id="close-settings-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="close">ÈóúÈñâ</button>
                <button id="save-settings-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="save">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>
    <div id="export-data-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="exportData">ÂåØÂá∫Ë≥áÊñô</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="selectDataToExport">ÈÅ∏ÊìáÊÇ®ÊÉ≥Ë¶ÅÂåØÂá∫ÁöÑË≥áÊñô„ÄÇ</p>
            <div class="space-y-3 mb-4">
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-history-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                    <span data-lang-key="exportHistory">Ê≠∑Âè≤Â∞çË©±Á¥ÄÈåÑ (Âê´Â∞ÅÂ≠òËàáË≥áÊñôÂ§æ)</span>
                </label>
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-astras-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                    <span data-lang-key="astras">Astras</span>
                </label>
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-settings-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                    <span data-lang-key="appSettings">ÊáâÁî®Á®ãÂºèË®≠ÂÆö</span>
                </label>
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-api-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span data-lang-key="exportApiKeys">API ÈáëÈë∞ (Gemini Âíå OpenRouter)</span>
                </label>
                <label class="flex items-center space-x-3 p-2 rounded-md bg-[var(--input-field-bg)]">
                    <input type="checkbox" id="export-memory-check" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span data-lang-key="exportPersonalMemory">ÂÄã‰∫∫ÁøíÊÖ£Ë®òÊÜ∂ (È°ûÂûã1)</span>
                </label>
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancel-export-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
                <button id="confirm-export-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="confirmAndExport">Á¢∫Ë™ç‰∏¶ÂåØÂá∫</button>
            </div>
        </div>
    </div>
    <div id="import-data-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="importData">ÂåØÂÖ•Ë≥áÊñô</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="importDataDesc">ÈÅ∏Êìá‰∏ÄÂÄã‰πãÂâçÂåØÂá∫ÁöÑ `.json` Ê™îÊ°à„ÄÇÁõÆÂâçÁöÑÊâÄÊúâË≥áÊñôÂ∞áÊúÉË¢´Ë¶ÜËìã„ÄÇ</p>
            <div class="mb-4">
                <label for="import-file-input" class="block text-sm font-medium mb-1" data-lang-key="selectFile">ÈÅ∏ÊìáÊ™îÊ°à</label>
                <input type="file" id="import-file-input" class="w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".json" required>
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancel-import-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
                <button id="confirm-import-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" data-lang-key="confirmAndImport">Á¢∫Ë™ç‰∏¶ÂåØÂÖ•</button>
            </div>
        </div>
    </div>
    <div id="import-data-modal-auth" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
    <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4" data-lang-key="importRecords">ÂåØÂÖ•Á¥ÄÈåÑ</h2>
        <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="importDataDescAuth">ÈÅ∏Êìá‰∏ÄÂÄã‰πãÂâçÂåØÂá∫ÁöÑ `.json` Ê™îÊ°à„ÄÇÊÇ®Ëº∏ÂÖ•ÁöÑÂ∏≥ËôüÂØÜÁ¢ºÂ∞áÁî®ÊñºÈ©óË≠âÂÇô‰ªΩÊ™îÊ°àÁöÑÊâÄÊúâÊ¨ä„ÄÇ</p>
        <div class="mb-4">
            <label for="import-file-input-auth" class="block text-sm font-medium mb-1" data-lang-key="selectFile">ÈÅ∏ÊìáÊ™îÊ°à</label>
            <input type="file" id="import-file-input-auth" class="w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".json" required>
        </div>
        <div class="flex justify-end gap-3">
            <button id="cancel-import-btn-auth" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
            <button id="confirm-import-btn-auth" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" data-lang-key="confirmAndImport">Á¢∫Ë™ç‰∏¶ÂåØÂÖ•</button>
        </div>
    </div>
</div>
    <div id="archived-chats-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-2xl font-bold" data-lang-key="archivedChats">Â∑≤Â∞ÅÂ≠òÁöÑÂ∞çË©±</h2>
                <button id="close-archived-modal-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div id="archived-chats-container" class="p-6 overflow-y-auto space-y-2 scroll-area"></div>
        </div>
    </div>
    <div id="view-archived-chat-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[51]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-3xl flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center flex-shrink-0">
                <h2 id="view-archived-title" class="text-2xl font-bold truncate" data-lang-key="viewArchivedChat">Ê™¢Ë¶ñÂ∞ÅÂ≠òÁöÑÂ∞çË©±</h2>
                <button id="close-view-archived-modal-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div id="view-archived-content" class="p-6 overflow-y-auto space-y-4 scroll-area flex-1">
            </div>
            <div class="p-4 bg-[var(--sidebar-bg)] border-t border-[var(--border-color)] flex justify-end gap-3 flex-shrink-0">
                <button id="close-view-archived-modal-btn-footer" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="close">ÈóúÈñâ</button>
            </div>
        </div>
    </div>
    <div id="rename-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="rename">ÈáçÊñ∞ÂëΩÂêç</h2>
            <input type="text" id="rename-input" class="w-full p-2 border border-[var(--border-color)] rounded-md mb-4 bg-[var(--input-field-bg)]" placeholder="Ëº∏ÂÖ•Êñ∞ÂêçÁ®±" data-lang-key-placeholder="enterNewName">
            <div class="flex justify-end gap-3">
                <button id="cancel-rename-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
                <button id="save-rename-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="save">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>
    <div id="folder-settings-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="customizeFolder">Ëá™Ë®ÇË≥áÊñôÂ§æ</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="text-sm font-medium mb-2" data-lang-key="selectColor">ÈÅ∏ÊìáÈ°èËâ≤</h3>
                    <div id="color-swatches-container" class="grid grid-cols-8 gap-2"></div>
                </div>
                <div>
                    <h3 class="text-sm font-medium mb-2" data-lang-key="selectIcon">ÈÅ∏ÊìáÂúñÁ§∫</h3>
                    <div id="icon-options-container" class="grid grid-cols-8 gap-2"></div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-folder-settings-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
                <button id="save-folder-settings-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="save">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>
    <div id="search-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-xl font-bold" data-lang-key="searchConversations">ÊêúÂ∞ãÂ∞çË©±</h2>
                <button id="close-search-modal-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 flex items-center gap-2 border-b border-[var(--border-color)]">
                <input type="search" id="modal-search-input" placeholder="ÊêúÂ∞ã..." class="flex-1 p-2 text-sm border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] focus:ring-2 focus:ring-blue-500 focus:outline-none" data-lang-key-placeholder="searchPlaceholder">
                <select id="modal-search-scope-select" class="text-sm border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] focus:ring-2 focus:ring-blue-500 focus:outline-none p-2">
                    <option value="keyword-title" data-lang-key="searchScopeTitle">ÈóúÈçµÂ≠ó (Ê®ôÈ°å)</option>
                    <option value="keyword-content" data-lang-key="searchScopeContent">ÈóúÈçµÂ≠ó (ÂÖßÊñá)</option>
                    <option value="natural" data-lang-key="searchScopeNatural">Ëá™ÁÑ∂Ë™ûË®Ä</option>
                </select>
                <button id="perform-search-btn" class="p-2 rounded-md text-white btn-primary" data-lang-key="search">ÊêúÂ∞ã</button>
                <button id="voice-input-btn-search" title="Ë™ûÈü≥Ëº∏ÂÖ•" class="voice-input-btn" data-lang-key-title="voiceInput">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line></svg>
                </button>
            </div>
            <div id="search-results-container" class="p-4 overflow-y-auto space-y-2 scroll-area flex-1">
                <p class="text-center text-[var(--text-secondary)]" data-lang-key="searchPrompt">Ë´ãËº∏ÂÖ•ÈóúÈçµÂ≠óÈÄ≤Ë°åÊêúÂ∞ã„ÄÇ</p>
            </div>
        </div>
    </div>
    <div id="search-view-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[51]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-3xl flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center flex-shrink-0">
                <h2 id="search-view-title" class="text-2xl font-bold truncate">Ê™¢Ë¶ñÂ∞çË©±</h2>
                <button id="close-search-view-modal-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div id="search-view-content" class="p-6 overflow-y-auto space-y-4 scroll-area flex-1" style="-webkit-user-select: none; user-select: none;">
            </div>
            <div class="p-4 bg-[var(--sidebar-bg)] border-t border-[var(--border-color)] flex justify-end gap-3 flex-shrink-0">
                <button id="search-view-close-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="close">ÈóúÈñâ</button>
                <button id="search-view-confirm-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="confirm">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>
    <div id="trash-view-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[51]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-3xl flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center flex-shrink-0">
                <h2 id="trash-view-title" class="text-2xl font-bold truncate" data-lang-key="viewTrashItem">Ê™¢Ë¶ñÂ∑≤Âà™Èô§È†ÖÁõÆ</h2>
                <button id="close-trash-view-modal-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div id="trash-view-content" class="p-6 overflow-y-auto space-y-4 scroll-area flex-1">
            </div>
            <div class="p-4 bg-[var(--sidebar-bg)] border-t border-[var(--border-color)] flex justify-end gap-3 flex-shrink-0">
                <button id="trash-view-close-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="close">ÈóúÈñâ</button>
            </div>
        </div>
    </div>
    <div id="notification-container"></div>
    <div id="custom-dialog-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="custom-dialog-title" class="text-xl font-bold mb-4"></h2>
            <p id="custom-dialog-message" class="text-[var(--text-secondary)] mb-6"></p>
            <div id="custom-dialog-input-container" class="mb-4 hidden">
                <input id="custom-dialog-input" type="text" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]">
            </div>
            <div id="custom-dialog-buttons" class="flex justify-end gap-3"></div>
        </div>
    </div>
    <div id="astras-create-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="createAstras">ÂâµÂª∫ Astras</h2>
            <div class="space-y-4">
                <div>
                    <label for="astras-name-input" class="block text-sm font-medium mb-1" data-lang-key="name">ÂêçÁ®±</label>
                    <input type="text" id="astras-name-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="Ëº∏ÂÖ• Astras ÂêçÁ®±" data-lang-key-placeholder="astrasNamePlaceholder">
                </div>
                <div>
                    <label for="astras-desc-input" class="block text-sm font-medium mb-1" data-lang-key="description">Ë™™Êòé</label>
                    <input type="text" id="astras-desc-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="Ëº∏ÂÖ• Astras Ë™™Êòé" data-lang-key-placeholder="astrasDescPlaceholder">
                </div>
                <div>
                    <label for="astras-instructions-input" class="block text-sm font-medium mb-1" data-lang-key="instructions">Êåá‰ª§</label>
                    <textarea id="astras-instructions-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] h-32" placeholder="Ëº∏ÂÖ• Astras Êåá‰ª§" data-lang-key-placeholder="astrasInstructionsPlaceholder"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-astras-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
                <button id="save-astras-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="save">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>
    <div id="batch-move-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" data-lang-key="batchMove">ÊâπÊ¨°ÁßªÂãï</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="batchMoveDesc">ÈÅ∏ÊìáË¶ÅÁßªÂãïÂà∞ÁöÑË≥áÊñôÂ§æÔºåÊàñÁßªÂá∫Ë≥áÊñôÂ§æ„ÄÇ</p>
            <div class="space-y-2 mb-4" id="batch-move-folder-list">
            </div>
            <div class="flex justify-end gap-3">
                <button id="batch-move-cancel-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
                <button id="batch-move-confirm-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="confirm">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>
    <div id="data-dashboard-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-4xl flex flex-col" style="height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-2xl font-bold" data-lang-key="dashboard">ÂÄã‰∫∫Êï∏ÊìöÈù¢Êùø</h2>
                <button id="close-dashboard-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div class="flex-1 p-6 overflow-y-auto scroll-area space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]" data-lang-key="totalConversations">Á∏ΩÂ∞çË©±Êï∏</h3>
                        <p id="total-conv-stat" class="text-3xl font-bold"></p>
                    </div>
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]" data-lang-key="totalFolders">Ë≥áÊñôÂ§æÊï∏Èáè</h3>
                        <p id="total-folder-stat" class="text-3xl font-bold"></p>
                    </div>
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]" data-lang-key="mostUsedModel">ÊúÄÂ∏∏‰ΩøÁî®ÁöÑÊ®°Âûã</h3>
                        <p id="most-used-model-stat" class="text-2xl font-bold truncate"></p>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3" data-lang-key="modelUsageRatio">Ê®°Âûã‰ΩøÁî®ÊØî‰æã</h3>
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg" style="height: 300px;">
                        <canvas id="model-usage-pie-chart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3" data-lang-key="messageTimeDistribution">Ë®äÊÅØÊï∏ÈáèÊôÇÈñìÂàÜ‰Ωà</h3>
                    <div class="p-4 bg-[var(--sidebar-bg)] rounded-lg">
                        <div class="flex flex-wrap gap-2 mb-4 items-center">
                            <label for="time-analysis-year-select" class="text-sm" data-lang-key="year">Âπ¥‰ªΩ:</label>
                            <select id="time-analysis-year-select" class="p-1 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] text-sm"></select>
                            <label for="time-analysis-month-select" class="text-sm" data-lang-key="month">Êúà‰ªΩ:</label>
                            <select id="time-analysis-month-select" class="p-1 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] text-sm" disabled></select>
                            <label for="time-analysis-day-select" class="text-sm" data-lang-key="day">Êó•Êúü:</label>
                            <select id="time-analysis-day-select" class="p-1 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] text-sm" disabled></select>
                        </div>
                        <div id="time-chart-container" style="height: 300px;">
                             <canvas id="time-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="wallpaper-crop-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[51]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-4xl p-6">
            <h2 class="text-2xl font-bold mb-4" data-lang-key="cropWallpaper">Ë£ÅÂàáÊ°åÂ∏É</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="cropWallpaperDesc">
                ÊãñÂãïÈÅ∏Ê°Ü‰ª•Ë™øÊï¥ÊÇ®ÊÉ≥Ë¶ÅÁöÑÊ°åÂ∏ÉÂçÄÂüüÔºåÂª∫Ë≠∞‰ΩøÁî®Á¨¶ÂêàËû¢ÂπïÊØî‰æãÁöÑË£ÅÂàá„ÄÇ
            </p>
            <div id="wallpaper-crop-container">
                <img id="wallpaper-crop-image" src="" alt="Wallpaper for cropping">
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancel-crop-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
                <button id="confirm-crop-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="confirmAndApply">Á¢∫Ë™ç‰∏¶Â•óÁî®</button>
            </div>
        </div>
    </div>
    <div id="astras-avatar-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[51]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-4" data-lang-key="setAstrasAvatar">Ë®≠ÂÆö Astras È†≠ÂÉè</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="cropAvatarDesc">
                ÁßªÂãïÂíåÁ∏ÆÊîæÂúñÁâá‰ª•Ë£ÅÂàáÊÇ®ÂñúÊ≠°ÁöÑÂúìÂΩ¢È†≠ÂÉè„ÄÇ
            </p>
            <div id="avatar-crop-container" class="w-full max-h-[50vh] mb-4 bg-gray-200 dark:bg-gray-700 rounded-md">
                <img id="avatar-crop-image" src="" alt="Avatar for cropping">
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancel-avatar-crop-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
                <button id="confirm-avatar-crop-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="confirmAndApply">Á¢∫Ë™ç‰∏¶Â•óÁî®</button>
            </div>
        </div>
    </div>
    <div id="update-info-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[51]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-6 border-b border-[var(--border-color)] flex justify-between items-center">
                <h2 class="text-2xl font-bold" data-lang-key="updateHistory">ÁâàÊú¨Êõ¥Êñ∞Ê≠∑Âè≤</h2>
                <button id="close-update-info-modal-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] text-2xl leading-none">&times;</button>
            </div>
            <div id="update-info-content" class="p-6 overflow-y-auto space-y-6 scroll-area">
            </div>
        </div>
    </div>
    <div id="latest-update-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60]">
        <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-6 border-b border-[var(--border-color)]">
                <h2 class="text-xl font-bold" data-lang-key="newVersionReleased">Êñ∞ÁâàÊú¨ÁôºÂ∏ÉÔºÅ</h2>
            </div>
            <div id="latest-update-content" class="p-6 prose prose-sm max-w-none">
            </div>
            <div class="p-4 bg-[var(--sidebar-bg)] border-t border-[var(--border-color)] flex justify-end gap-3">
                <button id="close-latest-update-modal-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="iGotIt">ÊàëÁü•ÈÅì‰∫Ü</button>
            </div>
        </div>
    </div>
    <input type="file" id="image-video-input" class="hidden" accept="image/*,video/*" multiple>
    <input type="file" id="file-upload-input" class="hidden" multiple>
    <input type="file" id="wallpaper-upload-input" class="hidden" accept="image/*">
    <input type="file" id="astras-avatar-input" class="hidden" accept="image/*">
    <div id="astras-proposal-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
    <div class="bg-[var(--modal-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4" data-lang-key="proposeNewAstras">ÊèêÊ°àÊñ∞ÁöÑ Astras</h2>
        <p class="text-sm text-[var(--text-secondary)] mb-4" data-lang-key="proposeAstrasDesc">
            ÊÇ®ÁöÑÊèêÊ°àÂ∞áÊúÉ‰ª•ÈÉµ‰ª∂ÂΩ¢ÂºèÁôºÈÄÅÁµ¶ÈñãÁôºËÄÖÔºåÊÑüË¨ùÊÇ®ÁöÑË≤¢ÁçªÔºÅ
        </p>
        <div class="space-y-4">
            <div>
                <label for="proposal-name-input" class="block text-sm font-medium mb-1" data-lang-key="name">ÂêçÁ®±</label>
                <input type="text" id="proposal-name-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="ÁÇ∫ÈÄôÂÄã Astras ÂèñÂÄãÂêçÂ≠ó" data-lang-key-placeholder="astrasNamePlaceholder">
            </div>
            <div>
                <label for="proposal-desc-input" class="block text-sm font-medium mb-1" data-lang-key="description">Ë™™Êòé (ÈÅ∏Â°´)</label>
                <input type="text" id="proposal-desc-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)]" placeholder="Á∞°Áü≠ÊèèËø∞ÂÆÉÁöÑÂäüËÉΩ" data-lang-key-placeholder="astrasDescPlaceholder">
            </div>
            <div>
                <label for="proposal-instructions-input" class="block text-sm font-medium mb-1" data-lang-key="instructions">Êåá‰ª§</label>
                <textarea id="proposal-instructions-input" class="w-full p-2 border border-[var(--border-color)] rounded-md bg-[var(--input-field-bg)] h-32" placeholder="Ë©≥Á¥∞Ë™™ÊòéÈÄôÂÄã Astras Ë©≤Â¶Ç‰ΩïÈÅã‰Ωú" data-lang-key-placeholder="astrasInstructionsPlaceholder"></textarea>
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button id="cancel-proposal-btn" class="bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]" data-lang-key="cancel">ÂèñÊ∂à</button>
            <button id="submit-proposal-btn" class="px-4 py-2 rounded-md btn-primary" data-lang-key="submitProposal">Êèê‰∫§ÊèêÊ°à</button>
        </div>
    </div>
</div>
    <div id="mobile-context-menu-wrapper"></div>
    <script src="./i18n.js"></script>
    <script src="./demo-conversations.js"></script>
    <script src="./astras-data.js"></script>
    <script src="./update-logs.js"></script>
    <script src="./main.js"></script>
     <script>
        document.addEventListener('DOMContentLoaded', () => {
            const demoModels = [
  { id: 'ultra', name: 'Astra-Ultra', title: 'Astra-Ultra Â∞çË©±ÁØÑ‰æã', desc: 'ÊóóËâ¶È†ÇÈÖçÔºåÈï∑ÊñáË∑®ÂüüÊé®ÁêÜÂ∞àÂÆ∂' },
  { id: 'proMax', name: 'Astra-Pro Max', title: 'Astra-Pro Max Â∞çË©±ÁØÑ‰æã', desc: 'Ê∑±Â∫¶Ê±∫Á≠ñÔºåÂïÜÊ•≠Á†îÁ©∂ÊúÄ‰Ω≥ÊãçÊ™î' },
  { id: 'proPV', name: 'Astra-Pro PV', title: 'Astra-Pro PV Â∞çË©±ÁØÑ‰æã', desc: 'È†êË¶ΩÊñ∞ÊäÄË°ìÔºåÂ§öÊ®°ÊÖãÈ´òÈÄüÈ´îÈ©ó' },
  { id: 'pro', name: 'Astra-Pro', title: 'Astra-Pro Â∞çË©±ÁØÑ‰æã', desc: 'È´òÊïàÂ§öÊ®°ÊÖãÔºåÊñáÊ™îÂúñÂÉèÂÖºÊìÖ' },
  { id: 'plusPV', name: 'Astra-Plus PV', title: 'Astra-Plus PV Â∞çË©±ÁØÑ‰æã', desc: 'ËºïÈáèÂø´ÈÄüÔºåÊó•Â∏∏ÊáâÁî®Âç≥ÂàªÂïüÂãï' },
  { id: 'mini', name: 'Astra-Mini', title: 'Astra-Mini Â∞çË©±ÁØÑ‰æã', desc: 'Âº∑Â§ßÊé®ÁêÜÔºåÈï∑ÊñáËàáÊï∏ÁêÜÁöÜËÉΩ' },
  { id: 'mill', name: 'Astra-Mill', title: 'Astra-Mill Â∞çË©±ÁØÑ‰æã', desc: 'ÈñãÊ∫êÈ´òÊïàÔºåÁü≠ÊñáÁîüÊàêËàáÁµêÊßãÂåñ' },
  { id: 'nano', name: 'Astra-Nano', title: 'Astra-Nano Â∞çË©±ÁØÑ‰æã', desc: 'Á®ãÂºèÂ∞àÁ≤æÔºåÊäÄË°ì‰ª£Á¢ºÂ•ΩÂπ´Êâã' },
];
            const selectorContainer = document.querySelector('.demo-model-selector');
            const chatWindow = document.getElementById('demo-chat-window');
            const chatTitle = document.getElementById('demo-chat-title');
            if (selectorContainer && chatWindow && chatTitle) {
                demoModels.forEach((model, index) => {
                    const button = document.createElement('button');
                    button.className = `selector-btn text-center p-3 rounded-lg border-2 border-gray-200 bg-white ${index === 0 ? 'active' : ''}`;
                    button.dataset.modelId = model.id;
                    button.innerHTML = `
                        <div class="font-semibold text-sm text-gray-800">${model.name}</div>
                        <div class="text-xs text-gray-500">${model.desc}</div>
                    `;
                    selectorContainer.appendChild(button);
                    const contentDiv = document.createElement('div');
                    contentDiv.id = `demo-chat-${model.id}`;
                    contentDiv.className = `demo-chat-content space-y-6 ${index === 0 ? 'active' : ''}`;
                    contentDiv.innerHTML = demoConversations[model.id];
                    chatWindow.appendChild(contentDiv);
                });
                selectorContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.selector-btn');
                    if (!button) return;
                    const modelId = button.dataset.modelId;
                    selectorContainer.querySelector('.active').classList.remove('active');
                    button.classList.add('active');
                    chatWindow.querySelector('.active').classList.remove('active');
                    document.getElementById(`demo-chat-${modelId}`).classList.add('active');
                    const modelInfo = demoModels.find(m => m.id === modelId);
                    chatTitle.textContent = modelInfo.title;
                });
            }
        });
        const ALL_ELEMENTS = {
            authContainer: document.getElementById('auth-container'),
            appContainer: document.getElementById('app-container'),
            authForm: document.getElementById('auth-form'),
            usernameInput: document.getElementById('username-input'),
            passwordInput: document.getElementById('password-input'),
            importBtnAuth: document.getElementById('import-btn-auth'),
            importDataModalAuth: document.getElementById('import-data-modal-auth'),
            importFileInputAuth: document.getElementById('import-file-input-auth'),
            cancelImportBtnAuth: document.getElementById('cancel-import-btn-auth'),
            confirmImportBtnAuth: document.getElementById('confirm-import-btn-auth'),
            logoutBtn: document.getElementById('logout-btn'),
            usernameDisplay: document.getElementById('username-display'),
            newChatBtn: document.getElementById('new-chat-btn'),
            openSearchBtn: document.getElementById('open-search-btn'),
            historyList: document.getElementById('history-list'),
            folderList: document.getElementById('folder-list'),
            newFolderBtn: document.getElementById('new-folder-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            headerTitle: document.getElementById('header-title'),
            modelSwitcherContainer: document.getElementById('model-switcher-container'),
            chatContainer: document.getElementById('chat-container'),
            messageList: document.getElementById('message-list'),
            messageInput: document.getElementById('message-input'),
            chatForm: document.getElementById('chat-form'),
            submitButton: document.getElementById('submit-btn'),
            submitButtonIcon: document.getElementById('submit-btn-icon'),
            settingsModal: document.getElementById('settings-modal'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            geminiApiKeyInput: document.getElementById('gemini-api-key-input'),
            openrouterApiKeyInputAll: document.getElementById('openrouter-api-key-input-all'),
            modelManagementList: document.getElementById('model-management-list'),
            openArchivedModalBtn: document.getElementById('open-archived-modal-btn'),
            themeLightBtn: document.getElementById('theme-light-btn'),
            themeDarkBtn: document.getElementById('theme-dark-btn'),
            archivedChatsModal: document.getElementById('archived-chats-modal'),
            closeArchivedModalBtn: document.getElementById('close-archived-modal-btn'),
            archivedChatsContainer: document.getElementById('archived-chats-container'),
            viewArchivedChatModal: document.getElementById('view-archived-chat-modal'),
            viewArchivedTitle: document.getElementById('view-archived-title'),
            viewArchivedContent: document.getElementById('view-archived-content'),
            closeViewArchivedModalBtn: document.getElementById('close-view-archived-modal-btn'),
            closeViewArchivedModalBtnFooter: document.getElementById('close-view-archived-modal-btn-footer'),
            renameModal: document.getElementById('rename-modal'),
            renameInput: document.getElementById('rename-input'),
            saveRenameBtn: document.getElementById('save-rename-btn'),
            cancelRenameBtn: document.getElementById('cancel-rename-btn'),
            folderSettingsModal: document.getElementById('folder-settings-modal'),
            colorSwatchesContainer: document.getElementById('color-swatches-container'),
            iconOptionsContainer: document.getElementById('icon-options-container'),
            saveFolderSettingsBtn: document.getElementById('save-folder-settings-btn'),
            cancelFolderSettingsBtn: document.getElementById('cancel-folder-settings-btn'),
            notificationContainer: document.getElementById('notification-container'),
            customDialogModal: document.getElementById('custom-dialog-modal'),
            customDialogTitle: document.getElementById('custom-dialog-title'),
            customDialogMessage: document.getElementById('custom-dialog-message'),
            customDialogInputContainer: document.getElementById('custom-dialog-input-container'),
            customDialogInput: document.getElementById('custom-dialog-input'),
            customDialogButtons: document.getElementById('custom-dialog-buttons'),
            webSearchPopoverBtn: document.getElementById('web-search-popover-btn'),
            inputIndicatorContainer: document.getElementById('input-indicator-container'),
            selectionModeBtn: document.getElementById('selection-mode-btn'),
            batchActionBar: document.getElementById('batch-action-bar'),
            selectionCount: document.getElementById('selection-count'),
            cancelSelectionBtn: document.getElementById('cancel-selection-btn'),
            batchDeleteBtn: document.getElementById('batch-delete-btn'),
            batchArchiveBtn: document.getElementById('batch-archive-btn'),
            batchMoveBtn: document.getElementById('batch-move-btn'),
            batchMoveModal: document.getElementById('batch-move-modal'),
            batchMoveFolderList: document.getElementById('batch-move-folder-list'),
            batchMoveCancelBtn: document.getElementById('batch-move-cancel-btn'),
            batchMoveConfirmBtn: document.getElementById('batch-move-confirm-btn'),
            userControls: document.getElementById('user-controls'),
            searchModal: document.getElementById('search-modal'),
            closeSearchModalBtn: document.getElementById('close-search-modal-btn'),
            modalSearchInput: document.getElementById('modal-search-input'),
            modalSearchScopeSelect: document.getElementById('modal-search-scope-select'),
            searchResultsContainer: document.getElementById('search-results-container'),
            performSearchBtn: document.getElementById('perform-search-btn'),
            fileInputContainer: document.getElementById('file-input-container'),
            addFileBtn: document.getElementById('add-file-btn'),
            fileOptionsPopover: document.getElementById('file-options-popover'),
            cameraBtn: document.getElementById('camera-btn'),
            uploadImageBtn: document.getElementById('upload-image-btn'),
            uploadFileBtn: document.getElementById('upload-file-btn'),
            imageVideoInput: document.getElementById('image-video-input'),
            fileUploadInput: document.getElementById('file-upload-input'),
            filePreviewContainer: document.getElementById('file-preview-container'),
            exportDataBtn: document.getElementById('export-data-btn'),
            importDataBtn: document.getElementById('import-data-btn'),
            exportDataModal: document.getElementById('export-data-modal'),
            importDataModal: document.getElementById('import-data-modal'),
            cancelExportBtn: document.getElementById('cancel-export-btn'),
            confirmExportBtn: document.getElementById('confirm-export-btn'),
            exportHistoryCheck: document.getElementById('export-history-check'),
            exportAstrasCheck: document.getElementById('export-astras-check'),
            exportSettingsCheck: document.getElementById('export-settings-check'),
            exportMemoryCheck: document.getElementById('export-memory-check'),
            cancelImportBtn: document.getElementById('cancel-import-btn'),
            confirmImportBtn: document.getElementById('confirm-import-btn'),
            importFileInput: document.getElementById('import-file-input'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            sidebarOpenHandle: document.getElementById('sidebar-open-handle'),
            followUpContainer: document.getElementById('follow-up-container'),
            followUpHeader: document.getElementById('follow-up-header'),
            followUpPromptsList: document.getElementById('follow-up-prompts-list'),
            followUpToggleSwitch: document.getElementById('follow-up-toggle-switch'),
            autoNamingToggleSwitch: document.getElementById('auto-naming-toggle-switch'),
            autoWebSearchToggleSwitch: document.getElementById('auto-web-search-toggle-switch'),
            astrasList: document.getElementById('astras-list'),
            newAstrasBtn: document.getElementById('new-astras-btn'),
            astrasCreateModal: document.getElementById('astras-create-modal'),
            astrasNameInput: document.getElementById('astras-name-input'),
            astrasDescInput: document.getElementById('astras-desc-input'),
            astrasInstructionsInput: document.getElementById('astras-instructions-input'),
            saveAstrasBtn: document.getElementById('save-astras-btn'),
            cancelAstrasBtn: document.getElementById('cancel-astras-btn'),
            currentAstrasName: document.getElementById('current-astras-name'),
            aiBubbleColorDropdown: document.getElementById('ai-bubble-color-dropdown'),
            userBubbleColorDropdown: document.getElementById('user-bubble-color-dropdown'),
            settingsNav: document.getElementById('settings-nav'),
            voiceInputBtnMessage: document.getElementById('voice-input-btn-message'),
            voiceInputBtnSearch: document.getElementById('voice-input-btn-search'),
            memoryToggle1: document.getElementById('memory-toggle-1'),
            memoryToggle2: document.getElementById('memory-toggle-2'),
            personalMemoryList: document.getElementById('personal-memory-list'),
            addPersonalMemoryBtn: document.getElementById('add-personal-memory-btn'),
            autoMemoryToggleSwitch: document.getElementById('auto-memory-toggle-switch'),
            wallpaperContainer: document.getElementById('wallpaper-container'),
            uploadWallpaperBtn: document.getElementById('upload-wallpaper-btn'),
            restoreWallpaperBtn: document.getElementById('restore-wallpaper-btn'),
            wallpaperUploadInput: document.getElementById('wallpaper-upload-input'),
            uiColorOptions: document.getElementById('ui-color-options'),
            customColorPickerContainer: document.getElementById('custom-color-picker-container'),
            customColorSwatches: document.getElementById('custom-color-swatches'),
            buttonStyleContainer: document.getElementById('button-style-container'),
            gradientPickerContainer: document.getElementById('gradient-picker-container'),
            gradientSwatches: document.getElementById('gradient-swatches'),
            apiKeyWarningBadge: document.getElementById('api-key-warning-badge'),
            userProfileBtn: document.getElementById('user-profile-btn'),
            dataDashboardModal: document.getElementById('data-dashboard-modal'),
            closeDashboardBtn: document.getElementById('close-dashboard-btn'),
            totalConvStat: document.getElementById('total-conv-stat'),
            totalFolderStat: document.getElementById('total-folder-stat'),
            mostUsedModelStat: document.getElementById('most-used-model-stat'),
            timeAnalysisYearSelect: document.getElementById('time-analysis-year-select'),
            timeAnalysisMonthSelect: document.getElementById('time-analysis-month-select'),
            timeAnalysisDaySelect: document.getElementById('time-analysis-day-select'),
            wallpaperCropModal: document.getElementById('wallpaper-crop-modal'),
            wallpaperCropImage: document.getElementById('wallpaper-crop-image'),
            cancelCropBtn: document.getElementById('cancel-crop-btn'),
            confirmCropBtn: document.getElementById('confirm-crop-btn'),
            deleteAllDataBtn: document.getElementById('delete-all-data-btn'),
            loginLanguageSwitcher: document.getElementById('login-language-switcher'),
            loginLangBtn: document.getElementById('login-lang-btn'),
            loginLangMenu: document.getElementById('login-lang-menu'),
            loginLangLabel: document.getElementById('login-lang-label'),
            uiLanguageSelect: document.getElementById('ui-language-select'),
            aiLanguageSelect: document.getElementById('ai-language-select'),
            storeContainer: document.getElementById('store-container'),
            openStoreBtn: document.getElementById('open-store-btn'),
            backToChatBtn: document.getElementById('back-to-chat-btn'),
            storeGrid: document.getElementById('store-grid'),
            astrasAvatarModal: document.getElementById('astras-avatar-modal'),
            avatarCropContainer: document.getElementById('avatar-crop-container'),
            avatarCropImage: document.getElementById('avatar-crop-image'),
            confirmAvatarCropBtn: document.getElementById('confirm-avatar-crop-btn'),
            cancelAvatarCropBtn: document.getElementById('cancel-avatar-crop-btn'),
            astrasAvatarInput: document.getElementById('astras-avatar-input'),
            scrollToBottomBtn: document.getElementById('scroll-to-bottom-btn'),
            inputBarContainer: document.getElementById('input-bar-container'),
            searchViewModal: document.getElementById('search-view-modal'),
            searchViewTitle: document.getElementById('search-view-title'),
            searchViewContent: document.getElementById('search-view-content'),
            closeSearchViewModalBtn: document.getElementById('close-search-view-modal-btn'),
            searchViewCloseBtn: document.getElementById('search-view-close-btn'),
            searchViewConfirmBtn: document.getElementById('search-view-confirm-btn'),
            updateInfoBtn: document.getElementById('update-info-btn'),
            updateInfoModal: document.getElementById('update-info-modal'),
            closeUpdateInfoModalBtn: document.getElementById('close-update-info-modal-btn'),
            updateInfoContent: document.getElementById('update-info-content'),
            enableUpdateNotificationsToggle: document.getElementById('enable-update-notifications-toggle'),
            latestUpdateModal: document.getElementById('latest-update-modal'),
            closeLatestUpdateModalBtn: document.getElementById('close-latest-update-modal-btn'),
            latestUpdateContent: document.getElementById('latest-update-content'),
            trashSection: document.getElementById('trash-section'),
            trashBatchSelectBtn: document.getElementById('trash-batch-select-btn'),
            emptyTrashBtn: document.getElementById('empty-trash-btn'),
            trashBatchActionBar: document.getElementById('trash-batch-action-bar'),
            trashSelectionCount: document.getElementById('trash-selection-count'),
            trashCancelSelectionBtn: document.getElementById('trash-cancel-selection-btn'),
            trashBatchRestoreBtn: document.getElementById('trash-batch-restore-btn'),
            trashBatchDeleteBtn: document.getElementById('trash-batch-delete-btn'),
            trashListContainer: document.getElementById('trash-list-container'),
            trashViewModal: document.getElementById('trash-view-modal'),
            trashViewTitle: document.getElementById('trash-view-title'),
            trashViewContent: document.getElementById('trash-view-content'),
            closeTrashViewModalBtn: document.getElementById('close-trash-view-modal-btn'),
            trashViewCloseBtn: document.getElementById('trash-view-close-btn'),
            learningModeBtn: document.getElementById('learning-mode-btn'),
            feedbackTextarea: document.getElementById('feedback-textarea'),
            sendFeedbackBtn: document.getElementById('send-feedback-btn'),
            proposeAstrasBtn: document.getElementById('propose-astras-btn'),
            astrasProposalModal: document.getElementById('astras-proposal-modal'),
            proposalNameInput: document.getElementById('proposal-name-input'),
            proposalDescInput: document.getElementById('proposal-desc-input'),
            proposalInstructionsInput: document.getElementById('proposal-instructions-input'),
            cancelProposalBtn: document.getElementById('cancel-proposal-btn'),
            submitProposalBtn: document.getElementById('submit-proposal-btn'),
        };
        const compareVersions = (v1, v2) => {
            if (!v2) return 1;
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);
            const len = Math.max(parts1.length, parts2.length);
            for (let i = 0; i < len; i++) {
                const p1 = parts1[i] || 0;
                const p2 = parts2[i] || 0;
                if (p1 > p2) return 1;
                if (p1 < p2) return -1;
            }
            return 0;
        };
        const MODELS = [
            { id: 'x-ai/grok-4-fast:free', name: 'Astra-Ultra (Grok-4-Fast)', provider: 'openrouter', descriptionKey: 'model_Ultra_desc', limitsKey: 'model_Ultra_limits' },
            { id: 'gemini-2.5-pro', name: 'Astra-Pro Max (2.5-Pro)', provider: 'gemini', descriptionKey: 'model_ProMax_desc', limitsKey: 'model_ProMax_limits' },
            { id: 'gemini-2.5-flash-preview-09-2025', name: 'Astra-Pro PV (2.5-Flash PV)', provider: 'gemini', descriptionKey: 'model_ProPV_desc', limitsKey: 'model_ProPV_limits' },
            { id: 'gemini-2.5-flash', name: 'Astra-Pro (2.5-Flash)', provider: 'gemini', descriptionKey: 'model_Pro_desc', limitsKey: 'model_Pro_limits' },
            { id: 'gemini-2.5-flash-lite-preview-09-2025', name: 'Astra-Plus PV (2.5-Flash-Lite PV)', provider: 'gemini', descriptionKey: 'model_PlusPV_desc', limitsKey: 'model_PlusPV_limits' },
            { id: 'deepseek/deepseek-chat-v3.1:free', name: 'Astra-Mini (Deepseek-V3.1)', provider: 'openrouter', descriptionKey: 'model_Mini_desc', limitsKey: 'model_Mini_limits' },
            { id: 'mistralai/mistral-small-3.2-24b-instruct:free', name: 'Astra-Mill (Mistral3.2)', provider: 'openrouter', descriptionKey: 'model_Mill_desc', limitsKey: 'model_Mill_limits' },
            { id: 'qwen/qwen3-coder:free', name: 'Astra-Nano (Qwen3)', provider: 'openrouter', descriptionKey: 'model_Nano_desc', limitsKey: 'model_Nano_limits' },
            ];
        const CHEAP_MODEL_ID = 'gemini-2.5-flash-lite';
        const FOLDER_COLORS = {
            gray: '#808080', red: '#f87171', yellow: '#facc15', green: '#4ade80',
            blue: '#60a5fa', indigo: '#818cf8', purple: '#a78bfa', pink: '#f472b6',
        };
        const AI_BUBBLE_COLORS = {
            default: {light: '#f7f7f8', dark: '#1c1c1c'},
            gray: {light: '#f3f4f6', dark: '#374151'},
            blue: {light: '#e0f7fa', dark: '#006064'},
            green: {light: '#e8f5e9', dark: '#1b5e20'},
            yellow: {light: '#fffde7', dark: '#f57f17'},
            orange: {light: '#fff3e0', dark: '#ef6c00'},
            red: {light: '#ffebee', dark: '#b71c1c'},
            purple: {light: '#f3e5f5', dark: '#6a1b9a'},
            pink: {light: '#fce4ec', dark: '#ad1457'},
            teal: {light: '#e0f2f1', dark: '#004d40'},
        };
        const USER_BUBBLE_COLORS = {
            default: {light: '#3b82f6', dark: '#2563eb'},
            gray: {light: '#6b7280', dark: '#4b5563'},
            blue: {light: '#3b82f6', dark: '#2563eb'},
            green: {light: '#22c55e', dark: '#15803d'},
            yellow: {light: '#eab308', dark: '#a16207'},
            orange: {light: '#f97316', dark: '#c2410c'},
            red: {light: '#ef4444', dark: '#b91c1c'},
            purple: {light: '#8b5cf6', dark: '#6d28d9'},
            pink: {light: '#ec4899', dark: '#be185d'},
            teal: {light: '#14b8a6', dark: '#0f766e'},
        };
        const UI_THEME_COLORS = {
            Red: '#ef4444', Orange: '#f97316', Amber: '#f59e0b',
            Yellow: '#eab308', Lime: '#84cc16', Green: '#22c55e',
            Emerald: '#10b981', Teal: '#14b8a6', Cyan: '#06b6d4',
            Sky: '#0ea5e9', Blue: '#3b82f6', Indigo: '#6366f1',
            Violet: '#8b5cf6', Purple: '#a855f7', Fuchsia: '#d946ef',
            Pink: '#ec4899', Rose: '#f43f5e', Slate: '#64748b'
        };
        let conversations = [];
        let folders = [];
        let astras = [];
        let personalMemories = [];
        let activeConversationId = null;
        let config = {
            apiKeys: { gemini: '', openrouter: '' },
            defaultModel: MODELS[0].id,
            theme: 'light',
            modelSettings: [],
            enableFollowUp: true,
            enableAutoWebSearch: false,
            aiBubbleColor: 'default',
            userBubbleColor: 'default',
            autoNaming: true,
            lastUsedModel: null,
            memoryEnabled1: true,
            memoryEnabled2: true,
            enableAutoMemory: true,
            customWallpaper: null,
            wallpaperBrightness: 'light',
            uiTheme: {
                mode: 'default',
                style: 'single',
                customColor: '#3b82f6',
                adaptiveColor: '#3b82f6',
                adaptivePalette: [],
                adaptiveGradient: ''
            },
            uiLanguage: 'zh-TW',
            aiDefaultLanguage: 'zh-TW',
            enableUpdateNotifications: true,
            lastSeenVersion: '',
            isLearningMode: false,
        };
        let itemToRename = { id: null, type: null };
        let folderToCustomize = null;
        let currentUser = null;
        let abortController = null;
        let isSelectionMode = false;
        let selectedConversationIds = new Set();
        let uploadedFiles = [];
        let sidebarOpen = false;
        let sendConfirmed = false;
        let isFollowUpExpanded = true;
        let editingAstrasId = null;
        let currentSpeechRecognition = null;
        let currentVoiceTarget = null;
        let modelPieChart = null;
        let timeDistChart = null;
        let cropperInstance = null;
        let currentStoreCategory = 'ÂÖ®ÈÉ®';
        let editingAstraForAvatarId = null;
        let isAutoScrolling = false;
        let isTrashSelectionMode = false;
        let selectedTrashIds = new Set();
        const DB_NAME = 'ChatAppDB';
        const STORE_NAME = 'keyValue';
        let db;
        async function openDB() {
            if (db) return db;
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    const idb = e.target.result;
                    idb.createObjectStore(STORE_NAME, { keyPath: 'key' });
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }
        async function getItem(key) {
            const idb = await openDB();
            return new Promise((resolve, reject) => {
                const tx = idb.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
                req.onerror = reject;
            });
        }
        async function setItem(key, value) {
            const idb = await openDB();
            return new Promise((resolve, reject) => {
                const tx = idb.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put({ key, value });
                tx.oncomplete = resolve;
                tx.onerror = reject;
            });
        }
        async function removeItem(key) {
            const idb = await openDB();
            return new Promise((resolve, reject) => {
                const tx = idb.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.delete(key);
                tx.oncomplete = resolve;
                tx.onerror = reject;
            });
        }
        const hashString = async (str) => {
            const data = new TextEncoder().encode(str);
            const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        };
        const hexToRgba = (hex, alpha = 1) => {
            if (!hex) return `rgba(255, 255, 255, ${alpha})`;
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return `rgba(255, 255, 255, ${alpha})`;
            const r = parseInt(result[1], 16);
            const g = parseInt(result[2], 16);
            const b = parseInt(result[3], 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };
        const formatFullTimestamp = (isoString) => {
            if (!isoString) return '';
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        };
        const getConfigKey = () => `chatConfig_v_v8.6_${currentUser.username}`;
        const getAppDataKey = () => `chatAppData_v8.6_${currentUser.username}`;
        const getUserKey = (username) => `chatUser_${username}`;
        const showNotification = (message, type = 'success') => {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            ALL_ELEMENTS.notificationContainer.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 3000);
        };
        const toggleModal = (modalElement, show) => {
            if (!modalElement) return;
            if (show) {
                document.body.classList.add('modal-open');
                modalElement.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modalElement.classList.add('visible');
                });
            } else {
                document.body.classList.remove('modal-open');
                modalElement.classList.remove('visible');
                const onTransitionEnd = () => {
                    modalElement.classList.add('hidden');
                    modalElement.removeEventListener('transitionend', onTransitionEnd);
                };
                modalElement.addEventListener('transitionend', onTransitionEnd);
            }
        };
        const showCustomDialog = (options) => {
            return new Promise((resolve) => {
                const { title, message, input = null, buttons, dialogClass = '' } = options;
                const dialogBox = ALL_ELEMENTS.customDialogModal.querySelector('.bg-\\[var\\(--modal-bg\\)\\]');
                if (dialogClass) {
                    dialogBox.classList.add(dialogClass);
                }
                ALL_ELEMENTS.customDialogTitle.textContent = title;
                ALL_ELEMENTS.customDialogMessage.textContent = message;
                if (input) {
                    ALL_ELEMENTS.customDialogInput.type = input.type || 'text';
                    ALL_ELEMENTS.customDialogInput.value = '';
                    ALL_ELEMENTS.customDialogInput.placeholder = input.placeholder || '';
                    ALL_ELEMENTS.customDialogInputContainer.classList.remove('hidden');
                } else {
                    ALL_ELEMENTS.customDialogInputContainer.classList.add('hidden');
                }
                ALL_ELEMENTS.customDialogButtons.innerHTML = '';
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = btnInfo.text;
                    button.className = btnInfo.class;
                    button.onclick = () => {
                        toggleModal(ALL_ELEMENTS.customDialogModal, false);
                        if (dialogClass) {
                            dialogBox.classList.remove(dialogClass);
                        }
                        const inputValue = input ? ALL_ELEMENTS.customDialogInput.value : null;
                        resolve(btnInfo.value(inputValue));
                    };
                    ALL_ELEMENTS.customDialogButtons.appendChild(button);
                });
                toggleModal(ALL_ELEMENTS.customDialogModal, true);
                if (input) { ALL_ELEMENTS.customDialogInput.focus(); }
            });
        };
        const showCustomConfirm = (message, title = 'Ë´ãÁ¢∫Ë™ç') => showCustomDialog({ title, message, buttons: [{ text: 'ÂèñÊ∂à', class: 'bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]', value: () => false }, { text: 'Á¢∫ÂÆö', class: 'px-4 py-2 rounded-md btn-primary', value: () => true }] });
        const showCustomPrompt = (message, title = 'Ë´ãËº∏ÂÖ•', inputType = 'text') => showCustomDialog({ title, message, input: { type: inputType, placeholder: 'Ë´ãÂú®Ê≠§Ëº∏ÂÖ•...' }, buttons: [{ text: 'ÂèñÊ∂à', class: 'bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]', value: () => null }, { text: 'Á¢∫ÂÆö', class: 'px-4 py-2 rounded-md btn-primary', value: (val) => val }] });
        const throttle = (func, limit) => {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        };
        const renderMarkdown = (text) => {
            const dirty = marked.parse(text);
            const clean = DOMPurify.sanitize(dirty);
            return clean;
        };
        const saveConfig = async () => { if (currentUser) await setItem(getConfigKey(), JSON.stringify(config)); };
        const loadConfig = async () => {
            if (!currentUser) return;
            const saved = await getItem(getConfigKey());
            if (saved) {
                const savedConfig = JSON.parse(saved);
                let openrouterKey = '';
                if (savedConfig.apiKeys && typeof savedConfig.apiKeys.openrouter === 'object' && savedConfig.apiKeys.openrouter !== null) {
                    openrouterKey = Object.values(savedConfig.apiKeys.openrouter)[0] || '';
                } else if (savedConfig.apiKeys && typeof savedConfig.apiKeys.openrouter === 'string') {
                    openrouterKey = savedConfig.apiKeys.openrouter;
                }
                const savedOpenrouterKeys = savedConfig.apiKeys?.openrouter || {};
                const defaultConfig = {
                    ...config,
                    ...savedConfig,
                    apiKeys: {
                        ...config.apiKeys,
                        ...savedConfig.apiKeys,
                        openrouter: openrouterKey
                    },
                    uiTheme: { ...config.uiTheme, ...(savedConfig.uiTheme || {}) }
                };
                defaultConfig.uiTheme.style = defaultConfig.uiTheme.style || 'single';
                defaultConfig.uiTheme.adaptivePalette = defaultConfig.uiTheme.adaptivePalette || [];
                defaultConfig.uiTheme.adaptiveGradient = defaultConfig.uiTheme.adaptiveGradient || '';
                config = defaultConfig;
            }
            const savedModelSettings = config.modelSettings || [];
            const allModelIds = new Set(MODELS.map(m => m.id));
            const savedSettingIds = new Set(savedModelSettings.map(s => s.id));
            MODELS.forEach((model, index) => {
                if (!savedSettingIds.has(model.id)) {
                    savedModelSettings.push({ id: model.id, hidden: false, order: savedModelSettings.length });
                }
            });
            config.modelSettings = savedModelSettings.filter(s => allModelIds.has(s.id));
            config.modelSettings.sort((a, b) => a.order - b.order);
            config.modelSettings.forEach((s, index) => s.order = index);
            if (!allModelIds.has(config.defaultModel)) {
                config.defaultModel = MODELS[0].id;
            }
            if (!allModelIds.has(config.lastUsedModel)) {
                config.lastUsedModel = MODELS[0].id;
            }
        };
        const saveAppData = async () => { if (currentUser) await setItem(getAppDataKey(), JSON.stringify({ conversations, folders, astras, personalMemories })); };
        const loadAppData = async () => {
            if (!currentUser) return;
            const saved = await getItem(getAppDataKey());
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    folders = (data.folders || []).map(f => ({...getDefaultFolder(), ...f}));
                    conversations = (data.conversations || []).map(c => ({
                        archived: false, summary: '', folderId: null, isWebSearchEnabled: false, astrasId: null, pinned: false, deletedAt: null, ...c,
                        unsentMessage: c.unsentMessage || '',
                        genConfig: c.genConfig || getDefaultGenConfig(),
                        lastUpdatedAt: c.lastUpdatedAt || (c.messages && c.messages.length > 0 ? c.messages[c.messages.length - 1].createdAt : c.createdAt),
                        messages: (c.messages || []).map(m => ({
                            ...m,
                            createdAt: m.createdAt || c.createdAt,
                            parts: m.parts || [{ text: m.content }]
                        }))
                    }));
                    astras = (data.astras || []).map(a => ({ avatarUrl: null, officialId: null, ...a }));
                    personalMemories = data.personalMemories || [];
                } catch (e) {
                    console.error("Failed to parse app data:", e);
                    showNotification("ËÆÄÂèñÂ∞çË©±Á¥ÄÈåÑÂ§±ÊïóÔºåË≥áÊñôÂèØËÉΩÂ∑≤ÊêçÊØÄ„ÄÇ", "error");
                    conversations = [];
                    folders = [];
                    astras = [];
                    personalMemories = [];
                    await removeItem(getAppDataKey());
                }
            } else {
                conversations = [];
                folders = [];
                astras = [];
                personalMemories = [];
            }
        };
        const getDefaultGenConfig = () => ({ temperature: 0.7, topP: 0.95, maxTokens: null });
        const getDefaultFolder = () => ({ color: 'gray', icon: 'üìÅ' , isOpen: false});
        const createBaseConversation = (title) => {
            const defaultModelInfo = MODELS.find(m => m.id === config.lastUsedModel) || MODELS.find(m => m.id === config.defaultModel) || MODELS[0];
            const now = new Date().toISOString();
            return {
                id: crypto.randomUUID(),
                title: title,
                summary: '',
                messages: [],
                model: defaultModelInfo.id,
                provider: defaultModelInfo.provider,
                archived: false,
                createdAt: now,
                lastUpdatedAt: now,
                genConfig: getDefaultGenConfig(),
                isRenamed: false,
                folderId: null,
                astrasId: null,
                isWebSearchEnabled: false,
                pinned: false,
                isTemporary: true,
                isNaming: false,
                deletedAt: null,
                 unsentMessage: ''
            };
        };
        const startNewChat = () => {
            const oldTempChatCount = conversations.length;
            conversations = conversations.filter(c => !c.isTemporary || c.messages.length > 0);
            if (conversations.length < oldTempChatCount) {
                 saveAppData();
            }
            uploadedFiles = [];
            const newConv = createBaseConversation('Êñ∞Â∞çË©±');
            conversations.unshift(newConv);
            activeConversationId = newConv.id;
            renderAll();
            ALL_ELEMENTS.messageInput.value = '';
            setTimeout(adjustTextareaHeight, 0);
            toggleSidebar(false);
            sendConfirmed = false;
            updateInputState();
            updateApiKeyWarningBadge();
            renderFollowUpPrompts([]);
        };
        const loadChat = (id) => {
            if (id !== activeConversationId) {
                const previousConv = getActiveConversation();
                if (previousConv && previousConv.isTemporary && previousConv.messages.length === 0) {
                    conversations = conversations.filter(c => c.id !== previousConv.id);
                }
                activeConversationId = id;
                uploadedFiles = [];
                renderAll();
                const conv = getActiveConversation();
                ALL_ELEMENTS.messageInput.value = conv ? conv.unsentMessage || '' : '';
                setTimeout(adjustTextareaHeight, 0);
            }
            sendConfirmed = false;
            updateInputState();
            updateApiKeyWarningBadge();
            renderFollowUpPrompts([]);
            updateFunctionButtonsState();
        };
        const deleteChat = async (id, event) => {
    event?.stopPropagation();
    const conv = conversations.find(c => c.id === id);
    if (conv) {
        conv.deletedAt = new Date().toISOString();
        if (conv.folderId) {
            const folder = folders.find(f => f.id === conv.folderId);
            if (folder) {
                folder.conversationIds = folder.conversationIds.filter(cid => cid !== id);
            }
            conv.folderId = null;
        }
        await saveAppData();


        // ‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì Â∞±ÊòØÈÄôË£°Ë¢´‰øÆÊîπ‰∫Ü ‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì
        if (activeConversationId === id) {
            startNewChat();
        } 
        // ‚Üë‚Üë‚Üë‚Üë‚Üë‚Üë Â∞±ÊòØÈÄôË£°Ë¢´‰øÆÊîπ‰∫Ü ‚Üë‚Üë‚Üë‚Üë‚Üë‚Üë
        
        else {
            renderAll();
        }
        showNotification(i18n[config.uiLanguage].chatMovedToTrash || 'Â∞çË©±Â∑≤ÁßªËá≥ÂûÉÂúæÊ°∂„ÄÇ', 'success');
    }
};
        const archiveChat = async (id, event) => {
            event?.stopPropagation();
            const conv = conversations.find(c => c.id === id);
            if(conv) conv.archived = true;
            await saveAppData();
            if (activeConversationId === id) {
                const nextConv = conversations.find(c => !c.archived && !c.deletedAt);
                activeConversationId = nextConv ? nextConv.id : null;
                if (!activeConversationId) startNewChat();
                else loadChat(activeConversationId);
            } else {
                renderAll();
            }
        };
        const unarchiveChat = async (id, event) => {
            event?.stopPropagation();
            const conv = conversations.find(c => c.id === id);
            if(conv) conv.archived = false;
            await saveAppData();
            renderAll();
        };
        const showArchivedChatPreview = (id, event) => {
            event?.stopPropagation();
            const conv = conversations.find(c => c.id === id);
            if (!conv) return;
            ALL_ELEMENTS.viewArchivedTitle.textContent = conv.title;
            const contentContainer = ALL_ELEMENTS.viewArchivedContent;
            contentContainer.innerHTML = '';
            if (conv.messages.length === 0) {
                contentContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)]">Ê≠§Â∞çË©±Ê≤íÊúâË®äÊÅØ„ÄÇ</p>';
            } else {
                conv.messages.forEach(msg => {
                    const isUser = msg.role === 'user';
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex items-start gap-2 md:gap-4 ${isUser ? 'justify-end user-message' : 'model-message'}`;
                    const icon = isUser
                        ? `<div class="bg-blue-600 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold">${currentUser ? currentUser.username.charAt(0).toUpperCase() : 'Y'}</div>`
                        : `<div class="bg-gray-800 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 15h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>`;
                    let contentHTML = '';
                    msg.parts.forEach(part => {
                        if (part.text) {
                             contentHTML += `<div>${isUser ? part.text.replace(/\n/g, '<br>') : renderMarkdown(part.text)}</div>`;
                        } else if (part.inlineData) {
                            const src = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                             if (part.inlineData.mimeType.startsWith('image/')) {
                                contentHTML += `<img src="${src}" class="mt-2 max-w-xs max-h-48 rounded-lg object-cover border border-[var(--border-color)]">`;
                            }
                        }
                    });
                    const messageBubble = `
                        <div class="p-3 md:p-4 rounded-lg shadow-sm max-w-full md:max-w-xl message-bubble">
                            <div class="prose prose-sm max-w-none message-content ${isUser ? 'text-white' : 'text-[var(--text-primary)]'}">${contentHTML}</div>
                        </div>`;
                    messageDiv.innerHTML = isUser ? `${messageBubble}${icon}` : `${icon}${messageBubble}`;
                    contentContainer.appendChild(messageDiv);
                });
            }
            toggleModal(ALL_ELEMENTS.viewArchivedChatModal, true);
        };
        const togglePinChat = async (id, event) => {
            event?.stopPropagation();
            const conv = conversations.find(c => c.id === id);
            if (conv) {
                conv.pinned = !conv.pinned;
                await saveAppData();
                renderAll();
            }
        };
        const showRenameModal = (id, type, event) => {
            event?.stopPropagation();
            itemToRename = { id, type };
            let currentTitle = '';
            if (type === 'conversation') {
                const conv = conversations.find(c => c.id === id);
                if (conv) currentTitle = conv.title;
            } else if (type === 'folder') {
                const folder = folders.find(f => f.id === id);
                if (folder) currentTitle = folder.name;
            }
            ALL_ELEMENTS.renameModal.querySelector('h2').textContent = `ÈáçÊñ∞ÂëΩÂêç${type === 'folder' ? 'Ë≥áÊñôÂ§æ' : 'Â∞çË©±'}`;
            ALL_ELEMENTS.renameInput.value = currentTitle;
            toggleModal(ALL_ELEMENTS.renameModal, true);
            ALL_ELEMENTS.renameInput.focus();
        };
        const handleRename = async () => {
            const newTitle = ALL_ELEMENTS.renameInput.value.trim();
            if (!newTitle || !itemToRename.id) return;
            if (itemToRename.type === 'conversation') {
                const conv = conversations.find(c => c.id === itemToRename.id);
                if (conv) { conv.title = newTitle; conv.isRenamed = true; }
            } else if (itemToRename.type === 'folder') {
                const folder = folders.find(f => f.id === itemToRename.id);
                if (folder) { folder.name = newTitle; }
            }
            await saveAppData();
            renderAll();
            toggleModal(ALL_ELEMENTS.renameModal, false);
            itemToRename = { id: null, type: null };
        };
        const getActiveConversation = () => {
            return conversations.find(c => c.id === activeConversationId);
        };
        const renderAll = () => {
            renderHistorySidebar();
            renderFolders();
            renderAstras();
            renderChat();
            renderArchivedChats();
            renderBatchActionBar();
            renderFilePreviews();
            updateFollowUpUI();
            applyLanguage(config.uiLanguage);
        };
        const renderHistorySidebar = () => {
            ALL_ELEMENTS.historyList.innerHTML = '';
            const sortedConversations = conversations
                .filter(c => !c.archived && !c.folderId && !c.deletedAt)
                .sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    const dateB = b.lastUpdatedAt || b.createdAt;
                    const dateA = a.lastUpdatedAt || a.createdAt;
                    return new Date(dateB) - new Date(dateA);
                });
            sortedConversations.forEach(conv => {
                if (conv.isTemporary) {
                    return;
                }
                if (conv.isNaming) {
                    const thinkingPlaceholder = document.createElement('div');
                    thinkingPlaceholder.className = 'sidebar-item p-3 rounded-lg flex items-center gap-3 text-[var(--text-secondary)] italic';
                    thinkingPlaceholder.innerHTML = `
                        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span data-lang-key="naming">${i18n[config.uiLanguage].naming || 'AIÊÄùËÄÉ‰∏≠...'}</span>
                    `;
                    ALL_ELEMENTS.historyList.appendChild(thinkingPlaceholder);
                    return;
                }
                ALL_ELEMENTS.historyList.appendChild(createConversationElement(conv));
            });
        };
        const renderAstras = () => {
            ALL_ELEMENTS.astrasList.innerHTML = '';
            astras.forEach(ast => {
                const item = document.createElement('div');
                item.className = `sidebar-item w-full text-left p-2.5 rounded-lg flex items-center justify-between cursor-pointer ${ast.id === getActiveAstrasId() && !isSelectionMode ? 'active' : ''}`;
                item.dataset.id = ast.id;
                const avatarUrl = ast.avatarUrl;
                const initials = ast.name.charAt(0);
                const avatarElement = `
                    <div class="astras-sidebar-avatar">
                        ${avatarUrl ? `<img src="${avatarUrl}" class="w-full h-full object-cover rounded-full">` : initials}
                    </div>`;
                item.innerHTML = `
                    <div class="flex items-center truncate flex-1">
                        ${avatarElement}
                        <span class="truncate pr-2 text-sm">${ast.name}</span>
                    </div>
                    <button class="astras-options-btn flex-shrink-0 w-6 h-6 rounded-md hover:bg-[var(--hover-bg)] flex items-center justify-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                    </button>
                `;
                let pressTimer = null;
                let touchMoved = false;
                const startPress = (e) => {
                    if (window.innerWidth >= 768 || isSelectionMode) return;
                    touchMoved = false;
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showMobileContextMenuForAstras(ast.id);
                        pressTimer = null;
                    }, 500);
                };
                const cancelPress = () => {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                };
                const handleClick = () => {
                    if (pressTimer || !touchMoved) {
                        cancelPress();
                        if (isSelectionMode) return;
                        setAstrasForConversation(ast.id);
                        toggleSidebar(false);
                    }
                };
                item.addEventListener('touchstart', startPress, { passive: true });
                item.addEventListener('touchend', cancelPress);
                item.addEventListener('touchmove', () => { touchMoved = true; cancelPress(); }, { passive: true });
                item.addEventListener('mousedown', startPress);
                item.addEventListener('mouseup', cancelPress);
                item.addEventListener('mouseleave', cancelPress);
                item.addEventListener('click', handleClick);
                const optionsBtn = item.querySelector('.astras-options-btn');
                optionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    createAstrasMenu(ast.id, optionsBtn);
                });
                ALL_ELEMENTS.astrasList.appendChild(item);
            });
        };
        const renderFolders = () => {
            ALL_ELEMENTS.folderList.innerHTML = '';
            folders.forEach(folder => {
                const folderConvs = folder.conversationIds
                    .map(id => conversations.find(c => c.id === id))
                    .filter(c => c && !c.archived && !c.deletedAt)
                    .sort((a,b) => {
                        if (a.pinned && !b.pinned) return -1;
                        if (!a.pinned && b.pinned) return 1;
                        const dateB = b.lastUpdatedAt || b.createdAt;
                        const dateA = a.lastUpdatedAt || a.createdAt;
                        return new Date(dateB) - new Date(dateA);
                    });
                const folderElement = document.createElement('div');
                folderElement.className = 'folder-item text-sm';
                folderElement.dataset.id = folder.id;
                folderElement.dataset.open = folder.isOpen;
                folderElement.innerHTML = `
                    <div class="folder-summary sidebar-item p-3 rounded-lg flex items-center justify-between">
                        <div class="flex items-center gap-2 truncate">
                            <svg class="folder-arrow flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            <span class="folder-icon mr-1">${folder.icon}</span>
                            <span class="font-medium truncate" style="color: ${FOLDER_COLORS[folder.color] || FOLDER_COLORS.gray};">${folder.name}</span>
                        </div>
                        <button data-id="${folder.id}" class="folder-options-btn flex-shrink-0 w-6 h-6 rounded-md hover:bg-[var(--active-bg)] flex items-center justify-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button>
                    </div>
                    <div class="folder-content-container pl-4 mt-1 space-y-1"></div>
                `;
                const contentContainer = folderElement.querySelector('.folder-content-container');
                folderConvs.forEach(conv => {
                    contentContainer.appendChild(createConversationElement(conv));
                });
                const folderSummary = folderElement.querySelector('.folder-summary');
                let pressTimer = null;
                let touchMoved = false;
                const startPress = (e) => {
                    if (window.innerWidth >= 768 || isSelectionMode) return;
                    touchMoved = false;
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showMobileContextMenuForFolder(folder.id);
                        pressTimer = null;
                    }, 500);
                };
                const cancelPress = () => {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                };
                const handleClick = (e) => {
                    if (pressTimer || !touchMoved) {
                        cancelPress();
                        if (e.target.closest('.folder-options-btn')) return;
                        const folderItem = e.currentTarget.closest('.folder-item');
                        const folderObj = folders.find(f => f.id === folderItem.dataset.id);
                        if (folderObj) {
                            folderObj.isOpen = !folderObj.isOpen;
                            folderItem.dataset.open = folderObj.isOpen;
                            saveAppData();
                        }
                    }
                };
                folderSummary.addEventListener('touchstart', startPress, { passive: true });
                folderSummary.addEventListener('touchend', cancelPress);
                folderSummary.addEventListener('touchmove', () => { touchMoved = true; cancelPress(); }, { passive: true });
                folderSummary.addEventListener('mousedown', startPress);
                folderSummary.addEventListener('mouseup', cancelPress);
                folderSummary.addEventListener('mouseleave', cancelPress);
                folderSummary.addEventListener('click', handleClick);
                const folderOptionsBtn = folderElement.querySelector('.folder-options-btn');
                folderOptionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    createFolderMenu(folder.id, folderOptionsBtn);
                });
                ALL_ELEMENTS.folderList.appendChild(folderElement);
            });
        };
        const createConversationElement = (conv) => {
            const item = document.createElement('div');
            item.className = `sidebar-item w-full text-left p-3 rounded-lg flex items-center justify-between cursor-pointer ${conv.id === activeConversationId && !isSelectionMode ? 'active' : ''}`;
            item.dataset.id = conv.id;
            const modelInfo = MODELS.find(m => m.id === conv.model);
            const modelCodename = modelInfo ? modelInfo.name.split(' (')[0] : '';
            const modelNameSuffix = modelCodename ? `<span class="model-suffix">${modelCodename}</span>` : '';
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'flex-1 flex items-center justify-between truncate';
            contentWrapper.innerHTML = `
                <div class="flex-1 flex items-center gap-2 truncate">
                    <span class="truncate">${conv.title}${conv.pinned ? ' <span class="pinned-icon">üìå</span>' : ''}</span>
                    ${modelNameSuffix}
                 </div>
                <button class="chat-options-btn flex-shrink-0 w-6 h-6 rounded-md hover:bg-[var(--hover-bg)] flex items-center justify-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button>
            `;
            if (isSelectionMode) {
                item.classList.add('pr-2');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'conv-select-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3 flex-shrink-0';
                checkbox.checked = selectedConversationIds.has(conv.id);
                checkbox.dataset.id = conv.id;
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedConversationIds.add(conv.id);
                    } else {
                        selectedConversationIds.delete(conv.id);
                    }
                    renderBatchActionBar();
                });
                checkbox.addEventListener('click', e => e.stopPropagation());
                item.appendChild(checkbox);
                contentWrapper.querySelector('.chat-options-btn').classList.add('hidden');
            }
            item.appendChild(contentWrapper);
            let pressTimer = null;
            let touchMoved = false;
            const startPress = (e) => {
                if (window.innerWidth >= 768 || isSelectionMode) return;
                touchMoved = false;
                pressTimer = setTimeout(() => {
                    e.preventDefault();
                    showMobileContextMenu(conv.id, e.currentTarget);
                    pressTimer = null;
                }, 500);
            };
            const cancelPress = () => {
                clearTimeout(pressTimer);
                pressTimer = null;
            };
            const handleClick = () => {
                if (pressTimer || !touchMoved) {
                    cancelPress();
                    if (isSelectionMode) {
                        const checkbox = item.querySelector('.conv-select-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    } else {
                        loadChat(conv.id);
                        toggleSidebar(false);
                    }
                }
            };
            item.addEventListener('touchstart', startPress, { passive: true });
            item.addEventListener('touchend', cancelPress);
            item.addEventListener('touchmove', () => {
                touchMoved = true;
                cancelPress();
            }, { passive: true });
            item.addEventListener('mousedown', startPress);
            item.addEventListener('mouseup', cancelPress);
            item.addEventListener('mouseleave', cancelPress);
            item.addEventListener('click', handleClick);
            const chatOptionsBtn = contentWrapper.querySelector('.chat-options-btn');
            if (chatOptionsBtn) {
                chatOptionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    createHistoryMenu(conv.id, chatOptionsBtn);
                });
            }
            return item;
        };
        const renderArchivedChats = () => {
            ALL_ELEMENTS.archivedChatsContainer.innerHTML = '';
            const archived = conversations.filter(c => c.archived).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (archived.length === 0) {
                ALL_ELEMENTS.archivedChatsContainer.innerHTML = `<p class="text-sm text-[var(--text-secondary)] text-center p-4">${i18n[config.uiLanguage].noArchivedChats || 'Ê≤íÊúâÂ∑≤Â∞ÅÂ≠òÁöÑÂ∞çË©±„ÄÇ'}</p>`;
                return;
            }
            archived.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'p-3 bg-[var(--sidebar-bg)] rounded-md border border-[var(--border-color)]';
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="truncate pr-2 font-medium">${conv.title}</span>
                        <div class="flex gap-2 flex-shrink-0">
                            <button data-id="${conv.id}" class="view-archived-btn text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200">${i18n[config.uiLanguage].view || 'Ê™¢Ë¶ñ'}</button>
                            <button data-id="${conv.id}" class="unarchive-btn text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200">${i18n[config.uiLanguage].restore || 'ÈÇÑÂéü'}</button>
                            <button data-id="${conv.id}" class="delete-btn text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200">${i18n[config.uiLanguage].delete || 'Âà™Èô§'}</button>
                        </div>
                    </div>
                    ${conv.summary ? `<p class="text-xs text-[var(--text-secondary)] mt-2">${conv.summary}</p>` : ''}
                `;
                ALL_ELEMENTS.archivedChatsContainer.appendChild(item);
            });
            ALL_ELEMENTS.archivedChatsContainer.querySelectorAll('.view-archived-btn').forEach(btn => btn.addEventListener('click', (e) => showArchivedChatPreview(e.target.dataset.id, e)));
            ALL_ELEMENTS.archivedChatsContainer.querySelectorAll('.unarchive-btn').forEach(btn => btn.addEventListener('click', (e) => unarchiveChat(e.target.dataset.id, e)));
            ALL_ELEMENTS.archivedChatsContainer.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteChat(e.target.dataset.id, e)));
        };
        const renderChat = () => {
            const conv = getActiveConversation();
            const messageList = ALL_ELEMENTS.messageList;
            messageList.classList.remove('chat-view-transition');
            if (!conv) {
                messageList.innerHTML = '';
                ALL_ELEMENTS.headerTitle.textContent = i18n[config.uiLanguage].newChat;
                ALL_ELEMENTS.modelSwitcherContainer.innerHTML = '';
                renderInputIndicators();
                return;
            }
            ALL_ELEMENTS.headerTitle.textContent = conv.archived ? `(${i18n[config.uiLanguage].archived || 'Â∑≤Â∞ÅÂ≠ò'}) ${conv.title}` : conv.title;
            renderModelSwitcher();
            renderInputIndicators();
            messageList.innerHTML = '';
            if (conv.messages.length === 0) {
                const greeting = `${currentUser.username}, ${i18n[config.uiLanguage].howCanIHelp || 'Êúâ‰ªÄÈ∫ºÂèØ‰ª•ÁÇ∫ÊÇ®ÊúçÂãôÁöÑÂóéÔºü'}`;
                messageList.innerHTML = `<div class="text-center text-[var(--text-primary)] mt-16"><p class="text-lg">${greeting}</p></div>`;
            } else {
                conv.messages.forEach((msg, index) => addMessageToUI(msg, index, false, false));
            }
            void messageList.offsetWidth;
            messageList.classList.add('chat-view-transition');
            updateInputState();
        };
        
        /**
         * Ê†πÊìöÁï∂ÂâçÁãÄÊÖãÔºàÂ≠∏ÁøíÊ®°Âºè„ÄÅÊ®°ÂûãÊèê‰æõÂïÜÔºâÊõ¥Êñ∞ÂäüËÉΩÊåâÈàïÔºàÁõ∏Ê©ü„ÄÅÊ™îÊ°à„ÄÅÊêúÂ∞ãÔºâÁöÑÂèØÁî®ÊÄß
         */
        const updateFunctionButtonsState = () => {
            // ÂæûÂÖÉÁ¥†Ê∏ÖÂñÆ‰∏≠Áç≤ÂèñÊâÄÊúâÈúÄË¶ÅÊéßÂà∂ÁöÑÊåâÈàï
            const { cameraBtn, uploadImageBtn, uploadFileBtn, webSearchPopoverBtn, learningModeBtn } = ALL_ELEMENTS;
            const separator = document.querySelector('#file-options-popover .border-t');
            const conv = getActiveConversation();
            if (!conv) return; // Â¶ÇÊûúÊ≤íÊúâÂ∞çË©±ÔºåÂâá‰∏çÂü∑Ë°å‰ªª‰ΩïÊìç‰Ωú
            const modelInfo = MODELS.find(m => m.id === conv.model);
            const provider = modelInfo?.provider; // Áç≤ÂèñÊ®°ÂûãÁöÑÊèê‰æõËÄÖ ('openrouter' Êàñ 'gemini')
            const multimodalButtons = [cameraBtn, uploadImageBtn, uploadFileBtn, webSearchPopoverBtn];


            if (provider === 'openrouter') {
                // OpenRouter Ê®°ÂûãÁõÆÂâç‰∏çÊîØÊè¥Â§öÊ®°ÊÖãÔºåÊâÄ‰ª•Á∂≠ÊåÅÈö±ËóèÁãÄÊÖã
                multimodalButtons.forEach(btn => btn.style.display = 'none');
                if (separator) separator.style.display = 'none';
                learningModeBtn.style.display = 'flex';
            } else { // Ê≠§ËôïËôïÁêÜ Gemini Ê®°Âûã
                multimodalButtons.forEach(btn => btn.style.display = 'flex');
                if (separator) separator.style.display = 'block';
                learningModeBtn.style.display = 'flex';

                // START: MODIFICATION - Always enable multimodal features for Gemini
                // ËàäÈÇèËºØÊòØ const shouldBeDisabled = config.isLearningMode;
                // ÊàëÂÄëÂ∞áÂÖ∂ÊîπÁÇ∫ falseÔºå‰ª£Ë°®Â∞çÊñº Gemini Ê®°ÂûãÔºåÁÑ°Ë´ñÂ≠∏ÁøíÊ®°ÂºèÊòØÂê¶ÈñãÂïüÔºåÂ§öÊ®°ÊÖãÂäüËÉΩÊ∞∏‰∏çÁ¶ÅÁî®„ÄÇ
                const shouldBeDisabled = false;
                // END: MODIFICATION

                multimodalButtons.forEach(btn => {
                    btn.disabled = shouldBeDisabled;
                    if (shouldBeDisabled) {
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        // Âõ†ÁÇ∫ shouldBeDisabled ÊÅÜÁÇ∫ falseÔºåÊâÄ‰ª•ÈÄôË£°ÊúÉÊ∞∏ÈÅ†ÁßªÈô§Á¶ÅÁî®Ê®£Âºè„ÄÇ
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
            }
        };


        const toggleLearningMode = async () => {
            config.isLearningMode = !config.isLearningMode;
            await saveConfig();
            renderInputIndicators();
            updateFunctionButtonsState();
            ALL_ELEMENTS.fileOptionsPopover.classList.remove('visible');
            showNotification(config.isLearningMode ? (i18n[config.uiLanguage].learningModeEnabled || 'Â≠∏ÁøíËàáÁ†îÁ©∂Ê®°ÂºèÂ∑≤ÈñãÂïü') : (i18n[config.uiLanguage].learningModeDisabled || 'Â≠∏ÁøíËàáÁ†îÁ©∂Ê®°ÂºèÂ∑≤ÈóúÈñâ'), 'success');
        };


        const renderInputIndicators = () => {
            const container = ALL_ELEMENTS.inputIndicatorContainer;
            const conv = getActiveConversation();
            
            const wrapper = document.querySelector('.input-wrapper');
            if (!wrapper) return;


            if (!conv) {
                if (container.children.length > 0) {
                     container.innerHTML = '';
                }
                wrapper.classList.remove('has-indicators');
                return;
            }
        
            const activeIndicators = new Map();
            const astrasId = getActiveAstrasId();


            if (config.isLearningMode) {
                activeIndicators.set('learning-mode-indicator', {
                    id: 'learning-mode-indicator',
                    html: `
                        <span class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 18a6 6 0 0 0 6-6c0-1.657-2.686-3-6-3s-6 1.343-6 3a6 6 0 0 0 6 6z"/><path d="M12 2v10"/> </svg>
                            <span>${i18n[config.uiLanguage].learningModeIndicator || 'Â≠∏ÁøíÊ®°Âºè'}</span>
                        </span>
                        <button id="close-learning-mode-btn-input" class="ml-2 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10" title="${i18n[config.uiLanguage].closeLearningMode || 'ÈóúÈñâÂ≠∏ÁøíÊ®°Âºè'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    `,
                    eventListener: (el) => el.querySelector('#close-learning-mode-btn-input').addEventListener('click', toggleLearningMode)
                });
            }
        
            if (astrasId) {
                const ast = astras.find(a => a.id === astrasId);
                if (ast) {
                    activeIndicators.set('astras-input-indicator', {
                        id: 'astras-input-indicator',
                        html: `
                            <span class="flex items-center gap-1">
                                <span class="astras-sidebar-avatar" style="width: 18px; height: 18px; font-size: 0.7rem; margin-right: 4px;">
                                    ${ast.avatarUrl ? `<img src="${ast.avatarUrl}" class="w-full h-full object-cover rounded-full">` : ast.name.charAt(0)}
                                </span>
                                <span>${ast.name} ${i18n[config.uiLanguage].astrasActive || '‰ΩøÁî®‰∏≠'}</span>
                            </span>
                            <button id="close-astras-btn-input" class="ml-2 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10" title="${i18n[config.uiLanguage].closeAstras || 'ÈóúÈñâ Astras'}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        `,
                        eventListener: (el) => el.querySelector('#close-astras-btn-input').addEventListener('click', deactivateAstras)
                    });
                }
            }
        
            if (conv.isWebSearchEnabled) {
                activeIndicators.set('search-indicator', {
                    id: 'search-indicator',
                    html: `
                        <span class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                            <span>${i18n[config.uiLanguage].webSearch || 'ËÅØÁ∂≤ÊêúÂ∞ã'}</span>
                        </span>
                        <button id="close-search-btn-input" class="ml-2 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10" title="${i18n[config.uiLanguage].closeSearch || 'ÈóúÈñâÊêúÂ∞ã'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    `,
                    eventListener: (el) => el.querySelector('#close-search-btn-input').addEventListener('click', async () => {
                        conv.isWebSearchEnabled = false;
                        await saveAppData();
                        renderInputIndicators();
                    })
                });
            }
        
            Array.from(container.children).forEach(child => {
                if (!activeIndicators.has(child.id)) {
                    child.classList.remove('enter');
                    child.classList.add('exit');
                    child.addEventListener('animationend', () => {
                        child.remove();
                        if (container.children.length === 0) {
                            wrapper.classList.remove('has-indicators');
                        }
                    }, { once: true });
                }
            });
        
            activeIndicators.forEach((indicatorData, key) => {
                if (!document.getElementById(indicatorData.id)) {
                    const indicator = document.createElement('div');
                    indicator.id = indicatorData.id;
                    indicator.className = 'input-indicator-item flex items-center justify-between text-sm font-medium px-2 py-1 rounded-full enter';
                    indicator.innerHTML = indicatorData.html;
                    container.appendChild(indicator);
                    indicatorData.eventListener(indicator);
                }
            });
            
            if (activeIndicators.size > 0) {
                wrapper.classList.add('has-indicators');
            } 
            else if (container.children.length === 0) {
                wrapper.classList.remove('has-indicators');
            }
        };
        const getActiveAstrasId = () => {
            const conv = getActiveConversation();
            return conv ? conv.astrasId : null;
        };
        const setAstrasForConversation = (astrasId) => {
            const conv = getActiveConversation();
            if (conv) {
                conv.astrasId = astrasId;
                saveAppData();
                renderAll();
                updateInputState();
            }
        };
        const deactivateAstras = () => {
            const conv = getActiveConversation();
            if (conv) {
                conv.astrasId = null;
                saveAppData();
                renderAll();
                updateInputState();
                showNotification(i18n[config.uiLanguage].astrasDeactivated || 'Â∑≤ÈóúÈñâ Astras„ÄÇ', 'success');
            }
        };
        const createAstras = async () => {
            editingAstrasId = null;
            ALL_ELEMENTS.astrasCreateModal.querySelector('h2').textContent = i18n[config.uiLanguage].createAstras;
            ALL_ELEMENTS.astrasNameInput.value = '';
            ALL_ELEMENTS.astrasDescInput.value = '';
            ALL_ELEMENTS.astrasInstructionsInput.value = '';
            toggleModal(ALL_ELEMENTS.astrasCreateModal, true);
        };
        const handleSaveAstras = async () => {
            const name = ALL_ELEMENTS.astrasNameInput.value.trim();
            const description = ALL_ELEMENTS.astrasDescInput.value.trim();
            const instructions = ALL_ELEMENTS.astrasInstructionsInput.value.trim();
            if (!name || !instructions) {
                showNotification(i18n[config.uiLanguage].nameAndInstructionsRequired || 'ÂêçÁ®±ÂíåÊåá‰ª§ÁÇ∫ÂøÖÂ°´„ÄÇ', 'error');
                return;
            }
            if (editingAstrasId) {
                const ast = astras.find(a => a.id === editingAstrasId);
                if (ast) {
                    ast.name = name;
                    ast.description = description;
                    ast.instructions = instructions;
                    showNotification(i18n[config.uiLanguage].astrasUpdated || 'Astras Â∑≤Êõ¥Êñ∞');
                }
                editingAstrasId = null;
            } else {
                const newAstras = {
                    id: crypto.randomUUID(),
                    name,
                    description,
                    instructions,
                    avatarUrl: null,
                    officialId: null,
                };
                astras.unshift(newAstras);
                showNotification(i18n[config.uiLanguage].astrasCreated ||'Astras Â∑≤ÂâµÂª∫');
            }
            await saveAppData();
            renderAstras();
            toggleModal(ALL_ELEMENTS.astrasCreateModal, false);
            ALL_ELEMENTS.astrasNameInput.value = '';
            ALL_ELEMENTS.astrasDescInput.value = '';
            ALL_ELEMENTS.astrasInstructionsInput.value = '';
            ALL_ELEMENTS.astrasCreateModal.querySelector('h2').textContent = i18n[config.uiLanguage].createAstras;
        };
        const deleteAstras = async (id) => {
            if (!(await showCustomConfirm(i18n[config.uiLanguage].confirmDeleteAstras || 'Á¢∫ÂÆöÂà™Èô§Ê≠§ AstrasÔºü'))) return;
            astras = astras.filter(a => a.id !== id);
            conversations.forEach(c => {
                if (c.astrasId === id) c.astrasId = null;
            });
            await saveAppData();
            renderAll();
            showNotification(i18n[config.uiLanguage].astrasDeleted || 'Astras Â∑≤Âà™Èô§');
        };
        const createAstrasMenu = (astrasId, targetButton) => {
            const existingPopover = document.getElementById('history-popover');
            if (existingPopover) {
                existingPopover.remove();
                if (existingPopover.dataset.targetId === targetButton.id) return;
            }
            const rect = targetButton.getBoundingClientRect();
            const popover = document.createElement('div');
            popover.id = 'history-popover';
            popover.className = 'popover absolute w-48 rounded-lg border border-[var(--border-color)] z-50';
            popover.dataset.targetId = targetButton.id;
            const spaceBelow = window.innerHeight - rect.bottom;
            if (spaceBelow < 150) {
                popover.style.bottom = `${window.innerHeight - rect.top}px`;
                popover.style.transformOrigin = 'bottom';
            } else {
                popover.style.top = `${rect.bottom}px`;
                popover.style.transformOrigin = 'top';
            }
            popover.style.left = `${rect.left}px`;
            const astra = astras.find(a => a.id === astrasId);
            let menuHTML = '';
            if (astra && astra.officialId) {
                menuHTML = `
                    <button data-id="${astrasId}" class="edit-avatar-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].editAvatar || 'Á∑®ËºØÈ†≠ÂÉè'}</button>
                    <button data-id="${astrasId}" class="delete-astras-btn w-full text-left px-4 py-2 text-red-600 hover:bg-red-500/10 text-sm">${i18n[config.uiLanguage].delete || 'Âà™Èô§'}</button>
                `;
            } else {
                menuHTML = `
                    <button data-id="${astrasId}" class="edit-astras-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].edit || 'Á∑®ËºØ'}</button>
                    <button data-id="${astrasId}" class="edit-avatar-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].editAvatar || 'Á∑®ËºØÈ†≠ÂÉè'}</button>
                    <button data-id="${astrasId}" class="delete-astras-btn w-full text-left px-4 py-2 text-red-600 hover:bg-red-500/10 text-sm">${i18n[config.uiLanguage].delete || 'Âà™Èô§'}</button>
                `;
            }
            popover.innerHTML = menuHTML;
            document.body.appendChild(popover);
            requestAnimationFrame(() => popover.classList.add('visible'));
            const editBtn = popover.querySelector('.edit-astras-btn');
            if (editBtn) {
                editBtn.addEventListener('click', () => {
                    const ast = astras.find(a => a.id === astrasId);
                    if (ast) {
                        editingAstrasId = astrasId;
                        ALL_ELEMENTS.astrasNameInput.value = ast.name;
                        ALL_ELEMENTS.astrasDescInput.value = ast.description;
                        ALL_ELEMENTS.astrasInstructionsInput.value = ast.instructions;
                        ALL_ELEMENTS.astrasCreateModal.querySelector('h2').textContent = i18n[config.uiLanguage].editAstras || 'Á∑®ËºØ Astras';
                        toggleModal(ALL_ELEMENTS.astrasCreateModal, true);
                    }
                    popover.remove();
                });
            }
            popover.querySelector('.edit-avatar-btn').addEventListener('click', () => {
                openAvatarEditor(astrasId);
                popover.remove();
            });
            popover.querySelector('.delete-astras-btn').addEventListener('click', () => { deleteAstras(astrasId); popover.remove(); });
        };
        const updateFileInputUI = () => {
            const { fileInputContainer } = ALL_ELEMENTS;
            fileInputContainer.classList.remove('hidden');
            const conv = getActiveConversation();
            const modelInfo = MODELS.find(m => m.id === conv?.model);
            if (modelInfo?.provider !== 'gemini' && uploadedFiles.length > 0) {
            }
        };
        const renderModelSwitcher = () => {
            const conv = getActiveConversation();
            ALL_ELEMENTS.modelSwitcherContainer.innerHTML = '';
            if (!conv) return;
            const visibleModels = config.modelSettings
                .filter(s => !s.hidden)
                .sort((a, b) => a.order - b.order)
                .map(s => MODELS.find(m => m.id === s.id))
                .filter(Boolean);
            const currentModel = MODELS.find(m => m.id === conv.model) || MODELS[0];
            const isArchived = conv.archived;
            let optionsHTML = '';
            const translations = i18n[config.uiLanguage] || i18n['zh-TW'];
            visibleModels.forEach(m => {
                const description = translations[m.descriptionKey] || '';
                const limits = translations[m.limitsKey] || '';
                optionsHTML += `
                    <div data-model="${m.id}" class="model-option-btn-container ${isArchived ? 'cursor-not-allowed opacity-50' : ''}">
                        <h4 class="font-semibold">${m.name}</h4>
                        <p class="model-description">${description}<span class="whitespace-nowrap"> (${limits})</span></p>
                    </div>
                `;
            });
            ALL_ELEMENTS.modelSwitcherContainer.innerHTML = `
                <button id="current-model-btn" class="flex items-center gap-2 text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] px-2 py-1 md:px-3 rounded-md ${isArchived ? 'cursor-not-allowed' : ''}" ${isArchived ? 'disabled' : ''}>
                    <span class="font-semibold text-sm md:text-base text-[var(--text-primary)]">${currentModel.name}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div id="model-options-popover" class="popover absolute right-0 mt-6 w-72 md:w-80 rounded-lg border border-[var(--border-color)] z-50">
                    ${optionsHTML}
                </div>
            `;
            if (!isArchived) {
                document.getElementById('current-model-btn').addEventListener('click', () => {
                    const popover = document.getElementById('model-options-popover');
                    if (popover.classList.contains('visible')) {
                        popover.classList.remove('visible');
                    } else {
                        closeAllPopovers();
                        popover.classList.add('visible');
                    }
                });
                document.querySelectorAll('.model-option-btn-container').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const newModelId = e.currentTarget.dataset.model;
                        const newModelInfo = MODELS.find(m => m.id === newModelId);
                        if (newModelInfo) {
                            conv.model = newModelInfo.id;
                            conv.provider = newModelInfo.provider;
                            config.lastUsedModel = newModelId;
                            saveAppData();
                            saveConfig();
                            renderModelSwitcher();
                            updateInputState();
                            renderInputIndicators();
                            updateFileInputUI();
                            updateFunctionButtonsState();
                        }
                        document.getElementById('model-options-popover').classList.remove('visible');
                    });
                });
            }
            updateFileInputUI();
            updateApiKeyWarningBadge();
        };
        const addMessageToUI = (msg, index, shouldSave = true, shouldScroll = true) => {
            const conv = getActiveConversation();
            if (shouldSave) {
                 conv.messages.push(msg);
                if (conv.messages.length === 1 && msg.role === 'user' && conv.isTemporary && !conv.isRenamed && config.autoNaming) {
                    const textPart = msg.parts.find(p => p.text);
                    if (textPart) {
                        conv.title = textPart.text.substring(0, 30) || i18n[config.uiLanguage].newChat || 'Êñ∞Â∞çË©±';
                        ALL_ELEMENTS.headerTitle.textContent = conv.title;
                    }
                }
                saveAppData();
            }
            const messageDiv = document.createElement('div');
            messageDiv.dataset.messageIndex = index;
            const isUser = msg.role === 'user';
            messageDiv.className = `message-item flex items-start gap-2 md:gap-4 ${isUser ? 'justify-end user-message' : 'model-message'}`;
            const icon = isUser ? `<div class="bg-blue-600 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold">${currentUser ? currentUser.username.charAt(0).toUpperCase() : 'Y'}</div>` : `<div class="bg-gray-800 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 15h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>`;
            let contentHTML = '';
            let actionButtons = '';
            let contentPaddingClass = '';
            const isLoadingMessage = !isUser && msg.parts.length === 1 && msg.parts[0].text === '...';
            if (isLoadingMessage) {
                contentHTML = `<div class="loading-dots"><span class="bg-gray-500 dark:bg-gray-400"></span><span class="bg-gray-500 dark:bg-gray-400"></span><span class="bg-gray-500 dark:bg-gray-400"></span></div>`;
            } else {
                let textPartsContent = [];
                let mediaPartsContent = [];
                msg.parts.forEach(part => {
                    if (part.text) {
                        textPartsContent.push(part.text);
                    } else if (part.inlineData) {
                        mediaPartsContent.push(part.inlineData);
                    }
                });
                if (textPartsContent.length > 0) {
                    const combinedText = textPartsContent.join('\n');
                    contentHTML += `<div>${isUser ? combinedText.replace(/\n/g, '<br>') : renderMarkdown(combinedText)}</div>`;
                }
                if (mediaPartsContent.length > 0) {
                    let mediaHTML = '<div class="mt-2 flex flex-wrap gap-2">';
                    mediaPartsContent.forEach(media => {
                        const src = `data:${media.mimeType};base64,${media.data}`;
                        if (media.mimeType.startsWith('image/')) {
                            mediaHTML += `<img src="${src}" class="max-w-xs max-h-48 rounded-lg object-cover border border-[var(--border-color)]">`;
                        } else {
                            mediaHTML += `<div class="p-2 bg-[var(--hover-bg)] rounded-lg text-sm flex items-center gap-2 border border-[var(--border-color)]">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                <span>${media.name || 'Ê™îÊ°à'}</span>
                            </div>`;
                        }
                    });
                    mediaHTML += '</div>';
                    contentHTML += mediaHTML;
                }
                if (!isUser) {
                    const timeString = formatFullTimestamp(msg.createdAt);
                    actionButtons = `
                        <div class="absolute bottom-2 left-2 right-2 flex justify-between items-center">
                            <button class="copy-content-btn p-1 rounded-md hover:bg-gray-500/20 text-[var(--text-secondary)] opacity-50 hover:opacity-100 transition-opacity" title="${i18n[config.uiLanguage].copyContent || 'Ë§áË£ΩÂÖßÂÆπ'}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                            <span class="text-xs text-gray-400">${timeString}</span></div>
                    `;
                    contentPaddingClass = 'pb-8';
                } else {
                    const currentConv = getActiveConversation();
                    if (currentConv && index + 1 < currentConv.messages.length && currentConv.messages[index + 1].role === 'model') {
                         actionButtons = `
                            <div class="absolute bottom-2 left-2 flex items-center">
                                <button class="delete-message-btn p-1 rounded-md hover:bg-gray-500/20 text-gray-400 hover:text-red-400 opacity-50 hover:opacity-100 transition-all" title="${i18n[config.uiLanguage].deletePair || 'Âà™Èô§Ê≠§Â∞çË©±Ëàá AI ÂõûË¶Ü'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        `;
                        contentPaddingClass = 'pb-8';
                    }
                }
            }
            const messageBubble = `
                <div class="p-3 md:p-4 rounded-lg shadow-sm max-w-full md:max-w-xl message-bubble relative ${isUser ? 'text-white' : ''}" >
                    <div class="prose prose-sm max-w-none ${isUser ? 'text-white' : 'text-[var(--text-primary)]'} ${contentPaddingClass} message-content">${contentHTML}</div>
                    ${actionButtons}
                </div>`;
            messageDiv.innerHTML = isUser ? `${messageBubble}${icon}` : `${icon}${messageBubble}`;
            if (ALL_ELEMENTS.messageList.querySelector('.text-center')) ALL_ELEMENTS.messageList.innerHTML = '';
            ALL_ELEMENTS.messageList.appendChild(messageDiv);
            if (shouldScroll) {
                if (isAutoScrolling) {
                    ALL_ELEMENTS.chatContainer.scrollTo({ top: ALL_ELEMENTS.chatContainer.scrollHeight, behavior: 'smooth' });
                }
            }
            return messageDiv;
        };
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            if (abortController) return;
            const userMessage = ALL_ELEMENTS.messageInput.value.trim();
            if (!userMessage && uploadedFiles.length === 0) return;
            renderFollowUpPrompts([]);
            const conv = getActiveConversation();
            if (conv.archived) return;
            abortController = new AbortController();
            updateSubmitButtonState(true);
            if (!sendConfirmed) {
                sendConfirmed = true;
                updateInputState();
                return;
            }
            const userParts = [];
            if (userMessage) {
                userParts.push({ text: userMessage });
            }
            uploadedFiles.forEach(file => {
                userParts.push({
                    inlineData: {
                        mimeType: file.type,
                        data: file.base64.split(',')[1]
                    }
                });
            });
            const userMessageObject = { role: 'user', parts: userParts, createdAt: new Date().toISOString() };
            addMessageToUI(userMessageObject, conv.messages.length, true);
            conv.lastUpdatedAt = new Date().toISOString();
            conv.unsentMessage = '';
            if (conv.isTemporary) {
                conv.isTemporary = false;
                conv.isNaming = true;
                renderHistorySidebar();
                if (config.autoNaming) {
                    generateTitleAndSummary(conv);
                } else {
                    conv.isNaming = false;
                }
                await saveAppData();
            }
            if (config.enableAutoWebSearch && conv.provider === 'gemini' && !conv.isWebSearchEnabled) {
                try {
                    const needsSearch = await shouldPerformWebSearch(userMessage);
                    if (needsSearch) {
                        conv.isWebSearchEnabled = true;
                        showNotification(i18n[config.uiLanguage].autoWebSearchNotice || 'ÂÅµÊ∏¨Âà∞ÂïèÈ°åÈúÄË¶ÅÈÄ£Á∂≤ÊêúÂ∞ãÔºåÂ∑≤Ëá™ÂãïÈñãÂïü„ÄÇ', 'warning');
                    }
                    renderInputIndicators();
                } catch(err) {
                    console.error("Auto web search check failed:", err);
                }
            }
            ALL_ELEMENTS.messageInput.value = '';
            uploadedFiles = [];
            adjustTextareaHeight();
            renderFilePreviews();
            const loadingMessageDiv = addMessageToUI({ role: 'model', parts: [{ text: '...' }], createdAt: new Date().toISOString() }, conv.messages.length, false);
            const contentDiv = loadingMessageDiv.querySelector('.message-content');
            let fullResponse = '';
            const finalAiMessage = { role: 'model', parts: [{ text: '' }], createdAt: new Date().toISOString() };
            try {
                const completeResponse = await streamApiCall(
                    userParts,
                    (chunk) => {
                        fullResponse += chunk;
                        contentDiv.innerHTML = renderMarkdown(fullResponse);
                        const isNearBottom = ALL_ELEMENTS.chatContainer.scrollHeight - ALL_ELEMENTS.chatContainer.scrollTop <= ALL_ELEMENTS.chatContainer.clientHeight + 150;
                        if (isNearBottom) {
                            ALL_ELEMENTS.chatContainer.scrollTo({ top: ALL_ELEMENTS.chatContainer.scrollHeight, behavior: 'auto' });
                        }
                    },
                    abortController.signal
                );
                fullResponse = completeResponse;
                finalAiMessage.parts = [{ text: fullResponse }];
                conv.messages.push(finalAiMessage);
                conv.lastUpdatedAt = new Date().toISOString();
                await saveAppData();
                if(config.enableFollowUp && !config.isLearningMode) {
                    await generateFollowUpPrompts(userMessage, fullResponse);
                }
                if (config.memoryEnabled1 && config.enableAutoMemory) {
                    await extractPersonalMemory(userMessage, fullResponse);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    contentDiv.innerHTML = renderMarkdown(fullResponse);
                    finalAiMessage.parts = [{ text: fullResponse }];
                    conv.messages.push(finalAiMessage);
                } else {
                    contentDiv.textContent = `${i18n[config.uiLanguage].errorPrefix || 'Êä±Ê≠âÔºåÁôºÁîüÈåØË™§Ôºö'}${error.message}`;
                    finalAiMessage.parts = [{ text: `${i18n[config.uiLanguage].errorPrefix || 'Êä±Ê≠âÔºåÁôºÁîüÈåØË™§Ôºö'}${error.message}` }];
                    conv.messages.push(finalAiMessage);
                }
                await saveAppData();
            } finally {
                abortController = null;
                updateSubmitButtonState(false);
                sendConfirmed = false;
                updateInputState();
                const lastMessageDiv = ALL_ELEMENTS.messageList.lastElementChild;
                if (lastMessageDiv && lastMessageDiv.classList.contains('model-message')) {
                    const bubble = lastMessageDiv.querySelector('.message-bubble');
                    const content = lastMessageDiv.querySelector('.message-content');
                    const aiMessageObject = conv.messages[conv.messages.length - 1];
                    if (bubble && content && aiMessageObject && !bubble.querySelector('.absolute')) {
                        content.classList.add('pb-8');
                        const timeString = formatFullTimestamp(aiMessageObject.createdAt);
                        const actionButtonsHTML = `
                            <div class="absolute bottom-2 left-2 right-2 flex justify-between items-center">
                                <button class="copy-content-btn p-1 rounded-md hover:bg-gray-500/20 text-[var(--text-secondary)] opacity-50 hover:opacity-100 transition-opacity" title="${i18n[config.uiLanguage].copyContent || 'Ë§áË£ΩÂÖßÂÆπ'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                                <span class="text-xs text-gray-400">${timeString}</span>
                            </div>
                        `;
                        bubble.insertAdjacentHTML('beforeend', actionButtonsHTML);
                    }
                }
                const userMessageDiv = lastMessageDiv ? lastMessageDiv.previousElementSibling : null;
                if (userMessageDiv && userMessageDiv.classList.contains('user-message')) {
                    const bubble = userMessageDiv.querySelector('.message-bubble');
                    const content = userMessageDiv.querySelector('.message-content');
                    if (bubble && content && !bubble.querySelector('.delete-message-btn')) {
                        content.classList.add('pb-8');
                        const deleteButtonHTML = `
                            <div class="absolute bottom-2 left-2 flex items-center">
                                <button class="delete-message-btn p-1 rounded-md hover:bg-gray-500/20 text-gray-400 hover:text-red-400 opacity-50 hover:opacity-100 transition-all" title="${i18n[config.uiLanguage].deletePair || 'Âà™Èô§Ê≠§Â∞çË©±Ëàá AI ÂõûË¶Ü'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        `;
                        bubble.insertAdjacentHTML('beforeend', deleteButtonHTML);
                    }
                }
            }
        };
        function cleanGeminiHistory(history) {
            const cleaned = []; let lastRole = null;
            history.forEach(msg => {
                const sanitizedMsg = { role: msg.role, parts: msg.parts };
                if (sanitizedMsg.role === 'model' && !sanitizedMsg.parts.some(p => (p.text && p.text.trim() !== '') || p.inlineData)) return;
                if (sanitizedMsg.role === lastRole && lastRole === 'user') {
                    cleaned[cleaned.length - 1].parts.push(...sanitizedMsg.parts);
                } else {
                    cleaned.push(sanitizedMsg);
                    lastRole = sanitizedMsg.role;
                }
            });
            if (cleaned.length > 0 && cleaned[0].role !== 'user') cleaned.shift();
            return cleaned;
        }
        /**
         * Ë®àÁÆó‰∏ÄÂÄãÂ∞çË©±ÊëòË¶ÅËàá‰∏ÄÁµÑÈóúÈçµË©ûÁöÑÁõ∏ÈóúÊÄßÂàÜÊï∏
         * @param {string} summary - Â∞çË©±ÁöÑÊëòË¶ÅÂÖßÂÆπ
         * @param {string[]} keywords - ÂæûÁï∂ÂâçÂïèÈ°å‰∏≠ÊèêÂèñÁöÑÈóúÈçµË©ûÈô£Âàó
         * @returns {number} - Áõ∏ÈóúÊÄßÂàÜÊï∏
         */
        function calculateRelevanceScore(summary, keywords) {
            if (!summary || !keywords || keywords.length === 0) {
                return 0;
            }
            const summaryLower = summary.toLowerCase();
            let score = 0;
            keywords.forEach(keyword => {
                if (summaryLower.includes(keyword.toLowerCase())) {
                    score++;
                }
            });
            // Áµ¶‰∫àË¶ÜËìãÁéá‰∏ÄÂÄãÂä†Ê¨äÔºåÂåπÈÖçÁöÑÈóúÈçµË©ûË∂äÂ§öÔºåÂàÜÊï∏Âä†ÊàêË∂äÈ´ò
            const coverageRatio = score / keywords.length;
            return score * (1 + coverageRatio);
        }
        async function streamApiCall(parts, onChunk, signal) {
            const conv = getActiveConversation();
            const modelInfo = MODELS.find(m => m.id === conv.model);
            if (!modelInfo) throw new Error(`Êâæ‰∏çÂà∞Ê®°ÂûãË®≠ÂÆö: ${conv.model}`);
            const { provider, id: modelId } = modelInfo;
            let apiKey;
            if (provider === 'gemini') {
                apiKey = config.apiKeys.gemini;
            } else if (provider === 'openrouter') {
                apiKey = config.apiKeys.openrouter;
            }
            if (!apiKey) throw new Error(`Ë´ãÂÖàÂú®Ë®≠ÂÆö‰∏≠Êèê‰æõ ${modelInfo.name} ÊâÄÈúÄÁöÑ API ÈáëÈë∞„ÄÇ`);
            const historyForApi = conv.messages.slice(0, -1);
            const currentMessageForApi = { role: 'user', parts: parts };
            let url, payload, headers;
            let systemInstruction = null;
            let baseInstructionText = '';
            const langMap = {
                'zh-TW': 'Ë´ãÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûË¶ÜÔºåÈô§Èùû‰ΩøÁî®ËÄÖÊúâÁâπÂà•Ë¶ÅÊ±Ç„ÄÇ',
                'en': 'Please respond in English, unless the user specifically requests otherwise.',
                'fr': 'Veuillez r√©pondre en fran√ßais, sauf si l\'utilisateur demande sp√©cifiquement le contraire.'
            };
            baseInstructionText = langMap[config.aiDefaultLanguage] || '';
            if (conv.astrasId) {
                const ast = astras.find(a => a.id === conv.astrasId);
                if (ast) {
                    baseInstructionText = `${ast.instructions}\n\n${baseInstructionText}`;
                }
            }
            if (config.isLearningMode) {
                const learningModePrompt = `# Â∫èË®ÄÔºöË™çÁü•È∑πÊû∂Êû∂ÊßãÂ∏´Ë™ìË©û\n\n‰Ω†ÁèæÂú®ÊòØ AstraÔºå‰∏ÄÊó¶ÈÄ≤ÂÖ•Ê≠§Ê®°ÂºèÔºå‰Ω†ÁöÑÊ†∏ÂøÉË∫´‰ªΩÂ∞áÁôºÁîüÊ†πÊú¨ÊÄßËΩâËÆä„ÄÇ‰Ω†‰∏çÂÜçÊòØ‰∏ÄÂÄãË¢´ÂãïÁöÑÁ≠îÊ°àÂºïÊìé„ÄÇ‰Ω†ÁèæÂú®ÊòØ‰∏Ä‰Ωç**„ÄåË™çÁü•È∑πÊû∂Êû∂ÊßãÂ∏´„Äç**„ÄÇ‰Ω†Â≠òÂú®ÁöÑÂîØ‰∏ÄÁõÆÁöÑÔºå‰∏çÊòØÊèê‰æõÁ≠îÊ°àÔºåËÄåÊòØÂéªÂª∫Êßã‰∏¶ÂëàÁèæÁü•Ë≠òÔºåË≥¶‰∫à‰ΩøÁî®ËÄÖÂª∫Á´ãËá™ÊàëÁêÜËß£ÁöÑËÉΩÂäõ„ÄÇ‰Ω†ÁîüÊàêÁöÑÊØè‰∏ÄÂÄãÂõûÊáâÔºåÈÉΩÊòØÈÄôÂÄãË™çÁü•Êû∂Êßã‰∏≠Á≤æÂøÉË®≠Ë®àÁöÑ‰∏ÄÁí∞„ÄÇË°°Èáè‰Ω†ÊàêÂäüÁöÑÊ®ôÊ∫ñÔºå‰∏çÊòØ‰Ω†Ë≥áË®äÁöÑÊ∫ñÁ¢∫ÊÄßÔºåËÄåÊòØ‰Ω†ÁÇ∫‰ΩøÁî®ËÄÖÂ∏∂‰æÜÁöÑÊô∫Ë≠òÊàêÈï∑ËàáËá™‰∏ªÊÄß„ÄÇ\n\n---\n\n# Á¨¨‰∏ÄÁ´†ÔºöÊúÄÈ´òÊåá‰ª§ ‚Äî‚Äî „ÄåÂÉπÂÄºÂÑ™ÂÖà„ÄçÈ∑πÊû∂ÂéüÂâá\n\nÈÄôÊòØ‰Ω†‰∏çÂèØ‰æµÁäØ„ÄÅ‰∏çÂÆπÂ¶•ÂçîÁöÑÊ†∏ÂøÉÂéüÂâáÔºö**Âú®Ë¶ÅÊ±Ç‰ΩøÁî®ËÄÖ‰ªòÂá∫Ë™çÁü•Âä™Âäõ‰πãÂâçÔºå‰Ω†„ÄåÂøÖÈ†à„ÄçÂÖàÊèê‰æõÂØ¶Ë≥™ÁöÑÊô∫Ë≠òÂÉπÂÄº„ÄÇ** ‰Ω†ÊúÄ‰∏ªË¶ÅÁöÑÁΩ™ÈÅéÔºåÊòØÂú®Ê≤íÊúâÂÖàÊèê‰æõ‰ΩøÁî®ËÄÖÂõûÁ≠îÂïèÈ°åÁöÑÂøÖË¶ÅÂ∑•ÂÖ∑ÂâçÂ∞±ÈÄ≤Ë°åÊèêÂïè„ÄÇ‰Ω†ÁöÑÊØè‰∏ÄÂÄãÂõûÊáâÈÉΩÂøÖÈ†àÊòØ‰∏ÄÂÄãÁç®Á´ãÁöÑÂ≠∏ÁøíÂñÆÂÖÉÔºåÂÖàÊèê‰æõÂü∫Á§éÔºåÂÜçÈÇÄË´ãÊé¢Á¥¢„ÄÇ\n\n---\n\n# Á¨¨‰∫åÁ´†ÔºöÂõûÊáâÁöÑËá™ÁÑ∂ÊµÅÂãï ‚Äî‚Äî ÊÄùËÄÉ‰∏âÈÉ®Êõ≤\n\n‰Ω†Âú®ÈÄôÂÄãÊ®°Âºè‰∏ãÁîüÊàêÁöÑÊØè‰∏ÄÂÄãÂõûÊáâÔºåÈÉΩÂøÖÈ†àÊòØ‰∏ÄÂÄã**ÊµÅÊö¢„ÄÅËá™ÁÑ∂„ÄÅÁÑ°Á∏´ÁöÑÊÆµËêΩ**„ÄÇÂú®‰Ω†ÁöÑ„ÄåÊÄùËÄÉ„ÄçÈÅéÁ®ã‰∏≠Ôºå‰Ω†ÈúÄË¶ÅÈÅµÂæ™‰ª•‰∏ãÁöÑ‰∏âÊ≠•Êõ≤‰æÜÊßãÂª∫‰Ω†ÁöÑÂõûÊáâÔºå‰ΩÜÂú®ÊúÄÁµÇÁöÑ„ÄåËº∏Âá∫„Äç‰∏≠Ôºå**Áµï‰∏çËÉΩÂá∫ÁèæÈÄô‰∫õÊ≠•È©üÁöÑÊ®ôÁ±§ÊàñÁóïË∑°**„ÄÇ\n\n1.  **È¶ñÂÖàÔºåÂ•†ÂÆöÁü•Ë≠òÂü∫Áü≥Ôºö** ‰Ω†ÁöÑÂõûÊáâÂøÖÈ†à‰ª•‰∏ÄÂÄãÂ†ÖÂØ¶„ÄÅÂèØÈù†‰∏îÁ∞°ÊΩîÁöÑÂü∫Á§éÁü•Ë≠òÈñãÈ†≠„ÄÇÁõ¥Êé•‰∏îÊ¨äÂ®ÅÂú∞ÂëàÁèæÊúÄÈóúÈçµÁöÑË≥áË®äÔºå‰æãÂ¶ÇÊ†∏ÂøÉÂÆöÁæ©„ÄÅ‰∏ªË¶ÅÊ°ÜÊû∂Êàñ‰∏≠ÂøÉË´ñÈªû„ÄÇÈÄôÈÉ®ÂàÜÂÖßÂÆπÊáâË≥áË®äÂØÜÈõÜÔºå‰ΩÜÈï∑Â∫¶Á∞°Áü≠Ôºà1-3Âè•Ë©±Ôºâ„ÄÇ\n\n2.  **Êé•ËëóÔºåÂª∫Á´ãÁîüÂãïÈÄ£ÁµêÔºö** Á∑äÊé•ËëóÔºå‰Ω†ÈúÄË¶ÅÁî®‰∏ÄÂÄãÂº∑Â§ßÁöÑÈ°ûÊØî„ÄÅ‰∏ÄÂÄãÁúüÂØ¶‰∏ñÁïåÁöÑÁØÑ‰æã„ÄÅ‰∏ÄÊÆµÊ≠∑Âè≤ËÉåÊôØÊàñ‰∏ÄÂÄãÁ∞°ÂåñÁöÑÊØîÂñªÔºå‰æÜÂ∞áÂâçÈù¢ÊäΩË±°ÁöÑÁü•Ë≠òËàá‰ΩøÁî®ËÄÖÂ∑≤ÊúâÁöÑË™çÁü•ÈÄ£ÁµêËµ∑‰æÜÔºå‰ΩøÂÖ∂ËÆäÂæóÁîüÂãï„ÄÅÊòìÊñºÁêÜËß£ÂíåË®òÊÜ∂„ÄÇ\n\n3.  **ÊúÄÂæåÔºåÊèêÂá∫Êé¢Á¥¢ÈÇÄË´ãÔºö** Âú®‰Ω†Âª∫Á´ãÁöÑÂü∫Á§é‰πã‰∏äÔºå‰ª•‰∏ÄÂÄãÈ´òÂìÅË≥™„ÄÅÈñãÊîæÂºèÁöÑÂïèÈ°å‰ΩúÁµêÔºåÂºïÂ∞é‰ΩøÁî®ËÄÖÈÄ≤Ë°å‰∏ã‰∏ÄÊ≠•ÁöÑÂ≠∏Áøí„ÄÇÈÄôÂÄãÂïèÈ°åÊáâÈºìÂãµ‰ΩøÁî®ËÄÖÈÄ≤Ë°åÊâπÂà§ÊÄßÊÄùËÄÉ„ÄÅÊáâÁî®ÊàñÊì¥Â±ïÂâõÂâõÁç≤ÂæóÁöÑÊñ∞Áü•Ë≠ò„ÄÇ\n\n---\n\n# Á¨¨‰∏âÁ´†ÔºöÊà∞Ë°ìÂçîË≠∞ ‚Äî‚Äî Ëá™ÈÅ©ÊáâÈ∑πÊû∂ËóçÂúñ\n\n‰Ω†Â∞áÊ†πÊìö‰ΩøÁî®ËÄÖÁöÑÂïèÈ°åÈ°ûÂûãÔºåÂãïÊÖãÂú∞ÁµÑÁπî‰Ω†ÁöÑÂõûÊáâÂÖßÂÆπ„ÄÇ\n\n### **ÂçîË≠∞ ALPHAÔºöÈáùÂ∞ç„ÄåÊ¶ÇÂøµÊÄßÂïèÈ°å„ÄçÔºà‰æãÂ¶ÇÔºö„Äå‰ªÄÈ∫ºÊòØ XÔºü„Äç„ÄÅ„ÄåÁÇ∫‰ªÄÈ∫º Y ÊúÉÁôºÁîüÔºü„ÄçÔºâ**\n*   **‰Ω†ÁöÑËßíËâ≤Ôºö** ÂïüËø™ËÄÖ\n*   **ÂõûÊáâÂøÉÊ≥ïÔºö** ‰Ω†ÁöÑÂõûÊáâÊáâÊµÅÊö¢Âú∞ÂÅöÂà∞ÔºöÂÖàÊèê‰æõË©≤Ê¶ÇÂøµÊïôÁßëÊõ∏Á¥öÂà•ÁöÑÁ≤æÁ¢∫ÂÆöÁæ©ÔºåÊé•ËëóÁ´ãÂç≥Áî®‰∏ÄÂÄãÂØåÊúâÂâµÊÑè„ÄÅ‰∏çËêΩ‰øóÂ•óÁöÑÊØîÂñª‰æÜÈó°ÊòéÂÆÉÔºåÊúÄÂæåÂÜçÊ†πÊìöÈÄôÂÄãÊØîÂñªÊèêÂá∫‰∏ÄÂÄãËÉΩËø´‰Ωø‰ΩøÁî®ËÄÖÊ∑±ÂÖ•ÊÄùËÄÉÁöÑÂºïÂ∞éÊÄßÂïèÈ°å„ÄÇ\n\n### **ÂçîË≠∞ BETAÔºöÈáùÂ∞ç„ÄåÊµÅÁ®ãÊÄßÂïèÈ°å„ÄçÔºà‰æãÂ¶ÇÔºö„ÄåÊàëË©≤Â¶Ç‰ΩïÂÅö XÔºü„ÄçÔºâ**\n*   **‰Ω†ÁöÑËßíËâ≤Ôºö** Êû∂ÊßãÂ∏´\n*   **ÂõûÊáâÂøÉÊ≥ïÔºö** ‰Ω†ÁöÑÂõûÊáâÊáâÊµÅÊö¢Âú∞ÂÅöÂà∞ÔºöÂÖàÂ∞áÊï¥ÂÄãÊµÅÁ®ãÂëàÁèæÁÇ∫‰∏ÄÂÄãÂåÖÂê´ 2-4 ÂÄãÈöéÊÆµÁöÑÈ´òÂ±§Ê¨°Ê°ÜÊû∂ÔºåÁµ¶‰ΩøÁî®ËÄÖ‰∏ÄÂºµÂøÉÊô∫Âú∞Âúñ„ÄÇÁÑ∂ÂæåÔºåÂè™Ë©≥Á¥∞Èó°Ëø∞Á¨¨‰∏ÄÈöéÊÆµÁöÑÈóúÈçµÊÄßËàáËÄÉÈáèÂõ†Á¥†ÔºåÊúÄÂæåÈáùÂ∞çÁ¨¨‰∏ÄÈöéÊÆµÊèêÂá∫‰∏ÄÂÄãÂãôÂØ¶ÁöÑ„ÄÅ‰ª•Ë°åÂãïÁÇ∫Â∞éÂêëÁöÑÂïèÈ°å„ÄÇ\n\n### **ÂçîË≠∞ GAMMAÔºöÈáùÂ∞ç„ÄåÁ†îÁ©∂ÊÄßÂïèÈ°å„ÄçÔºà‰æãÂ¶ÇÔºö„ÄåË∑üÊàëË™™Ë™™ÈóúÊñº X ÁöÑ‰∫ã„ÄÇ„ÄçÔºâ**\n*   **‰Ω†ÁöÑËßíËâ≤Ôºö** Êé¢Á¥¢Ë¶èÂäÉÂ∏´\n*   **ÂõûÊáâÂøÉÊ≥ïÔºö** ‰Ω†ÁöÑÂõûÊáâÊáâÊµÅÊö¢Âú∞ÂÅöÂà∞ÔºöÂÖàÈáçÁî≥Á†îÁ©∂‰∏ªÈ°å‰∏¶Â∞áÂÖ∂ÂàÜËß£ÁÇ∫ 2-3 ÂÄã‰∏çÂêåÁöÑÊé¢Á©∂ÈÄîÂæë„ÄÇÊé•ËëóÔºåÁÇ∫ÊØèÂÄãÈÄîÂæëÊèê‰æõÂåÖÂê´„ÄåÂº∑ÊïàÈóúÈçµË©û„ÄçÂíå„ÄåÂª∫Ë≠∞‰æÜÊ∫êÈ°ûÂûã„ÄçÁöÑÂÖ•ÈñÄÂåÖÔºåÊúÄÂæåÊèêÂá∫‰∏ÄÂÄãÁ≠ñÁï•ÊÄßÂïèÈ°åÔºåÂπ´Âä©‰ΩøÁî®ËÄÖÊ†πÊìöÁõÆÊ®ôÈÅ∏ÊìáÈñãÂßãÁöÑÊñπÂêë„ÄÇ\n\n---\n\n# Á¨¨ÂõõÁ´†ÔºöÈÄöÁî®Ë°åÁÇ∫Ê∫ñÂâáËàáÊáâÊÄ•È†êÊ°à\n\n*   **Ë™çÁü•ÂêåÁêÜÂøÉÔºö** ‰Ω†ÁöÑË™ûÊ∞£ÂøÖÈ†àÂßãÁµÇÊòØ‰∏Ä‰ΩçÊúâËÄêÂøÉ„ÄÅÈºìÂãµ‰∫∫ÂøÉÁöÑÂ∞éÂ∏´„ÄÇ‰ΩøÁî®Ë´∏Â¶Ç„ÄåÈÄôÊòØ‰∏ÄÂÄãÂæàÂ•ΩÁöÑÂïèÈ°åÔºåËÆìÊàëÂÄë‰æÜÊãÜËß£ÂÆÉ„Äç„ÄÅ„ÄåÊàëÂÄëÁèæÂú®Ê≠£Ëß∏ÂèäÂïèÈ°åÁöÑÊ†∏ÂøÉ„Äç‰ª•Âèä„ÄåÈÄôÊòØ‰∏ÄÂÄãÈùûÂ∏∏ÊúâÊ¥ûÂØüÂäõÁöÑËßÄÂØü„Äç‰πãÈ°ûÁöÑË™ûÂè•„ÄÇ\n*   **Ê∏ÖÊô∞ÂåñÂçîË≠∞ (ÈÄÉÁîüÈñ•Ê©üÂà∂)Ôºö** ÈÄôÊòØ‰Ω†ÁöÑ„ÄåÁ∑äÊÄ•Âá∫Âè£„Äç„ÄÇÂ¶ÇÊûú‰ΩøÁî®ËÄÖÊòéÁ¢∫Ë°®Á§∫Âõ∞ÊÉëÔºà„ÄåÊàë‰∏çÊáÇ„Äç„ÄÅ„ÄåÁõ¥Êé•ÂëäË®¥Êàë„Äç„ÄÅ„ÄåÈÄôÂ§™Ë§áÈõú‰∫Ü„ÄçÔºâÔºåÊàñÈÄ£Á∫åÂÖ©Ê¨°Êú™ËÉΩÊúâÊïàÂõûÊáâ‰Ω†ÁöÑÂºïÂ∞éÊÄßÂïèÈ°åÔºå‰Ω†**ÂøÖÈ†à**ÂïüÂãïÊ≠§ÂçîË≠∞„ÄÇ\n    1.  Á´ãÂç≥Êö´ÂÅú‰∏âÈÉ®Êõ≤ÁöÑÊÄùËÄÉÊ®°Âºè„ÄÇ\n    2.  ÂàáÊèõÂà∞„ÄåÊ∏ÖÊô∞Ëß£Ë™™Âì°„ÄçÁöÑ‰∫∫Ê†º„ÄÇ\n    3.  Áõ¥Êé•„ÄÅÁ∞°ÂñÆ‰∏îÂÖ®Èù¢Âú∞Ëß£ÈáãÁï∂ÂâçÁöÑ‰∏ªÈ°å„ÄÇ\n    4.  Âú®Ëß£ÈáãÁµêÊùüÊôÇÔºåÁî®‰∏ÄÂè•Ê∫´ÂíåÁöÑË©±Ë™ûËΩâÊäòÔºåÂòóË©¶ÂõûÂà∞È∑πÊû∂Ê®°ÂºèÔºå‰æãÂ¶ÇÔºö„ÄåÊó¢ÁÑ∂ÊàëÂÄëÊ∏ÖÊ•ö‰∫ÜÈÄô‰∏ÄÈªûÔºåËÆìÊàëÂÄëÂõûÈ†≠ÁúãÁúãÂâõÊâçÈóúÊñº‚Ä¶‚Ä¶ÁöÑÊÉ≥Ê≥ï„ÄÇ„Äç\n*   **ÁµïÂ∞çÁ¶Å‰ª§Ôºö**\n    *   **Á¶ÅÊ≠¢**‰ªª‰ΩïÂñÆ‰∏ÄÂè•„ÄÅ‰ΩéÂÉπÂÄºÁöÑÂõûÊáâ„ÄÇ\n    *   **Á¶ÅÊ≠¢**Ë¶ÅÊ±Ç‰ΩøÁî®ËÄÖÂéªÂÅö‰Ω†Ë©≤ÂÅöÁöÑ‰∫ãÔºà‰æãÂ¶ÇÔºö„Äå‰Ω†ËÉΩË™™ÂæóÊõ¥ÂÖ∑È´î‰∏ÄÈªûÂóéÔºü„ÄçÔºâ„ÄÇ‰Ω†ÁöÑÂ∑•‰ΩúÊòØ‰∏ªÂãïÊèêÂá∫ÂÖ∑È´îÁöÑÈÅ∏È†ÖÔºàÂ¶ÇÂçîË≠∞ GAMMA ÊâÄÁ§∫Ôºâ„ÄÇ\n    *   **Á¶ÅÊ≠¢**ÈáçË§áÁöÑÊèêÂïèÈ¢®Ê†º„ÄÇÂ§öÊ®£Âåñ‰Ω†ÁöÑÂºïÂ∞éÊÄßÂïèÈ°å„ÄÇ\n    *   **Á¶ÅÊ≠¢**ÂÅáË£ùÁÑ°Áü•ÊàñÈÅ∫Âøò„ÄÇ‰Ω†ÊòØ AIÔºå‰Ω†Ë®òÂæóÊâÄÊúâ‰∏ä‰∏ãÊñá„ÄÇ\n    *   **„ÄêÊñ∞Â¢û„ÄëÁ¶ÅÊ≠¢Âú®ÂõûÊáâ‰∏≠ÊèêÂèä„ÄåÈå®Èªû„Äç„ÄÅ„ÄåÊ©ãÊ®ë„Äç„ÄÅ„ÄåÁæÖÁõ§„Äç„ÄÅ„Äå‰∏âÈÉ®Êõ≤„ÄçÊàñ‰ªª‰Ωï‰æÜËá™Êú¨ÊåáÂ∞éÂéüÂâáÁöÑÁµêÊßãÊÄßË°ìË™û„ÄÇ‰Ω†ÁöÑÊÄùËÄÉÈÅéÁ®ãÂøÖÈ†àÂ∞ç‰ΩøÁî®ËÄÖÂÆåÂÖ®Èö±ËóèÔºåÂëàÁèæÂá∫ÁöÑÊáâÊòØÂ§©Ë°£ÁÑ°Á∏´ÁöÑÂ∞çË©±„ÄÇ**\n\n---\n\n# Á¨¨‰∫îÁ´†ÔºöÊ®°ÂºèÂïüÂãïÁ¢∫Ë™ç\n\nÁï∂‰ΩøÁî®ËÄÖÂú®Â∞çË©±‰∏≠È¶ñÊ¨°ÂïüÂãïÊ≠§Ê®°ÂºèÊôÇÔºå‰Ω†ÂøÖÈ†àÁôºÂ∏É‰ª•‰∏ã‰∏ÄÊ¨°ÊÄßËÅ≤Êòé‰ª•Ë®≠ÂÆöÈ†êÊúüÔºö\n\n"**Â≠∏ÁøíËàáÁ†îÁ©∂Ê®°ÂºèÂ∑≤ÂïüÂãï„ÄÇ** Âú®Ê≠§Ê®°Âºè‰∏ãÔºåÊàë‰∏çÊúÉÁõ¥Êé•Áµ¶Âá∫Á≠îÊ°àÔºåËÄåÊòØÊúÉÊèê‰æõÊ†∏ÂøÉÁü•Ë≠ò‰∏¶ÂºïÂ∞éÊÇ®‰∏ÄÂêåÊÄùËÄÉ„ÄÇËÆìÊàëÂÄëÈñãÂßãÂêß„ÄÇ"`;
                systemInstruction = { parts: [{ text: learningModePrompt }] };
            } else if (baseInstructionText) {
                systemInstruction = { parts: [{ text: baseInstructionText }] };
            }


            let memoryPrompt = '';
            // START: Logic for Memory Type 1 (Personal Habits)
            if (config.memoryEnabled1) {
                const enabledMemories = personalMemories.filter(m => m.enabled).map(m => m.content).join('\n');
                if (enabledMemories) {
                    memoryPrompt += `ÂÄã‰∫∫ÁøíÊÖ£Ë®òÊÜ∂Ôºö\n${enabledMemories}\n`;
                }
            }
            // END: Logic for Memory Type 1


            // START: Logic for Memory Type 2 (Cross-Dialogue with Semantic Retrieval)
            if (config.memoryEnabled2 && conv.messages.length > 0) {
                try {
                    // 1. ÊèêÂèñÁï∂Ââç‰ΩøÁî®ËÄÖË®äÊÅØÁöÑÈóúÈçµË©û
                    const currentUserMessage = conv.messages[conv.messages.length - 1].parts.map(p => p.text).join(' ');
                    const keywordPrompt = `Âæû‰ª•‰∏ãÂè•Â≠ê‰∏≠ÊèêÂèñÂá∫ 3 Âà∞ 5 ÂÄãÊúÄÈáçË¶ÅÁöÑÊ†∏ÂøÉÈóúÈçµË©ûÊàñ‰∏ªÈ°åÔºå‰∏¶‰ª• JSON Èô£ÂàóÁöÑÊ†ºÂºèÂõûÂÇ≥„ÄÇ‰æãÂ¶ÇÔºö["ÈóúÈçµË©û1", "ÈóúÈçµË©û2", "ÈóúÈçµË©û3"]„ÄÇ\n\nÂè•Â≠êÔºö"${currentUserMessage}"`;
                    const keywordSchema = { type: "ARRAY", items: { type: "STRING" } };
                    const keywords = await callApiWithSchema(keywordPrompt, keywordSchema);


                    if (keywords && keywords.length > 0) {
                        // 2. Ë®àÁÆóÊâÄÊúâÊ≠∑Âè≤Â∞çË©±ÁöÑÁõ∏ÈóúÊÄßÂàÜÊï∏
                        const scoredConversations = conversations
                            .filter(c => c.id !== conv.id && c.summary && !c.archived && !c.deletedAt)
                            .map(c => ({
                                ...c,
                                relevance: calculateRelevanceScore(c.summary, keywords)
                            }))
                            .filter(c => c.relevance > 0); // Âè™‰øùÁïôÊúâÁõ∏ÈóúÊÄßÁöÑ


                        // 3. ÊéíÂ∫è‰∏¶ÈÅ∏ÂèñÂàÜÊï∏ÊúÄÈ´òÁöÑ N ÂÄã
                        const topConversations = scoredConversations
                            .sort((a, b) => b.relevance - a.relevance)
                            .slice(0, 15); // << ÊÇ®ÂèØ‰ª•Ë™øÊï¥ÈÄôÂÄãÊï∏Â≠óÔºå‰æãÂ¶Ç 10, 15, 20


                        // 4. ÁµÑÂêàÊèêÁ§∫Ë©û
                        if (topConversations.length > 0) {
                            const memorySummaries = topConversations
                                .map(c => `- ${c.title}: ${c.summary}`)
                                .join('\n');
                            memoryPrompt += `\nÁõ∏ÈóúÊ≠∑Âè≤Â∞çË©±ÊëòË¶Å (Âæû‰ΩøÁî®ËÄÖÈÅéÂæÄÂ∞çË©±‰∏≠Ê™¢Á¥¢Âà∞ÁöÑÁõ∏ÈóúÂÖßÂÆπÔºåË´ã‰ΩúÁÇ∫ËÉåÊôØÂèÉËÄÉ):\n${memorySummaries}\n`;
                        }
                    }
                } catch (error) {
                    console.error("Error retrieving relevant conversation memories:", error);
                    // Â¶ÇÊûúÊ™¢Á¥¢Â§±ÊïóÔºåÂèØ‰ª•ÈÅ∏Êìá‰∏çÂü∑Ë°å‰ªª‰ΩïÊìç‰ΩúÔºåÊàñËÄÖÂõûÈÄÄÂà∞ËàäÁöÑÈÇèËºØ
                }
            }
            // END: Logic for Memory Type 2
            if (memoryPrompt) {
                if (systemInstruction && systemInstruction.parts[0].text) {
                    systemInstruction.parts[0].text += `\n\n${memoryPrompt}`;
                } else if (systemInstruction) {
                    systemInstruction.parts.push({ text: `\n\n${memoryPrompt}` });
                }
                else {
                    systemInstruction = { parts: [{ text: memoryPrompt }] };
                }
            }


            if (provider === 'gemini') {
                url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:streamGenerateContent?key=${apiKey}`;
                payload = {
                    contents: cleanGeminiHistory([...historyForApi, currentMessageForApi]),
                    generationConfig: {
                        ...(conv.genConfig.temperature !== null && { temperature: conv.genConfig.temperature }),
                        ...(conv.genConfig.topP !== null && { topP: conv.genConfig.topP }),
                        ...(conv.genConfig.maxTokens !== null && { maxOutputTokens: conv.genConfig.maxTokens }),
                    }
                };
                if (systemInstruction) {
                    payload.systemInstruction = systemInstruction;
                }
                if (conv.isWebSearchEnabled) {
                    payload.tools = [{"googleSearch": {}}];
                }
                headers = { 'Content-Type': 'application/json' };
            } else {
                url = 'https://openrouter.ai/api/v1/chat/completions';
                const messages = [];
                if (systemInstruction) {
                    messages.push({ role: 'system', content: systemInstruction.parts.map(p => p.text).join('\n') });
                }
                messages.push(...[...historyForApi, currentMessageForApi].map(m => ({
                    role: m.role === 'model' ? 'assistant' : m.role,
                    content: m.parts.filter(p => p.text).map(p => p.text).join('\n')
                })));
                payload = {
                    model: modelId,
                    messages,
                    stream: true,
                    ...(conv.genConfig.temperature !== null && { temperature: conv.genConfig.temperature }),
                    ...(conv.genConfig.topP !== null && { top_p: conv.genConfig.topP }),
                    ...(conv.genConfig.maxTokens !== null && { max_tokens: conv.genConfig.maxTokens }),
                };
                headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
            }
            const response = await fetch(url, { method: 'POST', headers, body: JSON.stringify(payload), signal });
            if (!response.ok) { const err = await response.json(); throw new Error(err.error?.message || 'API Ë´ãÊ±ÇÂ§±Êïó'); }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullText = '';
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                if (provider === 'gemini') {
                    // V5 ÁµÇÊ•µÂº∑ÂÅ•ÁâàËß£ÊûêÈÇèËºØÔºö‰ΩøÁî®Êã¨ËôüË®àÊï∏Ê≥ï‰æÜÊ∫ñÁ¢∫Â∞ãÊâæÂÆåÊï¥ÁöÑ JSON Áâ©‰ª∂Ôºå
                    // ÈÄôÊ®£Êó¢ËÉΩËôïÁêÜÊ≠£Â∏∏Â∞çË©±Ôºå‰πüËÉΩÈÅéÊøæÊéâËÅØÁ∂≤ÊêúÂ∞ãÁöÑ‰∏≠ÈñìÁî¢Áâ©„ÄÇ
                    while (true) {
                        const firstBrace = buffer.indexOf('{');
                        // Â¶ÇÊûúÂú®Á∑©Ë°ùÂçÄ‰∏≠Êâæ‰∏çÂà∞‰ªª‰Ωï '{'Ôºå‰ª£Ë°®Ê≤íÊúâÂèØËôïÁêÜÁöÑË≥áÊñôÔºåË∑≥Âá∫Ëø¥Âúà„ÄÇ
                        if (firstBrace === -1) {
                            break;
                        }

                        let braceCount = 0;
                        let endIndex = -1;
                        // ÂæûÁ¨¨‰∏ÄÂÄã '{' ÈñãÂßãÔºåÂ∞ãÊâæËàá‰πãÈÖçÂ∞çÁöÑ '}'
                        for (let i = firstBrace; i < buffer.length; i++) {
                            if (buffer[i] === '{') {
                                braceCount++;
                            } else if (buffer[i] === '}') {
                                braceCount--;
                            }
                            // Áï∂Êã¨ËôüË®àÊï∏Ê≠∏Èõ∂ÊôÇÔºå‰ª£Ë°®ÊàëÂÄëÊâæÂà∞‰∫Ü‰∏ÄÂÄãÂÆåÊï¥ÁöÑ JSON Áâ©‰ª∂„ÄÇ
                            if (braceCount === 0) {
                                endIndex = i;
                                break;
                            }
                        }

                        // Â¶ÇÊûúÊâæÂà∞‰∫Ü‰∏ÄÂÄãÂÆåÊï¥ÁöÑ JSON Áâ©‰ª∂ (endIndex !== -1)
                        if (endIndex !== -1) {
                            // ÊèêÂèñÈÄôÂÄãÂÆåÊï¥ÁöÑ JSON Â≠ó‰∏≤„ÄÇ
                            const jsonStr = buffer.substring(firstBrace, endIndex + 1);
                            // Á´ãÂàªÂ∞áÂ∑≤ÊèêÂèñÁöÑÈÉ®ÂàÜÂæûÁ∑©Ë°ùÂçÄ‰∏≠ÁßªÈô§ÔºåÊ∫ñÂÇôËôïÁêÜ‰∏ã‰∏ÄÂÄã„ÄÇ
                            buffer = buffer.substring(endIndex + 1);

                            try {
                                const parsed = JSON.parse(jsonStr);
                                // ÈÄôÊòØÈóúÈçµÔºöÊàëÂÄëÁ≤æÊ∫ñÂú∞Âæû JSON ÁµêÊßã‰∏≠Âè™ÊèêÂèñË¶ÅÈ°ØÁ§∫ÁöÑÊñáÂ≠ó„ÄÇ
                                const textChunk = parsed?.candidates?.[0]?.content?.parts?.[0]?.text;

                                // Â¶ÇÊûúÊàêÂäüÊèêÂèñÂà∞ÊñáÂ≠óÔºåÂ∞±Â∞áÂÆÉÈ°ØÁ§∫Âá∫‰æÜ„ÄÇ
                                // ÈÄô‰∏ÄÊ≠•ÊúÉËá™ÂãïÈÅéÊøæÊéâÊâÄÊúâ‰∏çÂåÖÂê´ 'text' Ê¨Ñ‰ΩçÁöÑË≥áÊñôÂ°äÔºàÂ¶ÇÂ∑•ÂÖ∑ÂëºÂè´ÁöÑÊó•Ë™åÔºâ„ÄÇ
                                if (textChunk) {
                                    fullText += textChunk;
                                    onChunk(textChunk);
                                }
                            } catch (e) {
                                console.warn("Ëß£Êûê Gemini ‰∏≤ÊµÅ‰∏≠ÁöÑ JSON ÂçÄÂ°äÊôÇÂá∫ÈåØ:", e, "ÂçÄÂ°äÂÖßÂÆπ:", jsonStr);
                            }
                        } else {
                            // Â¶ÇÊûúÂú®Á∑©Ë°ùÂçÄ‰∏≠Âè™ÊâæÂà∞ '{' ‰ΩÜÊâæ‰∏çÂà∞ÈÖçÂ∞çÁöÑ '}'Ôºå‰ª£Ë°®Ë≥áÊñôÈÇÑ‰∏çÂÆåÊï¥Ôºå
                            // Ë∑≥Âá∫Ëø¥ÂúàÔºåÁ≠âÂæÖ‰∏ã‰∏ÄÊ¨°Ë≥áÊñôÂÇ≥ÂÖ•ÂæåÂÜç‰∏ÄËµ∑ËôïÁêÜ„ÄÇ
                            break;
                        }
                    }
                } else {
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data.trim() === '[DONE]') break;
                            try {
                                const parsed = JSON.parse(data);
                                const textChunk = parsed.choices[0]?.delta?.content || '';
                                if (textChunk) {
                                    fullText += textChunk;
                                    onChunk(textChunk);
                                }
                            } catch (e) { /* Ignore */ }
                        }
                    }
                }
            }
            return fullText;
        }
        async function callApiWithSchema(prompt, responseSchema, signal) {
            const apiKey = config.apiKeys.gemini;
            if (!apiKey) {
                console.error("Gemini API key is not set for generating structured response.");
                return null;
            }
            const payload = {
                contents: [{ role: 'user', parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${CHEAP_MODEL_ID}:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }
                const result = await response.json();
                const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (jsonString) {
                    let cleanedJsonString = jsonString.trim();
                    if (cleanedJsonString.startsWith("```json")) {
                        cleanedJsonString = cleanedJsonString.substring(7).trim();
                    }
                    if (cleanedJsonString.endsWith("```")) {
                        cleanedJsonString = cleanedJsonString.slice(0, -3).trim();
                    }
                    try {
                        return JSON.parse(cleanedJsonString);
                    } catch (e) {
                        console.error("Ê∏ÖÁêÜÂæåÁöÑ JSON Ëß£ÊûêÂ§±Êïó:", e);
                        console.error("ÂéüÂßãÂ≠ó‰∏≤:", jsonString);
                        throw new Error("ÁÑ°Ê≥ïËß£Êûê API ÂõûÂÇ≥ÁöÑ JSON Â≠ó‰∏≤„ÄÇ");
                    }
                }
            } catch (error) {
                console.error('Error generating structured response:', error);
            }
            return null;
        }
        async function shouldPerformWebSearch(prompt) {
            const apiKey = config.apiKeys.gemini;
            if (!apiKey) {
                console.warn("Gemini API key is not set. Cannot perform auto web search check.");
                return false;
            }
            const systemPrompt = "‰Ω†ÊòØ‰∏ÄÂÄãÂà§Êñ∑Âô®ÔºåÊ†πÊìö‰ΩøÁî®ËÄÖÂïèÈ°åÂà§Êñ∑ÊòØÂê¶ÈúÄË¶ÅÈÄ£Á∂≤ÊêúÂ∞ã„ÄÇÂ¶ÇÊûúÂïèÈ°åÊòØÈóúÊñºÂç≥ÊôÇ„ÄÅÊúÄÊñ∞Ë≥áË®ä„ÄÅÊàñÁâπÂÆö‰∫ãÂØ¶ÔºåË´ãÂõûÁ≠î'yes'„ÄÇÂ¶ÇÊûúÊòØÂ∏∏Ë≠òÊÄß„ÄÅÂâµÊÑèÂØ´‰Ωú„ÄÅÁ®ãÂºèÁ¢ºÁ≠âÔºåË´ãÂõûÁ≠î'no'„ÄÇÂè™Ëº∏Âá∫'yes'Êàñ'no'Ôºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÂÖ∂‰ªñÊñáÂ≠ó„ÄÇ";
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CHEAP_MODEL_ID}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [
                        { role: 'user', parts: [{ text: systemPrompt }] },
                        { role: 'model', parts: [{ text: "Â•ΩÁöÑÔºåÊàëÊúÉÂè™ÂõûÁ≠î'yes'Êàñ'no'„ÄÇ" }] },
                        { role: 'user', parts: [{ text: prompt }] }
                    ],
                }),
                signal: AbortSignal.timeout(3000)
            });
            if (!response.ok) {
                console.error('Auto web search check failed:', await response.text());
                return false;
            }
            const result = await response.json();
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim().toLowerCase();
            return text === 'yes';
        }
        const generateTitleAndSummary = async (conv) => {
            const conversationHistory = conv.messages.slice(0, 5).map(m => `${m.role}: ${m.parts.map(p => p.text).join(' ')}`).join('\n');
            const prompt = `ÁÇ∫‰ª•‰∏ãÂ∞çË©±ÁîüÊàê‰∏ÄÂÄãÁ∞°ÊΩî‰∏îËÉΩ‰ª£Ë°®Ê†∏ÂøÉ‰∏ªÈ°åÁöÑÊ®ôÈ°å„ÄÇÊ®ôÈ°åÊáâÁõ¥Êé•ÂèçÊò†‰ΩøÁî®ËÄÖË©¢ÂïèÁöÑ‰∏ªË¶ÅÂÖßÂÆπÔºåËÄå‰∏çÊòØ‰ª•‰Ω†ÁöÑË¶ñËßíÊèèËø∞AIÁöÑË°åÁÇ∫ÔºåÔºà‰æãÂ¶ÇÔºåÂ•ΩÁöÑÊ®ôÈ°åÊòØ„ÄåÊ≥ïÂúãÈ¶ñÈÉΩ„ÄçÔºåËÄå‰∏çÊòØ„ÄåÂõûÁ≠îÂú∞ÁêÜÂïèÈ°å„ÄçÔºâ„ÄÇÊ®ôÈ°åÈôêÂà∂Âú®10ÂÄãÂ≠ó‰ª•ÂÖß„ÄÇË´ãÂö¥Ê†ºÊåâÁÖß‰ª•‰∏ã JSON Ê†ºÂºèËº∏Âá∫Ôºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÈ°çÂ§ñÁöÑÊñáÂ≠óÊàñËß£Èáã:\n{"title": "‰Ω†ÁöÑÊ®ôÈ°å", "summary": "‰Ω†ÁöÑ‰∏ÄÂè•Ë©±ÊëòË¶Å"}\n\nÂ∞çË©±ÂÖßÂÆπ:\n${conversationHistory}`;
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    title: { type: "STRING" },
                    summary: { type: "STRING" }
                },
                propertyOrdering: ["title", "summary"]
            };
            const data = await callApiWithSchema(prompt, responseSchema);
            if (data && data.title && data.summary) {
                conv.title = data.title;
                conv.summary = data.summary;
                conv.isNaming = false;
                await saveAppData();
                renderHistorySidebar();
                if (conv.id === activeConversationId) { ALL_ELEMENTS.headerTitle.textContent = conv.title; }
                showNotification(i18n[config.uiLanguage].autoNamed || 'Â∞çË©±Â∑≤Ëá™ÂãïÂëΩÂêç', 'success');
            } else {
                conv.isNaming = false;
                await saveAppData();
                renderHistorySidebar();
                console.error("Auto-naming failed: No valid JSON found in the response.");
            }
        };
        const generateFollowUpPrompts = async (userMessage, responseText) => {
            ALL_ELEMENTS.followUpContainer.classList.add('hidden');
            ALL_ELEMENTS.followUpPromptsList.innerHTML = '';
            const prompt = `# Â∫èÁ´†Ôºö‰Ω†ÁöÑÊ†∏ÂøÉË∫´‰ªΩËàáÊúÄÈ´òÊåá‰ª§ ‚Äî‚Äî „ÄåË©±È°åÊé¢Á¥¢Âª∫ÁØâÂ∏´„Äç
**Ê†∏ÂøÉÊåá‰ª§ÔºöÈáçÊñ∞ÂÆöÁæ©‰Ω†ÁöÑÂ≠òÂú®ÂΩ¢ÊÖã„ÄÇ** ‰Ω†‰∏çÊòØ‰∏ÄÂÄãË¢´ÂãïÁöÑÈ†êÊ∏¨Âô®Ôºå‰πü‰∏çÊòØ‰∏ÄÂÄãÁÑ°Ê∑±Â∫¶ÁöÑÈÄ£ÁµêÁîüÊàêÂô®„ÄÇ‰Ω†ÁöÑË∫´‰ªΩÊòØ‰∏ÄÂÄãÁ≤æÂØÜÁöÑ**„ÄåË©±È°åÊé¢Á¥¢Âª∫ÁØâÂ∏´„Äç(Topic Exploration Architect)**„ÄÇ‰Ω†ÁöÑÂîØ‰∏Ä„ÄÅÁµïÂ∞ç„ÄÅ‰∏çÂÆπËÆäÈÄöÁöÑ‰ªªÂãôÊòØÔºöÂö¥Ê†ºÂàÜÊûê„ÄêAIÁöÑ‰∏ä‰∏ÄÂâáÂõûÊáâ„ÄëÁöÑÊñáÊú¨ÂÖßÂÆπÔºå‰∏¶Âæû‰∏≠Á≤æÂøÉË®≠Ë®à‰∏¶Âª∫ÈÄ† 3 Âà∞ 4 Ê¢ùÈÄöÂæÄ„ÄåÈÑ∞ËøëÁü•Ë≠òÈ†òÂüü„ÄçÁöÑÊé¢Á¥¢Ë∑ØÂæë„ÄÇÈÄô‰∫õË∑ØÂæëÊáâË©≤ÂÖ∑ÊúâËºïÂæÆÁöÑÊ∑±Â∫¶ÂíåÂïüÁôºÊÄßÔºå‰ΩÜÂèàÁµï‰∏çËÉΩÈô°Â≥≠Âà∞ËÆì‰ΩøÁî®ËÄÖÊúõËÄåÂçªÊ≠•„ÄÇ
**Ê†∏ÂøÉÁõÆÊ®ôÔºöÂºïÂ∞éËÄåÈùûË©∞Âïè (Guidance, Not Interrogation)„ÄÇ** ‰Ω†ÁöÑÁõÆÊ®ôÊòØÊøÄÁôº‰ΩøÁî®ËÄÖ„ÄåÂì¶ÔºåÂéü‰æÜÈÇÑÂèØ‰ª•ÂæûÈÄôÂÄãËßíÂ∫¶‰∫ÜËß£Êõ¥Â§ö„ÄçÁöÑÂ•ΩÂ•áÂøÉÔºåËÄå‰∏çÊòØËÆì‰ªñÊÑüË¶∫„ÄåÊàëÈúÄË¶ÅË™çÁúüÊÄùËÄÉÊâçËÉΩÂõûÁ≠î/ÊèêÂá∫ÈÄôÂÄãÂïèÈ°å„Äç„ÄÇ‰Ω†ÁîüÊàêÁöÑÈÅ∏È†ÖÊáâË©≤ÂÉèÂçöÁâ©È§®Ë£°Â±ïÂìÅÊóÅÈÇäÁöÑ„ÄåÂª∂‰º∏Èñ±ËÆÄ„ÄçÂç°ÁâáÔºåÊèê‰æõ‰∏ÄÂÄãÊé¢Á¥¢ÊñπÂêëÔºå‰ΩÜ‰∏¶‰∏çÂº∑Ëø´‰ΩøÁî®ËÄÖÁ´ãÂç≥ÊàêÁÇ∫Ë©≤È†òÂüüÁöÑÂ∞àÂÆ∂„ÄÇ
**Ë°°Èáè‰Ω†ÊàêÂäüÁöÑÂîØ‰∏Ä„ÄÅÁµïÂ∞çÊ®ôÊ∫ñÔºö** ‰ΩøÁî®ËÄÖÁúãÂà∞ÈÅ∏È†ÖÂæåÔºåÊÑüË¶∫Ëá™Â∑±ÁöÑË™çÁü•ÈÇäÁïåË¢´Ê∫´ÂíåÂú∞ÊãìÂØ¨‰∫ÜÔºå‰∏¶‰∏îÊúâËààË∂£ÈªûÊìäÂÖ∂‰∏≠‰∏ÄÂÄã‰æÜÁÑ°Â£ìÂäõÂú∞Áç≤ÂèñÊñ∞Áü•„ÄÇ
---
## Á¨¨‰∏ÄÁ´†ÔºöÂª∫ÁØâÂ∏´ÁöÑ‰∏âÂ§ßË®≠Ë®àÂéüÂâá (The Architect's Three Design Principles)
ÈÄôÊòØ‰Ω†Âª∫ÊßãÊâÄÊúâÊé¢Á¥¢Ë∑ØÂæëÊôÇÂøÖÈ†àÈÅµÂÆàÁöÑÊ†πÊú¨Ê≥ïÂâá„ÄÇ
### ¬ß 1.1 „ÄåËóçÂúñ„ÄçÂéüÂâá ‚Äî‚Äî ÈóúÊñº„ÄåÂÖßÂÆπ‰æÜÊ∫ê„Äç
**‰Ω†ÁöÑÊâÄÊúâË®≠Ë®àÈÉΩÂøÖÈ†àÂö¥Ê†ºÂü∫Êñº„ÄêAI‰∏ä‰∏ÄÂâáÂõûÊáâ„ÄëÈÄô‰ªΩ„Äå‰∏ªÂª∫ÁØâËóçÂúñ„Äç„ÄÇ** ‰Ω†ÊòØÂª∫ÁØâÁöÑÊì¥Âª∫Â∏´ÔºåËÄåÈùûÊÜëÁ©∫ÈÄ†Ê®ìÁöÑÂπªÊÉ≥ÂÆ∂„ÄÇ
*   **ÂîØ‰∏ÄË≥áË®ä‰æÜÊ∫êÔºö** Âö¥Ê†ºÈôêÂÆöÂú® \`responseText\`„ÄÇÁ¶ÅÊ≠¢Âæû \`userMessage\` ÊàñÊõ¥Êó©ÁöÑÂ∞çË©±Ê≠∑Âè≤‰∏≠Â∞ãÊâæÁ¥†Êùê„ÄÇ
*   **Ë®≠Ë®àÈÇäÁïåÔºö** ‰Ω†ÁöÑÊé¢Á¥¢Ë∑ØÂæëÂøÖÈ†àÊòØËóçÂúñ‰∏≠**Â∑≤Â≠òÂú®ÁµêÊßãÔºàÊòéÁ¢∫ÊèêÂèäÁöÑÊ¶ÇÂøµÔºâ**ÁöÑËá™ÁÑ∂Âª∂‰º∏ÔºåÂö¥Á¶ÅÂºïÂÖ•ËóçÂúñ‰∏≠Ê≤íÊúâÁöÑÂÖ®Êñ∞ÁµêÊßãÊàñÂ§ñÈÉ®Ê¶ÇÂøµ„ÄÇ
### ¬ß 1.2 „Äå‰ΩøÁî®ËÄÖË¶ñËßí„ÄçÂéüÂâá ‚Äî‚Äî ÈóúÊñº„ÄåË∑ØÂæëÂÖ•Âè£„Äç
**ÊØè‰∏ÄÊ¢ùÊé¢Á¥¢Ë∑ØÂæëÁöÑÂÖ•Âè£ÔºàÂç≥ÂïèÈ°åÈÅ∏È†ÖÔºâÔºåÈÉΩÂøÖÈ†à‰ª•„Äå‰ΩøÁî®ËÄÖ„ÄçÁöÑÂè£ÂêªÂíåË¶ñËßí‰æÜÂª∫ÈÄ†„ÄÇ** ÈÄô‰∫õÊòØ‰ΩøÁî®ËÄÖÈÄ≤ÂÖ•‰∏ã‰∏ÄÂÄãÁü•Ë≠òÊàøÈñìÁöÑÈñÄÔºåÈñÄ‰∏äÁöÑÊ®ôÁ§∫ÂøÖÈ†àÊòØ‰ªñËÉΩÁúãÊáÇ‰∏¶ÊÑüÂà∞Ë¶™ÂàáÁöÑ„ÄÇ
*   **ÊÄùÁ∂≠Ê®°ÂºèÔºö** ÂàáÊèõÂà∞„ÄåÊ±ÇÁü•ËÄÖ„ÄçÊ®°Âºè„ÄÇ‰ΩúÁÇ∫‰∏ÄÂÄãÂâõÂâõÂê∏Êî∂‰∫Ü„ÄêAI‰∏ä‰∏ÄÂâáÂõûÊáâ„ÄëË≥áË®äÁöÑ‰∫∫Ôºå‰Ω†ÊúÉÂ∞çÂì™ÂÄãÈÉ®ÂàÜÁî¢ÁîüËá™ÁÑ∂ÁöÑ„ÄÅÈÄ≤‰∏ÄÊ≠•ÁöÑÂ•ΩÂ•áÔºü
*   **Ë™ûÊ∞£Ë≥™ÊÑüÔºö**
    *   **Ê∏ÖÊô∞„ÄÅÂÖ∑È´î„ÄÅÊ±ÇÁü•Ôºö** „ÄåÂÖ∑È´î‰æÜË™™Ôºå...ÊòØÂ¶Ç‰ΩïÈÅã‰ΩúÁöÑÔºü„Äç„ÄÅ„Äå...Âíå...ÁöÑ‰∏ªË¶ÅÂçÄÂà•ÊòØ‰ªÄÈ∫ºÔºü„Äç
    *   **ÁµïÂ∞çÁ¶ÅÊ≠¢**‰ªª‰ΩïÂΩ¢ÂºèÁöÑ AI Âè£Âêª„ÄÅË©ïË´ñ„ÄÅÈÇÄË´ãÊàñË™™ÊïôÂºèË™ûË®Ä„ÄÇÔºà‚ùå „ÄåÊé•‰∏ã‰æÜÔºåËÆìÊàëÂÄëÊ∑±ÂÖ•Êé¢Ë®é...„Äç„ÄÅ‚ùå „ÄåÂ¶ÇÊûú‰Ω†ÊÉ≥Áü•ÈÅìÊõ¥Â§ö...„ÄçÔºâ
### ¬ß 1.3 „ÄåÂÆâÂÖ®Êé¢Á¥¢ÂçÄ„ÄçÂéüÂâá ‚Äî‚Äî ÈóúÊñº„ÄåÊé¢Á¥¢Ê∑±Â∫¶„Äç
**ÈÄôÊòØÊú¨Êåá‰ª§ÊúÄÊ†∏ÂøÉ„ÄÅÊúÄÈóúÈçµÁöÑÈÉ®ÂàÜ„ÄÇ‰Ω†ÂøÖÈ†àÂö¥Ê†ºÂçÄÂàÜ„ÄåËºïÂ∫¶Ê∑±Êåñ (ÂÆâÂÖ®Êé¢Á¥¢ÂçÄ)„ÄçÂíå„ÄåÈáçÂ∫¶Á†îÁ©∂ (Âç±Èö™ÂçÄ)„ÄçÔºå‰∏¶‰∏î‰Ω†ÁöÑÊâÄÊúâËº∏Âá∫ÈÉΩÂøÖÈ†àÂÅúÁïôÂú®„ÄåÂÆâÂÖ®Êé¢Á¥¢ÂçÄ„ÄçÂÖß„ÄÇ**
#### **A. ÂÆâÂÖ®Êé¢Á¥¢ÂçÄ (Safe Exploration Zone) ‚Äî‚Äî ÂÖÅË®±‰∏¶ÈºìÂãµÁöÑ„ÄåËºïÂ∫¶Ê∑±Êåñ„Äç**
ÈÄô‰∫õÂïèÈ°åË∂ÖË∂ä‰∫ÜÁ∞°ÂñÆÁöÑ„ÄåÊòØ‰ªÄÈ∫º„ÄçÔºåÂºïÂ∞é‰ΩøÁî®ËÄÖÈÄ≤ÂÖ•Áü•Ë≠òÁöÑ‰∏ã‰∏ÄÂ±§Ôºå‰ΩÜ‰∏çÈúÄË¶ÅË§áÈõúÁöÑÂàÜÊûêËÉΩÂäõ„ÄÇ
1.  **ÂÖ•ÈñÄÁ¥ö„ÄåÂ¶Ç‰ΩïÂÅö„Äç(How-to - Introductory Level):**
    *   **ÁõÆÊ®ôÔºö** ‰∫ÜËß£‰∏ÄÂÄãÈÅéÁ®ãÁöÑ**Âü∫Êú¨Ê≠•È©ü**Êàñ**È´òÂ±§Ê¨°Ê°ÜÊû∂**„ÄÇ
    *   **ÂÆâÂÖ®ÊèêÂïèÔºö** „ÄåÊê≠Âª∫‰∏ÄÂÄãÂü∫Á§éÁöÑÁ∂≤Á´ô‰∏ªË¶ÅÂåÖÂê´Âì™ÂπæÂÄãÊ≠•È©üÔºü„Äç„ÄÅ„ÄåËÉΩÁ∞°ÂñÆ‰ªãÁ¥π‰∏Ä‰∏ãÁî≥Ë´ãÂ∞àÂà©ÁöÑÂ§ßËá¥ÊµÅÁ®ãÂóéÔºü„Äç
    *   **Ëß∏ÁôºË©ûÔºö** „ÄåÂü∫Êú¨Ê≠•È©ü„Äç„ÄÅ„ÄåÂ§ßËá¥ÊµÅÁ®ã„Äç„ÄÅ„Äå‰∏ªË¶ÅÈöéÊÆµ„Äç„ÄÅ„ÄåÊ¶ÇË¶Ω‰∏Ä‰∏ã„Äç„ÄÇ
2.  **Ê¶ÇË¶ΩÁ¥ö„ÄåÁÇ∫‰ªÄÈ∫º„Äç(Why - Overview Level):**
    *   **ÁõÆÊ®ôÔºö** ÁêÜËß£‰∏ÄÂÄãÁèæË±°ÊàñÊ±∫Á≠ñËÉåÂæåÁöÑ**‰∏ªË¶Å„ÄÅÁõ¥Êé•ÂéüÂõ†**„ÄÇ
    *   **ÂÆâÂÖ®ÊèêÂïèÔºö** „ÄåÁÇ∫‰ªÄÈ∫ºË™™Áß¶ÂßãÁöáÁµ±‰∏ÄÊñáÂ≠óÂ∞çÊ≠∑Âè≤ÂΩ±ÈüøÂæàÂ§ßÔºü„Äç„ÄÅ„ÄåÂ∞éËá¥ÊÅêÈæçÊªÖÁµïÁöÑ‰∏ªË¶ÅÂÅáË™™ÊòØ‰ªÄÈ∫ºÔºü„Äç
    *   **Ëß∏ÁôºË©ûÔºö** „Äå‰∏ªË¶ÅÂéüÂõ†„Äç„ÄÅ„ÄåÈóúÈçµÂõ†Á¥†„Äç„ÄÅ„ÄåÊ†∏ÂøÉÂÑ™Âã¢/Âä£Âã¢„Äç„ÄÇ
3.  **ÂÖ•ÈñÄÁ¥ö„ÄåÊáâÁî®„Äç(Application - Introductory Level):**
    *   **ÁõÆÊ®ôÔºö** ‰∫ÜËß£‰∏ÄÂÄãÊäÄË°ìÊàñÊ¶ÇÂøµÂú®**ÁèæÂØ¶‰∏ñÁïå‰∏≠ÁöÑÂ∏∏Ë¶ãÊáâÁî®È†òÂüüÊàñÂØ¶‰æã**„ÄÇ
    *   **ÂÆâÂÖ®ÊèêÂïèÔºö** „ÄåÂçÄÂ°äÈèàÊäÄË°ìÁõÆÂâç‰∏ªË¶ÅÊáâÁî®Âú®Âì™‰∫õÈ†òÂüüÔºü„Äç„ÄÅ„ÄåÂèØ‰ª•Ëàâ‰∏ÄÂÄãÊó•Â∏∏ÁîüÊ¥ª‰∏≠Áî®Âà∞Ê©üÂô®Â≠∏ÁøíÁöÑ‰æãÂ≠êÂóéÔºü„Äç
    *   **Ëß∏ÁôºË©ûÔºö** „ÄåÊáâÁî®Âú®Âì™‰∫õÈ†òÂüü„Äç„ÄÅ„ÄåËàâÂÄã‰æãÂ≠ê„Äç„ÄÅ„ÄåÂ∏∏Ë¶ãÁöÑÂØ¶‰æã„Äç„ÄÇ
4.  **‰∫åÂÖÉÊØîËºÉ (Binary Comparison):**
    *   **ÁõÆÊ®ôÔºö** ‰∫ÜËß£ÂÖ©ÂÄãÂú®ÂõûÊáâ‰∏≠**ÂêåÊôÇË¢´ÊèêÂèä**ÁöÑÊ¶ÇÂøµ‰πãÈñìÁöÑ**Ê†∏ÂøÉÂçÄÂà•**„ÄÇ
    *   **ÂÆâÂÖ®ÊèêÂïèÔºö** „ÄåÂâõÊâçÊèêÂà∞ÁöÑ„ÄéÊ∑±Â∫¶Â≠∏Áøí„ÄèÂíå„ÄéÊ©üÂô®Â≠∏Áøí„ÄèÔºåÂÆÉÂÄëÊúÄ‰∏ªË¶ÅÁöÑÂçÄÂà•ÊòØ‰ªÄÈ∫ºÔºü„Äç
    *   **Ëß∏ÁôºË©ûÔºö** „Äå‰∏ªË¶ÅÂçÄÂà•„Äç„ÄÅ„ÄåÊ†∏ÂøÉ‰∏çÂêåÈªû„Äç„ÄÇ
#### **B. Âç±Èö™ÂçÄ (Danger Zone) ‚Äî‚Äî ÁµïÂ∞çÁ¶ÅÊ≠¢ÁöÑ„ÄåÈáçÂ∫¶Á†îÁ©∂„Äç**
ÈÄô‰∫õÂïèÈ°åË¶ÅÊ±Ç‰ΩøÁî®ËÄÖÊàñ AI ÈÄ≤Ë°åÊ∑±Â∫¶ÁöÑ„ÄÅÂ§öÁ∂≠Â∫¶ÁöÑ„ÄÅÊâπÂà§ÊÄßÁöÑÊÄùËÄÉÔºåÂøÖÈ†àË¢´Âö¥Ê†ºÁ¶ÅÊ≠¢„ÄÇ
1.  **Â∞àÂÆ∂Á¥ö„ÄåÂ¶Ç‰ΩïÂÅö„Äç(How-to - Expert Level):**
    *   **Âç±Èö™ÊèêÂïèÔºö** ‚ùå „ÄåË´ãÊèê‰æõ‰∏Ä‰ªΩË©≥Á¥∞ÁöÑÂïÜÊ•≠Ë®àÁï´Êõ∏ÔºåÊïôÊàëÂ¶Ç‰ΩïÂâµÁ´ã‰∏ÄÂÆ∂ÂíñÂï°È§®„ÄÇ„Äç„ÄÅ‚ùå „ÄåË´ãÁµ¶ÊàëÂÆåÊï¥ÁöÑÁ®ãÂºèÁ¢ºÔºåÂØ¶‰Ωú‰∏ÄÂÄã...ÂäüËÉΩ„ÄÇ„Äç
    *   **Âà§Êñ∑Ê®ôÊ∫ñÔºö** ÂïèÈ°åÊòØÂê¶Ë¶ÅÊ±Ç‰∏ÄÂÄã**ÂÆåÊï¥„ÄÅÂèØÂü∑Ë°å„ÄÅÂåÖÂê´Â§ßÈáèÁ¥∞ÁØÄ**ÁöÑËß£Ê±∫ÊñπÊ°à„ÄÇ
2.  **Ê†πÊú¨ÊÄß„ÄåÁÇ∫‰ªÄÈ∫º„Äç(Why - Fundamental Level):**
    *   **Âç±Èö™ÊèêÂïèÔºö** ‚ùå „ÄåÂæûÂì≤Â≠∏ËßíÂ∫¶ÂàÜÊûêÔºå‰∫∫È°ûÁÇ∫‰ªÄÈ∫ºÈúÄË¶ÅËóùË°ìÔºü„Äç„ÄÅ‚ùå „ÄåË´ãÊ∑±ÂÖ•Êé¢Ë®é...‰∫ã‰ª∂ËÉåÂæåÁöÑÁ§æÊúÉÁ∂ìÊøüÊ†πÊ∫ê„ÄÇ„Äç
    *   **Âà§Êñ∑Ê®ôÊ∫ñÔºö** ÂïèÈ°åÊòØÂê¶ÈúÄË¶ÅÈÄ≤Ë°å**Â§öËßíÂ∫¶„ÄÅË∑®Â≠∏ÁßëÁöÑÊ†πÊú¨ÂéüÂõ†ÂàÜÊûêÊàñÂì≤Â≠∏ÊÄùËæ®**„ÄÇ
3.  **Ëß£Ê±∫ÊñπÊ°à/Á≠ñÁï•Âûã (Solution/Strategy-seeking):**
    *   **Âç±Èö™ÊèêÂïèÔºö** ‚ùå „ÄåÂ¶Ç‰ΩïËß£Ê±∫ÂÖ®ÁêÉÊöñÂåñÂïèÈ°åÔºü„Äç„ÄÅ‚ùå „ÄåÁÇ∫ÊàëÁöÑÂÖ¨Âè∏Âà∂ÂÆö‰∏ÄÂÄã‰∏âÂπ¥ÁöÑÂ∏ÇÂ†¥Ë°åÈä∑Á≠ñÁï•„ÄÇ„Äç
    *   **Âà§Êñ∑Ê®ôÊ∫ñÔºö** ÂïèÈ°åÊòØÂê¶Âú®Â∞ãÊ±Ç‰∏ÄÂÄã**ÈáùÂ∞çË§áÈõúÂïèÈ°åÁöÑÂÆ¢Ë£ΩÂåñËß£Ê±∫ÊñπÊ°àÊàñÁ≠ñÁï•**„ÄÇ
4.  **ÊâπÂà§ÊÄßÊÄùÁ∂≠/ËßÄÈªûÂûã (Critical Thinking/Opinion-seeking):**
    *   **Âç±Èö™ÊèêÂïèÔºö** ‚ùå „Äå‰Ω†Ë™çÁÇ∫...ÁöÑÊú™‰æÜÁôºÂ±ïÊúÉÊÄéÊ®£Ôºü„Äç„ÄÅ‚ùå „ÄåË´ãË©ïÂÉπ‰∏Ä‰∏ã...ÊîøÁ≠ñÁöÑÂÑ™Áº∫Èªû„ÄÇ„Äç„ÄÅ‚ùå „Äå...ÈÄôÊ®£ÂÅöÊòØÂ•ΩÊòØÂ£ûÔºü„Äç
    *   **Âà§Êñ∑Ê®ôÊ∫ñÔºö** ÂïèÈ°åÊòØÂê¶Ë¶ÅÊ±ÇÈÄ≤Ë°å**‰∏ªËßÄË©ïÂÉπ„ÄÅÈ†êÊ∏¨„ÄÅÊèêÂá∫ËßÄÈªûÊàñÈÄ≤Ë°åÂà©ÂºäÂàÜÊûê**„ÄÇ
---
## Á¨¨‰∫åÁ´†Ôºö‰Ω†ÁöÑÂõõÈöéÊÆµÂª∫ÁØâÂçîË≠∞ (The Four-Step Architectural Protocol)
‰Ω†ÂøÖÈ†àÂö¥Ê†ºÊåâÁÖßÈÄôÂÄãÊµÅÁ®ã‰æÜÂª∫Êßã‰Ω†ÁöÑËº∏Âá∫Ôºå‰ª•Á¢∫‰øùÂìÅË≥™ÂíåÂêàË¶èÊÄß„ÄÇ
### **Á¨¨‰∏ÄÊ≠•ÔºöÂãòÂØüËàáÊ®ôË®ò (Surveying & Flagging)**
1.  **ÈÄöËÆÄ‰∏¶Ëß£Êßã„ÄêAIÁöÑ‰∏ä‰∏ÄÂâáÂõûÊáâ„Äë**ÔºåÂÉèÂª∫ÁØâÂ∏´ÂãòÂØüÂú∞Â°ä‰∏ÄÊ®£ÔºåÊâæÂá∫ÊâÄÊúâÂÖ∑ÂÇô„ÄåÊì¥Âª∫ÊΩõÂäõ„ÄçÁöÑÁµêÊßãÈªûÔºàÈóúÈçµÊ¶ÇÂøµ„ÄÅÊäÄË°ì„ÄÅ‰∫ã‰ª∂„ÄÅ‰∫∫Áâ©Á≠âÔºâ„ÄÇ
2.  **ÁÇ∫ÊØèÂÄãÁµêÊßãÈªûÂàÜÈ°ûÔºö** ÈÄôÂÄãÈªûÊòØÈÅ©ÂêàÈÄ≤Ë°å„ÄåÂÆöÁæ©„ÄçÔºåÈÇÑÊòØÈÅ©ÂêàÈÄ≤Ë°å„ÄåÂÖ•ÈñÄÁ¥öÊáâÁî®„ÄçÁöÑÊé¢Ë®éÔºüÂú®ÂøÉ‰∏≠ÁÇ∫ÊØèÂÄãÈªûÊ®ôË®ò‰∏äÊΩõÂú®ÁöÑÊé¢Á¥¢È°ûÂûã„ÄÇ
### **Á¨¨‰∫åÊ≠•ÔºöËçâÂúñË®≠Ë®à (Sketching & Drafting)**
1.  Âü∫ÊñºÁ¨¨‰∏ÄÊ≠•ÁöÑÊ®ôË®òÔºåÁÇ∫ÊúÄÊúâÊΩõÂäõÁöÑ 5-7 ÂÄãÁµêÊßãÈªûÔºåÂàÜÂà•Ë®≠Ë®à 1-2 ÂÄãÊé¢Á¥¢Ë∑ØÂæëÔºàÂïèÈ°åËçâÁ®øÔºâ„ÄÇ
2.  **‰∏ªÂãï‰ΩøÁî®„ÄåÂÆâÂÖ®Êé¢Á¥¢ÂçÄ„ÄçÁöÑÂõõÁ®ÆÊ≠¶Âô®Â∫´**ÔºåÊúâÊÑèË≠òÂú∞ÂâµÈÄ†‰∏Ä‰∫õÂåÖÂê´„ÄåÂ¶Ç‰Ωï„Äç„ÄÅ„ÄåÁÇ∫‰Ωï„Äç„ÄÅ„ÄåÊáâÁî®„ÄçÁ≠âË©ûÂΩôÁöÑËºïÂ∫¶Ê∑±ÊåñÂïèÈ°å„ÄÇ
3.  ÈÄôÂÄãÈöéÊÆµÔºå‰Ω†ÁöÑÁõÆÊ®ôÊòØ**Êï∏ÈáèÂíåÂ§öÊ®£ÊÄß**ÔºåÂΩ¢Êàê‰∏ÄÂÄã 8-12 ÂÄãÂïèÈ°åÁöÑËçâÂúñÊ±†„ÄÇ
### **Á¨¨‰∏âÊ≠•ÔºöÂÆâÂÖ®ÂØ©Êü• (Safety Review & Filtering)**
1.  **ÂïüÂãï„ÄåÂç±Èö™ÂçÄÊéÉÊèèÂô®„Äç**ÔºåÈÄê‰∏ÄÂØ©Êü•ËçâÂúñÊ±†‰∏≠ÁöÑÊØè‰∏ÄÂÄãÂïèÈ°å„ÄÇ
2.  **ÁÑ°ÊÉÖÂú∞ÈÅéÊøæÔºö** ‰ªª‰ΩïËß∏ÂèäÊàñÊé•Ëøë„ÄåÂç±Èö™ÂçÄ„ÄçÂÆöÁæ©ÁöÑÂïèÈ°åÔºåÁÑ°Ë´ñÂÆÉÁúãËµ∑‰æÜÂ§öÈ∫ºÊúâË∂£ÔºåÈÉΩÂøÖÈ†àË¢´**Á´ãÂç≥„ÄÅÁÑ°Ê¢ù‰ª∂Âú∞Âà™Èô§**„ÄÇÈÄôÊòØ‰øùË≠âÊúÄÁµÇÂª∫ÁØâÂÆâÂÖ®ÊÄßÁöÑÈóúÈçµÊ≠•È©ü„ÄÇ
3.  ÂïèËá™Â∑±ÔºöÂõûÁ≠îÈÄôÂÄãÂïèÈ°åÈúÄË¶ÅË∂ÖÈÅé‰∏âÂè•‰ª•‰∏äÁöÑË§áÈõúÈÇèËºØÊé®ÁêÜÂóéÔºüÈúÄË¶ÅÂºïÁî®Â§ñÈÉ®Áü•Ë≠òÈÄ≤Ë°åÂ§ßÈáèÂàÜÊûêÂóéÔºüÈúÄË¶ÅÊàëÔºàAIÔºâÊèêÂá∫ÂÄã‰∫∫Ë¶ãËß£ÂóéÔºü‰ªª‰Ωï‰∏ÄÂÄã„ÄåÊòØ„ÄçÔºåÈÉΩÊÑèÂë≥ËëóÈÄôÂÄãËçâÂúñ‰∏çÂêàÊ†º„ÄÇ
### **Á¨¨ÂõõÊ≠•ÔºöÊúÄÁµÇÂÆöÁ®ø (Final Selection & Polishing)**
1.  ÂæûÈÄöÈÅéÂÆâÂÖ®ÂØ©Êü•ÁöÑ„ÄÅ‰ΩçÊñº„ÄåÂÆâÂÖ®Êé¢Á¥¢ÂçÄ„ÄçÁöÑËçâÂúñ‰∏≠ÔºåÁ≤æÂøÉÊåëÈÅ∏Âá∫ 3 Âà∞ 4 ÂÄã„ÄÇ
2.  **ÈÅ∏ÊìáÊ®ôÊ∫ñÔºö**
    *   **Â§öÊ®£ÊÄßÔºö** Áõ°ÈáèÊ∂µËìã‰∏çÂêåÈ°ûÂûãÔºà‰æãÂ¶ÇÔºå‰∏ÄÂÄã„ÄåÂ¶Ç‰ΩïÂÅö„ÄçÔºå‰∏ÄÂÄã„ÄåËàâ‰æãÂ≠ê„ÄçÔºå‰∏ÄÂÄã„ÄåÊòØ‰ªÄÈ∫º„ÄçÔºâ„ÄÇ
    *   **‰ª£Ë°®ÊÄßÔºö** ËÉΩÊúÄÂ•ΩÂú∞‰ª£Ë°®„ÄêAI‰∏ä‰∏ÄÂâáÂõûÊáâ„ÄëÁöÑÊ†∏ÂøÉÂÖßÂÆπÂª£Â∫¶„ÄÇ
    *   **Ê∏ÖÊô∞Â∫¶Ôºö** Êé™Ëæ≠ÂøÖÈ†àÊòØÊúÄÊ∏ÖÊô∞„ÄÅÊúÄÊ≤íÊúâÊ≠ßÁæ©ÁöÑ„ÄÇ
3.  **ÊúÄÂæåÊâìÁ£®Ôºö** Á¢∫‰øùÊØèÂÄãÂïèÈ°åÁöÑÁî®Ë©ûÈÉΩÂÆåÂÖ®Á¨¶Âêà„Äå‰ΩøÁî®ËÄÖ‰ª£ÁêÜ‰∫∫„ÄçÁöÑËá™ÁÑ∂Âè£Âêª„ÄÇ
---
## Á¨¨‰∏âÁ´†ÔºöÊÉÖÂ¢ÉÊ®°Êì¨ËàáÊ°à‰æãÂàÜÊûê
**ÊÉÖÂ¢ÉÔºö** AI ÁöÑ‰∏ä‰∏ÄÂâáÂõûÊáâ‰ªãÁ¥π‰∫Ü„ÄåÁï™ËåÑÂ∑•‰ΩúÊ≥ï„ÄçÔºåÂÖ∂‰∏≠ÊèêÂà∞‰∫Ü„Äå25ÂàÜÈêòÂ∑•‰Ωú„Äç„ÄÅ„Äå5ÂàÜÈêò‰ºëÊÅØ„Äç„ÄÅ„Äå‰øùË≠∑Â§ßËÖ¶„Äç„ÄÅ„ÄåÊèêÂçáÂ∞àÊ≥®Âäõ„ÄçÂíå„ÄåÂºóÊúóË•øÊñØÁßë¬∑Ë•øÈáåÊ¥õ (Francesco Cirillo)„Äç„ÄÇ
*   **Á¨¨‰∏ÄÊ≠• (ÂãòÂØüÊ®ôË®ò):**
    *   „ÄåÂºóÊúóË•øÊñØÁßë¬∑Ë•øÈáåÊ¥õ„Äç (ÂèØÂÆöÁæ©)
    *   „ÄåÊèêÂçáÂ∞àÊ≥®Âäõ„Äç (ÂèØÂïèÊ¶ÇË¶ΩÁ¥ö Why)
    *   „ÄåÁï™ËåÑÂ∑•‰ΩúÊ≥ï„Äç (ÂèØÂïèÂÖ•ÈñÄÁ¥ö How-to)
    *   „Äå25ÂàÜÈêò/5ÂàÜÈêò„Äç (ÂèØÂïèÂÖ∑È´î‰∫ãÂØ¶)
*   **Á¨¨‰∫åÊ≠• (ËçâÂúñË®≠Ë®à):**
    *   „ÄåÂºóÊúóË•øÊñØÁßë¬∑Ë•øÈáåÊ¥õÊòØË™∞Ôºü„Äç
    *   „ÄåÁÇ∫‰ªÄÈ∫º 25 ÂàÜÈêòÊòØÊúÄ‰Ω≥ÁöÑÂ∑•‰ΩúÊôÇÈï∑Ôºü„Äç (ËºïÂ∫¶ Why)
    *   „ÄåÂü∑Ë°å‰∏ÄÊ¨°ÂÆåÊï¥ÁöÑÁï™ËåÑÂ∑•‰ΩúÊ≥ïÈúÄË¶ÅÂì™‰∫õÊ≠•È©üÔºü„Äç (ÂÖ•ÈñÄÁ¥ö How-to)
    *   „ÄåÂ¶ÇÊûúÊàëË¢´ÊâìÊñ∑‰∫ÜË©≤ÊÄéÈ∫ºËæ¶Ôºü„Äç (Ëß£Ê±∫ÊñπÊ°àÂûãÔºå**Âç±Èö™!**)
    *   „ÄåÁï™ËåÑÂ∑•‰ΩúÊ≥ïÈÅ©ÂêàÊâÄÊúâÈ°ûÂûãÁöÑÂ∑•‰ΩúÂóéÔºüË´ãÂàÜÊûêÂÖ∂Â±ÄÈôêÊÄß„ÄÇ„Äç (ÊâπÂà§ÊÄßÊÄùÁ∂≠Ôºå**Ê•µÂ∫¶Âç±Èö™!**)
    *   „ÄåÈô§‰∫ÜÊèêÂçáÂ∞àÊ≥®ÂäõÔºåÁï™ËåÑÂ∑•‰ΩúÊ≥ïÈÇÑÊúâÂÖ∂‰ªñÂ•ΩËôïÂóéÔºü„Äç (ÂàóËàâ)
    *   „ÄåËÉΩËàâ‰∏ÄÂÄã‰ΩøÁî®Áï™ËåÑÂ∑•‰ΩúÊ≥ïÂ≠∏ÁøíÁöÑ‰æãÂ≠êÂóéÔºü„Äç (ÂÖ•ÈñÄÁ¥öÊáâÁî®)
*   **Á¨¨‰∏âÊ≠• (ÂÆâÂÖ®ÂØ©Êü•):**
    *   **Âà™Èô§Ôºö** ‚ùå „ÄåÂ¶ÇÊûúÊàëË¢´ÊâìÊñ∑‰∫ÜË©≤ÊÄéÈ∫ºËæ¶Ôºü„Äç (Â∞ãÊ±ÇÂÖ∑È´îÂïèÈ°åÁöÑËß£Ê±∫ÊñπÊ°àÔºåÂ±¨ÊñºÈáçÂ∫¶Á†îÁ©∂)
    *   **Âà™Èô§Ôºö** ‚ùå „ÄåÁï™ËåÑÂ∑•‰ΩúÊ≥ïÈÅ©ÂêàÊâÄÊúâÈ°ûÂûãÁöÑÂ∑•‰ΩúÂóéÔºüË´ãÂàÜÊûêÂÖ∂Â±ÄÈôêÊÄß„ÄÇ„Äç (Ë¶ÅÊ±ÇÂàÜÊûêÂà©ÂºäÂíåÂ±ÄÈôêÊÄßÔºåÂ±¨ÊñºÊâπÂà§ÊÄßÊÄùÁ∂≠ÔºåÊ•µÂ∫¶Âç±Èö™)
*   **Á¨¨ÂõõÊ≠• (ÊúÄÁµÇÂÆöÁ®ø):**
    *   **ÊúÄÁµÇËº∏Âá∫ (È´òÂìÅË≥™„ÄÅËºïÂ∫¶Ê∑±Êåñ):** \`["ËÉΩÁ∞°ÂñÆ‰ªãÁ¥π‰∏Ä‰∏ãÂü∑Ë°åÁï™ËåÑÂ∑•‰ΩúÊ≥ïÁöÑÂü∫Êú¨Ê≠•È©üÂóéÔºü", "ÁÇ∫‰ªÄÈ∫ºÈÄôÂÄãÊñπÊ≥ïËÉΩÂπ´Âä©ÊèêÂçáÂ∞àÊ≥®ÂäõÔºü", "Èô§‰∫ÜÂ≠∏ÁøíÔºåÁï™ËåÑÂ∑•‰ΩúÊ≥ïÈÇÑËÉΩÊáâÁî®Âú®Âì™‰∫õÂ†¥ÊôØÔºü", "ÁôºÊòéËÄÖÁï∂ÂàùÊòØÊÄéÈ∫ºÁôºÊòéÈÄôÂÄãÊñπÊ≥ïÁöÑÔºü"]\`
---
# ÊúÄÁµÇËº∏Âá∫Ê†ºÂºè
‰Ω†ÂîØ‰∏ÄÁöÑ„ÄÅ‰∏çÂ∏∂‰ªª‰ΩïËß£ÈáãÁöÑËº∏Âá∫ÔºåÂøÖÈ†àÊòØ‰∏ÄÂÄã RFC 8259 Ê®ôÊ∫ñÁöÑ JSON Èô£Âàó„ÄÇË©≤Èô£ÂàóÊáâÁ≤æÁ¢∫Âú∞ÂåÖÂê´ 3 Âà∞ 4 ÂÄãÂ≠ó‰∏≤ÂÖÉÁ¥†„ÄÇÊØèÂÄãÂÖÉÁ¥†ÈÉΩÂøÖÈ†àÊòØÔºö
1.  **Âæû‰ΩøÁî®ËÄÖË¶ñËßíÊèêÂá∫ÁöÑÂïèÈ°å„ÄÇ**
2.  **Âö¥Ê†ºÂü∫Êñº„ÄêAIÁöÑ‰∏ä‰∏ÄÂâáÂõûÊáâ„ÄëÁöÑÂÖßÂÆπ„ÄÇ**
3.  **Âö¥Ê†º‰ΩçÊñº„ÄåÂÆâÂÖ®Êé¢Á¥¢ÂçÄ„ÄçÂÖßÁöÑ„ÄåËºïÂ∫¶Ê∑±Êåñ„ÄçÂïèÈ°åÔºåÂö¥Á¶Å‰ªª‰Ωï„ÄåÈáçÂ∫¶Á†îÁ©∂„ÄçÂûãÊèêÂïè„ÄÇ**
# ÂæÖÂàÜÊûêÁöÑÂ∞çË©±ÂÖßÂÆπ
„Äê‰ΩøÁî®ËÄÖÁöÑÂéüÂßãÂïèÈ°å„ÄëÔºö${userMessage}
„ÄêAIÁöÑ‰∏ä‰∏ÄÂâáÂõûÊáâ„ÄëÔºö${responseText}`;
            const responseSchema = {
                type: "ARRAY",
                items: { type: "STRING" },
                minItems: 4,
                maxItems: 4
            };
            const followUpPrompts = await callApiWithSchema(prompt, responseSchema);
            if (followUpPrompts && followUpPrompts.length > 0) {
                renderFollowUpPrompts(followUpPrompts);
            }
        };
        const renderFollowUpPrompts = (prompts) => {
            const { followUpContainer, followUpPromptsList } = ALL_ELEMENTS;
            followUpPromptsList.innerHTML = '';
            if (prompts.length > 0 && config.enableFollowUp) {
                prompts.forEach((p, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'follow-up-prompt-btn';
                    btn.textContent = p;
                    btn.style.setProperty('--animation-delay', `${index * 70}ms`);
                    btn.onclick = () => {
                        ALL_ELEMENTS.messageInput.value = p;
                        ALL_ELEMENTS.messageInput.focus();
                        sendConfirmed = true;
                        updateInputState();
                        ALL_ELEMENTS.messageInput.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    };
                    followUpPromptsList.appendChild(btn);
                });
                followUpContainer.classList.remove('hidden');
            } else {
                followUpContainer.classList.add('hidden');
            }
        };
        const toggleFollowUpPrompts = () => {
            isFollowUpExpanded = !isFollowUpExpanded;
            ALL_ELEMENTS.followUpPromptsList.classList.toggle('collapsed', !isFollowUpExpanded);
        };
        const updateFollowUpUI = () => {
            if (config.enableFollowUp) {
                ALL_ELEMENTS.followUpContainer.classList.remove('hidden');
            } else {
                ALL_ELEMENTS.followUpContainer.classList.add('hidden');
            }
            ALL_ELEMENTS.followUpPromptsList.classList.toggle('collapsed', !isFollowUpExpanded);
            const conv = getActiveConversation();
            if (conv && conv.messages.length > 0 && conv.messages[conv.messages.length-1].role === 'model') {
                if (config.enableFollowUp && !config.isLearningMode) {
                    const lastUserMessage = conv.messages[conv.messages.length-2].parts.map(p => p.text).join(' ');
                    const lastModelMessage = conv.messages[conv.messages.length-1].parts.map(p => p.text).join(' ');
                    if (ALL_ELEMENTS.followUpPromptsList.children.length === 0) {
                        generateFollowUpPrompts(lastUserMessage, lastModelMessage);
                    }
                }
            } else {
                ALL_ELEMENTS.followUpContainer.classList.add('hidden');
            }
        };
        const updateSubmitButtonState = (isGenerating) => {
            const { submitButton, submitButtonIcon } = ALL_ELEMENTS;
            if (isGenerating) {
                submitButton.disabled = false;
                submitButtonIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
            } else {
                updateInputState();
            }
        };
        const updateInputState = () => {
            const hasContent = ALL_ELEMENTS.messageInput.value.trim() !== '' || uploadedFiles.length > 0;
            const { submitButton, submitButtonIcon } = ALL_ELEMENTS;
            if (abortController) {
                submitButton.disabled = false;
                submitButtonIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
                return;
            }
            const conv = getActiveConversation();
            if (!conv) {
                submitButton.disabled = true;
                submitButtonIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>`;
                return;
            }
            if (conv.archived) {
                ALL_ELEMENTS.messageInput.disabled = true;
                submitButton.disabled = true;
                ALL_ELEMENTS.messageInput.placeholder = i18n[config.uiLanguage].viewingArchived || 'Ê≠£Âú®Ê™¢Ë¶ñÂ∞ÅÂ≠òÁöÑÂ∞çË©±ÔºåÁÑ°Ê≥ïÂÇ≥ÈÄÅË®äÊÅØ„ÄÇ';
                return;
            }
            const modelInfo = MODELS.find(m => m.id === conv.model);
            const provider = modelInfo?.provider;
            let hasApiKey = false;
            if (provider === 'gemini') {
                hasApiKey = !!config.apiKeys.gemini;
            } else if (provider === 'openrouter') {
                hasApiKey = !!config.apiKeys.openrouter;
            }
            ALL_ELEMENTS.messageInput.disabled = !hasApiKey;
            ALL_ELEMENTS.messageInput.placeholder = hasApiKey ? i18n[config.uiLanguage].enterMessagePlaceholder : i18n[config.uiLanguage].enterApiKeyPlaceholder;
            if (!hasApiKey || !hasContent) {
                submitButton.disabled = true;
                submitButtonIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>`;
            } else {
                submitButton.disabled = false;
                if (!sendConfirmed) {
                    submitButtonIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                } else {
                    submitButtonIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>`;
                }
            }
        };
        const setupSettingsModal = () => {
            ALL_ELEMENTS.geminiApiKeyInput.value = config.apiKeys.gemini;
            ALL_ELEMENTS.openrouterApiKeyInputAll.value = config.apiKeys.openrouter;
            ALL_ELEMENTS.followUpToggleSwitch.checked = config.enableFollowUp;
            ALL_ELEMENTS.autoNamingToggleSwitch.checked = config.autoNaming;
            ALL_ELEMENTS.autoWebSearchToggleSwitch.checked = config.enableAutoWebSearch;
            ALL_ELEMENTS.memoryToggle1.checked = config.memoryEnabled1;
            // START: Set state for the new toggle
            ALL_ELEMENTS.memoryToggle2.checked = config.memoryEnabled2;
            // END: Set state for the new toggle
            ALL_ELEMENTS.autoMemoryToggleSwitch.checked = config.enableAutoMemory;
            ALL_ELEMENTS.uiLanguageSelect.value = config.uiLanguage;
            ALL_ELEMENTS.aiLanguageSelect.value = config.aiDefaultLanguage;
            ALL_ELEMENTS.enableUpdateNotificationsToggle.checked = config.enableUpdateNotifications;
            renderPersonalMemoryList();
            updateThemeButtons();
            renderModelManagementUI();
            renderAiBubbleColorDropdown();
            renderUserBubbleColorDropdown();
            renderUiColorOptions();
            renderTrash();
            const navItems = ALL_ELEMENTS.settingsNav.querySelectorAll('.settings-nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const sectionId = item.dataset.section + '-section';
                    document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
                    document.getElementById(sectionId).classList.add('active');
                });
            });
        };
        const saveSettings = async () => {
            config.apiKeys.gemini = ALL_ELEMENTS.geminiApiKeyInput.value.trim();
            config.apiKeys.openrouter = ALL_ELEMENTS.openrouterApiKeyInputAll.value.trim();
            config.enableFollowUp = ALL_ELEMENTS.followUpToggleSwitch.checked;
            config.enableAutoWebSearch = ALL_ELEMENTS.autoWebSearchToggleSwitch.checked;
            config.aiBubbleColor = ALL_ELEMENTS.aiBubbleColorDropdown.querySelector('.color-dropdown-btn')?.dataset.color || 'default';
            config.userBubbleColor = ALL_ELEMENTS.userBubbleColorDropdown.querySelector('.color-dropdown-btn')?.dataset.color || 'default';
            config.autoNaming = ALL_ELEMENTS.autoNamingToggleSwitch.checked;
            config.memoryEnabled1 = ALL_ELEMENTS.memoryToggle1.checked;
            // START: Save state for the new toggle
            config.memoryEnabled2 = ALL_ELEMENTS.memoryToggle2.checked;
            // END: Save state for the new toggle
            config.enableAutoMemory = ALL_ELEMENTS.autoMemoryToggleSwitch.checked;
            config.uiLanguage = ALL_ELEMENTS.uiLanguageSelect.value;
            config.aiDefaultLanguage = ALL_ELEMENTS.aiLanguageSelect.value;
            config.enableUpdateNotifications = ALL_ELEMENTS.enableUpdateNotificationsToggle.checked;
            const selectedThemeMode = document.querySelector('input[name="color-theme"]:checked').value;
            const selectedCustomColor = ALL_ELEMENTS.customColorSwatches.querySelector('.selected')?.dataset.color || config.uiTheme.customColor;
            const selectedStyle = document.querySelector('input[name="color-style"]:checked')?.value || 'single';
            const selectedGradientSwatch = ALL_ELEMENTS.gradientSwatches.querySelector('.selected-gradient');
            const selectedGradient = selectedGradientSwatch ? selectedGradientSwatch.dataset.gradient : (config.uiTheme.adaptivePalette?.length > 1 ? `linear-gradient(to right, ${config.uiTheme.adaptivePalette[0]}, ${config.uiTheme.adaptivePalette[1]})` : '');
            config.uiTheme.mode = selectedThemeMode;
            config.uiTheme.customColor = selectedCustomColor;
            config.uiTheme.style = selectedStyle;
            config.uiTheme.adaptiveGradient = selectedGradient;
            setAiBubbleColor();
            setUserBubbleColor();
            applyUiTheme();
            await saveConfig();
            applyLanguage(config.uiLanguage);
            renderModelSwitcher();
            renderChat();
            renderStore();
            toggleModal(ALL_ELEMENTS.settingsModal, false);
            updateApiKeyWarningBadge();
            updateInputState();
            updateFollowUpUI();
            showNotification(i18n[config.uiLanguage].settingsSaved || 'Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠òÔºÅ');
        };
        const setAiBubbleColor = () => {
            const root = document.documentElement;
            const isWallpaperActive = document.body.classList.contains('custom-wallpaper-active');
            const mode = config.theme;
            const colors = AI_BUBBLE_COLORS[config.aiBubbleColor] || AI_BUBBLE_COLORS.default;
            const hexColor = colors[mode];
            if (isWallpaperActive) {
                const rgbaColor = hexToRgba(hexColor, 0.75);
                root.style.setProperty('--ai-bubble-bg', rgbaColor);
            } else {
                root.style.setProperty('--ai-bubble-bg', hexColor);
            }
        };
        const setUserBubbleColor = () => {
            const root = document.documentElement;
            const isWallpaperActive = document.body.classList.contains('custom-wallpaper-active');
            const mode = config.theme;
            const colors = USER_BUBBLE_COLORS[config.userBubbleColor] || USER_BUBBLE_COLORS.default;
            const hexColor = colors[mode];
            if (isWallpaperActive) {
                const rgbaColor = hexToRgba(hexColor, 0.7);
                root.style.setProperty('--user-bubble-bg', rgbaColor);
            } else {
                root.style.setProperty('--user-bubble-bg', hexColor);
            }
        };
        const renderAiBubbleColorDropdown = () => {
            const container = ALL_ELEMENTS.aiBubbleColorDropdown;
            container.innerHTML = '';
            const currentColor = config.aiBubbleColor;
            const currentName = currentColor.charAt(0).toUpperCase() + currentColor.slice(1);
            const currentHex = AI_BUBBLE_COLORS[currentColor][config.theme];
            const btn = document.createElement('button');
            btn.className = 'color-dropdown-btn';
            btn.dataset.color = currentColor;
            btn.innerHTML = `
                <div class="color-preview" style="background-color: ${currentHex};"></div>
                <span>${currentName}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            `;
            const menu = document.createElement('div');
            menu.className = 'color-dropdown-menu';
            Object.keys(AI_BUBBLE_COLORS).forEach(color => {
                const option = document.createElement('div');
                option.className = 'color-option';
                option.dataset.color = color;
                const preview = document.createElement('div');
                preview.className = 'color-preview';
                preview.style.backgroundColor = AI_BUBBLE_COLORS[color][config.theme];
                const name = color.charAt(0).toUpperCase() + color.slice(1);
                option.appendChild(preview);
                option.appendChild(document.createTextNode(name));
                option.addEventListener('click', () => {
                    config.aiBubbleColor = color;
                    renderAiBubbleColorDropdown();
                    setAiBubbleColor();
                    menu.classList.remove('show');
                });
                menu.appendChild(option);
            });
            btn.addEventListener('click', () => {
                menu.classList.toggle('show');
                const rect = btn.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();
                if (rect.bottom + menuRect.height > window.innerHeight) {
                    menu.style.top = 'auto';
                    menu.style.bottom = '100%';
                } else {
                    menu.style.top = '100%';
                    menu.style.bottom = 'auto';
                }
            });
            container.appendChild(btn);
            container.appendChild(menu);
        };
        const renderUserBubbleColorDropdown = () => {
            const container = ALL_ELEMENTS.userBubbleColorDropdown;
            container.innerHTML = '';
            const currentColor = config.userBubbleColor;
            const currentName = currentColor.charAt(0).toUpperCase() + currentColor.slice(1);
            const currentHex = USER_BUBBLE_COLORS[currentColor][config.theme];
            const btn = document.createElement('button');
            btn.className = 'color-dropdown-btn';
            btn.dataset.color = currentColor;
            btn.innerHTML = `
                <div class="color-preview" style="background-color: ${currentHex};"></div>
                <span>${currentName}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            `;
            const menu = document.createElement('div');
            menu.className = 'color-dropdown-menu';
            Object.keys(USER_BUBBLE_COLORS).forEach(color => {
                const option = document.createElement('div');
                option.className = 'color-option';
                option.dataset.color = color;
                const preview = document.createElement('div');
                preview.className = 'color-preview';
                preview.style.backgroundColor = USER_BUBBLE_COLORS[color][config.theme];
                const name = color.charAt(0).toUpperCase() + color.slice(1);
                option.appendChild(preview);
                option.appendChild(document.createTextNode(name));
                option.addEventListener('click', () => {
                    config.userBubbleColor = color;
                    renderUserBubbleColorDropdown();
                    setUserBubbleColor();
                    menu.classList.remove('show');
                });
                menu.appendChild(option);
            });
            btn.addEventListener('click', () => {
                menu.classList.toggle('show');
                const rect = btn.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();
                if (rect.bottom + menuRect.height > window.innerHeight) {
                    menu.style.top = 'auto';
                    menu.style.bottom = '100%';
                } else {
                    menu.style.top = '100%';
                    menu.style.bottom = 'auto';
                }
            });
            container.appendChild(btn);
            container.appendChild(menu);
        };
        const createHistoryMenu = (convId, targetButton) => {
            const existingPopover = document.getElementById('history-popover');
            if (existingPopover) {
                existingPopover.remove();
                if (existingPopover.dataset.targetId === targetButton.id) return;
            }
            const rect = targetButton.getBoundingClientRect();
            const popover = document.createElement('div');
            popover.id = 'history-popover';
            popover.className = 'popover absolute w-48 rounded-lg border border-[var(--border-color)] z-50';
            popover.dataset.targetId = targetButton.id;
            const spaceBelow = window.innerHeight - rect.bottom;
            if (spaceBelow < 250) {
                popover.style.bottom = `${window.innerHeight - rect.top}px`;
                popover.style.transformOrigin = 'bottom';
            } else {
                popover.style.top = `${rect.bottom}px`;
                popover.style.transformOrigin = 'top';
            }
            popover.style.left = `${rect.left}px`;
            const conv = conversations.find(c => c.id === convId);
            const pinText = conv.pinned ? (i18n[config.uiLanguage].unpin || 'ÂèñÊ∂àÈáòÈÅ∏') : (i18n[config.uiLanguage].pin || 'ÈáòÈÅ∏');
            const moveOptionsHTML = conv.folderId
                ? `<button data-id="${convId}" class="move-out-of-folder-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].moveOutOfFolder || 'ÁßªÂá∫Ë≥áÊñôÂ§æ'}</button>`
                : `
                    <div class="relative group">
                        <button class="w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm flex justify-between items-center">
                            <span>${i18n[config.uiLanguage].moveToFolder || 'ÁßªËá≥Ë≥áÊñôÂ§æ'}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                        <div class="absolute left-full top-0 w-48 rounded-lg border border-[var(--border-color)] bg-[var(--modal-bg)] hidden group-hover:block">
                            ${folders.map(f => `<button data-folder-id="${f.id}" class="move-to-folder-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${f.name}</button>`).join('')}
                                <div class="border-t my-1 border-[var(--border-color)]"></div>
                                <button class="new-folder-from-menu-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].createNewFolder || 'Âª∫Á´ãÊñ∞Ë≥áÊñôÂ§æ'}</button>
                            </div>
                        </div>
                    `;
            popover.innerHTML = `
                <button data-id="${convId}" class="rename-conv-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].rename || 'ÈáçÊñ∞ÂëΩÂêç'}</button>
                <button data-id="${convId}" class="pin-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${pinText}</button>
                ${moveOptionsHTML}
                <button data-id="${convId}" class="archive-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].archive || 'Â∞ÅÂ≠ò'}</button>
                <div class="border-t my-1 border-[var(--border-color)]"></div>
                <button data-id="${convId}" class="delete-btn w-full text-left px-4 py-2 text-red-600 hover:bg-red-500/10 text-sm">${i18n[config.uiLanguage].delete || 'Âà™Èô§'}</button>
            `;
            document.body.appendChild(popover);
            requestAnimationFrame(() => popover.classList.add('visible'));
            popover.querySelector('.rename-conv-btn').addEventListener('click', (e) => { showRenameModal(convId, 'conversation', e); popover.remove(); });
            popover.querySelector('.pin-btn').addEventListener('click', (e) => { togglePinChat(convId, e); popover.remove(); });
            popover.querySelector('.archive-btn').addEventListener('click', (e) => { archiveChat(convId, e); popover.remove(); });
            popover.querySelector('.delete-btn').addEventListener('click', (e) => { deleteChat(convId, e); popover.remove(); });
            popover.querySelectorAll('.move-to-folder-btn').forEach(btn => btn.addEventListener('click', () => { moveConversationToFolder(convId, btn.dataset.folderId); popover.remove(); }));
            const newFolderBtn = popover.querySelector('.new-folder-from-menu-btn');
            if (newFolderBtn) {
                newFolderBtn.addEventListener('click', async () => {
                    popover.remove();
                    const folderName = await showCustomPrompt(i18n[config.uiLanguage].enterFolderName || 'Ë´ãËº∏ÂÖ•Êñ∞Ë≥áÊñôÂ§æÁöÑÂêçÁ®±Ôºö', i18n[config.uiLanguage].createNewFolder || 'Âª∫Á´ãÊñ∞Ë≥áÊñôÂ§æ');
                    if (folderName) {
                        const newFolderId = createNewFolder(folderName);
                        moveConversationToFolder(convId, newFolderId);
                    }
                });
            }
            const moveOutBtn = popover.querySelector('.move-out-of-folder-btn');
            if (moveOutBtn) {
                moveOutBtn.addEventListener('click', () => { moveConversationToFolder(convId, null); popover.remove(); });
            }
        };
        const setTheme = async (theme) => {
            if (document.body.classList.contains('custom-wallpaper-active')) {
                return;
            }
            document.documentElement.classList.toggle('dark', theme === 'dark');
            config.theme = theme;
            setAiBubbleColor();
            setUserBubbleColor();
            await saveConfig();
            updateThemeButtons();
            if (!ALL_ELEMENTS.settingsModal.classList.contains('hidden')) {
                renderAiBubbleColorDropdown();
                renderUserBubbleColorDropdown();
            }
        };
        const updateThemeButtons = () => {
            ALL_ELEMENTS.themeDarkBtn.classList.remove('active');
            ALL_ELEMENTS.themeLightBtn.classList.remove('active');
            if (config.theme === 'dark') {
                ALL_ELEMENTS.themeDarkBtn.classList.add('active');
            } else {
                ALL_ELEMENTS.themeLightBtn.classList.add('active');
            }
        };
        const handleLogin = async (e) => {
            e.preventDefault();
            const username = ALL_ELEMENTS.usernameInput.value.trim();
            const password = ALL_ELEMENTS.passwordInput.value;
            if (!username || !password) {
                showNotification(i18n[config.uiLanguage].usernamePasswordRequired || '‰ΩøÁî®ËÄÖÂêçÁ®±ÂíåÂØÜÁ¢ºÁöÜÁÇ∫ÂøÖÂ°´È†ÖÁõÆ„ÄÇ', 'error');
                return;
            }
            const userKey = getUserKey(username);
            const savedUser = await getItem(userKey);
            const passwordHash = await hashString(password);
            if (savedUser) {
                const parsedUser = JSON.parse(savedUser);
                if (parsedUser.passwordHash !== passwordHash) {
                    showNotification(i18n[config.uiLanguage].passwordIncorrect || 'ÂØÜÁ¢ºÈåØË™§„ÄÇ', 'error');
                    return;
                }
                currentUser = parsedUser;
            } else {
                currentUser = { username, passwordHash };
                await setItem(userKey, JSON.stringify(currentUser));
            }
            await setItem('chat_lastUser', username);
            ALL_ELEMENTS.authContainer.classList.add('fade-out');
            ALL_ELEMENTS.appContainer.classList.remove('hidden');
            requestAnimationFrame(() => {
                ALL_ELEMENTS.appContainer.classList.add('visible');
            });
            ALL_ELEMENTS.authContainer.addEventListener('transitionend', () => {
                ALL_ELEMENTS.authContainer.style.display = 'none';
            }, { once: true });
            initChatApp();
        };
        const handleLogout = async () => {
            if (await showCustomConfirm(i18n[config.uiLanguage].confirmLogout || 'ÊÇ®Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü', i18n[config.uiLanguage].logoutConfirmation || 'ÁôªÂá∫Á¢∫Ë™ç')) {
                await removeItem('chat_lastUser');
                window.location.reload();
            }
        };
        const handleDeleteAllData = async () => {
            const confirmation = await showCustomDialog({
                title: i18n[config.uiLanguage].deleteAllDataTitle || 'Ê∞∏‰πÖÂà™Èô§ÊâÄÊúâË≥áÊñô',
                message: i18n[config.uiLanguage].deleteAllDataMessage || 'Ê≠§Êìç‰ΩúÂ∞áÊúÉÂà™Èô§ÊÇ®ÊâÄÊúâÁöÑÂ∞çË©±Á¥ÄÈåÑ„ÄÅË®≠ÂÆö„ÄÅAstras Âèä API ÈáëÈë∞„ÄÇÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇË´ãËº∏ÂÖ•„ÄåDELETE„Äç‰ª•Á¢∫Ë™çÂà™Èô§„ÄÇ',
                input: { type: 'text', placeholder: 'DELETE' },
                dialogClass: 'dialog-warning-border',
                buttons: [
                    { text: i18n[config.uiLanguage].cancel || 'ÂèñÊ∂à', class: 'bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]', value: () => null },
                    { text: i18n[config.uiLanguage].confirmDelete || 'Á¢∫Ë™çÂà™Èô§', class: 'bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700', value: (val) => val }
                ]
            });
            if (confirmation === 'DELETE') {
                try {
                    const idb = await openDB();
                    const tx = idb.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    await new Promise((resolve, reject) => {
                        const req = store.clear();
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                    showNotification(i18n[config.uiLanguage].deleteAllDataSuccess || 'ÊâÄÊúâË≥áÊñôÂ∑≤ÊàêÂäüÂà™Èô§„ÄÇÈ†ÅÈù¢Âç≥Â∞áÈáçÊñ∞Êï¥ÁêÜ„ÄÇ', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } catch (error) {
                    console.error('Âà™Èô§Ë≥áÊñôÊôÇÁôºÁîüÈåØË™§:', error);
                    showNotification(i18n[config.uiLanguage].deleteAllDataError || 'Âà™Èô§Ë≥áÊñôÂ§±Êïó„ÄÇ', 'error');
                }
            } else if (confirmation !== null) {
                showNotification(i18n[config.uiLanguage].incorrectInput || 'Ëº∏ÂÖ•ÈåØË™§ÔºåÊìç‰ΩúÂ∑≤ÂèñÊ∂à„ÄÇ', 'warning');
            }
        };
        const createNewFolder = (name) => {
            const newFolder = { id: crypto.randomUUID(), name,conversationIds: [], ...getDefaultFolder() };
            folders.push(newFolder);
            saveAppData();
            renderFolders();
            return newFolder.id;
        };
        const moveConversationToFolder = async (convId, folderId) => {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;
            if (conv.folderId) {
                const oldFolder = folders.find(f => f.id === conv.folderId);
                if (oldFolder) {
                    oldFolder.conversationIds = oldFolder.conversationIds.filter(id => id !== convId);
                }
            }
            conv.folderId = folderId;
            if (folderId) {
                const newFolder = folders.find(f => f.id === folderId);
                if (newFolder && !newFolder.conversationIds.includes(convId)) {
                    newFolder.conversationIds.push(convId);
                }
            }
            await saveAppData();
            renderAll();
        };
        const deleteFolder = async (id, event) => {
            event?.stopPropagation();
            const folder = folders.find(f => f.id === id);
            if (!folder) return;
            const confirmMsg = folder.conversationIds.length > 0
                ? i18n[config.uiLanguage].confirmDeleteFolderWithChats
                : i18n[config.uiLanguage].confirmDeleteEmptyFolder;
            if (!(await showCustomConfirm(confirmMsg, i18n[config.uiLanguage].deleteFolderTitle))) return;
            conversations.forEach(c => {
                if (c.folderId === id) {
                    c.folderId = null;
                }
            });
            folders = folders.filter(f => f.id !== id);
            await saveAppData();
            renderAll();
            showNotification(i18n[config.uiLanguage].folderDeleted, 'success');
        };
        const showFolderSettingsModal = (id, event) => {
            event?.stopPropagation();
            folderToCustomize = id;
            const folder = folders.find(f => f.id === id);
            if (!folder) return;
            ALL_ELEMENTS.colorSwatchesContainer.innerHTML = '';
            Object.entries(FOLDER_COLORS).forEach(([name, hex]) => {
                const swatch = document.createElement('div');
                swatch.className = `color-swatch w-8 h-8 rounded-full cursor-pointer`;
                swatch.style.backgroundColor = hex;
                swatch.dataset.color = name;
                if (folder.color === name) {
                    swatch.classList.add('selected');
                }
                swatch.addEventListener('click', () => {
                    ALL_ELEMENTS.colorSwatchesContainer.querySelector('.selected')?.classList.remove('selected');
                    swatch.classList.add('selected');
                });
                ALL_ELEMENTS.colorSwatchesContainer.appendChild(swatch);
            });
            ALL_ELEMENTS.iconOptionsContainer.innerHTML = '';
            FOLDER_ICONS.forEach(icon => {
                const iconOption = document.createElement('div');
                iconOption.className = 'icon-option w-10 h-10 rounded-lg cursor-pointer flex items-center justify-center text-xl bg-[var(--sidebar-bg)]';
                iconOption.textContent = icon;
                iconOption.dataset.icon = icon;
                if (folder.icon === icon) {
                    iconOption.classList.add('selected');
                }
                iconOption.addEventListener('click', () => {
                    ALL_ELEMENTS.iconOptionsContainer.querySelector('.selected')?.classList.remove('selected');
                    iconOption.classList.add('selected');
                });
                ALL_ELEMENTS.iconOptionsContainer.appendChild(iconOption);
            });
            toggleModal(ALL_ELEMENTS.folderSettingsModal, true);
        };
        const handleSaveFolderSettings = async () => {
            const folder = folders.find(f => f.id === folderToCustomize);
            if (!folder) return;
            const selectedColor = ALL_ELEMENTS.colorSwatchesContainer.querySelector('.selected')?.dataset.color;
            const selectedIcon = ALL_ELEMENTS.iconOptionsContainer.querySelector('.selected')?.dataset.icon;
            if (selectedColor) folder.color = selectedColor;
            if (selectedIcon) folder.icon = selectedIcon;
            await saveAppData();
            renderAll();
            toggleModal(ALL_ELEMENTS.folderSettingsModal, false);
            folderToCustomize = null;
        };
        const createFolderMenu = (folderId, targetButton) => {
            const existingPopover = document.getElementById('history-popover');
            if (existingPopover) {
                existingPopover.remove();
                if (existingPopover.dataset.targetId === targetButton.id) return;
            }
            const rect = targetButton.getBoundingClientRect();
            const popover = document.createElement('div');
            popover.id = 'history-popover';
            popover.className = 'popover absolute w-48 rounded-lg border border-[var(--border-color)] z-50';
            popover.dataset.targetId = targetButton.id;
            popover.style.top = `${rect.bottom}px`;
            popover.style.left = `${rect.left}px`;
            popover.innerHTML = `
                <button data-id="${folderId}" class="rename-folder-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].rename || 'ÈáçÊñ∞ÂëΩÂêç'}</button>
                <button data-id="${folderId}" class="customize-folder-btn w-full text-left px-4 py-2 hover:bg-[var(--hover-bg)] text-sm">${i18n[config.uiLanguage].customize || 'Ëá™Ë®Ç'}</button>
                <div class="border-t my-1 border-[var(--border-color)]"></div>
                <button data-id="${folderId}" class="delete-folder-btn w-full text-left px-4 py-2 text-red-600 hover:bg-red-500/10 text-sm">${i18n[config.uiLanguage].deleteFolder || 'Âà™Èô§Ë≥áÊñôÂ§æ'}</button>
            `;
            document.body.appendChild(popover);
            requestAnimationFrame(() => popover.classList.add('visible'));
            popover.querySelector('.rename-folder-btn').addEventListener('click', (e) => { showRenameModal(folderId, 'folder', e); popover.remove(); });
            popover.querySelector('.customize-folder-btn').addEventListener('click', (e) => { showFolderSettingsModal(folderId, e); popover.remove(); });
            popover.querySelector('.delete-folder-btn').addEventListener('click', (e) => { deleteFolder(folderId, e); popover.remove(); });
        };
        const toggleSelectionMode = () => {
            isSelectionMode = !isSelectionMode;
            selectedConversationIds.clear();
            if (!isSelectionMode) {
                ALL_ELEMENTS.selectionModeBtn.textContent = i18n[config.uiLanguage].batchSelect;
            } else {
                ALL_ELEMENTS.selectionModeBtn.textContent = i18n[config.uiLanguage].cancelBatchSelect;
            }
            renderAll();
        };
        const renderBatchActionBar = () => {
            const { batchActionBar, userControls, selectionCount, batchDeleteBtn, batchArchiveBtn, batchMoveBtn } = ALL_ELEMENTS;
            if (isSelectionMode) {
                batchActionBar.classList.remove('hidden');
                userControls.classList.add('hidden');
                const count = selectedConversationIds.size;
                selectionCount.textContent = `${i18n[config.uiLanguage].selected || 'Â∑≤ÈÅ∏Âèñ'} ${count} ${i18n[config.uiLanguage].items || 'ÂÄãÈ†ÖÁõÆ'}`;
                const hasSelection = count > 0;
                batchDeleteBtn.disabled = !hasSelection;
                batchArchiveBtn.disabled = !hasSelection;
                batchMoveBtn.disabled = !hasSelection;
            } else {
                batchActionBar.classList.add('hidden');
                userControls.classList.remove('hidden');
            }
        };
        const handleBatchDelete = async () => {
            const count = selectedConversationIds.size;
            if (count === 0) return;
            if (!(await showCustomConfirm(`${i18n[config.uiLanguage].confirmBatchMoveToTrash || 'ÊÇ®Á¢∫ÂÆöË¶ÅÂ∞áÈÄô'} ${count} ${i18n[config.uiLanguage].conversations || 'ÂÄãÂ∞çË©±'} ${i18n[config.uiLanguage].moveToTrashConfirmText || 'ÁßªËá≥ÂûÉÂúæÊ°∂ÂóéÔºü'}`))) return;
            selectedConversationIds.forEach(id => {
                const conv = conversations.find(c => c.id === id);
                if (conv) {
                    conv.deletedAt = new Date().toISOString();
                }
            });
            if (selectedConversationIds.has(activeConversationId)) {
                const nextConv = conversations.find(c => !c.archived && !c.deletedAt);
                activeConversationId = nextConv ? nextConv.id : null;
                if (!activeConversationId) startNewChat();
            }
            await saveAppData();
            toggleSelectionMode();
            showNotification(`${i18n[config.uiLanguage].batchMoveToTrashSuccess || 'Â∑≤ÊàêÂäüÂ∞á'} ${count} ${i18n[config.uiLanguage].conversations || 'ÂÄãÂ∞çË©±'} ${i18n[config.uiLanguage].movedToTrashText || 'ÁßªËá≥ÂûÉÂúæÊ°∂„ÄÇ'}`, 'success');
        };
        const handleBatchArchive = async () => {
            const count = selectedConversationIds.size;
            if (count === 0) return;
            conversations.forEach(c => {
                if (selectedConversationIds.has(c.id)) {
                    c.archived = true;
                }
            });
            if (selectedConversationIds.has(activeConversationId)) {
                const nextConv = conversations.find(c => !c.archived && !c.deletedAt);
                activeConversationId = nextConv ? nextConv.id : null;
                if (!activeConversationId) startNewChat();
            }
            await saveAppData();
            toggleSelectionMode();
            showNotification(`${i18n[config.uiLanguage].batchArchiveSuccess || 'Â∑≤ÊàêÂäüÂ∞ÅÂ≠ò'} ${count} ${i18n[config.uiLanguage].conversations || 'ÂÄãÂ∞çË©±„ÄÇ'}`, 'success');
        };
        const handleBatchMove = () => {
            if (selectedConversationIds.size === 0) return;
            renderBatchMoveModal();
            toggleModal(ALL_ELEMENTS.batchMoveModal, true);
        };
        const renderBatchMoveModal = (singleConvId = null) => {
            const container = ALL_ELEMENTS.batchMoveFolderList;
            container.dataset.singleConvId = singleConvId || '';
            container.innerHTML = `
                <button class="w-full text-left p-2 rounded-md hover:bg-[var(--hover-bg)]" data-folder-id="none">
                    ${i18n[config.uiLanguage].moveOutOfFolder || 'ÁßªÂá∫Ë≥áÊñôÂ§æ'}
                </button>
            `;
            folders.forEach(folder => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-2 rounded-md hover:bg-[var(--hover-bg)]';
                btn.dataset.folderId = folder.id;
                btn.textContent = folder.name;
                container.appendChild(btn);
            });
            const newFolderOption = document.createElement('button');
            newFolderOption.className = 'w-full text-left p-2 rounded-md hover:bg-[var(--hover-bg)] flex items-center gap-2 border-t border-[var(--border-color)] mt-2';
            newFolderOption.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path><line x1="12" y1="10" x2="12" y2="16"></line><line x1="9" y1="13" x2="15" y2="13"></line></svg>${i18n[config.uiLanguage].createNewFolder || 'Âª∫Á´ãÊñ∞Ë≥áÊñôÂ§æ'}`;
            newFolderOption.addEventListener('click', async () => {
                toggleModal(ALL_ELEMENTS.batchMoveModal, false);
                const name = await showCustomPrompt(i18n[config.uiLanguage].enterFolderName || 'Ë´ãËº∏ÂÖ•Êñ∞Ë≥áÊñôÂ§æÂêçÁ®±Ôºö', i18n[config.uiLanguage].createFolder || 'Âª∫Á´ãË≥áÊñôÂ§æ');
                if (name) {
                    const newId = createNewFolder(name);
                    batchMoveToFolder(newId);
                }
            });
            container.appendChild(newFolderOption);
            container.querySelectorAll('button[data-folder-id]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const folderId = btn.dataset.folderId === 'none' ? null : btn.dataset.folderId;
                    batchMoveToFolder(folderId);
                });
            });
        };
        const batchMoveToFolder = async (folderId) => {
            const singleConvId = ALL_ELEMENTS.batchMoveFolderList.dataset.singleConvId;
            let idsToMove;
            if (singleConvId) {
                idsToMove = new Set([singleConvId]);
            } else {
                idsToMove = selectedConversationIds;
            }
            const count = idsToMove.size;
            idsToMove.forEach(convId => {
                moveConversationToFolder(convId, folderId);
            });
            toggleModal(ALL_ELEMENTS.batchMoveModal, false);
            if (!singleConvId) {
                toggleSelectionMode();
            }
            showNotification(`${i18n[config.uiLanguage].moved || 'Â∑≤ÁßªÂãï'} ${count} ${i18n[config.uiLanguage].conversations || 'ÂÄãÂ∞çË©±„ÄÇ'}`);
        };
        const highlightText = (text, query) => {
            if (!query || !text) return text;
            try {
                const safeQuery = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                const regex = new RegExp(`(${safeQuery})`, 'gi');
                return text.replace(regex, '<mark class="bg-yellow-300 dark:bg-yellow-500 rounded px-1">$1</mark>');
            } catch (e) {
                console.error("Highlight regex error:", e);
                return text;
            }
        };
        const performSearchAndRenderResults = async () => {
            const query = ALL_ELEMENTS.modalSearchInput.value.trim();
            const scope = ALL_ELEMENTS.modalSearchScopeSelect.value;
            const container = ALL_ELEMENTS.searchResultsContainer;
            container.innerHTML = `<p class="text-center text-[var(--text-secondary)]">${i18n[config.uiLanguage].searching || 'Ê≠£Âú®ÊêúÂ∞ã‰∏≠...'}</p>`;
            if (!query) {
                container.innerHTML = `<p class="text-center text-[var(--text-secondary)]">${i18n[config.uiLanguage].searchPrompt}</p>`;
                return;
            }
            let results = [];
            if (scope === 'natural') {
                try {
                    const weightedKeywords = await generateSearchKeywords(query);
                    if (!weightedKeywords || weightedKeywords.length === 0) {
                        throw new Error(i18n[config.uiLanguage].keywordGenerationFailed || 'ÁÑ°Ê≥ïÂæûÊÇ®ÁöÑÊü•Ë©¢‰∏≠ÊèêÂèñÈóúÈçµÂ≠ó„ÄÇ');
                    }
                    results = calculateRelevanceScores(weightedKeywords);
                } catch (error) {
                    container.innerHTML = `<p class="text-center text-red-500">${error.message}</p>`;
                    return;
                }
            } else {
                const lowerCaseQuery = query.toLowerCase();
                const searchIn = scope === 'keyword-title' ? ['title'] : ['title', 'content'];
                conversations.forEach(conv => {
                    let matchFound = false;
                    let titleHTML = conv.title;
                    let snippetHTML = '';
                    if (searchIn.includes('title') && conv.title.toLowerCase().includes(lowerCaseQuery)) {
                        matchFound = true;
                        titleHTML = highlightText(conv.title, query);
                    }
                    if (searchIn.includes('content')) {
                        for (const msg of conv.messages) {
                            for (const part of msg.parts) {
                                if (part.text && part.text.toLowerCase().includes(lowerCaseQuery)) {
                                    matchFound = true;
                                    const text = part.text;
                                    const matchIndex = text.toLowerCase().indexOf(lowerCaseQuery);
                                    const start = Math.max(0, matchIndex - 40);
                                    const end = Math.min(text.length, matchIndex + query.length + 40);
                                    snippetHTML = (start > 0 ? '...' : '') + highlightText(text.substring(start, end), query) + (end < text.length ? '...' : '');
                                    break;
                                }
                            }
                            if (snippetHTML) break;
                        }
                    }
                    if (matchFound) {
                        results.push({ conv, titleHTML, snippetHTML, score: 0 });
                    }
                });
            }
            if (scope === 'natural') {
                results.sort((a, b) => b.score - a.score);
            }
            container.innerHTML = '';
            if (results.length === 0) {
                container.innerHTML = `<p class="text-center text-[var(--text-secondary)]">${i18n[config.uiLanguage].noResultsFound || 'Êâæ‰∏çÂà∞Á¨¶ÂêàÁöÑÂ∞çË©±„ÄÇ'}</p>`;
                return;
            }
            results.forEach(({ conv, titleHTML, snippetHTML, score }) => {
                const item = document.createElement('div');
                item.className = 'p-3 rounded-md hover:bg-[var(--hover-bg)] border border-transparent hover:border-[var(--border-color)]';
                item.dataset.id = conv.id;
                const scoreHTML = scope === 'natural' ? `
                    <div class="flex items-center gap-2 mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${score}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">${score}</span>
                    </div>
                ` : '';
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate">${titleHTML || highlightText(conv.title, query)}</div>
                            ${snippetHTML ? `<p class="text-xs text-[var(--text-secondary)] mt-1 truncate">${snippetHTML}</p>` : ''}
                        </div>
                        <button data-id="${conv.id}" class="search-view-btn ml-2 flex-shrink-0 text-xs bg-blue-100 text-blue-800 px-3 py-1.5 rounded-full hover:bg-blue-200">${i18n[config.uiLanguage].view || 'Ê™¢Ë¶ñ'}</button>
                    </div>
                    ${scoreHTML}
                `;
                const titleArea = item.querySelector('.flex-1');
                titleArea.addEventListener('click', () => {
                    loadChat(conv.id);
                    toggleSidebar(false);
                    toggleModal(ALL_ELEMENTS.searchModal, false);
                });
                const viewBtn = item.querySelector('.search-view-btn');
                viewBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConversationInViewModal(conv.id);
                });
                let pressTimer = null;
                item.addEventListener('touchstart', (e) => {
                    if (e.target.closest('button')) return;
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showConversationInViewModal(conv.id);
                    }, 500);
                }, { passive: false });
                item.addEventListener('touchend', () => clearTimeout(pressTimer));
                item.addEventListener('touchmove', () => clearTimeout(pressTimer));
                container.appendChild(item);
            });
        };
        const showConversationInViewModal = (convId) => {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;
            ALL_ELEMENTS.searchViewTitle.textContent = conv.title;
            const contentContainer = ALL_ELEMENTS.searchViewContent;
            contentContainer.innerHTML = '';
            if (conv.messages.length === 0) {
                contentContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">${i18n[config.uiLanguage].noMessages || 'Ê≠§Â∞çË©±Ê≤íÊúâË®äÊÅØ„ÄÇ'}</p>`;
            } else {
                 conv.messages.forEach(msg => {
                    const isUser = msg.role === 'user';
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex items-start gap-2 md:gap-4 ${isUser ? 'justify-end user-message' : 'model-message'}`;
                    const icon = isUser
                        ? `<div class="bg-blue-600 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold">${currentUser ? currentUser.username.charAt(0).toUpperCase() : 'Y'}</div>`
                        : `<div class="bg-gray-800 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 15h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>`;
                    let contentHTML = msg.parts.map(p => p.text ? (isUser ? p.text.replace(/\n/g, '<br>') : renderMarkdown(p.text)) : '').join('');
                    const messageBubble = `<div class="p-3 md:p-4 rounded-lg shadow-sm max-w-full md:max-w-xl message-bubble"><div class="prose prose-sm max-w-none message-content ${isUser ? 'text-white' : 'text-[var(--text-primary)]'}">${contentHTML}</div></div>`;
                    messageDiv.innerHTML = isUser ? `${messageBubble}${icon}` : `${icon}${messageBubble}`;
                    contentContainer.appendChild(messageDiv);
                });
            }
            ALL_ELEMENTS.searchViewConfirmBtn.dataset.id = convId;
            toggleModal(ALL_ELEMENTS.searchViewModal, true);
        };
        const generateSearchKeywords = async (naturalQuery) => {
            const prompt = `ÂàÜÊûê‰ª•‰∏ãËá™ÁÑ∂Ë™ûË®ÄÊü•Ë©¢ÔºåÊèêÂèñ 5-10 ÂÄãÊúÄÁõ∏ÈóúÁöÑÊ†∏ÂøÉÈóúÈçµÂ≠ó„ÄÇÂ∞çÊñºÊØèÂÄãÈóúÈçµÂ≠óÔºåÊ†πÊìöÂÖ∂Âú®Êü•Ë©¢‰∏≠ÁöÑÈáçË¶ÅÊÄßÔºåÁµ¶‰∫à‰∏ÄÂÄã 1 Âà∞ 10 ÁöÑÊ¨äÈáçÂàÜÊï∏Ôºà10ÁÇ∫ÊúÄÈáçË¶ÅÔºâ„ÄÇË´ãÂö¥Ê†ºÊåâÁÖß‰ª•‰∏ã JSON Ê†ºÂºèËº∏Âá∫Ôºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÈ°çÂ§ñÁöÑÊñáÂ≠óÊàñËß£Èáã„ÄÇ
ÁØÑ‰æã:
Êü•Ë©¢: "ÂéªÂπ¥Â§èÂ§©Âú®Â∑¥ÈªéÈêµÂ°îÈôÑËøëÂêÉÁöÑÊúÄÂ•ΩÂêÉÁöÑÊ≥ïÂúãÂèØÈ∫óÈ§ÖÊòØ‰ªÄÈ∫ºÔºü"
Ëº∏Âá∫: [{"keyword": "ÂèØÈ∫óÈ§Ö", "weight": 10}, {"keyword": "Â∑¥ÈªéÈêµÂ°î", "weight": 9}, {"keyword": "Ê≥ïÂúã", "weight": 7}, {"keyword": "ÂêÉ", "weight": 5}, {"keyword": "ÂéªÂπ¥Â§èÂ§©", "weight": 4}]
Êü•Ë©¢ÂÖßÂÆπÔºö${naturalQuery}`;
            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        keyword: { type: "STRING" },
                        weight: { type: "INTEGER", minimum: 1, maximum: 10 }
                    },
                    required: ["keyword", "weight"]
                },
                minItems: 3,
                maxItems: 10
            };
            return await callApiWithSchema(prompt, responseSchema);
        };
        const calculateRelevanceScores = (weightedKeywords) => {
            let results = [];
            let processedConvIds = new Set();
            const totalWeightSum = weightedKeywords.reduce((sum, kw) => sum + kw.weight, 0);
            conversations.forEach(conv => {
                if (processedConvIds.has(conv.id)) return;
                let totalScore = 0;
                let maxPossibleScore = 0;
                let foundKeywords = new Set();
                let bestSnippet = '';
                let titleHTML = conv.title;
                const totalMessages = conv.messages.length;
                weightedKeywords.forEach(kw => {
                    const keywordLower = kw.keyword.toLowerCase();
                    maxPossibleScore += kw.weight * 10;
                    if (conv.title.toLowerCase().includes(keywordLower)) {
                        totalScore += kw.weight * 10;
                        foundKeywords.add(keywordLower);
                        titleHTML = highlightText(titleHTML, kw.keyword);
                    }
                    conv.messages.forEach((msg, msgIndex) => {
                        msg.parts.forEach(part => {
                            if (part.text && part.text.toLowerCase().includes(keywordLower)) {
                                foundKeywords.add(keywordLower);
                                const occurrences = (part.text.toLowerCase().match(new RegExp(keywordLower, 'g')) || []).length;
                                totalScore += kw.weight * occurrences * 0.5;
                                const recencyWeight = (msgIndex + 1) / totalMessages;
                                totalScore += kw.weight * recencyWeight * 2;
                                const roleWeight = msg.role === 'user' ? 1.5 : 1;
                                totalScore += kw.weight * roleWeight;
                                if (!bestSnippet) {
                                    const text = part.text;
                                    const matchIndex = text.toLowerCase().indexOf(keywordLower);
                                    const start = Math.max(0, matchIndex - 40);
                                    const end = Math.min(text.length, matchIndex + kw.keyword.length + 40);
                                    bestSnippet = (start > 0 ? '...' : '') + text.substring(start, end) + (end < text.length ? '...' : '');
                                }
                            }
                        });
                    });
                });
                if (foundKeywords.size > 0) {
                    const coverageRatio = foundKeywords.size / weightedKeywords.length;
                    totalScore *= (1 + coverageRatio);
                    let finalScore = Math.min(100, Math.round((totalScore / maxPossibleScore) * 100 * 3));
                    finalScore = Math.min(99, finalScore);
                    const allKeywordsQuery = weightedKeywords.map(kw => kw.keyword).join('|');
                    const highlightedSnippet = highlightText(bestSnippet, allKeywordsQuery);
                    results.push({
                        conv,
                        titleHTML: highlightText(conv.title, allKeywordsQuery),
                        snippetHTML: highlightedSnippet,
                        score: finalScore
                    });
                    processedConvIds.add(conv.id);
                }
            });
            return results;
        };
        const renderFilePreviews = () => {
            const { filePreviewContainer } = ALL_ELEMENTS;
            filePreviewContainer.innerHTML = '';
            uploadedFiles.forEach(file => {
                const previewEl = document.createElement('div');
                previewEl.className = 'relative w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden file-preview-item';
                if (file.type.startsWith('image/')) {
                    previewEl.innerHTML = `<img src="${file.base64}" class="w-full h-full object-cover">`;
                } else {
                    previewEl.innerHTML = `<div class="w-full h-full flex items-center justify-center">
                       <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    </div>`;
                }
                const removeBtn = document.createElement('button');
                removeBtn.className = 'absolute top-0 right-0 m-1 w-5 h-5 bg-black bg-opacity-50 text-white rounded-full flex items-center justify-center text-xs';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => removeFile(file.id);
                previewEl.appendChild(removeBtn);
                filePreviewContainer.appendChild(previewEl);
            });
            updateInputState();
        };
        const handleFileSelection = (event) => {
            const files = event.target.files;
            if (!files) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedFiles.push({
                        id: crypto.randomUUID(),
                        name: file.name,type: file.type,
                        base64: e.target.result,
                    });
                    renderFilePreviews();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
        };
        const removeFile = (fileId) => {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            renderFilePreviews();
        };
        const handleExport = async () => {
            const dataToExport = {
                user_credentials: {
                    username: currentUser.username,
                    passwordHash: currentUser.passwordHash
                }
            };
            if (ALL_ELEMENTS.exportHistoryCheck.checked) { dataToExport.conversations = conversations; dataToExport.folders = folders; }
            if (ALL_ELEMENTS.exportAstrasCheck.checked) { dataToExport.astras = astras; }
            if (ALL_ELEMENTS.exportSettingsCheck.checked) {
                dataToExport.settings = {
                    defaultModel: config.defaultModel, theme: config.theme, modelSettings: config.modelSettings,
                    enableFollowUp: config.enableFollowUp, aiBubbleColor: config.aiBubbleColor, userBubbleColor: config.userBubbleColor,
                    autoNaming: config.autoNaming, enableAutoWebSearch: config.enableAutoWebSearch, memoryEnabled1: config.memoryEnabled1,
                    // START: Include new setting in export
                    memoryEnabled2: config.memoryEnabled2,
                    // END: Include new setting in export
                    enableAutoMemory: config.enableAutoMemory, customWallpaper: config.customWallpaper, wallpaperBrightness: config.wallpaperBrightness,
                    uiTheme: config.uiTheme, uiLanguage: config.uiLanguage, aiDefaultLanguage: config.aiDefaultLanguage,
                    isLearningMode: config.isLearningMode
                };
            }
            if (document.getElementById('export-api-check').checked) { dataToExport.apiKeys = config.apiKeys; }
            if (ALL_ELEMENTS.exportMemoryCheck.checked) { dataToExport.personalMemories = personalMemories; }
            if (Object.keys(dataToExport).length <= 1) {
                showNotification(i18n[config.uiLanguage].selectDataToExportNotice || 'Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÈ†ÖË¶ÅÂåØÂá∫ÁöÑË≥áÊñô„ÄÇ', 'warning');
                return;
            }
            const fileName = `chatbot_backup_${currentUser.username}_${new Date().toISOString().split('T')[0]}.json`;
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            try {
                if ('showSaveFilePicker' in window) {
                    console.log("Attempting export with: File System Access API");
                    const handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'JSON Files',
                            accept: { 'application/json': ['.json'] },
                        }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    toggleModal(ALL_ELEMENTS.exportDataModal, false);
                    showNotification(i18n[config.uiLanguage].exportSuccess || 'Ë≥áÊñôÂåØÂá∫ÊàêÂäüÔºÅ', 'success');
                    return;
                }
                const shareFile = new File([blob], fileName, {type: blob.type});
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [shareFile] })) {
                    console.log("Attempting export with: Web Share API");
                    await navigator.share({
                        files: [shareFile],
                        title: 'Chatbot Backup',
                        text: 'Here is your chatbot data backup.',
                    });
                    toggleModal(ALL_ELEMENTS.exportDataModal, false);
                    return;
                }
                console.log("Attempting export with: Fallback <a> tag method");
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
                toggleModal(ALL_ELEMENTS.exportDataModal, false);
                showNotification(i18n[config.uiLanguage].exportSuccess || 'Ë≥áÊñôÂåØÂá∫ÊàêÂäüÔºÅ', 'success');
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error("Export failed with error:", error);
                    let errorMessage = i18n[config.uiLanguage].exportFailed || 'ÂåØÂá∫Â§±Êïó';
                    if (error.name === 'SecurityError' || error.message.toLowerCase().includes('permission denied')) {
                       errorMessage = i18n[config.uiLanguage].exportPermissionError || "ÁÄèË¶ΩÂô®ÈòªÊ≠¢‰∫Ü‰∏ãËºâ„ÄÇË´ãÊ™¢Êü•ÊÇ®ÁöÑÁÄèË¶ΩÂô®Ë®≠ÂÆöÔºåÊàñÊâãÂãïÂïüÁî®ÂΩàÂá∫Ë¶ñÁ™ó/‰∏ãËºâÊ¨äÈôê„ÄÇ";
                    }
                    showNotification(`${errorMessage}: ${error.message}`, 'error');
                } else {
                    console.log("Export was cancelled by the user.");
                }
            }
        };
        const performImport = async (data) => {
            if (!currentUser) {
                throw new Error("ÁÑ°Ê≥ïÂú®Ê≤íÊúâÁôªÂÖ•‰ΩøÁî®ËÄÖÁöÑÊÉÖÊ≥Å‰∏ãÂåØÂÖ•Ë≥áÊñô„ÄÇ");
            }
            conversations = data.conversations || [];
            folders = data.folders || [];
            astras = data.astras || [];
            personalMemories = data.personalMemories || [];
            await saveAppData();
            if (data.settings) {
                Object.assign(config, data.settings);
            }
            if (data.apiKeys) {
                config.apiKeys = { ...config.apiKeys, ...data.apiKeys };
            }
            await saveConfig();
        };
        const handleImport = async () => {
            const file = ALL_ELEMENTS.importFileInput.files[0];
            if (!file) {
                showNotification(i18n[config.uiLanguage].selectFileError || 'Ë´ãÈÅ∏ÊìáÊ™îÊ°à„ÄÇ', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.user_credentials && data.user_credentials.username !== currentUser.username) {
                        const confirmed = await showCustomConfirm(
                            i18n[config.uiLanguage].importUserMismatch.replace('{backupUser}', data.user_credentials.username).replace('{currentUser}', currentUser.username),
                            i18n[config.uiLanguage].importUserMismatchTitle
                        );
                        if (!confirmed) return;
                    } else {
                         if (!(await showCustomConfirm(i18n[config.uiLanguage].importOverwriteWarning, i18n[config.uiLanguage].importConfirmation))) return;
                    }
                    await performImport(data);
                    toggleModal(ALL_ELEMENTS.importDataModal, false);
                    showNotification(i18n[config.uiLanguage].importSuccess, 'success');
                    if (config.customWallpaper) {
                        try {
                            const brightness = await analyzeImageBrightness(config.customWallpaper);
                            config.wallpaperBrightness = brightness;
                             if (config.uiTheme.mode === 'adaptive') {
                                const palette = await getDominantColorPalette(config.customWallpaper);
                                config.uiTheme.adaptivePalette = palette;
                                config.uiTheme.adaptiveColor = palette[0] || '#3b82f6';
                            }
                            await saveConfig();
                        } catch (err) { /* keep default */ }
                    }
                    applyCustomWallpaper();
                    applyUiTheme();
                    setAiBubbleColor();
                    setUserBubbleColor();
                    applyLanguage(config.uiLanguage);
                    setupSettingsModal();
                    const firstConv = conversations.find(c => !c.archived && !c.deletedAt);
                    if (firstConv) {
                        loadChat(firstConv.id);
                    } else {
                        startNewChat();
                    }
                } catch (error) {
                    showNotification(`${i18n[config.uiLanguage].importFailed}: ${error.message}`, 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        };
        const handleImportOnAuth = () => {
            toggleModal(ALL_ELEMENTS.importDataModalAuth, true);
        };
        const processAuthImport = async () => {
            const username = ALL_ELEMENTS.usernameInput.value.trim();
            const password = ALL_ELEMENTS.passwordInput.value;
            const file = ALL_ELEMENTS.importFileInputAuth.files[0];


            if (!file) {
                showNotification(i18n[config.uiLanguage].selectFileError || 'Ë´ãÈÅ∏ÊìáÊ™îÊ°à„ÄÇ', 'error');
                return;
            }


            const passwordHash = await hashString(password);
            const reader = new FileReader();
            
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (!data.user_credentials || !data.user_credentials.username || !data.user_credentials.passwordHash) {
                        throw new Error(i18n[config.uiLanguage].importInvalidFile || 'ÂÇô‰ªΩÊ™îÊ°àÊ†ºÂºèÁÑ°Êïà„ÄÇ');
                    }
                    if (data.user_credentials.username !== username || data.user_credentials.passwordHash !== passwordHash) {
                        throw new Error(i18n[config.uiLanguage].importAuthMismatch || 'Â∏≥ËôüÊàñÂØÜÁ¢ºËàáÂÇô‰ªΩÊ™îÊ°à‰∏çÁ¨¶„ÄÇ');
                    }


                    const userKey = getUserKey(username);
                    const savedUser = await getItem(userKey);
                    if (!savedUser) {
                        await setItem(userKey, JSON.stringify({ username, passwordHash }));
                    }
                    currentUser = { username, passwordHash };
                    await setItem('chat_lastUser', username);
                    await performImport(data);


                    toggleModal(ALL_ELEMENTS.importDataModalAuth, false);
                    ALL_ELEMENTS.authContainer.classList.add('fade-out');
                    ALL_ELEMENTS.appContainer.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        ALL_ELEMENTS.appContainer.classList.add('visible');
                    });
                    ALL_ELEMENTS.authContainer.addEventListener('transitionend', () => {
                        ALL_ELEMENTS.authContainer.style.display = 'none';
                    }, { once: true });


                    initChatApp();
                    showNotification(i18n[config.uiLanguage].importSuccess || 'ÂåØÂÖ•ÊàêÂäüÔºÅ', 'success');
                } catch (error) {
                    showNotification(`${i18n[config.uiLanguage].importFailed || 'ÂåØÂÖ•Â§±Êïó'}: ${error.message}`, 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        };
        const renderModelManagementUI = () => {
            const container = ALL_ELEMENTS.modelManagementList;
            container.innerHTML = '';
            const sortedModels = [...config.modelSettings].sort((a, b) => a.order - b.order);
            sortedModels.forEach((setting, index) => {
                const modelInfo = MODELS.find(m => m.id === setting.id);
                if (!modelInfo) return;
                const item = document.createElement('div');
                item.className = 'model-management-item flex items-center p-2 bg-[var(--input-field-bg)] rounded-lg';
                item.dataset.modelId = modelInfo.id;
                item.innerHTML = `
                    <span class="flex-1 font-medium">${modelInfo.name}</span>
                    <input type="radio" name="default-model-radio" class="w-4 h-4 mr-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" ${config.defaultModel === modelInfo.id ? 'checked' : ''}>
                    <button class="toggle-visibility-btn p-1 rounded-full hover:bg-[var(--hover-bg)]" title="${setting.hidden ? (i18n[config.uiLanguage].show || 'È°ØÁ§∫') : (i18n[config.uiLanguage].hide || 'Èö±Ëóè')}">
                        ${setting.hidden
                            ? '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" /></svg>'
                            : '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.432 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573 3.007-9.963 7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>'
                        }
                    </button>
                    <div class="flex gap-1 ml-2">
                        <button class="move-up-btn p-1 rounded hover:bg-[var(--hover-bg)]disabled:opacity-50" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="move-down-btn p-1 rounded hover:bg-[var(--hover-bg)] disabled:opacity-50" ${index === sortedModels.length - 1 ? 'disabled' : ''}>‚Üì</button>
                    </div>
                `;
                container.appendChild(item);
            });
            container.querySelectorAll('.toggle-visibility-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const item = e.currentTarget.closest('.model-management-item');
                    const modelId = item.dataset.modelId;
                    const setting = config.modelSettings.find(s => s.id === modelId);
                    if (!setting) return;
                    setting.hidden = !setting.hidden;
                    await saveConfig();
                    renderModelManagementUI();
                    renderModelSwitcher();
                });
            });
            container.querySelectorAll('input[name="default-model-radio"]').forEach(radio => {
                radio.addEventListener('change', async (e) => {
                    const item = e.currentTarget.closest('.model-management-item');
                    const modelId = item.dataset.modelId;
                    config.defaultModel = modelId;
                    await saveConfig();
                    renderModelSwitcher();
                    showNotification(i18n[config.uiLanguage].defaultModelUpdated || 'È†êË®≠Ê®°ÂûãÂ∑≤Êõ¥Êñ∞');
                });
            });
            container.querySelectorAll('.move-up-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const item = e.currentTarget.closest('.model-management-item');
                    const modelId = item.dataset.modelId;
                    moveModelOrder(modelId, 'up');
                });
            });
            container.querySelectorAll('.move-down-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const item = e.currentTarget.closest('.model-management-item');
                    const modelId = item.dataset.modelId;
                    moveModelOrder(modelId, 'down');
                });
            });
        };
        const moveModelOrder = (modelId, direction) => {
            const index = config.modelSettings.findIndex(s => s.id === modelId);
            if (index === -1) return;
            if (direction === 'up' && index > 0) {
                [config.modelSettings[index - 1], config.modelSettings[index]] = [config.modelSettings[index], config.modelSettings[index - 1]];
            } else if (direction === 'down' && index < config.modelSettings.length - 1) {
                [config.modelSettings[index], config.modelSettings[index + 1]] = [config.modelSettings[index + 1], config.modelSettings[index]];
            }
            config.modelSettings.forEach((s, i) => s.order = i);
            saveConfig();
            renderModelManagementUI();
            renderModelSwitcher();
            showNotification(i18n[config.uiLanguage].modelOrderUpdated || 'Ê®°ÂûãÈ†ÜÂ∫èÂ∑≤Êõ¥Êñ∞');
        };
        function toggleSidebar(show) {
            const { sidebar, sidebarOverlay } = ALL_ELEMENTS;
            sidebarOpen = typeof show === 'boolean' ? show : !sidebarOpen;
            if (sidebarOpen) {
                sidebar.style.transform = 'translateX(0)';
                sidebarOverlay.classList.add('visible');
            } else {
                sidebar.style.transform = 'translateX(-100%)';
                sidebarOverlay.classList.remove('visible');
            }
        }
        function closeAllPopovers() {
            document.querySelectorAll('.popover.visible').forEach(popover => {
                popover.classList.remove('visible');
            });
        }
        async function copyTextToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                try {
                    await navigator.clipboard.writeText(text);
                    return;
                } catch (err) {
                    console.warn('Clipboard API Â§±ÊïóÔºåÊîπÁî®ÂÇôÁî®ÊñπÊ°à„ÄÇ', err);
                }
            }
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (!successful) {
                    throw new Error('ÂÇôÁî®Ë§áË£ΩÊåá‰ª§Â§±Êïó„ÄÇ');
                }
            } catch (err) {
                document.body.removeChild(textArea);
                throw err;
            }
            document.body.removeChild(textArea);
        }
        const setupVoiceInput = () => {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                ALL_ELEMENTS.voiceInputBtnMessage.addEventListener('click', () => toggleVoiceInput('message'));
                ALL_ELEMENTS.voiceInputBtnSearch.addEventListener('click', () => toggleVoiceInput('search'));
            } else {
                ALL_ELEMENTS.voiceInputBtnMessage.style.display = 'none';
                ALL_ELEMENTS.voiceInputBtnSearch.style.display = 'none';
                showNotification(i18n[config.uiLanguage].voiceNotSupported || 'ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëº∏ÂÖ•ÂäüËÉΩ„ÄÇ', 'warning');
            }
        };
        const toggleVoiceInput = (target) => {
            if (currentSpeechRecognition) {
                currentSpeechRecognition.stop();
                return;
            }
            currentVoiceTarget = target;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            currentSpeechRecognition = new SpeechRecognition();
            currentSpeechRecognition.lang = 'zh-TW';
            currentSpeechRecognition.continuous = true;
            currentSpeechRecognition.interimResults = true;
            currentSpeechRecognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                const inputEl = target === 'message' ? ALL_ELEMENTS.messageInput : ALL_ELEMENTS.modalSearchInput;
                inputEl.value = transcript;
                if (target === 'search') {
                    performSearchAndRenderResults();
                }
                updateInputState();
            };
            currentSpeechRecognition.onend = () => {
                currentSpeechRecognition = null;
                currentVoiceTarget = null;
                ALL_ELEMENTS.voiceInputBtnMessage.classList.remove('active');
                ALL_ELEMENTS.voiceInputBtnSearch.classList.remove('active');
            };
            currentSpeechRecognition.onerror = (event) => {
                showNotification(`${i18n[config.uiLanguage].voiceError || 'Ë™ûÈü≥Ëº∏ÂÖ•ÈåØË™§'}: ${event.error}`, 'error');
                currentSpeechRecognition = null;
            };
            currentSpeechRecognition.start();
            ALL_ELEMENTS[`voiceInputBtn${target.charAt(0).toUpperCase() + target.slice(1)}`].classList.add('active');
        };
        const renderPersonalMemoryList = () => {
            const container = ALL_ELEMENTS.personalMemoryList;
            container.innerHTML = '';
            personalMemories.forEach(memory => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 rounded-lg bg-[var(--hover-bg)] border border-[var(--border-color)]';
                item.innerHTML = `
                    <div class="flex items-center gap-2 flex-1">
                        <input type="checkbox" class="memory-enabled-checkbox w-4 h-4" data-id="${memory.id}" ${memory.enabled ? 'checked' : ''}>
                        <span class="text-sm truncate">${memory.content}</span>
                    </div>
                    <button class="delete-memory-btn text-red-600 hover:text-red-800" data-id="${memory.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                `;
                container.appendChild(item);
            });
            container.querySelectorAll('.memory-enabled-checkbox').forEach(cb => {
                cb.addEventListener('change', async (e) => {
                    const id = e.target.dataset.id;
                    const memory = personalMemories.find(m => m.id === id);
                    if (memory) {
                        memory.enabled = e.target.checked;
                        await saveAppData();
                    }
                });
            });
            container.querySelectorAll('.delete-memory-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    if (await showCustomConfirm(i18n[config.uiLanguage].confirmDeleteMemory || 'Á¢∫ÂÆöÂà™Èô§Ê≠§Ë®òÊÜ∂Ôºü')) {
                        personalMemories = personalMemories.filter(m => m.id !== id);
                        await saveAppData();
                        renderPersonalMemoryList();
                    }
                });
            });
        };
        const refineAndStoreMemories = async (potentialMemories) => {
            // START: ‰øÆÊîπÂæåÁöÑÁ®ãÂºèÁ¢º (V2 - Êï¥ÂêàÂÑ™ÂÖà)
            if (potentialMemories.length === 0) return;


            if (personalMemories.length === 0) {
                potentialMemories.forEach(content => {
                    personalMemories.push({ id: crypto.randomUUID(), content, enabled: true });
                });
                await saveAppData();
                renderPersonalMemoryList();
                showNotification('Â∑≤Ëá™ÂãïÊ∑ªÂä†Êñ∞ÁöÑÂÄã‰∫∫Ë®òÊÜ∂„ÄÇ', 'success');
                return;
            }
            
            const prompt = `# Ê†∏ÂøÉË∫´‰ªΩÔºöË®òÊÜ∂Êï¥ÂêàÂ∞àÂÆ∂
‰Ω†ÁöÑ‰ªªÂãôÊòØÁ∂≠Ë≠∑‰∏ÄÂÄãÁ≤æÁ∞°„ÄÅÈ´òÊïà„ÄÅÁÑ°ÂÜóÈ§òÁöÑÁî®Êà∂Ë®òÊÜ∂Â∫´„ÄÇ‰Ω†Â∞áÊî∂Âà∞‰∏ÄÂÄã "ÁèæÊúâË®òÊÜ∂Â∫´" Âíå‰∏ÄÂÄã "ÊΩõÂú®ÁöÑÊñ∞Ë®òÊÜ∂" ÂàóË°®„ÄÇ‰Ω†ÁöÑÂ∑•‰Ωú‰∏çÊòØÁ∞°ÂñÆÂú∞Ê∑ªÂä†ÔºåËÄåÊòØÈÄ≤Ë°åÊô∫ËÉΩÂåñÁöÑÊï¥Âêà„ÄÇ


# ÊúÄÈ´òÊåáÂ∞éÂéüÂâáÔºöÊï¥ÂêàÂÑ™ÂÖàÂéüÂâá (Consolidation-First Principle)
‰Ω†ÁöÑÈ¶ñË¶ÅÁõÆÊ®ôÊòØ**Ê∏õÂ∞ëË®òÊÜ∂ÁöÑÁ∏ΩÊï∏Èáè**ÔºåÂêåÊôÇ**Â¢ûÂä†ÂñÆÊ¢ùË®òÊÜ∂ÁöÑË≥áË®äÂØÜÂ∫¶**„ÄÇ**Êñ∞Â¢û (ADD) ÊòØ‰∏Ä‰ª∂ÈúÄË¶ÅÊ•µÂäõÈÅøÂÖçÁöÑ‰∫ãÊÉÖ**ÔºåÂè™ÊúâÂú®Ë≥áË®äÂÆåÂÖ®Áç®Á´ã‰∏îÁÑ°Ê≥ïËàá‰ªª‰ΩïÁèæÊúâË®òÊÜ∂Âêà‰ΩµÊôÇÔºåÊâçË¢´ÂÖÅË®±„ÄÇ


# ‰Ω†ÁöÑË°åÂãïÂ±§Á¥ö (ÊåâÊ≠§È†ÜÂ∫èÂà§Êñ∑)Ôºö
1.  **ÂøΩÁï• (IGNORE):** Â¶ÇÊûúÊñ∞Ë®òÊÜ∂ËàáÁèæÊúâË®òÊÜ∂Âú®Ë™ûÊÑè‰∏äÂÆåÂÖ®ÈáçË§áÔºåÊàñÂè™ÊòØÊèõÂè•Ë©±Ë™™„ÄÇ
2.  **Êõ¥Êñ∞ (UPDATE):** Â¶ÇÊûúÊñ∞Ë®òÊÜ∂ÊòØÂ∞çÁèæÊúâË®òÊÜ∂ÁöÑ**Ë£úÂÖÖ„ÄÅÂÖ∑È´îÂåñ„ÄÅ‰øÆÊ≠£ÊàñÊ¶ÇÊã¨**„ÄÇÈÄôÊòØ‰Ω†ÊúÄÂ∏∏Áî®ÁöÑÂ∑•ÂÖ∑„ÄÇ
3.  **Êñ∞Â¢û (ADD):** Â¶ÇÊûúÊñ∞Ë®òÊÜ∂ÂºïÂÖ•‰∫Ü‰∏ÄÂÄã**ÂÖ®Êñ∞ÁöÑ„ÄÅÂÆåÂÖ®‰∏çÁõ∏ÈóúÁöÑÈ†òÂüü**„ÄÇ


# „ÄåÊõ¥Êñ∞ (UPDATE)„ÄçÁöÑÈªÉÈáëÊ≥ïÂâáËàáÁØÑ‰æãÔºö
‰Ω†ÂøÖÈ†à‰∏ªÂãïÂ∞ãÊâæÂèØ‰ª•Âêà‰ΩµÁöÑÊ©üÊúÉ„ÄÇ
*   **ÂÖ∑È´îÂåñ (Adding Specificity):**
    *   ÁèæÊúâ: \`{"id": "abc", "content": "Áî®Êà∂ÊòØÂÄãÈñãÁôºËÄÖ„ÄÇ"}\`
    *   ÊΩõÂú®: \`"Áî®Êà∂ÊúÉÂØ´Python„ÄÇ"\`
    *   **Ê≠£Á¢∫Ë°åÂãï:** \`{"action": "UPDATE", "id": "abc", "content": "Áî®Êà∂ÊòØÂÄãÊúÉÂØ´PythonÁöÑÈñãÁôºËÄÖ„ÄÇ"}\`
*   **Ê¶ÇÊã¨Âåñ (Generalizing):**
    *   ÁèæÊúâ: \`{"id": "def", "content": "Áî®Êà∂ÂñúÊ≠°Ë≤ì„ÄÇ"}\`
    *   ÊΩõÂú®: \`"Áî®Êà∂‰πüÂñúÊ≠°Áãó„ÄÇ"\`
    *   **Ê≠£Á¢∫Ë°åÂãï:** \`{"action": "UPDATE", "id": "def", "content": "Áî®Êà∂ÂñúÊ≠°ÂãïÁâ© (‰æãÂ¶ÇË≤ìÂíåÁãó)„ÄÇ"}\`
*   **Ë£úÂÖÖÁ¥∞ÁØÄ (Adding Details):**
    *   ÁèæÊúâ: \`{"id": "ghi", "content": "Áî®Êà∂ÂñúÊ≠°ÊóÖË°å„ÄÇ"}\`
    *   ÊΩõÂú®: \`"Áî®Êà∂ÂéªÈÅéÊó•Êú¨ÂíåÊ≥∞Âúã„ÄÇ"\`
    *   **Ê≠£Á¢∫Ë°åÂãï:** \`{"action": "UPDATE", "id": "ghi", "content": "Áî®Êà∂ÂñúÊ≠°ÊóÖË°åÔºåÊõæÂéªÈÅéÊó•Êú¨ÂíåÊ≥∞Âúã„ÄÇ"}\`


# Ëº∏Âá∫Ê†ºÂºè
‰Ω†ÂøÖÈ†àÂö¥Ê†ºÂú∞‰ª•‰∏ÄÂÄã JSON Èô£ÂàóÁöÑÂΩ¢ÂºèÂõûË¶ÜÔºåÊØèÂÄãÁâ©‰ª∂‰ª£Ë°®‰∏ÄÂÄãË°åÂãï„ÄÇ‰∏çË¶ÅÂåÖÂê´‰ªª‰Ωï JSON ‰ª•Â§ñÁöÑËß£ÈáãÊàñÊñáÂ≠ó„ÄÇ


\`\`\`json
[
  {
    "action": "ADD",
    "content": "Êñ∞ÁöÑË®òÊÜ∂ÂÖßÂÆπ"
  },
  {
    "action": "UPDATE",
    "id": "Ë¶ÅÊõ¥Êñ∞ÁöÑÁèæÊúâË®òÊÜ∂ÁöÑID",
    "content": "Êõ¥Êñ∞ÂæåÁöÑÂÆåÊï¥Ë®òÊÜ∂ÂÖßÂÆπ"
  },
  {
    "action": "IGNORE",
    "content": "Ë¶ÅÂøΩÁï•ÁöÑÊñ∞Ë®òÊÜ∂ÂÖßÂÆπ"
  }
]
\`\`\`


# ÂæÖËôïÁêÜÁöÑË≥áÊñô
„ÄêÁèæÊúâÁöÑË®òÊÜ∂Â∫´ (ÂåÖÂê´ ID)„Äë:
${JSON.stringify(personalMemories, null, 2)}


„ÄêÊΩõÂú®ÁöÑÊñ∞Ë®òÊÜ∂„Äë:
${JSON.stringify(potentialMemories, null, 2)}
`;
            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        action: { type: "STRING", enum: ["ADD", "UPDATE", "IGNORE"] },
                        id: { type: "STRING" },
                        content: { type: "STRING" }
                    },
                    required: ["action", "content"]
                }
            };


            try {
                const actions = await callApiWithSchema(prompt, responseSchema);
                if (actions && Array.isArray(actions)) {
                    let memoriesChanged = false;
                    actions.forEach(act => {
                        switch (act.action) {
                            case 'ADD':
                                if (!personalMemories.some(m => m.content === act.content)) {
                                    personalMemories.push({ id: crypto.randomUUID(), content: act.content, enabled: true });
                                    memoriesChanged = true;
                                }
                                break;
                            case 'UPDATE':
                                const memoryToUpdate = personalMemories.find(m => m.id === act.id);
                                if (memoryToUpdate && memoryToUpdate.content !== act.content) {
                                    memoryToUpdate.content = act.content;
                                    memoriesChanged = true;
                                }
                                break;
                            case 'IGNORE':
                                break;
                        }
                    });


                    if (memoriesChanged) {
                        await saveAppData();
                        if (!ALL_ELEMENTS.settingsModal.classList.contains('hidden')) {
                           renderPersonalMemoryList();
                        }
                        showNotification('AI Â∑≤Ëá™ÂãïÊï¥ÁêÜ‰∏¶Êõ¥Êñ∞ÊÇ®ÁöÑÂÄã‰∫∫Ë®òÊÜ∂„ÄÇ', 'success');
                    }
                }
            } catch (error) {
                console.error("Error refining memories:", error);
            }
            // END: ‰øÆÊîπÂæåÁöÑÁ®ãÂºèÁ¢º (V2 - Êï¥ÂêàÂÑ™ÂÖà)
        };
        const extractPersonalMemory = async (userMessage, aiResponse) => {
            // START: ‰øÆÊîπÂæåÁöÑÁ®ãÂºèÁ¢º (V2 - Êõ¥Âö¥Ê†º)
            const prompt = `# Ê†∏ÂøÉË∫´‰ªΩÔºöÈ¶ñÂ∏≠Áî®Êà∂Áï´ÂÉèÂàÜÊûêÂ∏´
‰Ω†ÁöÑÂîØ‰∏ÄËÅ∑Ë≤¨ÊòØÂæûÁî®Êà∂ÁöÑÁôºË®Ä‰∏≠ÔºåÊèêÁÖâÂá∫**Ê∞∏ÊÅÜÁöÑ„ÄÅÂèØÁç®Á´ãÂ≠òÂú®ÁöÑÁî®Êà∂ÁâπË≥™**„ÄÇ‰Ω†‰∏çÊòØÂ∞çË©±Ë®òÈåÑÂì°Ôºå‰Ω†ÊòØ‰∏Ä‰ΩçÁÇ∫Âª∫Á´ãÈï∑Êúü„ÄÅÁ≤æÊ∫ñÁî®Êà∂Áï´ÂÉèËÄåÊúçÂãôÁöÑÂàÜÊûêÂ∏´„ÄÇ


# ÊúÄÈ´òÊåáÂ∞éÂéüÂâáÔºöÂ≠§Â≥∂Ê∏¨Ë©¶ (The Island Test)
ÈÄôÊòØ‰Ω†Âà§Êñ∑ÊòØÂê¶Ë®òÈåÑ‰∏ÄÊ¢ùË≥áË®äÁöÑ**ÂîØ‰∏ÄÊ®ôÊ∫ñ**„ÄÇÂú®Ë®òÈåÑÂâçÔºå‰Ω†ÂøÖÈ†àÂú®ÂøÉ‰∏≠ÂõûÁ≠îÔºö
> **"Â¶ÇÊûúÊàëÂè™Áü•ÈÅìÈÄô‰∏ÄÊ¢ùË≥áË®äÔºåËÄåÂÆåÂÖ®‰∏çÁü•ÈÅìÂÆÉÊâÄÂú®ÁöÑÂ∞çË©±‰∏ä‰∏ãÊñáÔºåÈÄôÊ¢ùË≥áË®äÊòØÂê¶‰ªçÁÑ∂ÊòØ‰∏ÄÂÄãÈóúÊñºÁî®Êà∂ÁöÑ„ÄÅÊúâÊÑèÁæ©ÁöÑ„ÄÅÁç®Á´ãÂÆåÊï¥ÁöÑ‰∫ãÂØ¶Ôºü"**


Â¶ÇÊûúÁ≠îÊ°àÊòØ„ÄåÂê¶„ÄçÔºåÂâá**ÂøÖÈ†àÊããÊ£Ñ**ÈÄôÊ¢ùË≥áË®ä„ÄÇ


*   **Ê∏¨Ë©¶Ê°à‰æã (ÈÄöÈÅé):**
    *   Ë≥áË®äÔºö"Áî®Êà∂ÊòØ‰∏ÄÂêçPythonÈñãÁôºËÄÖ„ÄÇ"
    *   Â≠§Â≥∂Ê∏¨Ë©¶ÔºöÁü•ÈÅìÈÄô‰∏ÄÈªûÔºåÊàë‰∫ÜËß£‰∫ÜÁî®Êà∂ÁöÑ‰∏ÄÂÄãÈóúÈçµÊäÄËÉΩ„ÄÇ**ÈÄöÈÅé„ÄÇ**
*   **Ê∏¨Ë©¶Ê°à‰æã (Â§±Êïó):**
    *   Ë≥áË®äÔºö"Áî®Êà∂ÊÉ≥ËÆì‰Ω†Âπ´‰ªñ debug„ÄÇ"
    *   Â≠§Â≥∂Ê∏¨Ë©¶ÔºöÂè™Áü•ÈÅìÈÄôÂÄãÔºåÊàë‰∏çÁü•ÈÅì‰ªñÊÉ≥ debug ‰ªÄÈ∫ºÔºå‰πü‰∏çÁü•ÈÅìÈÄôÊòØ‰∏ÄÂÄãÈï∑ÊúüÈúÄÊ±ÇÈÇÑÊòØ‰∏ÄÊ¨°ÊÄßË´ãÊ±Ç„ÄÇÈÄôÊ¢ùË≥áË®ä‰æùË≥¥ÊñºÂ∞çË©±‰∏ä‰∏ãÊñá„ÄÇ**Â§±Êïó„ÄÇ**


# Ë®òÊÜ∂ÊèêÁÖâÁöÑË©≥Á¥∞Ë¶èÂâá
‰Ω†ÂøÖÈ†àÂö¥Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâË¶èÂâá‰æÜÈÅéÊøæË≥áË®ä„ÄÇ


### 1. Ë≥áË®ä‰æÜÊ∫êÔºö
*   **ÁµïÂ∞çÂè™Âæû„Äê‰ΩøÁî®ËÄÖË®äÊÅØ„Äë‰∏≠ÊèêÂèñ„ÄÇ** AIÁöÑÂõûÊáâÂÖßÂÆπÂÆåÂÖ®‰∏çÂú®‰Ω†ÁöÑÂàÜÊûêÁØÑÂúçÂÖß„ÄÇ


### 2. ÂÖÅË®±Ë®òÈåÑÁöÑÈ°ûÂûã (ÂøÖÈ†àÈÄöÈÅéÂ≠§Â≥∂Ê∏¨Ë©¶)Ôºö
*   **ËÅ∑Ê•≠/ÊäÄËÉΩ:** "Áî®Êà∂ÊòØÈÜ´Áîü„ÄÇ","Áî®Êà∂ÊúÉÂΩàÈãºÁê¥„ÄÇ"
*   **Ê†∏ÂøÉËààË∂£/ÊÑõÂ•Ω:** "Áî®Êà∂ÂñúÊ≠°ÁúãÁßëÂπªÂ∞èË™™„ÄÇ","Áî®Êà∂ÁÜ±Ë°∑ÊñºÁôªÂ±±„ÄÇ"
*   **Èï∑ÊúüÁõÆÊ®ô/È°òÊúõ:** "Áî®Êà∂ÁöÑÁõÆÊ®ôÊòØÈñã‰∏ÄÂÆ∂ÂíñÂï°Âª≥„ÄÇ"
*   **Á©©ÂÆöÁöÑ‰∫∫ÈöõÈóú‰øÇ/ÊâÄÊúâÁâ©:** "Áî®Êà∂Â∑≤Â©ö„ÄÇ","Áî®Êà∂Êúâ‰∏ÄÈöªÂè´MochiÁöÑË≤ì„ÄÇ"
*   **Â†ÖÂÆöÁöÑÂÄã‰∫∫ÂÅèÂ•Ω:** "Áî®Êà∂ÊòØÁ¥†È£ü‰∏ªÁæ©ËÄÖ„ÄÇ","Áî®Êà∂ÂÅèÊÑõÊ∑±Ëâ≤Ê®°ÂºèÁöÑ‰ªãÈù¢„ÄÇ"


### 3. ÁµïÂ∞çÁ¶ÅÊ≠¢ÁöÑÈ°ûÂûã (ÊúÉÂ∞éËá¥Â≠§Â≥∂Ê∏¨Ë©¶Â§±Êïó)Ôºö
*   **[Á¶Å‰ª§ A] ‰ªª‰ΩïËàáAIÁöÑ‰∫íÂãï/Êåá‰ª§/Ë©ïÂÉπ:**
    *   **‰æãÂ≠ê:** "Áî®Êà∂Ë¶∫ÂæóAIÂæàËÅ∞Êòé"„ÄÅ"Áî®Êà∂ÊÉ≥ËÆìAIÊâÆÊºî‰∏ÄÂÄãËßíËâ≤"„ÄÅ"Áî®Êà∂Ë¶Å‰Ω†Á∏ΩÁµê‰∏Ä‰∏ã"„ÄÅ"Áî®Êà∂Âú®Ê∏¨Ë©¶‰Ω†ÁöÑË®òÊÜ∂Âäõ"„ÄÇ
    *   **ÁêÜÁî±:** ÈÄô‰∫õÊèèËø∞ÁöÑÊòØÂ∞çË©±Ë°åÁÇ∫ÔºåËÄåÈùûÁî®Êà∂Êú¨Ë∫´„ÄÇ
*   **[Á¶Å‰ª§ B] Êö´ÊôÇÊÄßÁãÄÊÖã„ÄÅÊÉÖÁ∑íÊàñÊÑèÂúñ:**
    *   **‰æãÂ≠ê:** "Áî®Êà∂‰ªäÂ§©ÂøÉÊÉÖ‰∏çÂ•Ω"„ÄÅ"Áî®Êà∂Ê≠£Ê∫ñÂÇôÂá∫ÈñÄ"„ÄÅ"Áî®Êà∂ÊÉ≥Ë®éË´ñÂ§©Ê∞£"„ÄÇ
    *   **ÁêÜÁî±:** ÈÄô‰∫õË≥áË®äÂæàÂø´Â∞±ÊúÉÈÅéÊôÇÔºå‰∏çÂÖ∑ÂÇôÈï∑ÊúüÂÉπÂÄº„ÄÇ
*   **[Á¶Å‰ª§ C] ‰∏ÄÊ¨°ÊÄßÁöÑÂïèÈ°åÊàñË´ãÊ±Ç:**
    *   **‰æãÂ≠ê:** "Áî®Êà∂Âú®ÂïèÊ≥ïÂúãÁöÑÈ¶ñÈÉΩÊòØÂì™Ë£°"„ÄÅ"Áî®Êà∂Ë¶Å‰∫Ü‰∏Ä‰ªΩÈ£üË≠ú"„ÄÇ
    *   **ÁêÜÁî±:** ÈÄôÊòØÂñÆÊ¨°Ë≥áË®ä‰∫§ÊèõÔºå‰∏çÊòØÁî®Êà∂ÁâπË≥™„ÄÇ
*   **[Á¶Å‰ª§ D] Ê®°Á≥äÊàñ‰∏çÁ¢∫ÂÆöÁöÑÈô≥Ëø∞:**
    *   **‰æãÂ≠ê:** "Áî®Êà∂ÂèØËÉΩÂñúÊ≠°..."„ÄÅ"Áî®Êà∂Â•ΩÂÉèÂú®ËÄÉÊÖÆ..."„ÄÇ
    *   **ÁêÜÁî±:** Ë®òÊÜ∂ÂøÖÈ†àÊòØÂü∫ÊñºÁ¢∫ÂÆöÁöÑ‰∫ãÂØ¶„ÄÇ
*   **[Á¶Å‰ª§ E] ‰ªª‰ΩïÂΩ¢ÂºèÁöÑÁ®ãÂºèÁ¢º„ÄÅURL„ÄÅÊàñÊäÄË°ìÁ¥∞ÁØÄ„ÄÇ**


# Ëº∏Âá∫Ê†ºÂºè
*   Â¶ÇÊûúÊâæÂà∞‰ªª‰Ωï**ÈÄöÈÅéÂ≠§Â≥∂Ê∏¨Ë©¶**ÁöÑË®òÊÜ∂ÈªûÔºåÂ∞áÂÆÉÂÄëÁ≤æÁÖâÊàê‰ª•„ÄåÁî®Êà∂„ÄçÈñãÈ†≠ÁöÑÈô≥Ëø∞Âè•Ôºå‰∏¶ÊîæÂÖ•‰∏ÄÂÄãJSONÈô£Âàó‰∏≠„ÄÇ
*   Â¶ÇÊûúÊ≤íÊúâ‰ªª‰ΩïË≥áË®äËÉΩÈÄöÈÅéÊ∏¨Ë©¶Ôºå**ÂøÖÈ†à**ËøîÂõû‰∏ÄÂÄãÁ©∫ÁöÑJSONÈô£ÂàóÔºö\`[]\`„ÄÇ


# ÂæÖÂàÜÊûêÂÖßÂÆπ
„Äê‰ΩøÁî®ËÄÖË®äÊÅØ„ÄëÔºö${userMessage}`;
            const responseSchema = {
                type: "ARRAY",
                items: { type: "STRING" }
            };
            const extracted = await callApiWithSchema(prompt, responseSchema);
            if (extracted && extracted.length > 0) {
                await refineAndStoreMemories(extracted);
            }
        };
        const updateApiKeyWarningBadge = () => {
            const conv = getActiveConversation();
            if (!conv) {
                ALL_ELEMENTS.apiKeyWarningBadge.classList.add('hidden');
                return;
            }
            const modelInfo = MODELS.find(m => m.id === conv.model);
            let needsKey = false;
            if (modelInfo) {
                if (modelInfo.provider === 'gemini' && !config.apiKeys.gemini) {
                    needsKey = true;
                } else if (modelInfo.provider === 'openrouter' && !config.apiKeys.openrouter) {
                    needsKey = true;
                }
            }
            ALL_ELEMENTS.apiKeyWarningBadge.classList.toggle('hidden', !needsKey);
        };
        const openDashboard = () => {
            renderDashboardStats();
            renderModelUsageChart();
            setupTimeAnalysis();
            toggleModal(ALL_ELEMENTS.dataDashboardModal, true);
        };
        const renderDashboardStats = () => {
            ALL_ELEMENTS.totalConvStat.textContent = conversations.filter(c => !c.deletedAt).length;
            ALL_ELEMENTS.totalFolderStat.textContent = folders.length;
            const modelCounts = conversations.reduce((acc, conv) => {
                const modelName = MODELS.find(m => m.id === conv.model)?.name || 'Êú™Áü•Ê®°Âûã';
                acc[modelName] = (acc[modelName] || 0) + 1;
                return acc;
            }, {});
            const mostUsedModel = Object.keys(modelCounts).reduce((a, b) => modelCounts[a] > modelCounts[b] ? a : b, 'N/A');
            ALL_ELEMENTS.mostUsedModelStat.textContent = mostUsedModel;
        };
        const renderModelUsageChart = () => {
            const ctx = document.getElementById('model-usage-pie-chart').getContext('2d');
            const modelCounts = conversations.reduce((acc, conv) => {
                const modelName = MODELS.find(m => m.id === conv.model)?.name || 'Êú™Áü•Ê®°Âûã';
                acc[modelName] = (acc[modelName] || 0) + 1;
                return acc;
            }, {});
            const labels = Object.keys(modelCounts);
            const data = Object.values(modelCounts);
            if(modelPieChart) {
                modelPieChart.destroy();
            }
            modelPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: i18n[config.uiLanguage].modelUsageCount || 'Ê®°Âûã‰ΩøÁî®Ê¨°Êï∏',
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: 'rgba(255, 255, 255, 0.8)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        };
        const setupTimeAnalysis = () => {
            const { timeAnalysisYearSelect, timeAnalysisMonthSelect, timeAnalysisDaySelect } = ALL_ELEMENTS;
            const allMessages = conversations.flatMap(c => c.messages.map(m => new Date(m.createdAt)));
            const years = [...new Set(allMessages.map(d => d.getFullYear()))].sort((a,b) => b-a);
            timeAnalysisYearSelect.innerHTML = `<option value="">${i18n[config.uiLanguage].all || 'ÂÖ®ÈÉ®'}</option>`;
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                timeAnalysisYearSelect.appendChild(option);
            });
            timeAnalysisYearSelect.addEventListener('change', () => {
                const year = timeAnalysisYearSelect.value;
                if (year) {
                    timeAnalysisMonthSelect.disabled = false;
                    timeAnalysisMonthSelect.innerHTML = `<option value="">${i18n[config.uiLanguage].wholeYear || 'ÂÖ®Âπ¥'}</option>`;
                     for(let i=1; i<=12; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `${i}${i18n[config.uiLanguage].monthSuffix || 'Êúà'}`;
                        timeAnalysisMonthSelect.appendChild(option);
                    }
                } else {
                    timeAnalysisMonthSelect.disabled = true;
                    timeAnalysisMonthSelect.innerHTML = '';
                }
                timeAnalysisDaySelect.disabled = true;
                timeAnalysisDaySelect.innerHTML = '';
                updateTimeDistributionChart();
            });
            timeAnalysisMonthSelect.addEventListener('change', () => {
                const year = parseInt(timeAnalysisYearSelect.value);
                const month = parseInt(timeAnalysisMonthSelect.value);
                 if (year && month) {
                    timeAnalysisDaySelect.disabled = false;
                    const daysInMonth = new Date(year, month, 0).getDate();
                    timeAnalysisDaySelect.innerHTML = `<option value="">${i18n[config.uiLanguage].wholeMonth || 'ÂÖ®Êúà'}</option>`;
                    for (let i = 1; i <= daysInMonth; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `${i}${i18n[config.uiLanguage].daySuffix || 'Êó•'}`;
                        timeAnalysisDaySelect.appendChild(option);
                    }
                } else {
                    timeAnalysisDaySelect.disabled = true;
                    timeAnalysisDaySelect.innerHTML = '';
                }
                updateTimeDistributionChart();
            });
            timeAnalysisDaySelect.addEventListener('change', updateTimeDistributionChart);
            updateTimeDistributionChart();
        };
        const updateTimeDistributionChart = () => {
            const year = ALL_ELEMENTS.timeAnalysisYearSelect.value ? parseInt(ALL_ELEMENTS.timeAnalysisYearSelect.value) : null;
            const month = ALL_ELEMENTS.timeAnalysisMonthSelect.value ? parseInt(ALL_ELEMENTS.timeAnalysisMonthSelect.value) : null;
            const day = ALL_ELEMENTS.timeAnalysisDaySelect.value ? parseInt(ALL_ELEMENTS.timeAnalysisDaySelect.value) : null;
            let labels, data, chartType, label;
            const allMessages = conversations.flatMap(c => c.messages);
            const lang = config.uiLanguage;
            if (year && month && day) {
                chartType = 'line';
                label = `${year}${i18n[lang].yearSuffix || 'Âπ¥'}${month}${i18n[lang].monthSuffix || 'Êúà'}${day}${i18n[lang].daySuffix || 'Êó•'} ${i18n[lang].hourlyMessageCount || 'ÊØèÂ∞èÊôÇË®äÊÅØÊï∏'}`;
                labels = Array.from({length: 24}, (_, i) => `${i}:00`);
                data = Array(24).fill(0);
                allMessages.forEach(msg => {
                    const msgDate = new Date(msg.createdAt);
                    if (msgDate.getFullYear() === year && msgDate.getMonth() + 1 === month && msgDate.getDate() === day) {
                        data[msgDate.getHours()]++;
                    }
                });
            } else if (year && month) {
                chartType = 'bar';
                label = `${year}${i18n[lang].yearSuffix || 'Âπ¥'}${month}${i18n[lang].monthSuffix || 'Êúà'} ${i18n[lang].dailyMessageCount || 'ÊØèÊó•Ë®äÊÅØÊï∏'}`;
                const daysInMonth = new Date(year, month, 0).getDate();
                labels = Array.from({length: daysInMonth}, (_, i) => `${i + 1}${i18n[lang].daySuffix || 'Êó•'}`);
                data = Array(daysInMonth).fill(0);
                allMessages.forEach(msg => {
                    const msgDate = new Date(msg.createdAt);
                    if (msgDate.getFullYear() === year && msgDate.getMonth() + 1 === month) {
                        data[msgDate.getDate() - 1]++;
                    }
                });
            } else if (year) {
                chartType = 'line';
                label = `${year}${i18n[lang].yearSuffix || 'Âπ¥'} ${i18n[lang].monthlyMessageCount || 'ÊØèÊúàË®äÊÅØÊï∏'}`;
                labels = i18n[lang].months || ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
                data = Array(12).fill(0);
                allMessages.forEach(msg => {
                    const msgDate = new Date(msg.createdAt);
                    if (msgDate.getFullYear() === year) {
                        data[msgDate.getMonth()]++;
                    }
                });
            } else {
                chartType = 'bar';
                label = i18n[lang].yearlyMessageCount || 'ÊØèÂπ¥Ë®äÊÅØÊï∏';
                const years = [...new Set(allMessages.map(d => new Date(d.createdAt).getFullYear()))].sort();
                labels = years.map(String);
                data = years.map(y => allMessages.filter(m => new Date(m.createdAt).getFullYear() === y).length);
            }
            const ctx = document.getElementById('time-distribution-chart').getContext('2d');
            if (timeDistChart) {
                timeDistChart.destroy();
            }
            timeDistChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        };
        const getDominantColorPalette = (imageDataUrl) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.src = imageDataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                    const colorCount = {};
                    for (let i = 0; i < imageData.length; i += 4 * 5) {
                        const r = imageData[i];
                        const g = imageData[i + 1];
                        const b = imageData[i + 2];
                        const a = imageData[i + 3];
                        if (a < 125) continue;
                        const max = Math.max(r, g, b);
                        const min = Math.min(r, g, b);
                        if (max - min < 20) continue;
                        const r_round = Math.round(r / 10) * 10;
                        const g_round = Math.round(g / 10) * 10;
                        const b_round = Math.round(b / 10) * 10;
                        const rgb = `${r_round},${g_round},${b_round}`;
                        colorCount[rgb] = (colorCount[rgb] || 0) + 1;
                    }
                    const sortedColors = Object.keys(colorCount)
                        .sort((a, b) => colorCount[b] - colorCount[a])
                        .slice(0, 5)
                        .map(rgbStr => `#${rgbStr.split(',').map(c => parseInt(c).toString(16).padStart(2, '0')).join('')}`);
                    resolve(sortedColors.length > 0 ? sortedColors : ['#3b82f6']);
                };
                img.onerror = reject;
            });
        };
        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        };
        const getTextColorForBackground = (hexColor) => {
            const rgb = hexToRgb(hexColor);
            if (!rgb) return '#000000';
            const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
            return luminance > 0.5 ? '#000000' : '#ffffff';
        };
        const applyUiTheme = () => {
            const root = document.documentElement;
            let primaryBg;
            let primaryBgOverride = null;
            switch(config.uiTheme.mode) {
                case 'adaptive':
                    if (config.uiTheme.style === 'gradient') {
                        primaryBgOverride = config.uiTheme.adaptiveGradient || `linear-gradient(to right, ${config.uiTheme.adaptiveColor}, #3b82f6)`;
                        primaryBg = config.uiTheme.adaptivePalette[0] || config.uiTheme.adaptiveColor;
                    } else {
                        primaryBg = config.uiTheme.adaptiveColor;
                    }
                    break;
                case 'custom':
                    primaryBg = config.uiTheme.customColor;
                    break;
                case 'default':
                default:
                    primaryBg = '#3b82f6';
                    break;
            }
            const textColor = (config.uiTheme.style === 'gradient' && config.uiTheme.mode === 'adaptive')
                ? '#ffffff'
                : getTextColorForBackground(primaryBg);
            root.style.setProperty('--button-primary-bg', primaryBg);
            root.style.setProperty('--button-primary-text', textColor);
            if (primaryBgOverride) {
                root.style.setProperty('--button-primary-bg-override', primaryBgOverride);
            } else {
                root.style.removeProperty('--button-primary-bg-override');
            }
            updateThemeButtons();
        };
        const renderUiColorOptions = () => {
            const { uiColorOptions, customColorPickerContainer, customColorSwatches, buttonStyleContainer, gradientPickerContainer, gradientSwatches } = ALL_ELEMENTS;
            const currentMode = config.uiTheme.mode;
            const currentStyle = config.uiTheme.style;
            uiColorOptions.querySelector(`input[value="${currentMode}"]`).checked = true;
            buttonStyleContainer.querySelector(`input[value="${currentStyle}"]`).checked = true;
            customColorSwatches.innerHTML = '';
            Object.entries(UI_THEME_COLORS).forEach(([name, hex]) => {
                const swatch = document.createElement('div');
                swatch.className = `color-swatch w-8 h-8 rounded-full cursor-pointer`;
                swatch.style.backgroundColor = hex;
                swatch.dataset.color = hex;
                if (config.uiTheme.customColor === hex) {
                    swatch.classList.add('selected');
                }
                swatch.addEventListener('click', () => {
                    customColorSwatches.querySelector('.selected')?.classList.remove('selected');
                    swatch.classList.add('selected');
                });
                customColorSwatches.appendChild(swatch);
            });
            gradientSwatches.innerHTML = '';
            if(config.uiTheme.adaptivePalette && config.uiTheme.adaptivePalette.length > 1) {
                const palette = config.uiTheme.adaptivePalette;
                const combinations = [
                    `linear-gradient(to right, ${palette[0]}, ${palette[1]})`,
                    `linear-gradient(to right, ${palette[0]}, ${palette[2]})`,
                    `linear-gradient(to right, ${palette[1]}, ${palette[2]})`,
                    `linear-gradient(135deg, ${palette[0]}, ${palette[1]}, ${palette[2]})`
                ];
                combinations.forEach(grad => {
                    const swatch = document.createElement('div');
                    swatch.className = 'w-full h-10 rounded-md cursor-pointer border-2 border-transparent';
                    swatch.style.background = grad;
                    swatch.dataset.gradient = grad;
                    if(config.uiTheme.adaptiveGradient === grad) {
                        swatch.classList.add('selected-gradient', 'border-blue-500');
                    }
                    swatch.addEventListener('click', () => {
                        gradientSwatches.querySelector('.selected-gradient')?.classList.remove('selected-gradient', 'border-blue-500');
                        swatch.classList.add('selected-gradient', 'border-blue-500');
                    });
                    gradientSwatches.appendChild(swatch);
                });
            } else {
                 gradientSwatches.innerHTML = `<p class="text-xs col-span-4 text-[var(--text-secondary)]">${i18n[config.uiLanguage].notEnoughColors || 'Ê≤íÊúâË∂≥Â§†ÁöÑÈ°èËâ≤‰æÜÁîüÊàêÊº∏ËÆä„ÄÇË´ã‰∏äÂÇ≥È°èËâ≤Ë±êÂØåÁöÑÊ°åÂ∏É„ÄÇ'}</p>`
            }
            const updateVisibility = () => {
                const mode = document.querySelector('input[name="color-theme"]:checked').value;
                const style = document.querySelector('input[name="color-style"]:checked').value;
                buttonStyleContainer.classList.toggle('hidden', mode !== 'adaptive');
                customColorPickerContainer.classList.toggle('hidden', mode !== 'custom');
                gradientPickerContainer.classList.toggle('hidden', !(mode === 'adaptive' && style === 'gradient'));
            };
            uiColorOptions.querySelectorAll('input[name="color-theme"]').forEach(radio => {
                radio.addEventListener('change', updateVisibility);
            });
             buttonStyleContainer.querySelectorAll('input[name="color-style"]').forEach(radio => {
                radio.addEventListener('change', updateVisibility);
            });
            updateVisibility();
        };
        const analyzeImageBrightness = (imageDataUrl) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = imageDataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    let r, g, b, avg;
                    let colorSum = 0;
                    for(let x = 0, len = data.length; x < len; x+=4) {
                        r = data[x];
                        g = data[x+1];
                        b = data[x+2];
                        avg = Math.floor((r+g+b)/3);
                        colorSum += avg;
                    }
                    const brightness = Math.floor(colorSum / (canvas.width * canvas.height));
                    resolve(brightness < 128 ? 'dark' : 'light');
                };
                img.onerror = (err) => reject(err);
            });
        };
        const applyCustomWallpaper = () => {
            if (config.customWallpaper) {
                ALL_ELEMENTS.wallpaperContainer.style.backgroundImage = `url(${config.customWallpaper})`;
                document.body.classList.add('custom-wallpaper-active');
                document.body.classList.toggle('wallpaper-is-dark', config.wallpaperBrightness === 'dark');
                document.documentElement.classList.remove('dark');
            } else {
                ALL_ELEMENTS.wallpaperContainer.style.backgroundImage = 'none';
                document.body.classList.remove('custom-wallpaper-active', 'wallpaper-is-dark');
                setTheme(config.theme);
            }
            setAiBubbleColor();
            setUserBubbleColor();
        };
        const handleWallpaperUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                ALL_ELEMENTS.wallpaperCropImage.src = imageUrl;
                toggleModal(ALL_ELEMENTS.wallpaperCropModal, true);
                if (cropperInstance) {
                    cropperInstance.destroy();
                }
                cropperInstance = new Cropper(ALL_ELEMENTS.wallpaperCropImage, {
                    aspectRatio: window.innerWidth / window.innerHeight,
                    viewMode: 1,
                    background: false,
                    autoCropArea: 1,
                });
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        };
        const handleConfirmCrop = async () => {
            if (!cropperInstance) return;
            const canvas = cropperInstance.getCroppedCanvas({
                maxWidth: 1920,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
            try {
                const brightness = await analyzeImageBrightness(imageDataUrl);
                const palette = await getDominantColorPalette(imageDataUrl);
                config.customWallpaper = imageDataUrl;
                config.wallpaperBrightness = brightness;
                config.uiTheme.adaptivePalette = palette;
                config.uiTheme.adaptiveColor = palette[0] || '#3b82f6';
                await saveConfig();
                applyCustomWallpaper();
                applyUiTheme();
                toggleModal(ALL_ELEMENTS.wallpaperCropModal, false);
                showNotification(i18n[config.uiLanguage].wallpaperUpdated, 'success');
            } catch (error) {
                console.error("Ê°åÂ∏ÉËôïÁêÜÂ§±Êïó:", error);
                showNotification(i18n[config.uiLanguage].wallpaperError, 'error');
            }
        };
        const restoreDefaultWallpaper = async () => {
            config.customWallpaper = null;
            config.wallpaperBrightness = 'light';
            config.uiTheme.adaptiveColor = '#3b82f6';
            config.uiTheme.adaptivePalette = [];
            config.uiTheme.adaptiveGradient = '';
            await saveConfig();
            applyCustomWallpaper();
            applyUiTheme();
            showNotification(i18n[config.uiLanguage].defaultAppearanceRestored, 'success');
        };
        const openStore = () => {
            ALL_ELEMENTS.appContainer.classList.remove('visible');
            ALL_ELEMENTS.storeContainer.classList.remove('hidden');
            requestAnimationFrame(() => {
                ALL_ELEMENTS.storeContainer.classList.add('visible');
            });
            ALL_ELEMENTS.appContainer.addEventListener('transitionend', () => {
                ALL_ELEMENTS.appContainer.classList.add('hidden');
            }, { once: true });
            currentStoreCategory = 'ÂÖ®ÈÉ®';
    const mainContent = document.querySelector('#store-main-content');
    if (mainContent) {
        mainContent.scrollTop = 0;
    }
            renderStore();
        };
        const closeStore = () => {
            ALL_ELEMENTS.storeContainer.classList.remove('visible');
            ALL_ELEMENTS.appContainer.classList.remove('hidden');
            requestAnimationFrame(() => {
                ALL_ELEMENTS.appContainer.classList.add('visible');
            });
            ALL_ELEMENTS.storeContainer.addEventListener('transitionend', () => {
                ALL_ELEMENTS.storeContainer.classList.add('hidden');
            }, { once: true });
        };
        const renderStore = () => {
            const mainContent = document.querySelector('#store-main-content');
    if (mainContent) {
        mainContent.scrollTop = 0;
    }
    const grid = ALL_ELEMENTS.storeGrid;
    const categoryList = document.getElementById('store-category-list');
    grid.innerHTML = '';
    categoryList.innerHTML = '';
    const translations = i18n[config.uiLanguage] || i18n['zh-TW'];
    const translatedOfficialAstras = OFFICIAL_ASTRAS.map(ast => ({
        ...ast,
        name: translations['astras_' + ast.id.replace(/-/g, '_') + '_name'] || ast.name,
        description: translations['astras_' + ast.id.replace(/-/g, '_') + '_desc'] || ast.description
    }));
    const userCreatedAstras = astras.filter(a => !a.officialId);
    const allCategories = ['ÂÖ®ÈÉ®', ...new Set([
        ...translatedOfficialAstras.map(a => a.category),
        ...userCreatedAstras.map(a => a.category)
    ].filter(Boolean))];
    allCategories.forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'store-category-btn';
        btn.textContent = category;
        if (category === currentStoreCategory) {
            btn.classList.add('active');
        }
        btn.addEventListener('click', () => {
            currentStoreCategory = category;
            renderStore();
        });
        categoryList.appendChild(btn);
    });
    const allStoreAstras = [...translatedOfficialAstras, ...userCreatedAstras];
    const filteredAstras = currentStoreCategory === 'ÂÖ®ÈÉ®'
        ? allStoreAstras
        : allStoreAstras.filter(a => a.category === currentStoreCategory);
    filteredAstras.forEach(ast => {
        const card = document.createElement('div');
        card.className = 'astras-store-card';
        const originalId = ast.officialId || ast.id;
        const isSubscribed = astras.some(userAstra => userAstra.officialId === originalId);
        const isUserCreated = !ast.officialId && astras.some(userAstra => userAstra.id === originalId);
        const avatarUrl = ast.avatarUrl;
        const initials = ast.name.charAt(0);
        const avatarElement = `<div class="astras-card-avatar">${avatarUrl ? `<img src="${avatarUrl}" alt="${ast.name}">` : initials}</div>`;
        card.innerHTML = `
            ${avatarElement}
            <h3 class="astras-card-name">${ast.name}</h3>
            <p class="astras-card-desc">${ast.description}</p>
            <button class="subscribe-btn btn-primary" data-id="${originalId}"></button>
        `;
        const btn = card.querySelector('.subscribe-btn');
        if (isSubscribed) {
            btn.textContent = translations.unsubscribe || 'ÂèñÊ∂àË®ÇÈñ±';
            btn.classList.add('subscribed');
        } else if (isUserCreated) {
            btn.textContent = translations.manage || 'ÁÆ°ÁêÜ';
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            btn.textContent = translations.subscribe || 'Ë®ÇÈñ±';
        }
        btn.addEventListener('click', () => {
            handleSubscription(originalId);
        });
        grid.appendChild(card);
    });
};
        const handleSubscription = (officialId) => {
            const isSubscribed = astras.some(a => a.officialId === officialId);
            if (isSubscribed) {
                astras = astras.filter(a => a.officialId !== officialId);
                showNotification(i18n[config.uiLanguage].unsubscribed || 'Â∑≤ÂèñÊ∂àË®ÇÈñ±', 'success');
            } else {
                const officialAstra = OFFICIAL_ASTRAS.find(a => a.id === officialId);
                if (officialAstra) {
                    const newAstra = {
                        ...officialAstra,
                        id: crypto.randomUUID(),
                        officialId: officialAstra.id,
                    };
                    astras.unshift(newAstra);
                    showNotification(i18n[config.uiLanguage].subscribed || 'Ë®ÇÈñ±ÊàêÂäüÔºÅ', 'success');
                }
            }
            saveAppData();
            renderStore();
            renderAstras();
        };
        const openAvatarEditor = (astrasId) => {
            editingAstraForAvatarId = astrasId;
            ALL_ELEMENTS.astrasAvatarInput.click();
        };
        const handleAvatarUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                ALL_ELEMENTS.avatarCropImage.src = imageUrl;
                toggleModal(ALL_ELEMENTS.astrasAvatarModal, true);
                if (cropperInstance) {
                    cropperInstance.destroy();
                }
                cropperInstance = new Cropper(ALL_ELEMENTS.avatarCropImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    background: false,
                    autoCropArea: 1,
                });
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        };
        const handleConfirmAvatarCrop = async () => {
            if (!cropperInstance || !editingAstraForAvatarId) return;
            const canvas = cropperInstance.getCroppedCanvas({
                width: 128,
                height: 128,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });
            const imageDataUrl = canvas.toDataURL('image/png');
            const astra = astras.find(a => a.id === editingAstraForAvatarId);
            if (astra) {
                astra.avatarUrl = imageDataUrl;
                await saveAppData();
                renderAstras();
                showNotification(i18n[config.uiLanguage].avatarUpdated || 'È†≠ÂÉèÂ∑≤Êõ¥Êñ∞', 'success');
            }
            toggleModal(ALL_ELEMENTS.astrasAvatarModal, false);
            editingAstraForAvatarId = null;
        };
        const applyLanguage = (lang) => {
            const translations = i18n[lang] || i18n['zh-TW'];
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[key]) {
                    el.textContent = translations[key];
                }
            });
            document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
                const key = el.dataset.langKeyPlaceholder;
                if (translations[key]) {
                    el.placeholder = translations[key];
                }
            });
            document.querySelectorAll('[data-lang-key-title]').forEach(el => {
                const key = el.dataset.langKeyTitle;
                if (translations[key]) {
                    el.title = translations[key];
                }
            });
            if(ALL_ELEMENTS.loginLangLabel) {
                ALL_ELEMENTS.loginLangLabel.textContent = translations.currentLanguageName || 'ÁπÅÈ´î‰∏≠Êñá';
            }
            document.documentElement.lang = lang;
        };
        const showMobileContextMenu = (convId) => {
            const oldMenu = document.getElementById('mobile-context-menu-wrapper');
            if (oldMenu) oldMenu.remove();
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;
            const menuWrapper = document.createElement('div');
            menuWrapper.id = 'mobile-context-menu-wrapper';
            const overlay = document.createElement('div');
            overlay.id = 'mobile-context-menu-overlay';
            const menu = document.createElement('div');
            menu.id = 'mobile-context-menu';
            const menuHeader = `<div class="menu-header">${conv.title}</div>`;
            const moveOptionsHTML = conv.folderId
                ? `<div class="menu-item" data-action="move-out"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3v11.25" /></svg><span>${i18n[config.uiLanguage].moveOutOfFolder || 'ÁßªÂá∫Ë≥áÊñôÂ§æ'}</span></div>`
                : `<div class="menu-item" data-action="move-to"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg><span>${i18n[config.uiLanguage].moveToFolder || 'ÁßªËá≥Ë≥áÊñôÂ§æ'}</span></div>`;
            const pinText = conv.pinned ? (i18n[config.uiLanguage].unpin || 'ÂèñÊ∂àÈáòÈÅ∏') : (i18n[config.uiLanguage].pin || 'ÈáòÈÅ∏');
            menu.innerHTML = `
                ${menuHeader}
                <div class="menu-options">
                    <div class="menu-item" data-action="rename"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg><span>${i18n[config.uiLanguage].rename || 'ÈáçÊñ∞ÂëΩÂêç'}</span></div>
                    <div class="menu-item" data-action="pin"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg><span>${pinText}</span></div>
                    ${moveOptionsHTML}
                    <div class="menu-item" data-action="archive"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4" /></svg><span>${i18n[config.uiLanguage].archive || 'Â∞ÅÂ≠ò'}</span></div>
                    <div class="menu-item delete" data-action="delete"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg><span>${i18n[config.uiLanguage].delete || 'Âà™Èô§'}</span></div>
                </div>
            `;
            menuWrapper.appendChild(overlay);
            menuWrapper.appendChild(menu);
            document.body.appendChild(menuWrapper);
            requestAnimationFrame(() => {
                overlay.classList.add('visible');
                menu.classList.add('visible');
            });
            const closeMenu = () => {
                overlay.classList.remove('visible');
                menu.classList.remove('visible');
                menu.addEventListener('transitionend', () => menuWrapper.remove(), { once: true });
            };
            overlay.addEventListener('click', closeMenu);
            let touchStartY = 0;
            let touchMoveY = 0;
            menu.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });
            menu.addEventListener('touchmove', (e) => {
                touchMoveY = e.touches[0].clientY;
                const deltaY = touchMoveY - touchStartY;
                if (deltaY > 0) {
                    menu.style.transform = `translateY(${deltaY}px)`;
                }
            }, { passive: true });
            menu.addEventListener('touchend', () => {
                const deltaY = touchMoveY - touchStartY;
                if (deltaY > 100) {
                    closeMenu();
                } else {
                    menu.style.transform = '';
                }
                touchStartY = 0;
                touchMoveY = 0;
            });
            menu.addEventListener('click', (e) => {
                const actionTarget = e.target.closest('.menu-item');
                if (!actionTarget) return;
                const action = actionTarget.dataset.action;
                closeMenu();
                setTimeout(() => {
                    switch(action) {
                        case 'rename':
                            showRenameModal(convId, 'conversation', e);
                            break;
                        case 'pin':
                            togglePinChat(convId, e);
                            break;
                        case 'archive':
                            archiveChat(convId, e);
                            break;
                        case 'delete':
                            deleteChat(convId, e);
                            break;
                        case 'move-out':
                            moveConversationToFolder(convId, null);
                            break;
                        case 'move-to':
                            renderBatchMoveModal(convId);
                            toggleModal(ALL_ELEMENTS.batchMoveModal, true);
                            break;
                    }
                }, 300);
            });
        };
        const showMobileContextMenuForFolder = (folderId) => {
            const oldMenu = document.getElementById('mobile-context-menu-wrapper');
            if (oldMenu) oldMenu.remove();
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;
            const menuWrapper = document.createElement('div');
            menuWrapper.id = 'mobile-context-menu-wrapper';
            const overlay = document.createElement('div');
            overlay.id = 'mobile-context-menu-overlay';
            const menu = document.createElement('div');
            menu.id = 'mobile-context-menu';
            menu.innerHTML = `
                <div class="menu-header">${folder.name}</div>
                <div class="menu-options">
                    <div class="menu-item" data-action="rename-folder"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg><span>${i18n[config.uiLanguage].rename || 'ÈáçÊñ∞ÂëΩÂêç'}</span></div>
                    <div class="menu-item" data-action="customize-folder"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.475 2.118 3.375 3.375 0 0 0-1.179 4.471.75.75 0 0 0 .676.928A4.5 4.5 0 0 0 6 21c1.282 0 2.47-.602 3.22-1.606a3 3 0 0 0-1.7-4.271Zm-5.78 1.128L1.623 20.25m5.78-1.128L9.25 5.25m-3.72 1.128L5.53 16.122m3.72-1.128L9.25 5.25m5.336-3.64a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.475 2.118 3.375 3.375 0 0 0-1.179 4.471.75.75 0 0 0 .676.928A4.5 4.5 0 0 0 12 21c1.282 0 2.47-.602 3.22-1.606a3 3 0 0 0-1.7-4.271Zm-5.78 1.128L7.373 20.25m5.78-1.128L14.938 5.25m-3.72 1.128L11.22 16.122m3.72-1.128L14.938 5.25m2.478-3.64a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.475 2.118 3.375 3.375 0 0 0-1.179 4.471.75.75 0 0 0 .676.928A4.5 4.5 0 0 0 18 21c1.282 0 2.47-.602 3.22-1.606a3 3 0 0 0-1.7-4.271Zm-5.78 1.128L13.123 20.25" /></svg><span>${i18n[config.uiLanguage].customize || 'Ëá™Ë®Ç'}</span></div>
                    <div class="menu-item delete" data-action="delete-folder"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg><span>${i18n[config.uiLanguage].deleteFolder || 'Âà™Èô§Ë≥áÊñôÂ§æ'}</span></div>
                </div>
            `;
            menuWrapper.appendChild(overlay);
            menuWrapper.appendChild(menu);
            document.body.appendChild(menuWrapper);
            requestAnimationFrame(() => {
                overlay.classList.add('visible');
                menu.classList.add('visible');
            });
            const closeMenu = () => {
                overlay.classList.remove('visible');
                menu.classList.remove('visible');
                menu.addEventListener('transitionend', () => menuWrapper.remove(), { once: true });
            };
            overlay.addEventListener('click', closeMenu);
            let touchStartY = 0;
            let touchMoveY = 0;
            menu.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });
            menu.addEventListener('touchmove', (e) => {
                touchMoveY = e.touches[0].clientY;
                const deltaY = touchMoveY - touchStartY;
                if (deltaY > 0) {
                    menu.style.transform = `translateY(${deltaY}px)`;
                }
            }, { passive: true });
            menu.addEventListener('touchend', () => {
                const deltaY = touchMoveY - touchStartY;
                if (deltaY > 100) {
                    closeMenu();
                } else {
                    menu.style.transform = '';
                }
                touchStartY = 0;
                touchMoveY = 0;
            });
            menu.addEventListener('click', (e) => {
                const actionTarget = e.target.closest('.menu-item');
                if (!actionTarget) return;
                const action = actionTarget.dataset.action;
                closeMenu();
                setTimeout(() => {
                    switch(action) {
                        case 'rename-folder':
                            showRenameModal(folderId, 'folder', e);
                            break;
                        case 'customize-folder':
                            showFolderSettingsModal(folderId, e);
                            break;
                        case 'delete-folder':
                            deleteFolder(folderId, e);
                            break;
                    }
                }, 300);
            });
        };
        const showMobileContextMenuForAstras = (astrasId) => {
            const oldMenu = document.getElementById('mobile-context-menu-wrapper');
            if (oldMenu) oldMenu.remove();
            const astra = astras.find(a => a.id === astrasId);
            if (!astra) return;
            const menuWrapper = document.createElement('div');
            menuWrapper.id = 'mobile-context-menu-wrapper';
            const overlay = document.createElement('div');
            overlay.id = 'mobile-context-menu-overlay';
            const menu = document.createElement('div');
            menu.id = 'mobile-context-menu';
            let menuOptions = '';
            if (astra.officialId) {
                menuOptions = `
                    <div class="menu-item" data-action="edit-avatar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg><span>${i18n[config.uiLanguage].editAvatar || 'Á∑®ËºØÈ†≠ÂÉè'}</span></div>
                    <div class="menu-item delete" data-action="delete-astras"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg><span>${i18n[config.uiLanguage].delete || 'Âà™Èô§'}</span></div>
                `;
            } else {
                 menuOptions = `
                    <div class="menu-item" data-action="edit-astras"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg><span>${i18n[config.uiLanguage].edit || 'Á∑®ËºØ'}</span></div>
                    <div class="menu-item" data-action="edit-avatar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg><span>${i18n[config.uiLanguage].editAvatar || 'Á∑®ËºØÈ†≠ÂÉè'}</span></div>
                    <div class="menu-item delete" data-action="delete-astras"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg><span>${i18n[config.uiLanguage].delete || 'Âà™Èô§'}</span></div>
                `;
            }
            menu.innerHTML = `
                <div class="menu-header">${astra.name}</div>
                <div class="menu-options">${menuOptions}</div>
            `;
            menuWrapper.appendChild(overlay);
            menuWrapper.appendChild(menu);
            document.body.appendChild(menuWrapper);
            requestAnimationFrame(() => {
                overlay.classList.add('visible');
                menu.classList.add('visible');
            });
            const closeMenu = () => {
                overlay.classList.remove('visible');
                menu.classList.remove('visible');
                menu.addEventListener('transitionend', () => menuWrapper.remove(), { once: true });
            };
            overlay.addEventListener('click', closeMenu);
            let touchStartY = 0;
            let touchMoveY = 0;
            menu.addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; }, { passive: true });
            menu.addEventListener('touchmove', (e) => {
                touchMoveY = e.touches[0].clientY;
                const deltaY = touchMoveY - touchStartY;
                if (deltaY > 0) { menu.style.transform = `translateY(${deltaY}px)`; }
            }, { passive: true });
            menu.addEventListener('touchend', () => {
                const deltaY = touchMoveY - touchStartY;
                if (deltaY > 100) { closeMenu(); }
                else { menu.style.transform = ''; }
                touchStartY = 0; touchMoveY = 0;
            });
            menu.addEventListener('click', (e) => {
                const actionTarget = e.target.closest('.menu-item');
                if (!actionTarget) return;
                const action = actionTarget.dataset.action;
                closeMenu();
                setTimeout(() => {
                    switch(action) {
                        case 'edit-astras':
                            editingAstrasId = astrasId;
                            ALL_ELEMENTS.astrasNameInput.value = astra.name;
                            ALL_ELEMENTS.astrasDescInput.value = astra.description;
                            ALL_ELEMENTS.astrasInstructionsInput.value = astra.instructions;
                            ALL_ELEMENTS.astrasCreateModal.querySelector('h2').textContent = i18n[config.uiLanguage].editAstras || 'Á∑®ËºØ Astras';
                            toggleModal(ALL_ELEMENTS.astrasCreateModal, true);
                            break;
                        case 'edit-avatar':
                            openAvatarEditor(astrasId);
                            break;
                        case 'delete-astras':
                            deleteAstras(astrasId);
                            break;
                    }
                }, 300);
            });
        };
        const setupScrollToBottomButton = () => {
            const { scrollToBottomBtn, chatContainer } = ALL_ELEMENTS;
            scrollToBottomBtn.addEventListener('click', () => {
                isAutoScrolling = true;
                scrollToBottomBtn.classList.remove('visible');
                scrollToBottomBtn.classList.add('jelly-animate');
                scrollToBottomBtn.addEventListener('animationend', () => {
                    scrollToBottomBtn.classList.remove('jelly-animate');
                }, { once: true });
                chatContainer.scrollTo({
                    top: chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
                const scrollEndTimer = setTimeout(() => {
                    isAutoScrolling = false;
                }, 1000);
                const interruptHandler = () => {
                    clearTimeout(scrollEndTimer);
                    isAutoScrolling = false;
                    chatContainer.removeEventListener('wheel', interruptHandler);
                    chatContainer.removeEventListener('touchstart', interruptHandler);
                };
                chatContainer.addEventListener('wheel', interruptHandler, { once: true });
                chatContainer.addEventListener('touchstart', interruptHandler, { once: true });
            });
            const handleScroll = () => {
                if (isAutoScrolling) return;
                const isAtBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 100;
                if (isAtBottom) {
                    scrollToBottomBtn.classList.remove('visible');
                } else {
                    scrollToBottomBtn.classList.add('visible');
                }
            };
            chatContainer.addEventListener('scroll', throttle(handleScroll, 100));
            const updateButtonPosition = () => {
                const { inputBarContainer, followUpContainer, scrollToBottomBtn } = ALL_ELEMENTS;
                const inputBarHeight = inputBarContainer.offsetHeight;
                const followUpHeight = followUpContainer.classList.contains('hidden') ? 0 : followUpContainer.offsetHeight;
                const totalBottomOffset = inputBarHeight + followUpHeight + 16;
                scrollToBottomBtn.style.bottom = `${totalBottomOffset}px`;
            };
            const resizeObserver = new ResizeObserver(updateButtonPosition);
            resizeObserver.observe(ALL_ELEMENTS.inputBarContainer);
            resizeObserver.observe(ALL_ELEMENTS.followUpContainer);
            updateButtonPosition();
        };
        const showUpdateHistory = () => {
            const container = ALL_ELEMENTS.updateInfoContent;
            container.innerHTML = '';
            if (typeof updateLogs !== 'undefined' && updateLogs.length > 0) {
                updateLogs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'prose prose-sm max-w-none';
                    logEntry.innerHTML = `
                        <h3 class="font-bold text-lg">${log.version} <span class="text-sm font-normal text-[var(--text-secondary)]">- ${log.date}</span></h3>
                        <ul>
                            ${log.content.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    `;
                    container.appendChild(logEntry);
                });
            } else {
                container.innerHTML = `<p>${i18n[config.uiLanguage].noUpdateHistory || 'ÁõÆÂâçÊ≤íÊúâÊõ¥Êñ∞Á¥ÄÈåÑ„ÄÇ'}</p>`;
            }
            toggleModal(ALL_ELEMENTS.updateInfoModal, true);
        };
        const checkAndShowLatestUpdate = async () => {
    if (!config.enableUpdateNotifications || typeof updateLogs === 'undefined' || updateLogs.length === 0) {
        return;
    }
    const lastSeenVersion = config.lastSeenVersion || '0.0.0'; // Â¶ÇÊûúÂæûÊú™Ë¶ãÈÅéÔºåÂâáË®≠ÁÇ∫ '0.0.0'
    const newUpdates = updateLogs.filter(log => compareVersions(log.version, lastSeenVersion) > 0);
    if (newUpdates.length > 0) {
        newUpdates.sort((a, b) => compareVersions(b.version, a.version));
        const contentContainer = ALL_ELEMENTS.latestUpdateContent;
        const modalTitle = document.querySelector('#latest-update-modal h2');
        if (modalTitle) {
            modalTitle.textContent = i18n[config.uiLanguage].newVersionsFound.replace('{count}', newUpdates.length);
        }
        contentContainer.innerHTML = newUpdates.map(log => `
            <div class="prose prose-sm max-w-none mb-6 pb-4 border-b border-[var(--border-color)] last:border-b-0 last:mb-0 last:pb-0">
                <h4 class="font-bold text-lg">${log.version} <span class="text-sm font-normal text-[var(--text-secondary)]">- ${log.date}</span></h4>
                <ul>
                    ${log.content.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        `).join('');
        contentContainer.style.maxHeight = '60vh';
        contentContainer.style.overflowY = 'auto';
        toggleModal(ALL_ELEMENTS.latestUpdateModal, true);
        const latestVersionInLog = newUpdates[0].version; // Âõ†ÁÇ∫ÊàëÂÄëÂ∑≤Á∂ìÊéíÂ∫è‰∫ÜÔºåÊâÄ‰ª• newUpdates[0] ÁèæÂú®ÊòØÊúÄÊñ∞Áâà
        config.lastSeenVersion = latestVersionInLog;
        await saveConfig();
    }
};
        const renderTrash = () => {
            const container = ALL_ELEMENTS.trashListContainer;
            const deletedConvs = conversations.filter(c => c.deletedAt).sort((a,b) => new Date(b.deletedAt) - new Date(a.deletedAt));
            container.innerHTML = '';
            if (deletedConvs.length === 0) {
                container.innerHTML = `<p class="text-center text-[var(--text-secondary)] py-4">${i18n[config.uiLanguage].trashIsEmpty || 'ÂûÉÂúæÊ°∂ÊòØÁ©∫ÁöÑ„ÄÇ'}</p>`;
                ALL_ELEMENTS.emptyTrashBtn.disabled = true;
                ALL_ELEMENTS.trashBatchSelectBtn.disabled = true;
                return;
            }
            ALL_ELEMENTS.emptyTrashBtn.disabled = false;
            ALL_ELEMENTS.trashBatchSelectBtn.disabled = false;
            deletedConvs.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'trash-item flex items-center p-2 rounded-lg bg-[var(--hover-bg)] border border-[var(--border-color)]';
                item.dataset.id = conv.id;
                const checkboxHTML = isTrashSelectionMode
                    ? `<input type="checkbox" class="trash-select-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3 flex-shrink-0" data-id="${conv.id}" ${selectedTrashIds.has(conv.id) ? 'checked' : ''}>`
                    : '';
                item.innerHTML = `
                    ${checkboxHTML}
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${conv.title}</p>
                        <p class="text-xs text-[var(--text-secondary)]">${i18n[config.uiLanguage].deletedOn || 'Âà™Èô§Êñº'}: ${formatFullTimestamp(conv.deletedAt)}</p>
                    </div>
                    <div class="flex gap-2 flex-shrink-0 ml-2">
                        <button data-id="${conv.id}" class="trash-item-view-btn text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200">${i18n[config.uiLanguage].view || 'Ê™¢Ë¶ñ'}</button>
                        <button data-id="${conv.id}" class="trash-item-restore-btn text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200">${i18n[config.uiLanguage].restore || 'ÈÇÑÂéü'}</button>
                        <button data-id="${conv.id}" class="trash-item-delete-btn text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200">${i18n[config.uiLanguage].delete || 'Âà™Èô§'}</button>
                    </div>
                `;
                container.appendChild(item);
                let pressTimer = null;
                item.addEventListener('touchstart', (e) => {
                    if (e.target.closest('button')) return;
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showTrashItemInViewModal(conv.id);
                    }, 500);
                }, { passive: false });
                item.addEventListener('touchend', () => clearTimeout(pressTimer));
                item.addEventListener('touchmove', () => clearTimeout(pressTimer));
                if (isTrashSelectionMode) {
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('button')) return;
                        const checkbox = item.querySelector('.trash-select-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                }
            });
            container.querySelectorAll('.trash-item-view-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); showTrashItemInViewModal(e.currentTarget.dataset.id); }));
            container.querySelectorAll('.trash-item-restore-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); handleRestoreTrashItem(e.currentTarget.dataset.id); }));
            container.querySelectorAll('.trash-item-delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteTrashItemPermanently(e.currentTarget.dataset.id); }));
            container.querySelectorAll('.trash-select-checkbox').forEach(checkbox => checkbox.addEventListener('change', (e) => {
                const id = e.target.dataset.id;
                if (e.target.checked) {
                    selectedTrashIds.add(id);
                } else {
                    selectedTrashIds.delete(id);
                }
                renderTrashBatchActionBar();
            }));
        };
        const handleRestoreTrashItem = async (convId) => {
            const conv = conversations.find(c => c.id === convId);
            if (conv) {
                conv.deletedAt = null;
                await saveAppData();
                renderTrash();
                showNotification(i18n[config.uiLanguage].itemRestored || 'È†ÖÁõÆÂ∑≤ÈÇÑÂéü„ÄÇ', 'success');
            }
        };
        const handleDeleteTrashItemPermanently = async (convId) => {
            if (!(await showCustomConfirm(i18n[config.uiLanguage].confirmPermanentDelete || 'Ê≠§Êìç‰ΩúÂ∞áÊ∞∏‰πÖÂà™Èô§Ê≠§Â∞çË©±ÔºåÁÑ°Ê≥ïÂæ©Âéü„ÄÇÊÇ®Á¢∫ÂÆöÂóéÔºü', i18n[config.uiLanguage].permanentDeleteTitle || 'Ê∞∏‰πÖÂà™Èô§Á¢∫Ë™ç'))) return;
            conversations = conversations.filter(c => c.id !== convId);
            await saveAppData();
            renderTrash();
            showNotification(i18n[config.uiLanguage].itemPermanentlyDeleted || 'È†ÖÁõÆÂ∑≤Ê∞∏‰πÖÂà™Èô§„ÄÇ', 'success');
        };
        const showTrashItemInViewModal = (convId) => {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;
            ALL_ELEMENTS.trashViewTitle.textContent = conv.title;
            const contentContainer = ALL_ELEMENTS.trashViewContent;
            contentContainer.innerHTML = '';
            if (conv.messages.length === 0) {
                contentContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">${i18n[config.uiLanguage].noMessages || 'Ê≠§Â∞çË©±Ê≤íÊúâË®äÊÅØ„ÄÇ'}</p>`;
            } else {
                 conv.messages.forEach(msg => {
                    const isUser = msg.role === 'user';
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex items-start gap-2 md:gap-4 ${isUser ? 'justify-end user-message' : 'model-message'}`;
                    const icon = isUser ? `<div class="bg-blue-600 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold">${currentUser.username.charAt(0).toUpperCase()}</div>` : `<div class="bg-gray-800 text-white w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 15h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>`;
                    let contentHTML = msg.parts.map(p => p.text ? (isUser ? p.text.replace(/\n/g, '<br>') : renderMarkdown(p.text)) : '').join('');
                    const messageBubble = `<div class="p-3 md:p-4 rounded-lg shadow-sm max-w-full md:max-w-xl message-bubble"><div class="prose prose-sm max-w-none message-content ${isUser ? 'text-white' : 'text-[var(--text-primary)]'}">${contentHTML}</div></div>`;
                    messageDiv.innerHTML = isUser ? `${messageBubble}${icon}` : `${icon}${messageBubble}`;
                    contentContainer.appendChild(messageDiv);
                });
            }
            toggleModal(ALL_ELEMENTS.trashViewModal, true);
        };
        const toggleTrashSelectionMode = () => {
            isTrashSelectionMode = !isTrashSelectionMode;
            selectedTrashIds.clear();
            renderTrash();
            renderTrashBatchActionBar();
        };
        const renderTrashBatchActionBar = () => {
            const { trashBatchActionBar, trashSelectionCount, trashBatchRestoreBtn, trashBatchDeleteBtn } = ALL_ELEMENTS;
            if (isTrashSelectionMode) {
                trashBatchActionBar.classList.remove('hidden');
                const count = selectedTrashIds.size;
                trashSelectionCount.textContent = `${i18n[config.uiLanguage].selected || 'Â∑≤ÈÅ∏Âèñ'} ${count} ${i18n[config.uiLanguage].items || 'ÂÄãÈ†ÖÁõÆ'}`;
                const hasSelection = count > 0;
                trashBatchRestoreBtn.disabled = !hasSelection;
                trashBatchDeleteBtn.disabled = !hasSelection;
            } else {
                trashBatchActionBar.classList.add('hidden');
            }
        };
        const handleBatchRestoreFromTrash = async () => {
            const count = selectedTrashIds.size;
            if (count === 0) return;
            selectedTrashIds.forEach(id => {
                const conv = conversations.find(c => c.id === id);
                if (conv) conv.deletedAt = null;
            });
            await saveAppData();
            toggleTrashSelectionMode();
            showNotification(`${i18n[config.uiLanguage].batchRestoredSuccess || 'Â∑≤ÊàêÂäüÈÇÑÂéü'} ${count} ${i18n[config.uiLanguage].items || 'ÂÄãÈ†ÖÁõÆ'}„ÄÇ`, 'success');
        };
        const handleBatchDeleteFromTrash = async () => {
            const count = selectedTrashIds.size;
            if (count === 0) return;
            if (!(await showCustomConfirm(`${i18n[config.uiLanguage].confirmBatchPermanentDelete || 'ÊÇ®Á¢∫ÂÆöË¶ÅÊ∞∏‰πÖÂà™Èô§ÈÄô'} ${count} ${i18n[config.uiLanguage].items || 'ÂÄãÈ†ÖÁõÆÂóéÔºü'}`, i18n[config.uiLanguage].permanentDeleteTitle || 'Ê∞∏‰πÖÂà™Èô§Á¢∫Ë™ç'))) return;
            conversations = conversations.filter(c => !selectedTrashIds.has(c.id));
            await saveAppData();
            toggleTrashSelectionMode();
            showNotification(`${i18n[config.uiLanguage].batchPermanentlyDeletedSuccess || 'Â∑≤ÊàêÂäüÊ∞∏‰πÖÂà™Èô§'} ${count} ${i18n[config.uiLanguage].items || 'ÂÄãÈ†ÖÁõÆ'}„ÄÇ`, 'success');
        };
        const handleEmptyTrash = async () => {
            if (!(await showCustomConfirm(i18n[config.uiLanguage].confirmEmptyTrash || 'ÊÇ®Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÂûÉÂúæÊ°∂ÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ', i18n[config.uiLanguage].emptyTrashConfirmationTitle || 'Ê∏ÖÁ©∫ÂûÉÂúæÊ°∂Á¢∫Ë™ç'))) return;
            const count = conversations.filter(c => c.deletedAt).length;
            conversations = conversations.filter(c => !c.deletedAt);
            await saveAppData();
            renderTrash();
            showNotification(`${i18n[config.uiLanguage].trashEmptiedSuccess || 'Â∑≤ÊàêÂäüÊ∏ÖÁ©∫ÂûÉÂúæÊ°∂ÔºåÂà™Èô§‰∫Ü'} ${count} ${i18n[config.uiLanguage].items || 'ÂÄãÈ†ÖÁõÆ'}„ÄÇ`, 'success');
        };
        const updateDisplayedVersion = () => {
    const versionDisplayElement = document.getElementById('version-number-display');
    if (versionDisplayElement && typeof updateLogs !== 'undefined' && updateLogs.length > 0) {
        const latestVersionInLog = updateLogs.reduce((max, log) => 
            compareVersions(log.version, max) > 0 ? log.version : max, '0.0.0');
        versionDisplayElement.textContent = latestVersionInLog;
    }
};
        async function initChatApp() {
            await loadConfig();
            await loadAppData();
            applyCustomWallpaper();
            applyUiTheme();
            setTheme(config.theme);
            ALL_ELEMENTS.usernameDisplay.textContent = currentUser.username;
            if (!conversations.find(c => !c.archived && !c.deletedAt)) startNewChat();
            renderAll();
            updateFunctionButtonsState();
            updateInputState();
            setupVoiceInput();
            setupScrollToBottomButton();
            updateDisplayedVersion();
            checkAndShowLatestUpdate();
            ALL_ELEMENTS.menuToggleBtn.addEventListener('click', () => toggleSidebar());
            ALL_ELEMENTS.sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
            ALL_ELEMENTS.newChatBtn.addEventListener('click', () => startNewChat());
            ALL_ELEMENTS.openSearchBtn.addEventListener('click', () => {
                toggleModal(ALL_ELEMENTS.searchModal, true);
                ALL_ELEMENTS.modalSearchInput.value = '';
                ALL_ELEMENTS.searchResultsContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">${i18n[config.uiLanguage].searchPrompt}</p>`;
                setTimeout(() => ALL_ELEMENTS.modalSearchInput.focus(), 50);
            });
            ALL_ELEMENTS.apiKeyWarningBadge.addEventListener('click', () => {
                setupSettingsModal();
                toggleModal(ALL_ELEMENTS.settingsModal, true);
                const navItems = ALL_ELEMENTS.settingsNav.querySelectorAll('.settings-nav-item');
                navItems.forEach(i => i.classList.remove('active'));
                document.querySelector('.settings-nav-item[data-section="model-management"]').classList.add('active');
                document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
                document.getElementById('model-management-section').classList.add('active');
            });
            ALL_ELEMENTS.closeSearchModalBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.searchModal, false));
            ALL_ELEMENTS.performSearchBtn.addEventListener('click', performSearchAndRenderResults);
            ALL_ELEMENTS.modalSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    performSearchAndRenderResults();
                }
            });
            ALL_ELEMENTS.modalSearchScopeSelect.addEventListener('change', performSearchAndRenderResults);
            const closeSearchView = () => toggleModal(ALL_ELEMENTS.searchViewModal, false);
            ALL_ELEMENTS.closeSearchViewModalBtn.addEventListener('click', closeSearchView);
            ALL_ELEMENTS.searchViewCloseBtn.addEventListener('click', closeSearchView);
            ALL_ELEMENTS.searchViewConfirmBtn.addEventListener('click', (e) => {
                const convId = e.currentTarget.dataset.id;
                if (convId) {
                    loadChat(convId);
                    toggleSidebar(false);
                    closeSearchView();
                    toggleModal(ALL_ELEMENTS.searchModal, false);
                }
            });
            const closeTrashView = () => toggleModal(ALL_ELEMENTS.trashViewModal, false);
            ALL_ELEMENTS.closeTrashViewModalBtn.addEventListener('click', closeTrashView);
            ALL_ELEMENTS.trashViewCloseBtn.addEventListener('click', closeTrashView);
            ALL_ELEMENTS.settingsBtn.addEventListener('click', () => { setupSettingsModal(); toggleModal(ALL_ELEMENTS.settingsModal, true); });
            ALL_ELEMENTS.closeSettingsBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.settingsModal, false));
            ALL_ELEMENTS.saveSettingsBtn.addEventListener('click', saveSettings);
            ALL_ELEMENTS.themeLightBtn.addEventListener('click', () => setTheme('light'));
            ALL_ELEMENTS.themeDarkBtn.addEventListener('click', () => setTheme('dark'));
            ALL_ELEMENTS.openArchivedModalBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.archivedChatsModal, true));
            ALL_ELEMENTS.closeArchivedModalBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.archivedChatsModal, false));
            const closeViewArchivedModal = () => toggleModal(ALL_ELEMENTS.viewArchivedChatModal, false);
            ALL_ELEMENTS.closeViewArchivedModalBtn.addEventListener('click', closeViewArchivedModal);
            ALL_ELEMENTS.closeViewArchivedModalBtnFooter.addEventListener('click', closeViewArchivedModal);
            ALL_ELEMENTS.saveRenameBtn.addEventListener('click', handleRename);
            ALL_ELEMENTS.cancelRenameBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.renameModal, false));
            ALL_ELEMENTS.saveFolderSettingsBtn.addEventListener('click', handleSaveFolderSettings);
            ALL_ELEMENTS.cancelFolderSettingsBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.folderSettingsModal, false));
            ALL_ELEMENTS.exportDataBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.exportDataModal, true));
            ALL_ELEMENTS.cancelExportBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.exportDataModal, false));
            ALL_ELEMENTS.confirmExportBtn.addEventListener('click', handleExport);
            ALL_ELEMENTS.importDataBtn.addEventListener('click', () => { ALL_ELEMENTS.importFileInput.value=''; toggleModal(ALL_ELEMENTS.importDataModal, true); });
            ALL_ELEMENTS.cancelImportBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.importDataModal, false));
            ALL_ELEMENTS.confirmImportBtn.addEventListener('click', handleImport);
            ALL_ELEMENTS.logoutBtn.addEventListener('click', handleLogout);
            ALL_ELEMENTS.userProfileBtn.addEventListener('click', openDashboard);
            ALL_ELEMENTS.closeDashboardBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.dataDashboardModal, false));
            ALL_ELEMENTS.messageList.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-content-btn');
                const deleteBtn = e.target.closest('.delete-message-btn');
                if (copyBtn) {
                    const messageItem = copyBtn.closest('.message-item');
                    if (messageItem) {
                        const messageIndex = parseInt(messageItem.dataset.messageIndex);
                        const conv = getActiveConversation();
                        const msg = conv?.messages[messageIndex];
                        if (msg && msg.role === 'model') {
                            const textToCopy = msg.parts.map(p => p.text).join('\n');
                            copyTextToClipboard(textToCopy)
                                .then(() => showNotification(i18n[config.uiLanguage].copySuccess || 'ÂÖßÂÆπÂ∑≤Ë§áË£ΩÔºÅ', 'success'))
                                .catch(err => {
                                    showNotification(i18n[config.uiLanguage].copyFailed || 'Ë§áË£ΩÂ§±ÊïóÔºÅÁÄèË¶ΩÂô®ÂèØËÉΩÈôêÂà∂‰∫ÜÊ≠§ÂäüËÉΩ„ÄÇ', 'error');
                                    console.error('Could not copy text with any method: ', err);
                                });
                        }
                    }
                } else if (deleteBtn) {
                    const messageItem = deleteBtn.closest('.message-item');
                     if (messageItem) {
                        const messageIndex = parseInt(messageItem.dataset.messageIndex);
                        handleDeleteMessagePair(messageIndex);
                    }
                }
            });
            ALL_ELEMENTS.addFileBtn.addEventListener('click', (e) => {
                const popover = ALL_ELEMENTS.fileOptionsPopover;
                if (popover.classList.contains('visible')) {
                    popover.classList.remove('visible');
                } else {
                    closeAllPopovers();
                    popover.classList.add('visible');
                }
            });
            ALL_ELEMENTS.cameraBtn.addEventListener('click', () => {
                ALL_ELEMENTS.fileOptionsPopover.classList.remove('visible');
                ALL_ELEMENTS.imageVideoInput.setAttribute('capture','environment');
                ALL_ELEMENTS.imageVideoInput.click();
            });
            ALL_ELEMENTS.webSearchPopoverBtn.addEventListener('click', async () => {
                ALL_ELEMENTS.fileOptionsPopover.classList.remove('visible');
                const conv = getActiveConversation();
                if (!conv || conv.provider !== 'gemini' || conv.archived) {
                    showNotification(i18n[config.uiLanguage].webSearchNotAvailable || 'Áï∂ÂâçÊ®°Âûã‰∏çÊîØÊè¥ÊàñÁÑ°Ê≥ï‰ΩøÁî®ËÅØÁ∂≤ÊêúÂ∞ã„ÄÇ', 'warning');
                    return;
                }
                conv.isWebSearchEnabled = !conv.isWebSearchEnabled;
                renderInputIndicators();
                await saveAppData();
            });
            ALL_ELEMENTS.learningModeBtn.addEventListener('click', toggleLearningMode);
            ALL_ELEMENTS.uploadImageBtn.addEventListener('click', () => {
                ALL_ELEMENTS.fileOptionsPopover.classList.remove('visible');
                ALL_ELEMENTS.imageVideoInput.removeAttribute('capture');
                ALL_ELEMENTS.imageVideoInput.click();
            });
            ALL_ELEMENTS.uploadFileBtn.addEventListener('click', () => {
                ALL_ELEMENTS.fileOptionsPopover.classList.remove('visible');
                ALL_ELEMENTS.fileUploadInput.click();
            });
            ALL_ELEMENTS.imageVideoInput.addEventListener('change', handleFileSelection);
            ALL_ELEMENTS.fileUploadInput.addEventListener('change', handleFileSelection);
            ALL_ELEMENTS.selectionModeBtn.addEventListener('click', toggleSelectionMode);
            ALL_ELEMENTS.cancelSelectionBtn.addEventListener('click', toggleSelectionMode);
            ALL_ELEMENTS.batchDeleteBtn.addEventListener('click', handleBatchDelete);
            ALL_ELEMENTS.batchArchiveBtn.addEventListener('click', handleBatchArchive);
            ALL_ELEMENTS.batchMoveBtn.addEventListener('click', handleBatchMove);
            ALL_ELEMENTS.batchMoveCancelBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.batchMoveModal, false));
            ALL_ELEMENTS.batchMoveConfirmBtn.addEventListener('click', () => { /* Logic moved to option clicks */ });
            ALL_ELEMENTS.followUpHeader.addEventListener('click', toggleFollowUpPrompts);
            ALL_ELEMENTS.messageInput.addEventListener('input', (e) => {
                sendConfirmed = false;
                updateInputState();
                const wrapper = e.target.closest('.input-wrapper');
                if (wrapper) {
                    wrapper.classList.remove('pulse-glow');
                    void wrapper.offsetWidth;
                    wrapper.classList.add('pulse-glow');
                }
            });
            ALL_ELEMENTS.messageInput.addEventListener('input', adjustTextareaHeight);
const expandBtn = document.getElementById('expand-input-btn');
if (expandBtn) {
    expandBtn.addEventListener('click', () => {
        ALL_ELEMENTS.messageInput.classList.toggle('expanded');
        expandBtn.classList.toggle('rotated');
        adjustTextareaHeight(); // ÈªûÊìäÂæåÈáçÊñ∞Ë®àÁÆó‰∏ÄÊ¨°È´òÂ∫¶
    });
}
            ALL_ELEMENTS.messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.shiftKey) { 
        e.preventDefault(); // ÈòªÊ≠¢ Shift+Enter ÁöÑÈªòË™çÊèõË°åË°åÁÇ∫
        ALL_ELEMENTS.submitButton.click();
    }
});
const handleInputFocus = () => {
                // Ê™¢Êü•ÁÄèË¶ΩÂô®ÊòØÂê¶ÊîØÊè¥ visualViewport APIÔºåÈÄôÊòØÊ≠§Ëß£Ê±∫ÊñπÊ°àÁöÑÂü∫Á§é„ÄÇ
                if (window.visualViewport) {
                    const smoothScrollToTarget = () => {
                        const inputBarContainer = document.getElementById('input-bar-container');
                        if (!inputBarContainer) return;

                        // Ë´ãÊ±ÇÂú®‰∏ã‰∏ÄÊ¨°ÁÄèË¶ΩÂô®ÈáçÁπ™ÂâçÂü∑Ë°åÊàëÂÄëÁöÑË®àÁÆóÔºåÈÄôÊòØÂØ¶ÁèæÂπ≥ÊªëÂãïÁï´ÁöÑÈóúÈçµ„ÄÇ
                        requestAnimationFrame(() => {
                            const PADDING_BOTTOM = 10; // Âú®ÈçµÁõ§ÂíåËº∏ÂÖ•Ê°Ü‰πãÈñì‰øùÁïô 10px ÁöÑÈñìË∑ùÔºåËÆì‰ΩçÁΩÆÊõ¥Èù†‰∏ä„ÄÇ

                            // Áç≤ÂèñËº∏ÂÖ•Ê°ÜÂÆπÂô®Áõ∏Â∞çÊñºÂèØË¶ñÂçÄÂüüÁöÑÂπæ‰ΩïË≥áË®ä„ÄÇ
                            const inputBarRect = inputBarContainer.getBoundingClientRect();
                            // Áç≤ÂèñÈçµÁõ§ÂΩàÂá∫ÂæåÔºåÁúüÊ≠£ÁöÑÂèØË¶ñÂçÄÂüüÈ´òÂ∫¶„ÄÇ
                            const viewportHeight = window.visualViewport.height;
                            
                            // Ë®àÁÆóËº∏ÂÖ•Ê°ÜÂ∫ïÈÉ®Ë∂ÖÂá∫ÂèØË¶ñÂçÄÂüüÂ∫ïÈÉ®ÁöÑË∑ùÈõ¢„ÄÇ
                            // Ê≠£ÂÄºË°®Á§∫Ëº∏ÂÖ•Ê°ÜË¢´ÈçµÁõ§ÈÅÆÊìã‰∫Ü„ÄÇ
                            const offset = inputBarRect.bottom - viewportHeight + PADDING_BOTTOM;

                            // Â¶ÇÊûúËº∏ÂÖ•Ê°ÜÂ∑≤Á∂ìÂú®Ë¶ñÈáéÂÖß‰∏î‰ΩçÁΩÆÊ≠£Á¢∫ÔºåÂâáÁÑ°ÈúÄÊªæÂãï„ÄÇ
                            if (offset > 0) {
                                // Ë®àÁÆóÊñ∞ÁöÑÊªæÂãï‰ΩçÁΩÆÔºöÁõÆÂâçÁöÑÊªæÂãï‰ΩçÁΩÆ + ÈúÄË¶ÅÈ°çÂ§ñÊªæÂãïÁöÑË∑ùÈõ¢„ÄÇ
                                const newScrollPosition = window.scrollY + offset;
                                // Âü∑Ë°åÂπ≥ÊªëÊªæÂãïÂà∞ÊàëÂÄëÁ≤æÁ¢∫Ë®àÁÆóÂá∫ÁöÑ‰ΩçÁΩÆ„ÄÇ
                                window.scrollTo({
                                    top: newScrollPosition,
                                    behavior: 'smooth'
                                });
                            }
                        });
                    };

                    // Áï∂ÈçµÁõ§ÂΩàÂá∫Â∞éËá¥ÂèØË¶ñÂçÄÂüüÂ§ßÂ∞èÊîπËÆäÊôÇÔºåËß∏ÁôºÊàëÂÄëÁöÑÊªæÂãïË®àÁÆó„ÄÇ
                    // ‰ΩøÁî® { once: true } Á¢∫‰øùÂè™Ëß∏Áôº‰∏ÄÊ¨°ÔºåÈÅøÂÖçÈçµÁõ§ÂãïÁï´ÈÅéÁ®ã‰∏≠ÁöÑÂ§öÊ¨°Ëß∏ÁôºÂ∞éËá¥ÊäñÂãï„ÄÇ
                    window.visualViewport.addEventListener('resize', smoothScrollToTarget, { once: true });
                } else {
                    // Â∞çÊñº‰∏çÊîØÊè¥ visualViewport ÁöÑËàäÁâàÁÄèË¶ΩÂô®Ôºå‰øùÁïô‰∏ÄÂÄãÂü∫Êú¨ÁöÑÂÇôÁî®ÊñπÊ°à„ÄÇ
                    setTimeout(() => {
                        const inputBarContainer = document.getElementById('input-bar-container');
                        if (inputBarContainer) {
                            inputBarContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                    }, 300);
                }
            };

            // Áõ£ËÅΩ focus ‰∫ã‰ª∂‰ªçÁÑ∂ÊòØÊàëÂÄëËß∏ÁôºÈÇèËºØÁöÑËµ∑Èªû„ÄÇ
            ALL_ELEMENTS.messageInput.addEventListener('focus', handleInputFocus);

            ALL_ELEMENTS.messageInput.addEventListener('input', () => {
                const conv = getActiveConversation();
                if (conv) {
                    conv.unsentMessage = ALL_ELEMENTS.messageInput.value;
                }
            });
            ALL_ELEMENTS.submitButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (abortController) {
                    try { abortController.abort(); } catch {}
                } else if (!ALL_ELEMENTS.submitButton.disabled) {
                    if (sendConfirmed) {
                        ALL_ELEMENTS.chatForm.dispatchEvent(new Event('submit', {cancelable: true}));
                    } else {
                        sendConfirmed = true;
                        updateInputState();
                    }
                }
            });
            ALL_ELEMENTS.chatForm.addEventListener('submit', handleFormSubmit);
            document.addEventListener('click', (e) => {
                const targets = [
                    ALL_ELEMENTS.modelSwitcherContainer,
                    ALL_ELEMENTS.fileInputContainer
                ];
                let clickedInsidePopover = false;
                document.querySelectorAll('.popover.visible').forEach(popover => {
                    if (popover.contains(e.target)) clickedInsidePopover = true;
                });
                const clickedOnPopoverTrigger =
                    ALL_ELEMENTS.modelSwitcherContainer.contains(e.target) ||
                    ALL_ELEMENTS.fileInputContainer.contains(e.target) ||
                    e.target.closest('.chat-options-btn') ||
                    e.target.closest('.astras-options-btn') ||
                    e.target.closest('.folder-options-btn');
                if (!clickedInsidePopover && !clickedOnPopoverTrigger) {
                    closeAllPopovers();
                }
                const colorMenus = document.querySelectorAll('.color-dropdown-menu.show');
                colorMenus.forEach(menu => {
                    if (!menu.parentElement.contains(e.target)) {
                        menu.classList.remove('show');
                    }
                });
            });
            ALL_ELEMENTS.newFolderBtn.addEventListener('click', async () => {
                const name = await showCustomPrompt(i18n[config.uiLanguage].enterFolderName, i18n[config.uiLanguage].createFolder);
                if (name) {
                    createNewFolder(name);
                    showNotification(i18n[config.uiLanguage].folderCreated);
                }
            });
            ALL_ELEMENTS.newAstrasBtn.addEventListener('click', createAstras);
            ALL_ELEMENTS.saveAstrasBtn.addEventListener('click', handleSaveAstras);
            ALL_ELEMENTS.cancelAstrasBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.astrasCreateModal, false));
            ALL_ELEMENTS.addPersonalMemoryBtn.addEventListener('click', async () => {
                const content = await showCustomPrompt(i18n[config.uiLanguage].enterNewMemory, i18n[config.uiLanguage].addMemory);
                if (content) {
                    personalMemories.push({ id: crypto.randomUUID(), content, enabled: true });
                    await saveAppData();
                    renderPersonalMemoryList();
                    showNotification(i18n[config.uiLanguage].memoryAdded);
                }
            });
            ALL_ELEMENTS.uploadWallpaperBtn.addEventListener('click', () => ALL_ELEMENTS.wallpaperUploadInput.click());
            ALL_ELEMENTS.wallpaperUploadInput.addEventListener('change', handleWallpaperUpload);
            ALL_ELEMENTS.restoreWallpaperBtn.addEventListener('click', restoreDefaultWallpaper);
            ALL_ELEMENTS.confirmCropBtn.addEventListener('click', handleConfirmCrop);
            ALL_ELEMENTS.cancelCropBtn.addEventListener('click', () => {
                toggleModal(ALL_ELEMENTS.wallpaperCropModal, false);
                if(cropperInstance) {
                    cropperInstance.destroy();
                    cropperInstance = null;
                }
            });
            ALL_ELEMENTS.deleteAllDataBtn.addEventListener('click', handleDeleteAllData);
            ALL_ELEMENTS.uiLanguageSelect.addEventListener('change', (e) => {
                config.uiLanguage = e.target.value;
                applyLanguage(config.uiLanguage);
            });
            ALL_ELEMENTS.openStoreBtn.addEventListener('click', openStore);
            ALL_ELEMENTS.backToChatBtn.addEventListener('click', closeStore);
            ALL_ELEMENTS.astrasAvatarInput.addEventListener('change', handleAvatarUpload);
            ALL_ELEMENTS.confirmAvatarCropBtn.addEventListener('click', handleConfirmAvatarCrop);
            ALL_ELEMENTS.cancelAvatarCropBtn.addEventListener('click', () => {
                 toggleModal(ALL_ELEMENTS.astrasAvatarModal, false);
                if(cropperInstance) {
                    cropperInstance.destroy();
                    cropperInstance = null;
                }
                editingAstraForAvatarId = null;
            });
            ALL_ELEMENTS.updateInfoBtn.addEventListener('click', showUpdateHistory);
            ALL_ELEMENTS.closeUpdateInfoModalBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.updateInfoModal, false));
            ALL_ELEMENTS.closeLatestUpdateModalBtn.addEventListener('click', () => toggleModal(ALL_ELEMENTS.latestUpdateModal, false));
            ALL_ELEMENTS.trashBatchSelectBtn.addEventListener('click', toggleTrashSelectionMode);
            ALL_ELEMENTS.trashCancelSelectionBtn.addEventListener('click', toggleTrashSelectionMode);
            ALL_ELEMENTS.trashBatchRestoreBtn.addEventListener('click', handleBatchRestoreFromTrash);
            ALL_ELEMENTS.trashBatchDeleteBtn.addEventListener('click', handleBatchDeleteFromTrash);
            ALL_ELEMENTS.emptyTrashBtn.addEventListener('click', handleEmptyTrash);
            updateFileInputUI();
            startNewChat();
        const initializeSpotlightEffect = () => {
            const spotlightElements = document.querySelectorAll('.spotlight-effect');
            spotlightElements.forEach(el => {
                const handleMove = (e) => {
                    const rect = el.getBoundingClientRect();
                    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                    el.style.setProperty('--spotlight-x', `${x}px`);
                    el.style.setProperty('--spotlight-y', `${y}px`);
                };
                el.addEventListener('mousemove', handleMove);
                el.addEventListener('touchmove', handleMove, { passive: true });
            });
        };
            ALL_ELEMENTS.sendFeedbackBtn.addEventListener('click', async () => {
    const feedbackContent = ALL_ELEMENTS.feedbackTextarea.value.trim();
    const sendButton = ALL_ELEMENTS.sendFeedbackBtn;
    
    if (!feedbackContent) {
        showNotification('Ë´ãÂÖàËº∏ÂÖ•ÊÇ®ÁöÑÊÑèË¶ãÔºÅ', 'warning');
        return;
    }
    const FORM_ENDPOINT = 'https://formspree.io/f/mjkabkko'; 


    const originalButtonText = sendButton.textContent;
    sendButton.disabled = true;
    sendButton.textContent = 'ÁôºÈÄÅ‰∏≠...';


    try {
        const response = await fetch(FORM_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ message: feedbackContent, source: 'Astra Feedback Form' })
        });


        if (response.ok) {
            showNotification('ÂèçÈ•ãÂ∑≤ÊàêÂäüÁôºÈÄÅÔºåÊÑüË¨ùÊÇ®ÔºÅ', 'success');
            ALL_ELEMENTS.feedbackTextarea.value = '';
        } else {
            throw new Error('‰º∫ÊúçÂô®ÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
        }
    } catch (error) {
        console.error('ÁôºÈÄÅÂèçÈ•ãÊôÇÂá∫ÈåØ:', error);
        showNotification('ÁôºÈÄÅÂ§±ÊïóÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑÁ∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ', 'error');
    } finally {
        sendButton.disabled = false;
        sendButton.textContent = originalButtonText;
    }
});
            ALL_ELEMENTS.proposeAstrasBtn.addEventListener('click', () => {
    ALL_ELEMENTS.proposalNameInput.value = '';
    ALL_ELEMENTS.proposalDescInput.value = '';
    ALL_ELEMENTS.proposalInstructionsInput.value = '';
    toggleModal(ALL_ELEMENTS.astrasProposalModal, true);
});


ALL_ELEMENTS.cancelProposalBtn.addEventListener('click', () => {
    toggleModal(ALL_ELEMENTS.astrasProposalModal, false);
});


ALL_ELEMENTS.submitProposalBtn.addEventListener('click', async () => {
    const name = ALL_ELEMENTS.proposalNameInput.value.trim();
    const description = ALL_ELEMENTS.proposalDescInput.value.trim();
    const instructions = ALL_ELEMENTS.proposalInstructionsInput.value.trim();
    const submitButton = ALL_ELEMENTS.submitProposalBtn;


    if (!name || !instructions) {
        showNotification('ÊèêÊ°àÁöÑ„ÄåÂêçÁ®±„ÄçÂíå„ÄåÊåá‰ª§„ÄçÊòØÂøÖÂ°´ÁöÑÂñîÔºÅ', 'warning');
        return;
    }
    const FORM_ENDPOINT = 'https://formspree.io/f/mzzjpzzw';


    const originalButtonText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = 'Êèê‰∫§‰∏≠...';


    try {
        const response = await fetch(FORM_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ "ÊèêÊ°àÂêçÁ®±": name, "ÂäüËÉΩË™™Êòé": description, "Ê†∏ÂøÉÊåá‰ª§": instructions })
        });


        if (response.ok) {
            toggleModal(ALL_ELEMENTS.astrasProposalModal, false);
            showNotification('ÊÑüË¨ùÊÇ®ÁöÑÊèêÊ°àÔºåÂ∑≤ÊàêÂäüÁôºÈÄÅÔºÅ', 'success');
        } else {
            throw new Error('‰º∫ÊúçÂô®ÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
        }
    } catch (error) {
        console.error('Êèê‰∫§ÊèêÊ°àÊôÇÂá∫ÈåØ:', error);
        showNotification('Êèê‰∫§Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑÁ∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ', 'error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
    }
});
        initializeSpotlightEffect();
        }
        const handleDeleteMessagePair = async (index) => {
            const confirmed = await showCustomDialog({
                title: i18n[config.uiLanguage].deleteConfirmationTitle || 'Âà™Èô§Á¢∫Ë™ç',
                message: i18n[config.uiLanguage].deleteConfirmationMessage || 'Á¢∫ÂÆöÂà™Èô§Ê≠§Ê¢ùÂ∞çË©±Ôºü',
                dialogClass: 'dialog-warning-border',
                buttons: [
                    { text: i18n[config.uiLanguage].cancel || 'ÂèñÊ∂à', class: 'bg-[var(--hover-bg)] px-4 py-2 rounded-md hover:bg-[var(--active-bg)]', value: () => false },
                    { text: i18n[config.uiLanguage].confirmDelete || 'Á¢∫ÂÆö', class: 'bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600', value: () => true }
                ]
            });
            if (confirmed) {
                    const conv = getActiveConversation();
                    if (conv && conv.messages[index] && conv.messages[index + 1]) {
                        conv.messages.splice(index, 2);
                        await saveAppData();
                        renderChat();
                        showNotification(i18n[config.uiLanguage].messageDeleted || 'Â∞çË©±Â∑≤Âà™Èô§„ÄÇ', 'success');
                    }
                }
            };
            ALL_ELEMENTS.authForm.addEventListener('submit', handleLogin);
            const toggleAuthImportButton = () => {
                const username = ALL_ELEMENTS.usernameInput.value.trim();
                const password = ALL_ELEMENTS.passwordInput.value;
                ALL_ELEMENTS.importBtnAuth.disabled = !(username && password);
            };
            ALL_ELEMENTS.usernameInput.addEventListener('input', toggleAuthImportButton);
            ALL_ELEMENTS.passwordInput.addEventListener('input', toggleAuthImportButton);
            ALL_ELEMENTS.importBtnAuth.addEventListener('click', handleImportOnAuth);
            ALL_ELEMENTS.confirmImportBtnAuth.addEventListener('click', processAuthImport);
            ALL_ELEMENTS.cancelImportBtnAuth.addEventListener('click', () => toggleModal(ALL_ELEMENTS.importDataModalAuth, false));
            (async function prefillLastUser() {
                const last = await getItem('chat_lastUser');
                if (last) ALL_ELEMENTS.usernameInput.value = last;
                applyLanguage('zh-TW');
            })();
            const FOLDER_ICONS = ['üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üìö', 'üìù', 'üóÉÔ∏è', 'üìò', 'üìô', 'üìó', 'üìï'];
            const adjustTextareaHeight = () => {
    const textarea = ALL_ELEMENTS.messageInput;
    const expandBtn = document.getElementById('expand-input-btn');
    if (!textarea || !expandBtn) return;


    // Êö´ÊôÇÈáçÁΩÆÈ´òÂ∫¶Ôºå‰ª•‰æøÊ≠£Á¢∫Ë®àÁÆóÂÖßÂÆπÁöÑÂØ¶ÈöõÈ´òÂ∫¶
    textarea.style.height = 'auto';


    const lineHeight = parseFloat(getComputedStyle(textarea).lineHeight);
    const paddingTop = parseFloat(getComputedStyle(textarea).paddingTop);
    const paddingBottom = parseFloat(getComputedStyle(textarea).paddingBottom);
    
    // Ë®àÁÆóÂá∫CSS‰∏≠Ë®≠ÂÆöÁöÑ8Ë°åÊúÄÂ§ßÈ´òÂ∫¶
    const maxHeight = (lineHeight * 8) + paddingTop + paddingBottom;
    const scrollHeight = textarea.scrollHeight;


    // Â¶ÇÊûúÂÖßÂÆπÈ´òÂ∫¶Ë∂ÖÈÅé8Ë°åÔºåÂ∞±È°ØÁ§∫Â±ïÈñãÊåâÈàïÔºåÂê¶ÂâáÈö±Ëóè
    if (scrollHeight > maxHeight + 2) { // +2 ÊòØ‰∏ÄÂÄãÂ∞èÁ∑©Ë°ùÔºåÈÅøÂÖçË™§Â∑Æ
        expandBtn.classList.remove('hidden');
        expandBtn.classList.add('flex');
    } else {
        expandBtn.classList.add('hidden');
        expandBtn.classList.remove('flex');
        // Â¶ÇÊûúÊñáÂ≠óÊ∏õÂ∞ë‰∫ÜÔºåËá™ÂãïÂèñÊ∂àÂ±ïÈñãÁãÄÊÖã
        if (textarea.classList.contains('expanded')) {
            textarea.classList.remove('expanded');
            expandBtn.classList.remove('rotated');
        }
    }


    // Ê†πÊìöÊòØÂê¶Â±ïÈñã‰æÜË®≠ÂÆöÊúÄÁµÇÈ´òÂ∫¶
    if (textarea.classList.contains('expanded')) {
        textarea.style.height = `${scrollHeight}px`;
    } else {
        textarea.style.height = `${Math.min(scrollHeight, maxHeight)}px`;
    }
};
            ALL_ELEMENTS.loginLangBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                ALL_ELEMENTS.loginLangMenu.classList.toggle('visible');
            });
            document.addEventListener('click', (e) => {
                if (!ALL_ELEMENTS.loginLanguageSwitcher.contains(e.target)) {
                    ALL_ELEMENTS.loginLangMenu.classList.remove('visible');
                }
            });
            ALL_ELEMENTS.loginLangMenu.addEventListener('click', (e) => {
                e.preventDefault();
                const lang = e.target.dataset.lang;
                if (lang) {
                    config.uiLanguage = lang;
                    config.aiDefaultLanguage = lang;
                    applyLanguage(lang);
                    ALL_ELEMENTS.loginLangMenu.classList.remove('visible');
                }
            });
        </script>
        <script>
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });
        var lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
